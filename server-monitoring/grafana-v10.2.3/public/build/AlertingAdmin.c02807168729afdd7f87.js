"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7680],{19135:(w,T,t)=>{t.r(T),t.d(T,{default:()=>ue});var e=t(85960),P=t(39512),c=t(66681),E=t(47257),x=t(49199),I=t(95162),V=t(70335),F=t(92746),U=t(84954),L=t(5970),y=t(76679),Y=t(85745),J=t(74042),H=t(27436),O=t(29165),W=t(81828),Z=t(66596),B=t(20519),K=t(62577),X=t(77980);const o=({defaultValues:a,readOnly:l,loading:s,alertManagerSourceName:g,showConfirmDeleteAMConfig:d,onSubmit:r,onReset:n,onConfirmReset:m,onDismiss:f})=>e.createElement(Z.l,{defaultValues:a,onSubmit:r,key:a.configJSON},({errors:u,setValue:i,register:S})=>(S("configJSON",{required:{value:!0,message:"Required"},validate:p=>{try{return JSON.parse(p),!0}catch(N){return N instanceof Error?N.message:"JSON is invalid"}}}),e.createElement(e.Fragment,null,e.createElement(B.g,{disabled:s,label:"Configuration",invalid:!!u.configJSON,error:u.configJSON?.message,"data-testid":l?"readonly-config":"config"},e.createElement(K.p,{language:"json",width:"100%",height:500,showLineNumbers:!0,value:a.configJSON,showMiniMap:!1,onSave:p=>{i("configJSON",p)},onBlur:p=>{i("configJSON",p)},readOnly:l})),!l&&e.createElement(J.Lh,null,e.createElement(O.zx,{type:"submit",variant:"primary",disabled:s},"Save configuration"),n&&e.createElement(O.zx,{type:"button",disabled:s,variant:"destructive",onClick:n},"Reset configuration")),!!d&&m&&f&&e.createElement(X.s,{isOpen:!0,title:"Reset Alertmanager configuration",body:`Are you sure you want to reset configuration ${g===y.GC?"for the Grafana Alertmanager":`for "${g}"`}? Contact points and notification policies will be reset to their defaults.`,confirmText:"Yes, reset configuration",onConfirm:m,onDismiss:f}))));function A({onChange:a,selectedAmConfig:l,defaultValues:s,onSubmit:g,readOnly:d,loading:r}){const{useGetValidAlertManagersConfigQuery:n,useResetAlertManagerConfigToOldVersionMutation:m}=W.alertmanagerApi,f=(0,E.wW)(h),{currentData:u,isLoading:i}=n(),[S]=m(),p=(0,e.useMemo)(()=>{if(!u?.length)return[];const v=u.map(D=>{const $=new Date(D.last_applied);return{label:D.last_applied?`Config from ${$.toLocaleString()} (${(0,Y.CQ)($).locale("en").fromNow(!0)} ago)`:"Previous config",value:D}});return a(v[0]),v},[u,a]),N=async()=>{const v=l?.value?.id;v!==void 0&&S({id:v})};return e.createElement(e.Fragment,null,!i&&u&&u.length>0?e.createElement(e.Fragment,null,e.createElement("div",null,"Select a previous working configuration until you fix this error:"),e.createElement("div",{className:f.container},e.createElement(J.Lh,{align:"flex-start",spacing:"md"},e.createElement(H.Ph,{options:p,value:l,onChange:v=>{a(v)}}),e.createElement(O.zx,{variant:"primary",disabled:r,onClick:N},"Reset to selected configuration"))),e.createElement(o,{defaultValues:s,onSubmit:v=>g(v),readOnly:d,loading:r,alertManagerSourceName:y.GC})):null)}const h=a=>({container:(0,c.css)`
    margin-top: ${a.spacing(2)};
    margin-bottom: ${a.spacing(2)};
  `});function M(){const a=(0,I.useDispatch)(),[l,s]=(0,e.useState)(!1),{loading:g}=(0,F._)(G=>G.deleteAMConfig),{loading:d}=(0,F._)(G=>G.saveAMConfig),{selectedAlertmanager:r}=(0,U.ZA)(),n=r?(0,y.RY)(r):!1,m=(0,E.wW)(R),[f,u]=(0,e.useState)(),{currentData:i,error:S,isLoading:p}=(0,V.W)(r),N=()=>{r&&a((0,L.Nc)(r)),s(!1)},v=(0,e.useMemo)(()=>({configJSON:i?JSON.stringify(i,null,2):""}),[i]),D=(0,e.useMemo)(()=>({configJSON:f?JSON.stringify(f.value,null,2):""}),[f]),$=g||p||d,_=G=>{r&&i&&a((0,L.mM)({newConfig:JSON.parse(G.configJSON),oldConfig:i,alertManagerSourceName:r,successMessage:"Alertmanager configuration updated."}))};return e.createElement("div",{className:m.container},S&&!$&&e.createElement(e.Fragment,null,e.createElement(x.b,{severity:"error",title:"Your Alertmanager configuration is incorrect. These are the details of the error:"},S.message||"Unknown error."),r===y.GC&&e.createElement(A,{onChange:u,selectedAmConfig:f,defaultValues:D,readOnly:!0,loading:$,onSubmit:_})),g&&r!==y.GC&&e.createElement(x.b,{severity:"info",title:"Resetting Alertmanager configuration"},"It might take a while..."),r&&i&&e.createElement(o,{defaultValues:v,onSubmit:G=>_(G),readOnly:n,loading:$,alertManagerSourceName:r,showConfirmDeleteAMConfig:l,onReset:()=>s(!0),onConfirmReset:N,onDismiss:()=>s(!1)}))}const R=a=>({container:(0,c.css)`
    margin-bottom: ${a.spacing(4)};
  `});var z=t(5106),C=t(98642),Q=t(16901),j=t(56375),ee=t(8111);function te(){const{useGetExternalAlertmanagersQuery:a}=W.alertmanagerApi,{currentData:l}=a(),s=(0,y.aM)().filter(n=>n.jsonData.handleGrafanaManagedAlerts),g=(0,I.useSelector)((0,ee.P1)(n=>n.dataSources.dataSources.filter(m=>m.type==="alertmanager"),n=>(0,j.keyBy)(n,m=>m.uid))),d=(0,j.countBy)(l?.droppedAlertManagers,n=>n.url),r=(0,j.countBy)(l?.activeAlertManagers,n=>n.url);return s.map(n=>{const m=g[n.uid];if(!m)return{dataSource:n,status:"pending"};const u=`${ae(m)}/api/v2/alerts`,i=d[u]??0,S=r[u]??0,p=i>0,N=S>0,v=i+S>1,D=p?"dropped":N?"active":"pending";return{dataSource:n,url:m.url,status:D,statusInconclusive:v}})}function ae(a){return new RegExp("^[^:]*://").test(a.url)?a.url:`http://${a.url}`}var ne=t(11318),b=t(72435),re=t(14607),le=t(97666),k=t(67192),oe=t(77294);function se({alertmanagers:a,inactive:l}){const s=(0,E.wW)(q);return e.createElement(e.Fragment,null,e.createElement("h5",null,"Alertmanagers Receiving Grafana-managed alerts"),e.createElement("div",{className:s.muted},"Alertmanager data sources support a configuration setting that allows you to choose to send Grafana-managed alerts to that Alertmanager. ",e.createElement("br",null),"Below, you can see the list of all Alertmanager data sources that have this setting enabled."),a.length===0&&e.createElement(ne._,{message:e.createElement("div",null,"There are no Alertmanager data sources configured to receive Grafana-managed alerts. ",e.createElement("br",null),"You can change this by selecting Receive Grafana Alerts in a data source configuration."),callToActionElement:e.createElement(O.Qj,{href:"/datasources"},"Go to data sources"),className:s.externalDsCTA}),a.length>0&&e.createElement("div",{className:s.externalDs},a.map(g=>e.createElement(ie,{key:g.dataSource.uid,alertmanager:g,inactive:l}))))}function ie({alertmanager:a,inactive:l}){const s=(0,E.wW)(q),{dataSource:g,status:d,statusInconclusive:r,url:n}=a;return e.createElement(b.Z,null,e.createElement(b.Z.Heading,{className:s.externalHeading},g.name," ",r&&e.createElement(re.u,{content:"Multiple Alertmanagers have the same URL configured. The state might be inconclusive."},e.createElement(le.J,{name:"exclamation-triangle",size:"md",className:s.externalWarningIcon}))),e.createElement(b.Z.Figure,null,e.createElement("img",{src:"public/app/plugins/datasource/alertmanager/img/logo.svg",alt:"",height:"40px",width:"40px",style:{objectFit:"contain"}})),e.createElement(b.Z.Tags,null,l?e.createElement(k.C,{text:"Inactive",color:"red",tooltip:"Grafana is configured to send alerts to the built-in internal Alertmanager only. External Alertmanagers do not receive any alerts."}):e.createElement(k.C,{text:(0,j.capitalize)(d),color:d==="dropped"?"red":d==="active"?"green":"orange"})),e.createElement(b.Z.Meta,null,n),e.createElement(b.Z.Actions,null,e.createElement(O.Qj,{href:(0,oe.__)(g),size:"sm",variant:"secondary"},"Go to datasource")))}const q=a=>({muted:(0,c.css)`
    font-size: ${a.typography.bodySmall.fontSize};
    line-height: ${a.typography.bodySmall.lineHeight};
    color: ${a.colors.text.secondary};
  `,externalHeading:(0,c.css)`
    justify-content: flex-start;
  `,externalWarningIcon:(0,c.css)`
    margin: ${a.spacing(0,1)};
    fill: ${a.colors.warning.main};
  `,externalDs:(0,c.css)`
    display: grid;
    gap: ${a.spacing(1)};
    padding: ${a.spacing(2,0)};
  `,externalDsCTA:(0,c.css)`
    margin: ${a.spacing(2,0)};
  `}),ce=[{value:Q.TE.Internal,label:"Only Internal"},{value:Q.TE.External,label:"Only External"},{value:Q.TE.All,label:"Both internal and external"}],ge=()=>{const a=(0,E.wW)(me),l=(0,I.useDispatch)(),s=te(),{useSaveExternalAlertmanagersConfigMutation:g,useGetExternalAlertmanagerConfigQuery:d,useGetExternalAlertmanagersQuery:r}=W.alertmanagerApi,[n]=g(),{currentData:m}=d();r(void 0,{pollingInterval:5e3});const f=m?.alertmanagersChoice;(0,e.useEffect)(()=>{l((0,C.bZ)())},[l]);const u=i=>{n({alertmanagersChoice:i})};return e.createElement("div",null,e.createElement("h4",null,"External Alertmanagers"),e.createElement(x.b,{title:"External Alertmanager changes",severity:"info"},"The way you configure external Alertmanagers has changed.",e.createElement("br",null),"You can now use configured Alertmanager data sources as receivers of your Grafana-managed alerts.",e.createElement("br",null),"For more information, refer to our documentation."),e.createElement("div",{className:a.amChoice},e.createElement(B.g,{label:"Send alerts to",description:"Configures how the Grafana alert rule evaluation engine Alertmanager handles your alerts. Internal (Grafana built-in Alertmanager), External (All Alertmanagers configured below), or both."},e.createElement(z.S,{options:ce,value:f,onChange:i=>u(i)}))),e.createElement(se,{alertmanagers:s,inactive:f===Q.TE.Internal}))},me=a=>({url:(0,c.css)`
    margin-right: ${a.spacing(1)};
  `,actions:(0,c.css)`
    margin-top: ${a.spacing(2)};
    display: flex;
    justify-content: flex-end;
  `,table:(0,c.css)`
    margin-bottom: ${a.spacing(2)};
  `,amChoice:(0,c.css)`
    margin-bottom: ${a.spacing(4)};
  `});function ue(){return e.createElement(P.O,{pageId:"alerting-admin",accessType:"notification"},e.createElement(de,null))}function de(){const{selectedAlertmanager:a}=(0,U.ZA)(),l=a===y.GC;return e.createElement(e.Fragment,null,e.createElement(M,{"test-id":"admin-alertmanagerconfig"}),l&&e.createElement(ge,{"test-id":"admin-externalalertmanagers"}))}},39512:(w,T,t)=>{t.d(T,{J:()=>Z,O:()=>B});var e=t(85960),P=t(8134),c=t(20989),E=t(84954),x=t(66681),I=t(47257),V=t(84933),F=t(27436),U=t(76679);function L(o){return o.name===U.GC?"Grafana":o.name.slice(0,37)}const y=({disabled:o=!1})=>{const A=(0,I.wW)(Y),{selectedAlertmanager:h,availableAlertManagers:M,setSelectedAlertmanager:R}=(0,E.ZA)(),z=(0,e.useMemo)(()=>M.map(C=>({label:L(C),value:C.name,imgUrl:C.imgUrl,meta:C.meta})),[M]);return e.createElement(V._,{className:A.field,label:o?"Alertmanager":"Choose Alertmanager",disabled:o||z.length===1,"data-testid":"alertmanager-picker"},e.createElement(F.Ph,{"aria-label":o?"Alertmanager":"Choose Alertmanager",width:29,className:"ds-picker select-container",backspaceRemovesValue:!1,onChange:C=>{C?.value&&R(C.value)},options:z,maxMenuHeight:500,noOptionsMessage:"No datasources found",value:h,getOptionLabel:C=>C.label}))},Y=o=>({field:(0,x.css)`
    margin: 0;
  `});var J=t(49199);const H=()=>e.createElement(J.b,{title:"No Alertmanager found",severity:"warning"},"We could not find any external Alertmanagers and you may not have access to the built-in Grafana Alertmanager."),O=()=>e.createElement(J.b,{title:"Selected Alertmanager not found.",severity:"warning"},"The selected Alertmanager no longer exists or you may not have permission to access it. You can select a different Alertmanager from the dropdown."),W=({availableAlertManagers:o})=>{const A=o.length>0;return e.createElement("div",null,A?e.createElement(O,null):e.createElement(H,null))},Z=({children:o,pageId:A,pageNav:h,actions:M,isLoading:R})=>e.createElement(c.T,{pageNav:h,navId:A,actions:M},e.createElement(c.T.Contents,{isLoading:R},o)),B=({children:o,accessType:A,...h})=>{const M=K();return e.createElement(E.h5,{accessType:A},e.createElement(Z,{...h,actions:e.createElement(y,{disabled:M})},e.createElement(X,null,o)))};function K(){const o=(0,P.Z)();return["/edit","/new"].some(h=>o?.pathname?.includes(h))}const X=({children:o})=>{const{availableAlertManagers:A,selectedAlertmanager:h}=(0,E.ZA)();return h?e.createElement(e.Fragment,null,o):e.createElement(W,{availableAlertManagers:A})}},70335:(w,T,t)=>{t.d(T,{W:()=>P});var e=t(81828);function P(c,E){const x=e.alertmanagerApi.endpoints.getAlertmanagerConfiguration.useQuery(c??"",{...E,skip:!c});return{...x,error:x.error}}}}]);

//# sourceMappingURL=AlertingAdmin.c02807168729afdd7f87.js.map