"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7843],{33223:(ie,G,s)=>{s.d(G,{a:()=>j});var x=s(85960),w=s(66681),z=s(84933),k=s(6089),e=s(24956),N=s(15889),T=Object.defineProperty,h=Object.defineProperties,R=Object.getOwnPropertyDescriptors,I=Object.getOwnPropertySymbols,W=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable,$=(M,D,B)=>D in M?T(M,D,{enumerable:!0,configurable:!0,writable:!0,value:B}):M[D]=B,E=(M,D)=>{for(var B in D||(D={}))W.call(D,B)&&$(M,B,D[B]);if(I)for(var B of I(D))K.call(D,B)&&$(M,B,D[B]);return M},Q=(M,D)=>h(M,R(D));const j=({config:M,onChange:D,className:B})=>{const ve=ce=>{D(Q(E({},M),{jsonData:Q(E({},M.jsonData),{keepCookies:ce})}))},me=ce=>{D(Q(E({},M),{jsonData:Q(E({},M.jsonData),{timeout:parseInt(ce.currentTarget.value,10)})}))},Z={container:(0,w.css)({maxWidth:578})};return x.createElement(N._,{title:"Advanced HTTP settings",className:(0,w.cx)(Z.container,B)},x.createElement(z._,{htmlFor:"advanced-http-cookies",label:"Allowed cookies",labelWidth:24,tooltip:"Grafana proxy deletes forwarded cookies by default. Specify cookies by name that should be forwarded to the data source.",disabled:M.readOnly,grow:!0},x.createElement(k.B,{id:"advanced-http-cookies",placeholder:"New cookie (hit enter to add)",tags:M.jsonData.keepCookies,onChange:ve})),x.createElement(z._,{htmlFor:"advanced-http-timeout",label:"Timeout",labelWidth:24,tooltip:"HTTP request timeout in seconds",disabled:M.readOnly,grow:!0},x.createElement(e.I,{id:"advanced-http-timeout",type:"number",min:0,placeholder:"Timeout in seconds","aria-label":"Timeout in seconds",value:M.jsonData.timeout,onChange:me})))}},76581:(ie,G,s)=>{s.d(G,{i:()=>k});var x=s(66681),w=s(85960),z=s(47257);const k=({hideLine:N=!1})=>{const T=(0,z.wW)(e);return N?w.createElement("hr",{className:T.dividerHideLine}):w.createElement("hr",{className:T.divider})},e=N=>({divider:(0,x.css)({margin:N.spacing(4,0)}),dividerHideLine:(0,x.css)({border:"none",margin:N.spacing(3,0)})})},20691:(ie,G,s)=>{s.d(G,{n:()=>N});var x=s(85960),w=s(49289);const z=x.lazy(()=>Promise.all([s.e(4639),s.e(7142)]).then(s.bind(s,23685))),k=T=>x.createElement(x.Suspense,{fallback:null},x.createElement(z,{...T})),e=T=>{const h=(0,x.useRef)(null),{onRunQuery:R,onChange:I,...W}=T,K=E=>{h.current=E,I(E),R()},$=E=>{I(E)};return x.createElement(k,{onRunQuery:K,onBlur:$,onChange:I,...W})};class N extends x.PureComponent{constructor(h){super(h),this._isMounted=!1,this.onChangeQuery=(R,I)=>{const{query:W,onChange:K,onRunQuery:$}=this.props;if(K){const E={...W,expr:R};K(E),I&&$&&$()}},this.state={labelsLoaded:!1}}async componentDidMount(){this._isMounted=!0,await this.props.datasource.languageProvider.start(this.props.range),this._isMounted&&this.setState({labelsLoaded:!0})}componentWillUnmount(){this._isMounted=!1}componentDidUpdate(h){const{range:R,datasource:{languageProvider:I}}=this.props;(0,w.rf)(R,h.range)&&I.fetchLabels({timeRange:R})}render(){const{ExtraFieldElement:h,query:R,datasource:I,history:W,onRunQuery:K,range:$}=this.props,E=this.props.placeholder??"Enter a Loki query (run with Shift+Enter)";return x.createElement(x.Fragment,null,x.createElement("div",{className:"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1","data-testid":this.props["data-testid"]},x.createElement("div",{className:"gf-form--grow flex-shrink-1 min-width-15"},x.createElement(e,{datasource:I,history:W??[],onChange:this.onChangeQuery,onRunQuery:K,initialValue:R.expr??"",placeholder:E,timeRange:$}))),h)}}},49289:(ie,G,s)=>{s.d(G,{Hk:()=>I,U9:()=>T,_z:()=>W,aC:()=>K,iS:()=>h,k:()=>$,rf:()=>k,tU:()=>R});var x=s(60134);function w(E){return z(E/1e3)}function z(E){return Math.floor(E/60)}function k(E,Q){if(E&&Q){const j=w(E.from.valueOf())===w(Q.from.valueOf()),M=w(E.to.valueOf())===w(Q.to.valueOf());return!(j&&M)}return!1}const e=/[*+?()|\\.\[\]{}^$]/g;function N(E){return E.replace(e,"\\$&")}function T(E){return E.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/"/g,'\\"')}function h(E){return E.replace(/\\n/g,`
`).replace(/\\"/g,'"').replace(/\\\\/g,"\\")}function R(E){return T(N(E))}function I(E,Q){return W(Q)?R(E):T(E)}function W(E){return!!(E&&(E.includes("=~")||E.includes("!~")))}function K(E){const Q=["b","kib","Kib","kb","KB","mib","Mib","mb","MB","gib","Gib","gb","GB","tib","Tib","tb","TB","pib","Pib","pb","PB","eib","Eib","eb","EB"],j=new RegExp(`^(?:-?\\d+(?:\\.\\d+)?)(?:${Q.join("|")})$`);return!!E.match(j)}function $(E,Q,j){if(!Q||j===void 0)return null;const M=Q.fields.find(D=>D.name==="labelTypes")?.values[j];if(!M)return null;switch(M[E]){case"I":return x.JG.Indexed;case"S":return x.JG.StructuredMetadata;case"P":return x.JG.Parsed;default:return null}}},47843:(ie,G,s)=>{s.r(G),s.d(G,{plugin:()=>Ua});var x=s(41466),w=s(43471),z=s(2384),k=s(56375),e=s(85960),N=s(43183),T=s(49289);const h=['{job="default/prometheus"}'],R=["job","app","k8s_app"],I=5,W=[{title:"Log pipeline",expression:'{job="mysql"} |= "metrics" | logfmt | duration > 10s',label:'This query targets the MySQL job, keeps logs that contain the substring "metrics", and then parses and filters the logs further.'},{title:"Count over time",expression:'count_over_time({job="mysql"}[5m])',label:"This query counts all the log lines within the last five minutes for the MySQL job."},{title:"Rate",expression:'rate(({job="mysql"} |= "error" != "timeout")[10s])',label:"This query gets the per-second rate of all non-timeout errors within the last ten seconds for the MySQL job."},{title:"Aggregate, count, and group",expression:'sum(count_over_time({job="mysql"}[5m])) by (level)',label:"Get the count of logs during the last five minutes, grouping by level."}];class K extends e.PureComponent{constructor(){super(...arguments),this.state={userExamples:[]},this.checkUserLabels=async()=>{const t=this.props.datasource?.languageProvider;if(t.started){const n=t.getLabelKeys()||[],l=R.find(r=>n.includes(r));if(l){const r=await t.fetchLabelValues(l),o=(0,k.shuffle)(r).slice(0,I).map(u=>`{${l}="${(0,T.U9)(u)}"}`);this.setState({userExamples:o})}}else this.scheduleUserLabelChecking()}}componentDidMount(){this.scheduleUserLabelChecking(),(0,N.ff)("grafana_loki_cheatsheet_opened",{})}componentWillUnmount(){clearTimeout(this.userLabelTimer)}scheduleUserLabelChecking(){this.userLabelTimer=setTimeout(this.checkUserLabels,1e3)}renderExpression(t){const{onClickExample:n}=this.props,l=r=>{n(r),(0,N.ff)("grafana_loki_cheatsheet_example_clicked",{})};return e.createElement("button",{type:"button",className:"cheat-sheet-item__example",key:t,onClick:()=>l({refId:"A",expr:t})},e.createElement("code",null,t))}render(){const{userExamples:t}=this.state,n=t.length>0;return e.createElement("div",null,e.createElement("h2",null,"Loki Cheat Sheet"),e.createElement("div",{className:"cheat-sheet-item"},e.createElement("div",{className:"cheat-sheet-item__title"},"See your logs"),e.createElement("div",{className:"cheat-sheet-item__label"},"Start by selecting a log stream from the Label browser, or alternatively you can write a stream selector into the query field."),n?e.createElement("div",null,e.createElement("div",{className:"cheat-sheet-item__label"},"Here are some example streams from your logs:"),t.map(l=>this.renderExpression(l))):e.createElement("div",null,e.createElement("div",{className:"cheat-sheet-item__label"},"Here is an example of a log stream:"),this.renderExpression(h[0]))),e.createElement("div",{className:"cheat-sheet-item"},e.createElement("div",{className:"cheat-sheet-item__title"},"Combine stream selectors"),this.renderExpression('{app="cassandra",namespace="prod"}'),e.createElement("div",{className:"cheat-sheet-item__label"},"Returns all log lines from streams that have both labels.")),e.createElement("div",{className:"cheat-sheet-item"},e.createElement("div",{className:"cheat-sheet-item__title"},"Filtering for search terms."),this.renderExpression('{app="cassandra"} |~ "(duration|latency)s*(=|is|of)s*[d.]+"'),this.renderExpression('{app="cassandra"} |= "exact match"'),this.renderExpression('{app="cassandra"} != "do not match"'),e.createElement("div",{className:"cheat-sheet-item__label"},e.createElement("a",{href:"https://grafana.com/docs/loki/latest/logql/#log-pipeline",target:"logql"},"LogQL")," ","supports exact and regular expression filters.")),W.map(l=>e.createElement("div",{className:"cheat-sheet-item",key:l.expression},e.createElement("div",{className:"cheat-sheet-item__title"},l.title),this.renderExpression(l.expression),e.createElement("div",{className:"cheat-sheet-item__label"},l.label))))}}var $=s(81223),E=s(69690),Q=s(23757),j=s(92369),M=s(86755),D=s(7442),B=s(53628),ve=s(98181),me=s(23270),Z=s(90857),ce=s(77980),U=s(29165),rt=s(65607),ot=s(69217),_=s(33485),Fe=s(36867),f=s(66681),J=s(47257),we=s(7288),Ie=s(79468),it=s(52248),ct=s(403),ut=s(15820),ge=s(57445),Ee=s(11389),ne=s(24956),Re=s(74042);const ye=1e3,be=1e4,dt=4,Le="{}";function Y(a){const t=[];for(const n of a)if(n.selected&&n.values&&n.values.length>0){const l=n.values.filter(r=>r.selected).map(r=>r.name);l.length>1?t.push(`${n.name}=~"${l.map(T.tU).join("|")}"`):l.length===1&&t.push(`${n.name}="${(0,T.U9)(l[0])}"`)}return["{",t.join(","),"}"].join("")}function mt(a,t,n){return a.map(l=>{const r=t[l.name];if(r){let o;if(l.name===n&&l.values)o=l.values;else{const u=new Set(l.values?.filter(i=>i.selected).map(i=>i.name)||[]);o=r.map(i=>({name:i,selected:u.has(i)}))}return{...l,loading:!1,values:o,facets:o.length}}return{...l,loading:!1,hidden:!r,values:void 0,facets:0}})}const gt=a=>({wrapper:(0,f.css)`
    background-color: ${a.colors.background.secondary};
    width: 100%;
  `,wrapperPadding:(0,f.css)`
    padding: ${a.spacing(2)};
  `,list:(0,f.css)`
    margin-top: ${a.spacing(1)};
    display: flex;
    flex-wrap: wrap;
    max-height: 200px;
    overflow: auto;
  `,section:(0,f.css)`
    & + & {
      margin: ${a.spacing(2,0)};
    }

    position: relative;
  `,footerSectionStyles:(0,f.css)`
    padding: ${a.spacing(1)};
    background-color: ${a.colors.background.primary};
    position: sticky;
    bottom: -${a.spacing(3)}; /* offset the padding on modal */
    left: 0;
  `,selector:(0,f.css)`
    font-family: ${a.typography.fontFamilyMonospace};
    margin-bottom: ${a.spacing(1)};
    width: 100%;
  `,status:(0,f.css)`
    margin-bottom: ${a.spacing(1)};
    color: ${a.colors.text.secondary};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: opacity 100ms linear;
    opacity: 0;
    font-size: ${a.typography.bodySmall.fontSize};
    height: calc(${a.typography.bodySmall.fontSize} + 10px);
  `,statusShowing:(0,f.css)`
    opacity: 1;
  `,error:(0,f.css)`
    color: ${a.colors.error.main};
  `,valueList:(0,f.css)`
    margin-right: ${a.spacing(1)};
    resize: horizontal;
  `,valueListWrapper:(0,f.css)`
    border-left: 1px solid ${a.colors.border.medium};
    margin: ${a.spacing(1,0)};
    padding: ${a.spacing(1,0,1,1)};
  `,valueListArea:(0,f.css)`
    display: flex;
    flex-wrap: wrap;
    margin-top: ${a.spacing(1)};
  `,valueTitle:(0,f.css)`
    margin-left: -${a.spacing(.5)};
    margin-bottom: ${a.spacing(1)};
  `,validationStatus:(0,f.css)`
    padding: ${a.spacing(.5)};
    margin-bottom: ${a.spacing(1)};
    color: ${a.colors.text.maxContrast};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  `});class pt extends e.Component{constructor(){super(...arguments),this.state={labels:[],searchTerm:"",status:"Ready",error:"",validationStatus:""},this.onChangeSearch=t=>{this.setState({searchTerm:t.target.value})},this.onClickRunLogsQuery=()=>{(0,N.ff)("grafana_loki_label_browser_closed",{app:this.props.app,closeType:"showLogsButton"});const t=Y(this.state.labels);this.props.onChange(t)},this.onClickRunMetricsQuery=()=>{(0,N.ff)("grafana_loki_label_browser_closed",{app:this.props.app,closeType:"showLogsRateButton"});const n=`rate(${Y(this.state.labels)}[$__auto])`;this.props.onChange(n)},this.onClickClear=()=>{this.setState(t=>({labels:t.labels.map(l=>({...l,values:void 0,selected:!1,loading:!1,hidden:!1,facets:void 0})),searchTerm:"",status:"",error:"",validationStatus:""})),this.props.deleteLastUsedLabels()},this.onClickLabel=(t,n,l)=>{const r=this.state.labels.find(i=>i.name===t);if(!r)return;const o=!r.selected;let u={selected:o};if(r.values&&!o){const i=r.values.map(c=>({...c,selected:!1}));u={...u,facets:0,values:i}}this.setState({searchTerm:""}),this.updateLabelState(t,u,"",()=>this.doFacettingForLabel(t))},this.onClickValue=(t,n,l)=>{const r=this.state.labels.find(u=>u.name===t);if(!r||!r.values)return;this.setState({searchTerm:""});const o=r.values.map(u=>({...u,selected:u.name===n?!u.selected:u.selected}));this.updateLabelState(t,{values:o},"",()=>this.doFacetting(t))},this.onClickValidate=()=>{const t=Y(this.state.labels);this.validateSelector(t)},this.doFacetting=t=>{const n=Y(this.state.labels);if(n===Le){const l=this.state.labels.map(r=>({...r,facets:0,values:void 0,hidden:!1}));this.setState({labels:l},()=>{this.state.labels.forEach(r=>r.selected&&this.fetchValues(r.name,n))})}else this.fetchSeries(n,t)}}updateLabelState(t,n,l="",r){this.setState(o=>{const u=o.labels.map(c=>c.name===t?{...c,...n}:c),i=l?"":o.error;return{labels:u,status:l,error:i,validationStatus:""}},r)}componentDidMount(){const{languageProvider:t,autoSelect:n=dt,lastUsedLabels:l,timeRange:r}=this.props;if(t){const o=l;t.start(r).then(()=>{let u=t.getLabelKeys();if(u.length>ye){const c=`Too many labels found (showing only ${ye} of ${u.length})`;u=u.slice(0,ye),this.setState({error:c})}const i=u.map((c,g,v)=>({name:c,selected:v.length<=n&&o.length===0||o.includes(c),loading:!1}));this.setState({labels:i},()=>{this.state.labels.forEach(c=>{c.selected&&this.fetchValues(c.name,Le)})})})}}doFacettingForLabel(t){const n=this.state.labels.find(r=>r.name===t);if(!n)return;const l=this.state.labels.filter(r=>r.selected).map(r=>r.name);this.props.storeLastUsedLabels(l),n.selected?n.values||this.fetchValues(t,Y(this.state.labels)):this.doFacetting()}async fetchValues(t,n){const{languageProvider:l,timeRange:r}=this.props;this.updateLabelState(t,{loading:!0},`Fetching values for ${t}`);try{let o=await l.fetchLabelValues(t,{timeRange:r});if(n!==Y(this.state.labels)){this.updateLabelState(t,{loading:!1},"");return}if(o.length>be){const i=`Too many values for ${t} (showing only ${be} of ${o.length})`;o=o.slice(0,be),this.setState({error:i})}const u=o.map(i=>({name:i}));this.updateLabelState(t,{values:u,loading:!1})}catch(o){console.error(o)}}async fetchSeries(t,n){const{languageProvider:l,timeRange:r}=this.props;n&&this.updateLabelState(n,{loading:!0},`Loading labels for ${t}`);try{const o=await l.fetchSeriesLabels(t,{timeRange:r});if(t!==Y(this.state.labels)){n&&this.updateLabelState(n,{loading:!1});return}if(Object.keys(o).length===0){this.setState({error:`Empty results, no matching label for ${t}`});return}const u=mt(this.state.labels,o,n);this.setState({labels:u,error:""}),n&&this.updateLabelState(n,{loading:!1})}catch(o){console.error(o)}}async validateSelector(t){const{languageProvider:n,timeRange:l}=this.props;this.setState({validationStatus:`Validating selector ${t}`,error:""});const r=await n.fetchSeries(t,{timeRange:l});this.setState({validationStatus:`Selector is valid (${r.length} streams found)`})}render(){const{theme:t}=this.props,{labels:n,searchTerm:l,status:r,error:o,validationStatus:u}=this.state;if(n.length===0)return e.createElement(Ie.u,{text:"Loading labels..."});const i=gt(t),c=Y(this.state.labels),g=c===Le;let v=n.filter(d=>d.selected&&d.values);return l?v=v.map(d=>{const L=d.values.filter(C=>{if(C.selected)return C.highlightParts=void 0,!0;const P=(0,ut.C)(C.name.toLowerCase(),l.toLowerCase());return P.found?(C.highlightParts=P.ranges,C.order=P.distance,!0):!1});return{...d,values:(0,k.sortBy)(L,C=>C.selected?-1/0:C.order)}}):v=this.state.labels.filter(d=>d.selected&&d.values).map(d=>({...d,values:d?.values?d.values.map(L=>({...L,highlightParts:void 0})):[]})),e.createElement(e.Fragment,null,e.createElement("div",{className:i.wrapper},e.createElement("div",{className:(0,f.cx)(i.section,i.wrapperPadding)},e.createElement(ge._,{description:"Which labels would you like to consider for your search?"},"1. Select labels to search in"),e.createElement("div",{className:i.list},n.map(d=>e.createElement(Ee._,{key:d.name,name:d.name,loading:d.loading,active:d.selected,hidden:d.hidden,facets:d.facets,onClick:this.onClickLabel})))),e.createElement("div",{className:(0,f.cx)(i.section,i.wrapperPadding)},e.createElement(ge._,{description:"Choose the label values that you would like to use for the query. Use the search field to find values across selected labels."},"2. Find values for the selected labels"),e.createElement("div",null,e.createElement(ne.I,{onChange:this.onChangeSearch,"aria-label":"Filter expression for values",value:l,placeholder:"Enter a label value"})),e.createElement("div",{className:i.valueListArea},v.map(d=>e.createElement("div",{role:"list",key:d.name,className:i.valueListWrapper},e.createElement("div",{className:i.valueTitle,"aria-label":`Values for ${d.name}`},e.createElement(Ee._,{name:d.name,loading:d.loading,active:d.selected,hidden:d.hidden,facets:d.facets||d.values?.length,onClick:this.onClickLabel})),e.createElement(ct.t7,{height:200,itemCount:d.values?.length||0,itemSize:28,itemKey:L=>d.values?.[L].name??L,width:200,className:i.valueList},({index:L,style:C})=>{const P=d.values?.[L];return P?e.createElement("div",{style:C},e.createElement(Ee._,{name:d.name,value:P?.name,active:P?.selected,highlightParts:P?.highlightParts,onClick:this.onClickValue,searchTerm:l})):null})))))),e.createElement("div",{className:i.footerSectionStyles},e.createElement(ge._,null,"3. Resulting selector"),e.createElement("pre",{"aria-label":"selector",className:i.selector},c),u&&e.createElement("div",{className:i.validationStatus},u),e.createElement("div",{className:(0,f.cx)(i.status,(r||o)&&i.statusShowing)},e.createElement("span",{className:o?i.error:""},o||r)),e.createElement(Re.Lh,null,e.createElement(U.zx,{"aria-label":"Use selector as logs button",disabled:g,onClick:this.onClickRunLogsQuery},"Show logs"),e.createElement(U.zx,{"aria-label":"Use selector as metrics button",variant:"secondary",disabled:g,onClick:this.onClickRunMetricsQuery},"Show logs rate"),e.createElement(U.zx,{"aria-label":"Validate submit button",variant:"secondary",disabled:g,onClick:this.onClickValidate},"Validate selector"),e.createElement(U.zx,{"aria-label":"Selector clear button",variant:"secondary",onClick:this.onClickClear},"Clear"))))}}const ht=(0,J.HE)(pt),ft=a=>{const{isOpen:t,onClose:n,datasource:l,app:r,timeRange:o}=a,[u,i]=(0,e.useState)(!1),[c,g]=(0,e.useState)(!1),v="grafana.datasources.loki.browser.labels",d=(0,J.wW)(vt);(0,e.useEffect)(()=>{t&&l.languageProvider.fetchLabels({timeRange:o}).then(y=>{i(!0),g(y.length>0)})},[l,t,o]);const L=y=>{const{query:p,onChange:m,onRunQuery:S}=a,F={...p,expr:y};m(F),S()},C=y=>{L(y),n()},P=()=>{(0,N.ff)("grafana_loki_label_browser_closed",{app:r,closeType:"modalClose"}),n()};return e.createElement(we.u,{isOpen:t,title:"Label browser",onDismiss:P,className:d.modal},!u&&e.createElement(Ie.u,{text:"Loading labels..."}),u&&!c&&e.createElement("p",null,"No labels found."),u&&c&&e.createElement(it.G,{storageKey:v,defaultValue:[]},(y,p,m)=>e.createElement(ht,{languageProvider:l.languageProvider,onChange:C,lastUsedLabels:y,storeLastUsedLabels:p,deleteLastUsedLabels:m,app:r,timeRange:o})))},vt=a=>({modal:(0,f.css)`
      width: 85vw;
      ${a.breakpoints.down("md")} {
        width: 100%;
      }
    `});var Et=s(20079),A=s(36451),ee=s(97986),yt=s(9833),Se=s(82564),$e=s(33614),te=s(73688),bt=s(25673),se=s(11248),Lt=s(70613),St=s(37890),le=s(84933),ae=s(27436),re=s(14061),xt=s(80988);function Ct({item:a,items:t,defaultOp:n,onChange:l,onDelete:r,onGetLabelNames:o,onGetLabelValues:u,invalidLabel:i,invalidValue:c}){const[g,v]=(0,e.useState)({}),[d,L]=(0,e.useState)(!1),[C,P]=(0,e.useState)(!1),y="You have conflicting label filters",p=(b=a.op)=>Be.find(q=>q.label===b)?.isMultiValue,m=b=>b?b.indexOf("|")>0?b.split("|"):[b]:[],S=()=>{const b=g.labelValues?[...g.labelValues]:[],q=m(a?.value).map(se.E);return(0,k.uniqBy)([...q,...b],"value")},F=(0,xt.Zc)(a,t);return e.createElement("div",{"data-testid":"prometheus-dimensions-filter-item"},e.createElement(le._,{error:y,invalid:F?!0:void 0},e.createElement(Lt.B,null,e.createElement(ae.Ph,{placeholder:"Select label","aria-label":j.wl.components.QueryBuilder.labelSelect,inputId:"prometheus-dimensions-filter-item-key",width:"auto",value:a.label?(0,se.E)(a.label):null,allowCustomValue:!0,onOpenMenu:async()=>{v({isLoadingLabelNames:!0});const b=await o(a);L(!0),v({labelNames:b,isLoadingLabelNames:void 0})},onCloseMenu:()=>{L(!1)},isOpen:d,isLoading:g.isLoadingLabelNames,options:g.labelNames,onChange:b=>{b.label&&l({...a,op:a.op??n,label:b.label})},invalid:F||i}),e.createElement(ae.Ph,{"aria-label":j.wl.components.QueryBuilder.matchOperatorSelect,value:(0,se.E)(a.op??n),options:Be,width:"auto",onChange:b=>{b.value!=null&&l({...a,op:b.value,value:p(b.value)?a.value:m(a?.value)[0]})},invalid:F}),e.createElement(ae.Ph,{placeholder:"Select value","aria-label":j.wl.components.QueryBuilder.valueSelect,inputId:"prometheus-dimensions-filter-item-value",width:"auto",value:p()?m(a?.value).map(se.E):m(a?.value).map(se.E)[0],allowCustomValue:!0,onOpenMenu:async()=>{v({isLoadingLabelValues:!0});const b=await u(a);v({...g,labelValues:b,isLoadingLabelValues:void 0}),P(!0)},onCloseMenu:()=>{P(!1)},isOpen:C,isMulti:p(),isLoading:g.isLoadingLabelValues,options:S(),onChange:b=>{if(b.value)l({...a,value:b.value,op:a.op??n});else{const q=b.map(H=>H.label).join("|");l({...a,value:q,op:a.op??n})}},invalid:F||c}),e.createElement(St._,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:r}))))}const Be=[re.AI.equals,re.AI.doesNotEqual,re.AI.matchesRegex,re.AI.doesNotMatchRegex],Mt="Select at least 1 label filter (label and value)";function Nt({labelsFilters:a,onChange:t,onGetLabelNames:n,onGetLabelValues:l,labelFilterRequired:r}){const o="=",[u,i]=(0,e.useState)([{op:o}]);(0,e.useEffect)(()=>{a.length>0?i(a):i([{op:o}])},[a]);const c=v=>{i(v);const d=v.filter(L=>L.label!=null&&L.value!=null);(0,k.isEqual)(d,a)||t(d)},g=u.some(v=>v.label&&v.value);return e.createElement($e.s,null,e.createElement(te.S,{label:"Label filters",error:Mt,invalid:r&&!g},e.createElement(bt.k,{items:u,onChange:c,renderItem:(v,d,L)=>e.createElement(Ct,{item:v,items:u,defaultOp:o,onChange:d,onDelete:L,onGetLabelNames:n,onGetLabelValues:l,invalidLabel:r&&!v.label,invalidValue:r&&!v.value})})))}var Ue=s(88556),Pt=s(59694),Ae=s(99149),Ot=s(36796),Tt=s(42763),pe=s(16972),he=s(35055),Ve=s(13086);const ze="Fetch all log lines matching label filters.",We=e.memo(({query:a})=>{const t=(0,ee._z)(a||"").query,n={grammar:he.xY,name:"lokiql"};return e.createElement(Ve.K,{gap:0,direction:"column"},e.createElement(Ue.B,{stepNumber:1,title:e.createElement(pe.U,{query:`${A.y.renderLabels(t.labels)}`,lang:n})},ze),e.createElement(Ae.V,{stepNumber:2,queryModeller:A.y,query:t,lang:n}))});We.displayName="LokiQueryBuilderExplained";var ue=s(15910),je=s(75064),Dt=s(42424);const Ge=e.memo(({nestedQuery:a,index:t,datasource:n,onChange:l,onRemove:r,onRunQuery:o,showExplain:u})=>{const i=(0,J.wW)(kt);return e.createElement("div",{className:i.card},e.createElement("div",{className:i.header},e.createElement("div",{className:i.name},"Operator"),e.createElement(ae.Ph,{"aria-label":"Select operator",width:"auto",options:Qt,value:(0,se.E)(a.operator),onChange:c=>{l(t,{...a,operator:c.value})}}),e.createElement("div",{className:i.name},"Vector matches"),e.createElement("div",{className:i.vectorMatchWrapper},e.createElement(ae.Ph,{width:"auto",value:a.vectorMatchesType||"on",allowCustomValue:!0,options:[{value:"on",label:"on"},{value:"ignoring",label:"ignoring"}],onChange:c=>{l(t,{...a,vectorMatchesType:c.value})}}),e.createElement(ue.H,{className:i.vectorMatchInput,minWidth:20,defaultValue:a.vectorMatches,onCommitChange:c=>{l(t,{...a,vectorMatches:c.currentTarget.value,vectorMatchesType:a.vectorMatchesType||"on"})}})),e.createElement(B.B,{grow:1}),e.createElement(je.h,{name:"times",size:"sm",onClick:()=>r(t),tooltip:"Remove nested query"})),e.createElement("div",{className:i.body},e.createElement(me._,null,e.createElement(xe,{showExplain:u,query:a.query,datasource:n,onRunQuery:o,onChange:c=>{l(t,{...a,query:c})}}))))}),Qt=Dt.i.map(a=>({label:a.sign,value:a.sign}));Ge.displayName="NestedQuery";const kt=a=>({card:(0,f.css)({label:"card",display:"flex",flexDirection:"column",gap:a.spacing(.5)}),header:(0,f.css)({label:"header",padding:a.spacing(.5,.5,.5,1),gap:a.spacing(1),display:"flex",alignItems:"center"}),name:(0,f.css)({label:"name",whiteSpace:"nowrap"}),body:(0,f.css)({label:"body",paddingLeft:a.spacing(2)}),vectorMatchInput:(0,f.css)({label:"vectorMatchInput",marginLeft:-1}),vectorMatchWrapper:(0,f.css)({label:"vectorMatchWrapper",display:"flex"})});function Ft({query:a,datasource:t,onChange:n,onRunQuery:l,showExplain:r}){const o=a.binaryQueries??[],u=(c,g)=>{const v=[...o];v.splice(c,1,g),n({...a,binaryQueries:v})},i=c=>{const g=[...o.slice(0,c),...o.slice(c+1)];n({...a,binaryQueries:g})};return e.createElement(Ve.K,{direction:"column",gap:1},o.map((c,g)=>e.createElement(Ge,{key:g.toString(),nestedQuery:c,index:g,onChange:u,datasource:t,onRemove:i,onRunQuery:l,showExplain:r})))}const xe=e.memo(({datasource:a,query:t,onChange:n,onRunQuery:l,showExplain:r,timeRange:o})=>{const[u,i]=(0,e.useState)(),[c,g]=(0,e.useState)(void 0),v=p=>{n({...t,labels:p})},d=async p=>{const m=await p;return[...a.getVariables(),...m].map(S=>({label:S,value:S}))},L=async p=>{const m=t.labels.filter(H=>H!==p);if(m.length===0)return await a.languageProvider.fetchLabels({timeRange:o});const S=A.y.renderLabels(m),F=await a.languageProvider.fetchSeriesLabels(S,{timeRange:o}),b=m.map(H=>H.label);return Object.keys(F).filter(H=>!b.includes(H)).sort()},C=async p=>{if(!p.label)return[];let m;const S=t.labels.filter(F=>F!==p);if(S.length===0)m=await a.languageProvider.fetchLabelValues(p.label,{timeRange:o});else{const F=A.y.renderLabels(S);m=(await a.languageProvider.fetchSeriesLabels(F))[a.interpolateString(p.label)]}return m?m.map(F=>(0,T.Hk)(F,p.op)):[]},P=(0,e.useMemo)(()=>{const{labels:p,operations:m}=t;return!p.length&&m.length?!(m.length===1&&m[0].id===re.B5.LineContains&&m[0].params[0]===""):!1},[t]);(0,e.useEffect)(()=>{(async()=>{const m={expr:A.y.renderQuery(t),refId:"data-samples"},S=o??(0,yt.JK)(),b={series:await a.getDataSamples(m,S),state:Q.Gu.Done,timeRange:S};i(b)})().catch(console.error)},[a,t,o]);const y={grammar:he.ZP,name:"logql"};return e.createElement("div",{"data-testid":Ne.editor},e.createElement(Se.p,null,e.createElement(Nt,{onGetLabelNames:p=>d(L(p)),onGetLabelValues:p=>d(C(p)),labelsFilters:t.labels,onChange:v,labelFilterRequired:P})),r&&e.createElement(Ue.B,{stepNumber:1,title:e.createElement(pe.U,{query:`${A.y.renderLabels(t.labels)}`,lang:y})},ze),e.createElement(Ot.B,null,e.createElement(Pt.P,{queryModeller:A.y,query:t,onChange:n,onRunQuery:l,datasource:a,highlightedOp:c}),e.createElement(Tt.L,{datasource:a,query:t,onChange:n,data:u,queryModeller:A.y,buildVisualQueryFromString:ee._z})),r&&e.createElement(Ae.V,{stepNumber:2,queryModeller:A.y,query:t,lang:y,onMouseEnter:p=>{g(p)},onMouseLeave:()=>{g(void 0)}}),t.binaryQueries&&t.binaryQueries.length>0&&e.createElement(Ft,{query:t,datasource:a,onChange:n,onRunQuery:l,showExplain:r}))});xe.displayName="LokiQueryBuilder";function wt({query:a}){return e.createElement(Se.p,null,e.createElement($e.s,null,e.createElement(pe.U,{query:a,lang:{grammar:he.xY,name:"lokiql"}})))}function It(a){const{query:t,onChange:n,onRunQuery:l,datasource:r,showExplain:o,timeRange:u}=a,[i,c]=(0,e.useReducer)(Ke.reducer,{expr:t.expr,visQuery:t.expr===""?{labels:[],operations:[{id:"__line_contains",params:[""]}]}:void 0});(0,e.useEffect)(()=>{c(Bt(t.expr))},[t.expr]);const g=v=>{const d=A.y.renderQuery(v);c($t({visQuery:v,expr:d})),n({...a.query,expr:d})};return i.visQuery?e.createElement(e.Fragment,null,e.createElement(xe,{query:i.visQuery,datasource:r,onChange:g,onRunQuery:l,showExplain:o,"data-testid":Ne.editor,timeRange:u}),t.expr!==""&&e.createElement(wt,{query:t.expr})):null}const Rt={expr:""},Ke=(0,Et.oM)({name:"loki-builder-container",initialState:Rt,reducers:{visualQueryChange:(a,t)=>{a.expr=t.payload.expr,a.visQuery=t.payload.visQuery},exprChanged:(a,t)=>{if(!a.visQuery||a.expr!==t.payload){a.expr=t.payload;const n=(0,ee._z)(t.payload);a.visQuery=n.query}}}}),{visualQueryChange:$t,exprChanged:Bt}=Ke.actions;var He=s(18678),Ut=s(5106),At=s(49199),Vt=s(15880),de=s(96965),Ce=s(4639);const Ze=e.memo(({app:a,query:t,onChange:n,onRunQuery:l,maxLines:r,queryStats:o})=>{const[u,i]=(0,e.useState)(!0),c=m=>{n({...t,queryType:m}),l()},g=m=>{(0,N.ff)("grafana_loki_resolution_clicked",{app:a,resolution:m.value}),n({...t,resolution:m.value}),l()},v=m=>{const S=m.currentTarget.value;if(!(0,He.jO)(S)){i(!1);return}i(!0),n({...t,splitDuration:S}),l()},d=m=>{n({...t,legendFormat:m.currentTarget.value}),l()};function L(m){const S=(0,de.Wz)(m.currentTarget.value);t.maxLines!==S&&(n({...t,maxLines:S}),l())}function C(m){n({...t,step:(0,k.trim)(m.currentTarget.value)}),l()}const P=(0,Ce.Lw)(t),y=(0,Ce.rE)(t.expr),p=(0,e.useMemo)(()=>!!(!t.step||(0,He.fI)(t.step)||!isNaN(Number(t.step))),[t.step]);return e.createElement(Se.p,null,e.createElement(Vt.d,{title:"Options",collapsedInfo:zt(t,P,r,y,p),queryStats:o},e.createElement(te.S,{label:"Legend",tooltip:"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname."},e.createElement(ue.H,{placeholder:"{{label}}",type:"string",minWidth:14,defaultValue:t.legendFormat,onCommitChange:d})),e.createElement(te.S,{label:"Type"},e.createElement(Ut.S,{options:de.uG,value:P,onChange:c})),y&&e.createElement(te.S,{label:"Line limit",tooltip:"Upper limit for number of log lines returned by query."},e.createElement(ue.H,{className:"width-4",placeholder:r.toString(),type:"number",min:0,defaultValue:t.maxLines?.toString()??"",onCommitChange:L})),!y&&e.createElement(e.Fragment,null,e.createElement(te.S,{label:"Step",tooltip:"Use the step parameter when making metric queries to Loki. If not filled, Grafana's calculated interval will be used. Example valid values: 1s, 5m, 10h, 1d.",invalid:!p,error:"Invalid step. Example valid values: 1s, 5m, 10h, 1d."},e.createElement(ue.H,{className:"width-6",placeholder:"auto",type:"string",defaultValue:t.step??"",onCommitChange:C})),t.resolution!==void 0&&t.resolution>1&&e.createElement(e.Fragment,null,e.createElement(te.S,{label:"Resolution",tooltip:"Changes the step parameter of Loki metrics range queries. With a resolution of 1/1, each pixel corresponds to one data point. 1/10 retrieves one data point per 10 pixels. Lower resolutions perform better."},e.createElement(ae.Ph,{isSearchable:!1,onChange:g,options:de.oZ,value:t.resolution||1,"aria-label":"Select resolution"})),e.createElement(At.b,{severity:"warning",title:"The 'Resolution' is deprecated. Use 'Step' editor instead to change step parameter."}))),Z.config.featureToggles.lokiQuerySplittingConfig&&Z.config.featureToggles.lokiQuerySplitting&&e.createElement(te.S,{label:"Split Duration",tooltip:"Defines the duration of a single query when query splitting is enabled."},e.createElement(ue.H,{minWidth:14,type:"string",min:0,defaultValue:t.splitDuration??"1d",onCommitChange:v,invalid:!u}))))});function zt(a,t,n,l,r){const o=de.uG.find(c=>c.value===t),u=de.oZ.find(c=>c.value===(a.resolution??1)),i=[];return a.legendFormat&&i.push(`Legend: ${a.legendFormat}`),i.push(`Type: ${o?.label}`),l&&i.push(`Line limit: ${a.maxLines??n}`),l||(a.step&&i.push(`Step: ${r?a.step:"Invalid value"}`),a.resolution&&i.push(`Resolution: ${u?.label}`)),i}Ze.displayName="LokiQueryBuilderOptions";var Je=s(14607),Ye=s(97666),Wt=s(55953),Xe=s(20691);function jt({query:a,datasource:t,range:n,onRunQuery:l,onChange:r,data:o,app:u,showExplain:i,history:c}){const g=(0,J.wW)(Gt),v=Z.config.featureToggles.lokiFormatQuery,d=async()=>r({...a,expr:(0,Ce.Ix)(a.expr,t)});return e.createElement("div",{className:g.wrapper},e.createElement(Xe.n,{datasource:t,query:a,range:n,onRunQuery:l,onChange:r,history:c,data:o,app:u,"data-testid":Ne.editor,ExtraFieldElement:e.createElement(e.Fragment,null,v&&e.createElement("div",{className:g.buttonGroup},e.createElement("div",null,e.createElement(Re.Lh,{spacing:"sm"},e.createElement(je.h,{onClick:d,name:"brackets-curly",size:"xs",tooltip:"Format query"}),e.createElement(Je.u,{content:`Use ${(0,Wt.vl)()}+z to undo`},e.createElement(Ye.J,{className:g.hint,name:"keyboard"}))))))}),i&&e.createElement(We,{query:a.expr}))}const Gt=a=>({wrapper:(0,f.css)`
      max-width: 100%;
      .gf-form {
        margin-bottom: 0.5;
      }
    `,buttonGroup:(0,f.css)`
      border: 1px solid ${a.colors.border.medium};
      border-top: none;
      padding: ${a.spacing(.5,.5,.5,.5)};
      margin-bottom: ${a.spacing(.5)};
      display: flex;
      flex-grow: 1;
      justify-content: end;
      font-size: ${a.typography.bodySmall.fontSize};
    `,hint:(0,f.css)`
      color: ${a.colors.text.disabled};
      white-space: nowrap;
      cursor: help;
    `});var Kt=s(8655),Ht=s(21871),Me=s(72435);const Zt=a=>{const{pattern:t,onPatternSelect:n,hasNewQueryOption:l,hasPreviousQuery:r,selectedPatternName:o,setSelectedPatternName:u}=a,i=(0,J.wW)(Jt),c={grammar:he.ZP,name:"logql"};return e.createElement(Me.Z,{className:i.card},e.createElement(Me.Z.Heading,null,t.name),e.createElement("div",{className:i.rawQueryContainer},e.createElement(pe.U,{query:A.y.renderQuery({labels:[],operations:t.operations}),lang:c,className:i.rawQuery})),e.createElement(Me.Z.Actions,null,o!==t.name?e.createElement(U.zx,{size:"sm",onClick:()=>{r?u(t.name):n(t)}},"Use this query"):e.createElement(e.Fragment,null,e.createElement("div",{className:i.spacing},`If you would like to use this query, ${l?"you can either replace your current query or create a new query":"your current query will be replaced"}.`),e.createElement(U.zx,{size:"sm",fill:"outline",onClick:()=>u(null)},"Back"),e.createElement(U.zx,{size:"sm",onClick:()=>{n(t)}},"Replace query"),l&&e.createElement(U.zx,{size:"sm",onClick:()=>{n(t,!0)}},"Create new query"))))},Jt=a=>({card:(0,f.css)`
      width: 49.5%;
      display: flex;
      flex-direction: column;
    `,rawQueryContainer:(0,f.css)`
      flex-grow: 1;
    `,rawQuery:(0,f.css)`
      background-color: ${a.colors.background.primary};
      padding: ${a.spacing(1)};
      margin-top: ${a.spacing(1)};
    `,spacing:(0,f.css)`
      margin-bottom: ${a.spacing(1)};
    `}),Yt=a=>{const{isOpen:t,onClose:n,onChange:l,onAddQuery:r,query:o,queries:u,app:i}=a,[c,g]=(0,e.useState)([]),[v,d]=(0,e.useState)(null),L=(0,J.wW)(Xt),C=!!r,P=(0,e.useMemo)(()=>(0,ee._z)(o.expr).query.operations.length>0,[o.expr]),y=(p,m=!1)=>{const S=(0,ee._z)(m?"":o.expr);(0,N.ff)("grafana_loki_query_patterns_selected",{version:"v2",app:i??"",editorMode:o.editorMode,selectedPattern:p.name,preSelectedOperationsCount:S.query.operations.length,preSelectedLabelsCount:S.query.labels.length,createNewQuery:C&&m}),S.query.operations=p.operations,C&&m?r({...o,refId:(0,Ht.Hs)(u??[o]),expr:A.y.renderQuery(S.query)}):l({...o,expr:A.y.renderQuery(S.query)}),d(null),n()};return e.createElement(we.u,{isOpen:t,title:"Kick start your query",onDismiss:n,className:L.modal},e.createElement("div",{className:L.spacing},"Kick start your query by selecting one of these queries. You can then continue to complete your query."),Object.values(re.Hv).map(p=>e.createElement(Kt.U,{key:p,label:`${(0,k.capitalize)(p)} query starters`,isOpen:c.includes(p),collapsible:!0,onToggle:()=>g(m=>m.includes(p)?m.filter(S=>S!==p):[...m,p])},e.createElement("div",{className:L.cardsContainer},A.y.getQueryPatterns().filter(m=>m.type===p).map(m=>e.createElement(Zt,{key:m.name,pattern:m,hasNewQueryOption:C,hasPreviousQuery:P,onPatternSelect:y,selectedPatternName:v,setSelectedPatternName:d}))))),e.createElement(U.zx,{variant:"secondary",onClick:n},"Close"))},Xt=a=>({cardsContainer:(0,f.css)`
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: space-between;
    `,spacing:(0,f.css)`
      margin-bottom: ${a.spacing(1)};
    `,modal:(0,f.css)`
      width: 85vw;
      ${a.breakpoints.down("md")} {
        width: 100%;
      }
    `});var qe=s(20994),qt=s(60134);const _e="LokiQueryEditorModeDefault";function _t(a,t,n){a.expr===""&&qe.Z.set(_e,t),n({...a,editorMode:t})}function ea(a){if(a!=null&&a!=="")return _.c.Code;switch(qe.Z.get(_e)){case"code":return _.c.Code;case"builder":default:return _.c.Builder}}function ta(a){let t=a;return a.editorMode||(t={...a,editorMode:ea(a.expr)}),a.expr==null&&(t={...t,expr:""}),a.queryType==null&&(t={...t,queryType:qt.EM.Range}),t}var aa=s(85745);function et(a,t){return!a||!t?!1:(0,aa.v9)(a)?a.isSame(t):a===t}function na(a,t,n,l,r,o){return t===void 0||a.trim()!==t.trim()||r!==o?!0:!(et(n?.raw.from,l?.raw.from)&&et(n?.raw.to,l?.raw.to))}const Ne={editor:"loki-editor"},tt=e.memo(a=>{const t=(0,e.useId)(),{onChange:n,onRunQuery:l,onAddQuery:r,data:o,app:u,queries:i,datasource:c,range:g}=a,[v,d]=(0,e.useState)(!1),[L,C]=(0,e.useState)(!1),[P,y]=(0,e.useState)(!1),[p,m]=(0,e.useState)(!1),[S,F]=(0,e.useState)(null),{flag:b,setFlag:q}=(0,Fe.P5)(Fe.iS),H=c.predefinedOperations,nt=(0,E.Z)(g),O=ta(a.query);Z.config.featureToggles.lokiPredefinedOperations&&!O.expr&&H&&(O.expr=`{} ${H}`);const st=(0,E.Z)(O.expr),lt=(0,E.Z)(O.queryType),De=O.editorMode,Aa=V=>{q(V.currentTarget.checked)},Va=(0,e.useCallback)(V=>{if((0,N.ff)("grafana_loki_editor_mode_clicked",{newEditor:V,previousEditor:O.editorMode??"",newQuery:!O.expr,app:u??""}),V===_.c.Builder&&(0,ee._z)(O.expr||"").errors.length){d(!0);return}_t(O,V,n)},[n,O,u]);(0,e.useEffect)(()=>{y(!1)},[o]);const Qe=V=>{(0,k.isEqual)(V,a.query)||y(!0),n(V)},za=()=>{(0,N.ff)("grafana_loki_label_browser_opened",{app:u}),m(V=>!V)};return(0,e.useEffect)(()=>{na(O.expr,st,g,nt,O.queryType,lt)&&g&&(async()=>{const Wa=await c.getStats({...O,refId:`${t}_${O.refId}`},g);F(Wa)})()},[c,g,nt,O,st,lt,F,t]),e.createElement(e.Fragment,null,e.createElement(ce.s,{isOpen:v,title:"Query parsing",body:"There were errors while trying to parse the query. Continuing to visual builder may lose some parts of the query.",confirmText:"Continue",onConfirm:()=>{n({...O,editorMode:_.c.Builder}),d(!1)},onDismiss:()=>d(!1)}),e.createElement(Yt,{isOpen:L,onClose:()=>C(!1),query:O,queries:i,app:u,onChange:n,onAddQuery:r}),e.createElement(ft,{isOpen:p,datasource:c,query:O,app:u,onClose:()=>m(!1),onChange:Qe,onRunQuery:l,timeRange:g}),e.createElement(M.K,null,e.createElement(D.K,{gap:1},e.createElement(U.zx,{"aria-label":j.wl.components.QueryBuilder.queryPatterns,variant:"secondary",size:"sm",onClick:()=>{C(ke=>!ke);const V=(0,ee._z)(O.expr||"");(0,N.ff)("grafana_loki_query_patterns_opened",{version:"v2",app:u??"",editorMode:O.editorMode,preSelectedOperationsCount:V.query.operations.length,preSelectedLabelsCount:V.query.labels.length})}},"Kick start your query"),e.createElement(U.zx,{variant:"secondary",size:"sm",onClick:za,"data-testid":"label-browser-button"},"Label browser")),e.createElement(ot.n,{label:"Explain query",value:b,onChange:Aa}),e.createElement(B.B,{grow:1}),u!==$.zj.Explore&&u!==$.zj.Correlations&&e.createElement(U.zx,{variant:P?"primary":"secondary",size:"sm",onClick:l,icon:o?.state===Q.Gu.Loading?"spinner":void 0,disabled:o?.state===Q.Gu.Loading},i&&i.length>1?"Run queries":"Run query"),e.createElement(rt.k,{mode:De,onChange:Va})),e.createElement(ve.T,{v:.5}),e.createElement(me._,null,De===_.c.Code&&e.createElement(jt,{...a,query:O,onChange:Qe,showExplain:b}),De===_.c.Builder&&e.createElement(It,{datasource:a.datasource,query:O,onChange:Qe,onRunQuery:a.onRunQuery,showExplain:b,timeRange:g}),e.createElement(Ze,{query:O,onChange:n,onRunQuery:l,app:u,maxLines:c.maxLines,queryStats:S})))});tt.displayName="LokiQueryEditor";function sa(a){const{query:t,data:n,datasource:l,onChange:r,onRunQuery:o,history:u}=a;return e.createElement(Xe.n,{datasource:l,query:t,onChange:r,onRunQuery:o,history:u,data:n,placeholder:"Enter a Loki query","data-testid":la.editor})}const la={editor:"loki-editor-cloud-alerting"};function ra(a){const{app:t}=a;switch(t){case $.zj.CloudAlerting:return e.createElement(sa,{...a});default:return e.createElement(tt,{...a})}}const oa=(0,e.memo)(ra),ja={editor:"loki-editor"};var ia=s(83743),ca=s(55857),ua=s(99323),da=s(30743),ma=s(57773),ga=s(33223),pa=s(9011),oe=s(76581),Pe=s(15889),at=s(5999),Oe=s(7033);function ha({options:a,onOptionsChange:t}){return e.createElement(Pe._,{title:"Alerting",description:e.createElement(Oe.W,{description:"Manage alert rules for the Loki data source.",suffix:"loki/configure-loki-data-source/#alerting",feature:"alerting"})},e.createElement(le._,{labelWidth:29,label:"Manage alert rules in Alerting UI",disabled:a.readOnly,tooltip:"Manage alert rules for this data source. To manage other alerting resources, add an Alertmanager data source."},e.createElement(at.x,{value:a.jsonData.manageAlerts!==!1,onChange:n=>t({...a,jsonData:{...a.jsonData,manageAlerts:n.currentTarget.checked}})})))}var fa=s(56582),va=s(89306),Ea=s(58309),ya=s(7073),ba=s(52077);const La=a=>{const{derivedFields:t,className:n}=a,[l,r]=(0,e.useState)("");let o=[];return l&&t&&(o=xa(t,l)),e.createElement("div",{className:n},e.createElement(le._,{label:"Debug log message",labelWidth:24,grow:!0},e.createElement(ya.K,{type:"text","aria-label":"Prometheus Query",placeholder:"Paste an example log line here to test the regular expressions of your derived fields",value:l,onChange:u=>r(u.currentTarget.value)})),!!o.length&&e.createElement(Sa,{fields:o}))},Sa=({fields:a})=>e.createElement("table",{className:"filter-table"},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",null,"Name"),e.createElement("th",null,"Value"),e.createElement("th",null,"Url"))),e.createElement("tbody",null,a.map(t=>{let n=t.value;return t.error&&t.error instanceof Error?n=t.error.message:t.href&&(n=e.createElement("a",{href:t.href},n)),e.createElement("tr",{key:`${t.name}=${t.value}`},e.createElement("td",null,t.name),e.createElement("td",null,n),e.createElement("td",null,t.href?e.createElement("a",{href:t.href},t.href):""))})));function xa(a,t){return a.filter(n=>n.name&&n.matcherRegex).map(n=>{try{const l=t.match(n.matcherRegex),r=l&&l[1];let o=null;return n.url&&r&&(o=(0,ba.a_)({field:{name:"",type:Ea.fS.string,values:[r],config:{links:[{title:"",url:n.url}]}},rowIndex:0,range:{}})[0]),{name:n.name,value:r||"<no match>",href:o?o.href:void 0}}catch(l){return{name:n.name,error:l}}})}var X=s(20519),Ca=s(91757),Ma=s(40715);const Na=a=>({row:(0,f.css)`
    display: flex;
    align-items: baseline;
  `,nameField:(0,f.css)`
    flex: 2;
    margin-right: ${a.spacing(.5)};
  `,regexField:(0,f.css)`
    flex: 3;
    margin-right: ${a.spacing(.5)};
  `,urlField:(0,f.css)`
    flex: 1;
    margin-right: ${a.spacing(.5)};
  `,urlDisplayLabelField:(0,f.css)`
    flex: 1;
  `,internalLink:(0,f.css)`
    margin-right: ${a.spacing(1)};
  `,dataSource:(0,f.css)``,nameMatcherField:(0,f.css)({width:a.spacing(20),marginRight:a.spacing(.5)})}),Pa=a=>{const{value:t,onChange:n,onDelete:l,suggestions:r,className:o,validateName:u}=a,i=(0,J.wW)(Na),[c,g]=(0,e.useState)(!!t.datasourceUid),v=(0,E.Z)(t.datasourceUid),[d,L]=(0,e.useState)(t.matcherType??"regex");(0,e.useEffect)(()=>{!v&&t.datasourceUid&&!c&&g(!0),v&&!t.datasourceUid&&c&&g(!1)},[v,t.datasourceUid,c]);const C=y=>p=>{n({...t,[y]:p.currentTarget.value})},P=!u(t.name);return e.createElement("div",{className:o,"data-testid":"derived-field"},e.createElement("div",{className:"gf-form"},e.createElement(X.g,{className:i.nameField,label:"Name",invalid:P,error:"The name is already in use"},e.createElement(ne.I,{value:t.name,onChange:C("name"),placeholder:"Field name",invalid:P})),e.createElement(X.g,{className:i.nameMatcherField,label:e.createElement(fe,{label:"Type",content:"Derived fields can be created from labels or by applying a regular expression to the log message."})},e.createElement(ae.Ph,{options:[{label:"Regex in log line",value:"regex"},{label:"Label",value:"label"}],value:d,onChange:y=>{(y.value==="label"||y.value==="regex")&&(L(y.value),n({...t,matcherType:y.value}))}})),e.createElement(X.g,{className:i.regexField,label:e.createElement(e.Fragment,null,d==="regex"&&e.createElement(fe,{label:"Regex",content:"Use to parse and capture some part of the log message. You can use the captured groups in the template."}),d==="label"&&e.createElement(fe,{label:"Label",content:"Use to derive the field from a label."}))},e.createElement(ne.I,{value:t.matcherRegex,onChange:C("matcherRegex")})),e.createElement(X.g,{label:""},e.createElement(U.zx,{variant:"destructive",title:"Remove field",icon:"times",onClick:y=>{y.preventDefault(),l()}}))),e.createElement("div",{className:"gf-form"},e.createElement(X.g,{label:c?"Query":"URL",className:i.urlField},e.createElement(Ca.v,{placeholder:c?"${__value.raw}":"http://example.com/${__value.raw}",value:t.url||"",onChange:y=>n({...t,url:y}),suggestions:r})),e.createElement(X.g,{className:i.urlDisplayLabelField,label:e.createElement(fe,{label:"URL Label",content:"Use to override the button label when this derived field is found in a log."})},e.createElement(ne.I,{value:t.urlDisplayLabel,onChange:C("urlDisplayLabel")}))),e.createElement("div",{className:"gf-form"},e.createElement(X.g,{label:"Internal link",className:i.internalLink},e.createElement(at.r,{value:c,onChange:y=>{const{checked:p}=y.currentTarget;p||n({...t,datasourceUid:void 0}),g(p)}})),c&&e.createElement(X.g,{label:"",className:i.dataSource},e.createElement(Ma.q,{tracing:!0,onChange:y=>n({...t,datasourceUid:y.uid}),current:t.datasourceUid,noDefault:!0}))))},fe=({content:a,label:t})=>e.createElement(ge._,null,t,e.createElement(Je.u,{placement:"top",content:a,theme:"info"},e.createElement(Ye.J,{tabIndex:0,name:"info-circle",size:"sm",style:{marginLeft:"10px"}}))),Oa=a=>({addButton:(0,f.css)`
    margin-right: 10px;
  `,derivedField:(0,f.css)`
    margin-bottom: ${a.spacing(1)};
  `,container:(0,f.css)`
    margin-bottom: ${a.spacing(4)};
  `,debugSection:(0,f.css)`
    margin-top: ${a.spacing(4)};
  `}),Ta=({fields:a=[],onChange:t})=>{const n=(0,J.l4)(),l=Oa(n),[r,o]=(0,e.useState)(!1),u=(0,e.useCallback)(i=>a.filter(c=>c.name&&c.name===i).length<=1,[a]);return e.createElement(Pe._,{title:"Derived fields",description:e.createElement(Oe.W,{description:"Derived fields can be used to extract new fields from a log message and create a link from its value.",suffix:"loki/configure-loki-data-source/#derived-fields",feature:"derived fields"})},e.createElement("div",{className:l.container},a.map((i,c)=>e.createElement(Pa,{className:l.derivedField,key:c,value:i,onChange:g=>{const v=[...a];v.splice(c,1,g),t(v)},onDelete:()=>{const g=[...a];g.splice(c,1),t(g)},validateName:u,suggestions:[{value:fa.W.valueRaw,label:"Raw value",documentation:"Exact string captured by the regular expression",origin:va.L8.Value}]})),e.createElement("div",null,e.createElement(U.zx,{variant:"secondary",className:l.addButton,icon:"plus",onClick:i=>{i.preventDefault();const c={name:"",matcherRegex:"",urlDisplayLabel:"",url:"",matcherType:"regex"},g=[...a,c];t(g)}},"Add"),a.length>0&&e.createElement(U.zx,{variant:"secondary",type:"button",onClick:()=>o(!r)},r?"Hide example log message":"Show example log message")),r&&e.createElement("div",{className:l.debugSection},e.createElement(La,{className:(0,f.css)`
                margin-bottom: 10px;
              `,derivedFields:a}))))};var Da=s(81368),Qa=s(67192);const ka=a=>{const{maxLines:t,onMaxLinedChange:n,predefinedOperations:l,onPredefinedOperationsChange:r}=a;return e.createElement(Pe._,{title:"Queries",description:e.createElement(Oe.W,{description:"Additional options to customize your querying experience.",suffix:"loki/configure-loki-data-source/#queries",feature:"query settings"})},e.createElement(le._,{label:"Maximum lines",htmlFor:"loki_config_maxLines",labelWidth:22,tooltip:e.createElement(e.Fragment,null,"Loki queries must contain a limit of the maximum number of lines returned (default: 1000). Increase this limit to have a bigger result set for ad-hoc analysis. Decrease this limit if your browser becomes sluggish when displaying the log results.")},e.createElement(ne.I,{type:"number",id:"loki_config_maxLines",value:t,onChange:o=>n(o.currentTarget.value),width:16,placeholder:"1000",spellCheck:!1})),Z.config.featureToggles.lokiPredefinedOperations&&e.createElement(Da.Z,null,e.createElement(le._,{label:"Predefined operations",htmlFor:"loki_config_predefinedOperations",labelWidth:22,tooltip:e.createElement(e.Fragment,null,'Predefined operations are used as an initial state for your queries. They are useful, if you want to unpack, parse or format all log lines. Currently we support only log operations starting with |. For example: | unpack | line_format "{{.message}}".')},e.createElement(ne.I,{type:"string",id:"loki_config_predefinedOperations",value:l,onChange:o=>r(o.currentTarget.value),width:40,placeholder:"| unpack | line_format",spellCheck:!1})),e.createElement(le._,null,e.createElement(Qa.C,{text:"Experimental",color:"orange",icon:"exclamation-triangle",tooltip:"Predefined operations is an experimental feature that may change in the future."}))))},Te=a=>(t,n)=>({...t,jsonData:{...t.jsonData,[a]:n}}),Fa=Te("maxLines"),wa=Te("predefinedOperations"),Ia=Te("derivedFields"),Ra=a=>{const{options:t,onOptionsChange:n}=a,l=(0,e.useCallback)(r=>{(0,N.ff)("grafana_loki_predefined_operations_changed",{value:r}),n(wa(t,r))},[t,n]);return e.createElement(e.Fragment,null,e.createElement(ia.j,{dataSourceName:"Loki",docsLink:"https://grafana.com/docs/grafana/latest/datasources/loki/configure-loki-data-source/",hasRequiredFields:!1}),e.createElement(oe.i,null),e.createElement(ca.f,{config:t,onChange:n,urlPlaceholder:"http://localhost:3100"}),e.createElement(oe.i,null),e.createElement(ua.g,{...(0,da.T2)({config:t,onChange:n})}),e.createElement(oe.i,null),e.createElement(ma.K,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!0},e.createElement(ga.a,{config:t,onChange:n}),e.createElement(oe.i,{hideLine:!0}),Z.config.secureSocksDSProxyEnabled&&e.createElement(pa.i,{options:t,onOptionsChange:n}),e.createElement(ha,{options:t,onOptionsChange:n}),e.createElement(oe.i,{hideLine:!0}),e.createElement(ka,{maxLines:t.jsonData.maxLines||"",onMaxLinedChange:r=>n(Fa(t,r)),predefinedOperations:t.jsonData.predefinedOperations||"",onPredefinedOperationsChange:l}),e.createElement(oe.i,{hideLine:!0}),e.createElement(Ta,{fields:t.jsonData.derivedFields,onChange:r=>n(Ia(t,r))})))};var $a=s(1651),Ba=s(13460);const Ua=new x.hf($a.KV).setQueryEditor(oa).setConfigEditor(Ra).setQueryEditorHelp(K);(0,z.N$)().subscribe(w.Pl,Ba.uJ)},60134:(ie,G,s)=>{s.d(G,{JG:()=>N,sb:()=>k,EM:()=>w,Z3:()=>T,$o:()=>z});var x=(h=>(h.Builder="builder",h.Code="code",h))(x||{}),w=(h=>(h.Instant="instant",h.Range="range",h.Stream="stream",h))(w||{}),z=(h=>(h.DataSample="dataSample",h.LogsSample="logsSample",h.LogsVolume="logsVolume",h))(z||{}),k=(h=>(h.Backward="backward",h.Forward="forward",h))(k||{}),e=(h=>(h.Stream="streams",h.Vector="vector",h.Matrix="matrix",h))(e||{}),N=(h=>(h.Indexed="I",h.StructuredMetadata="S",h.Parsed="P",h))(N||{}),T=(h=>(h[h.LabelNames=0]="LabelNames",h[h.LabelValues=1]="LabelValues",h))(T||{})}}]);

//# sourceMappingURL=7843.fd833b57dca1dd85f8d2.js.map