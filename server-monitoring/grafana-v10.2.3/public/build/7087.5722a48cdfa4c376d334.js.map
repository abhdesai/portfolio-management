{"version":3,"file":"7087.5722a48cdfa4c376d334.js","mappings":"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,GAAa,GACxB,qBAAsB,EACxB,CACF,CCrFO,MAAMC,GAAmC,CAC9C,CACE,SAAU,aACV,YAAa,6BACf,EACA,CACE,SAAU,yBACV,YAAa,8DACf,EACA,CACE,SAAU,2BACV,YAAa,oEACf,EACA,CACE,SAAU,4CACV,YACE,qHACJ,EACA,CACE,SAAU,oBACV,YAAa,0CACf,EACA,CACE,SAAU,eACV,YAAa,6BACf,EACA,CACE,SAAU,kCACV,YAAa,mDACf,EACA,CACE,SAAU,0BACV,YAAa,wFACf,EACA,CACE,SAAU,kCACV,YAAa,oCACf,EACA,CACE,SAAU,iCACV,YAAa,uEACf,EACA,CACE,SAAU,8CACV,YAAa,uFACf,EACA,CACE,SAAU,0BACV,YAAa,iDACf,EACA,CACE,SAAU,kBACV,YAAa,4EACf,EACA,CACE,SAAU,mBACV,YAAa,mDACf,EACA,CACE,SAAU,kBACV,YAAa,mBACf,EACA,CACE,SAAU,0CACV,YAAa,mDACf,EACA,CACE,SAAU,kCACV,YAAa,uDACf,CACF,EAEaC,GAAmC,CAC9C,CACE,SAAU,mCACV,YACE,8GACJ,EACA,CACE,SAAU,uBACV,YAAa,uDACf,EACA,CACE,SAAU,uCACV,YACE,wHACJ,EACA,CACE,SAAU,4BACV,YAAa,+EACf,EACA,CACE,SAAU,iCACV,YAAa,4EACf,EACA,CACE,SAAU,2BACV,YAAa,uDACf,EACA,CACE,SAAU,oCACV,YAAa,0FACf,EACA,CACE,SAAU,wBACV,YAAa,8DACf,EACA,CACE,SAAU,mCACV,YACE,kIACJ,EACA,CACE,SAAU,2CACV,YAAa,kEACf,EACA,CACE,SAAU,wDACV,YAAa,iDACf,EACA,CACE,SAAU,8CACV,YAAa,qEACf,EACA,CACE,SAAU,4BACV,YAAa,mEACf,EACA,CACE,SAAU,4BACV,YAAa,8EACf,EACA,CACE,SAAU,qCACV,YAAa,iDACf,CACF,EAEaC,GAAqC,CAChD,CACE,SAAU,2DACV,YACE,4KACJ,EACA,CACE,SAAU,gDACV,YAAa,6DACf,EACA,CACE,SAAU,2DACV,YAAa,6FACf,EACA,CACE,SAAU,oCACV,YAAa,6BACf,CACF,EAEaC,GAAiC,CAC5C,CACE,SAAU,yBACV,YAAa,sDACf,EACA,CACE,SAAU,kBACV,YAAa,4DACf,EACA,CACE,SAAU,0BACV,YAAa,kGACf,EACA,CACE,SAAU,kBACV,YAAa,uDACf,EACA,CACE,SAAU,kBACV,YAAa,sDACf,EACA,CACE,SAAU,kBACV,YAAa,sFACf,EACA,CACE,SAAU,kBACV,YAAa,yCACf,EACA,CACE,SAAU,mBACV,YAAa,4CACf,EACA,CACE,SAAU,gCACV,YAAa,yCACf,EACA,CACE,SAAU,gCACV,YAAa,uDACf,EACA,CACE,SAAU,qCACV,YAAa,oDACf,EACA,CACE,SAAU,wBACV,YAAa,6FACf,EACA,CACE,SAAU,4CACV,YACE,+GACJ,EACA,CACE,SAAU,gCACV,YAAa,uEACf,EACA,CACE,SAAU,kBACV,YAAa,qCACf,EACA,CACE,SAAU,kBACV,YAAa,kDACf,EACA,CACE,SAAU,2CACV,YAAa,oDACf,EACA,CACE,SAAU,sBACV,YAAa,yDACf,EACA,CACE,SAAU,yBACV,YAAa,+DACf,EACA,CACE,SAAU,kCACV,YAAa,sEACf,EACA,CACE,SAAU,qCACV,YAAa,8CACf,EACA,CACE,SAAU,mCACV,YAAa,wEACf,EACA,CACE,SAAU,8BACV,YACE,iHACJ,EACA,CACE,SAAU,uBACV,YAAa,6CACf,EACA,CACE,SAAU,gCACV,YAAa,uDACf,EACA,CACE,SAAU,qCACV,YAAa,iEACf,CACF,EAEA,SAASC,EAAgBC,EAA4BC,EAAgBjL,EAAiC,CACpG,MAAO,CACL,MAAOgL,EAAa,SAAS,QAAQ,WAAYC,CAAM,EAAE,QAAQ,KAAMjL,CAAM,EAC7E,YAAagL,EAAa,YAAY,QAAQ,WAAYC,CAAM,CAClE,CACF,CAEO,SAASC,GAAuBxB,EAAoBC,EAAoB3J,EAAmC,CAChH,IAAImL,EAAyC,CAAC,EAC9C,OAAQxB,EAAY,CAClB,IAAK,UACHwB,EAAsBA,EAAoB,OACxCP,GACG,IAAKhH,GAAMmH,EAAgBnH,EAA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","sources":["webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/operationUtils.ts","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/types.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromCheatSheet.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/QueryPattern.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/QueryPatternsModal.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/state.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/NestedQuery.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/NestedQueryList.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/QuerySuggestionItem.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/types.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/QuerySuggestionContainer.tsx","webpack://grafana/./.yarn/__virtual__/@grafana-experimental-virtual-dc168f64a3/2/yarn/cache/@grafana-experimental-npm-1.7.4-f38fe41f94-e62e638239.zip/node_modules/@grafana/experimental/dist/esm/llms/vector.js","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/prompts.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/state/state.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/state/templates.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/state/helpers.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/PromQail.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryBuilder.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/QueryPreview.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryBuilderContainer.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromExemplarField.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromExploreExtraField.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryLegendEditor.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryBuilderOptions.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryEditorSelector.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromQueryEditorForAlerting.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromQueryEditorByApp.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/module.ts"],"sourcesContent":["import { LabelParamEditor } from '../../prometheus/querybuilder/components/LabelParamEditor';\nimport {\n  getAggregationExplainer,\n  getLastLabelRemovedHandler,\n  getOnLabelAddedHandler,\n  getPromAndLokiOperationDisplayName,\n} from '../../prometheus/querybuilder/shared/operationUtils';\nimport {\n  QueryBuilderOperation,\n  QueryBuilderOperationDef,\n  QueryBuilderOperationParamDef,\n  VisualQueryModeller,\n} from '../../prometheus/querybuilder/shared/types';\nimport { FUNCTIONS } from '../syntax';\n\nimport { LokiOperationId, LokiOperationOrder, LokiVisualQuery, LokiVisualQueryOperationCategory } from './types';\n\nexport function createRangeOperation(name: string, isRangeOperationWithGrouping?: boolean): QueryBuilderOperationDef {\n  const params = [getRangeVectorParamDef()];\n  const defaultParams = ['$__auto'];\n  let paramChangedHandler = undefined;\n\n  if (name === LokiOperationId.QuantileOverTime) {\n    defaultParams.push('0.95');\n    params.push({\n      name: 'Quantile',\n      type: 'number',\n    });\n  }\n\n  if (isRangeOperationWithGrouping) {\n    params.push({\n      name: 'By label',\n      type: 'string',\n      restParam: true,\n      optional: true,\n    });\n\n    paramChangedHandler = getOnLabelAddedHandler(`__${name}_by`);\n  }\n\n  return {\n    id: name,\n    name: getPromAndLokiOperationDisplayName(name),\n    params: params,\n    defaultParams,\n    alternativesKey: 'range function',\n    category: LokiVisualQueryOperationCategory.RangeFunctions,\n    orderRank: LokiOperationOrder.RangeVectorFunction,\n    renderer: operationWithRangeVectorRenderer,\n    addOperationHandler: addLokiOperation,\n    paramChangedHandler,\n    explainHandler: (op, def) => {\n      let opDocs = FUNCTIONS.find((x) => x.insertText === op.id)?.documentation ?? '';\n\n      if (op.params[0] === '$__auto') {\n        return `${opDocs} \\`$__auto\\` is a variable that will be replaced with the [value of step](https://grafana.com/docs/grafana/next/datasources/loki/query-editor/#options) for range queries and with the value of the selected time range (calculated to - from) for instant queries.`;\n      } else {\n        return `${opDocs} The [range vector](https://grafana.com/docs/loki/latest/logql/metric_queries/#range-vector-aggregation) is set to \\`${op.params[0]}\\`.`;\n      }\n    },\n  };\n}\n\nexport function createRangeOperationWithGrouping(name: string): QueryBuilderOperationDef[] {\n  const rangeOperation = createRangeOperation(name, true);\n  // Copy range operation params without the last param\n  const params = rangeOperation.params.slice(0, -1);\n  const operations: QueryBuilderOperationDef[] = [\n    rangeOperation,\n    {\n      id: `__${name}_by`,\n      name: `${getPromAndLokiOperationDisplayName(name)} by`,\n      params: [\n        ...params,\n        {\n          name: 'Label',\n          type: 'string',\n          restParam: true,\n          optional: true,\n          editor: LabelParamEditor,\n        },\n      ],\n      defaultParams: [...rangeOperation.defaultParams, ''],\n      alternativesKey: 'range function with grouping',\n      category: LokiVisualQueryOperationCategory.RangeFunctions,\n      renderer: getRangeAggregationWithGroupingRenderer(name, 'by'),\n      paramChangedHandler: getLastLabelRemovedHandler(name),\n      explainHandler: getAggregationExplainer(name, 'by'),\n      addOperationHandler: addLokiOperation,\n      hideFromList: true,\n    },\n    {\n      id: `__${name}_without`,\n      name: `${getPromAndLokiOperationDisplayName(name)} without`,\n      params: [\n        ...params,\n        {\n          name: 'Label',\n          type: 'string',\n          restParam: true,\n          optional: true,\n          editor: LabelParamEditor,\n        },\n      ],\n      defaultParams: [...rangeOperation.defaultParams, ''],\n      alternativesKey: 'range function with grouping',\n      category: LokiVisualQueryOperationCategory.RangeFunctions,\n      renderer: getRangeAggregationWithGroupingRenderer(name, 'without'),\n      paramChangedHandler: getLastLabelRemovedHandler(name),\n      explainHandler: getAggregationExplainer(name, 'without'),\n      addOperationHandler: addLokiOperation,\n      hideFromList: true,\n    },\n  ];\n\n  return operations;\n}\n\nexport function getRangeAggregationWithGroupingRenderer(aggregation: string, grouping: 'by' | 'without') {\n  return function aggregationRenderer(model: QueryBuilderOperation, def: QueryBuilderOperationDef, innerExpr: string) {\n    const restParamIndex = def.params.findIndex((param) => param.restParam);\n    const params = model.params.slice(0, restParamIndex);\n    const restParams = model.params.slice(restParamIndex);\n\n    if (params.length === 2 && aggregation === LokiOperationId.QuantileOverTime) {\n      return `${aggregation}(${params[1]}, ${innerExpr} [${params[0]}]) ${grouping} (${restParams.join(', ')})`;\n    }\n\n    return `${aggregation}(${innerExpr} [${params[0]}]) ${grouping} (${restParams.join(', ')})`;\n  };\n}\n\nfunction operationWithRangeVectorRenderer(\n  model: QueryBuilderOperation,\n  def: QueryBuilderOperationDef,\n  innerExpr: string\n) {\n  const params = model.params ?? [];\n  const rangeVector = params[0] ?? '$__auto';\n  // QuantileOverTime is only range vector with more than one param\n  if (params.length === 2 && model.id === LokiOperationId.QuantileOverTime) {\n    const quantile = params[1];\n    return `${model.id}(${quantile}, ${innerExpr} [${rangeVector}])`;\n  }\n\n  return `${model.id}(${innerExpr} [${params[0] ?? '$__auto'}])`;\n}\n\nexport function labelFilterRenderer(model: QueryBuilderOperation, def: QueryBuilderOperationDef, innerExpr: string) {\n  const integerOperators = ['<', '<=', '>', '>='];\n\n  if (integerOperators.includes(String(model.params[1]))) {\n    return `${innerExpr} | ${model.params[0]} ${model.params[1]} ${model.params[2]}`;\n  }\n\n  return `${innerExpr} | ${model.params[0]} ${model.params[1]} \\`${model.params[2]}\\``;\n}\n\nexport function isConflictingFilter(\n  operation: QueryBuilderOperation,\n  queryOperations: QueryBuilderOperation[]\n): boolean {\n  const operationIsNegative = operation.params[1].toString().startsWith('!');\n\n  const candidates = queryOperations.filter(\n    (queryOperation) =>\n      queryOperation.id === LokiOperationId.LabelFilter &&\n      queryOperation.params[0] === operation.params[0] &&\n      queryOperation.params[2] === operation.params[2]\n  );\n\n  const conflict = candidates.some((candidate) => {\n    if (operationIsNegative && candidate.params[1].toString().startsWith('!') === false) {\n      return true;\n    }\n    if (operationIsNegative === false && candidate.params[1].toString().startsWith('!')) {\n      return true;\n    }\n    return false;\n  });\n\n  return conflict;\n}\n\nexport function pipelineRenderer(model: QueryBuilderOperation, def: QueryBuilderOperationDef, innerExpr: string) {\n  switch (model.id) {\n    case LokiOperationId.Logfmt:\n      const [strict = false, keepEmpty = false, ...labels] = model.params;\n      return `${innerExpr} | logfmt${strict ? ' --strict' : ''}${keepEmpty ? ' --keep-empty' : ''} ${labels\n        .filter((label) => label)\n        .join(', ')}`.trim();\n    case LokiOperationId.Json:\n      return `${innerExpr} | json ${model.params.filter((param) => param).join(', ')}`.trim();\n    case LokiOperationId.Drop:\n      return `${innerExpr} | drop ${model.params.filter((param) => param).join(', ')}`.trim();\n    case LokiOperationId.Keep:\n      return `${innerExpr} | keep ${model.params.filter((param) => param).join(', ')}`.trim();\n    default:\n      return `${innerExpr} | ${model.id}`;\n  }\n}\n\nfunction isRangeVectorFunction(def: QueryBuilderOperationDef) {\n  return def.category === LokiVisualQueryOperationCategory.RangeFunctions;\n}\n\nfunction getIndexOfOrLast(\n  operations: QueryBuilderOperation[],\n  queryModeller: VisualQueryModeller,\n  condition: (def: QueryBuilderOperationDef) => boolean\n) {\n  const index = operations.findIndex((x) => {\n    const opDef = queryModeller.getOperationDef(x.id);\n    if (!opDef) {\n      return false;\n    }\n    return condition(opDef);\n  });\n\n  return index === -1 ? operations.length : index;\n}\n\nexport function addLokiOperation(\n  def: QueryBuilderOperationDef,\n  query: LokiVisualQuery,\n  modeller: VisualQueryModeller\n): LokiVisualQuery {\n  const newOperation: QueryBuilderOperation = {\n    id: def.id,\n    params: def.defaultParams,\n  };\n\n  const operations = [...query.operations];\n\n  const existingRangeVectorFunction = operations.find((x) => {\n    const opDef = modeller.getOperationDef(x.id);\n    if (!opDef) {\n      return false;\n    }\n    return isRangeVectorFunction(opDef);\n  });\n\n  switch (def.category) {\n    case LokiVisualQueryOperationCategory.Aggregations:\n    case LokiVisualQueryOperationCategory.Functions:\n      // If we are adding a function but we have not range vector function yet add one\n      if (!existingRangeVectorFunction) {\n        const placeToInsert = getIndexOfOrLast(\n          operations,\n          modeller,\n          (def) => def.category === LokiVisualQueryOperationCategory.Functions\n        );\n        operations.splice(placeToInsert, 0, { id: LokiOperationId.Rate, params: ['$__auto'] });\n      }\n      operations.push(newOperation);\n      break;\n    case LokiVisualQueryOperationCategory.RangeFunctions:\n      // If adding a range function and range function is already added replace it\n      if (existingRangeVectorFunction) {\n        const index = operations.indexOf(existingRangeVectorFunction);\n        operations[index] = newOperation;\n        break;\n      }\n\n    // Add range functions after any formats, line filters and label filters\n    default:\n      const placeToInsert = getIndexOfOrLast(\n        operations,\n        modeller,\n        (x) => (def.orderRank ?? 100) < (x.orderRank ?? 100)\n      );\n      operations.splice(placeToInsert, 0, newOperation);\n      break;\n  }\n\n  return {\n    ...query,\n    operations,\n  };\n}\n\nexport function addNestedQueryHandler(def: QueryBuilderOperationDef, query: LokiVisualQuery): LokiVisualQuery {\n  return {\n    ...query,\n    binaryQueries: [\n      ...(query.binaryQueries ?? []),\n      {\n        operator: '/',\n        query,\n      },\n    ],\n  };\n}\n\nexport function getLineFilterRenderer(operation: string, caseInsensitive?: boolean) {\n  return function lineFilterRenderer(model: QueryBuilderOperation, def: QueryBuilderOperationDef, innerExpr: string) {\n    if (caseInsensitive) {\n      return `${innerExpr} ${operation} \\`(?i)${model.params.join('` or `(?i)')}\\``;\n    }\n    return `${innerExpr} ${operation} \\`${model.params.join('` or `')}\\``;\n  };\n}\n\nfunction getRangeVectorParamDef(): QueryBuilderOperationParamDef {\n  return {\n    name: 'Range',\n    type: 'string',\n    options: ['$__auto', '1m', '5m', '10m', '1h', '24h'],\n  };\n}\n","import { VisualQueryBinary } from '../../prometheus/querybuilder/shared/LokiAndPromQueryModellerBase';\nimport { QueryBuilderLabelFilter, QueryBuilderOperation } from '../../prometheus/querybuilder/shared/types';\n\n/**\n * Visual query model\n */\nexport interface LokiVisualQuery {\n  labels: QueryBuilderLabelFilter[];\n  operations: QueryBuilderOperation[];\n  binaryQueries?: LokiVisualQueryBinary[];\n}\n\nexport type LokiVisualQueryBinary = VisualQueryBinary<LokiVisualQuery>;\nexport enum LokiQueryPatternType {\n  Log = 'log',\n  Metric = 'metric',\n}\n\nexport interface LokiQueryPattern {\n  name: string;\n  operations: QueryBuilderOperation[];\n  type: LokiQueryPatternType;\n}\n\nexport enum LokiVisualQueryOperationCategory {\n  Aggregations = 'Aggregations',\n  RangeFunctions = 'Range functions',\n  Functions = 'Functions',\n  Formats = 'Formats',\n  LineFilters = 'Line filters',\n  LabelFilters = 'Label filters',\n  BinaryOps = 'Binary operations',\n}\n\nexport enum LokiOperationId {\n  Json = 'json',\n  Logfmt = 'logfmt',\n  Regexp = 'regexp',\n  Pattern = 'pattern',\n  Unpack = 'unpack',\n  LineFormat = 'line_format',\n  LabelFormat = 'label_format',\n  Decolorize = 'decolorize',\n  Drop = 'drop',\n  Keep = 'keep',\n  Rate = 'rate',\n  RateCounter = 'rate_counter',\n  CountOverTime = 'count_over_time',\n  SumOverTime = 'sum_over_time',\n  AvgOverTime = 'avg_over_time',\n  MaxOverTime = 'max_over_time',\n  MinOverTime = 'min_over_time',\n  FirstOverTime = 'first_over_time',\n  LastOverTime = 'last_over_time',\n  StdvarOverTime = 'stdvar_over_time',\n  StddevOverTime = 'stddev_over_time',\n  QuantileOverTime = 'quantile_over_time',\n  BytesRate = 'bytes_rate',\n  BytesOverTime = 'bytes_over_time',\n  AbsentOverTime = 'absent_over_time',\n  Sum = 'sum',\n  Avg = 'avg',\n  Min = 'min',\n  Max = 'max',\n  Stddev = 'stddev',\n  Stdvar = 'stdvar',\n  Count = 'count',\n  TopK = 'topk',\n  BottomK = 'bottomk',\n  LineContains = '__line_contains',\n  LineContainsNot = '__line_contains_not',\n  LineContainsCaseInsensitive = '__line_contains_case_insensitive',\n  LineContainsNotCaseInsensitive = '__line_contains_not_case_insensitive',\n  LineMatchesRegex = '__line_matches_regex',\n  LineMatchesRegexNot = '__line_matches_regex_not',\n  LineFilterIpMatches = '__line_filter_ip_matches',\n  LabelFilter = '__label_filter',\n  LabelFilterNoErrors = '__label_filter_no_errors',\n  LabelFilterIpMatches = '__label_filter_ip_marches',\n  Unwrap = 'unwrap',\n  SumBy = '__sum_by',\n  SumWithout = '__sum_without',\n  // Binary ops\n  Addition = '__addition',\n  Subtraction = '__subtraction',\n  MultiplyBy = '__multiply_by',\n  DivideBy = '__divide_by',\n  Modulo = '__modulo',\n  Exponent = '__exponent',\n  NestedQuery = '__nested_query',\n  EqualTo = '__equal_to',\n  NotEqualTo = '__not_equal_to',\n  GreaterThan = '__greater_than',\n  LessThan = '__less_than',\n  GreaterOrEqual = '__greater_or_equal',\n  LessOrEqual = '__less_or_equal',\n}\n\nexport enum LokiOperationOrder {\n  LineFilters = 1,\n  Parsers = 2,\n  PipeOperations = 3,\n  // Unwrap is a special case, as it is usually the last operation, so the order is after pipeOperations\n  Unwrap = 4,\n  NoErrors = 5,\n  RangeVectorFunction = 5,\n  Last = 6,\n}\n\nexport const lokiOperators = {\n  equals: { label: '=', value: '=', description: 'Equals', isMultiValue: false },\n  doesNotEqual: { label: '!=', value: '!=', description: 'Does not equal', isMultiValue: false },\n  matchesRegex: { label: '=~', value: '=~', description: 'Matches regex', isMultiValue: true },\n  doesNotMatchRegex: { label: '!~', value: '!~', description: 'Does not match regex', isMultiValue: true },\n  greaterThan: { label: '>', value: '>', description: 'Greater than', isMultiValue: false },\n  greaterThanOrEqual: { label: '>=', value: '>=', description: 'Greater than or equal to', isMultiValue: false },\n  lessThan: { label: '<', value: '<', description: 'Less than', isMultiValue: false },\n  lessThanOrEqual: { label: '<=', value: '<=', description: 'Less than or equal to', isMultiValue: false },\n  contains: { label: '|=', value: '|=', description: 'Contains', isMultiValue: false },\n  doesNotContain: { label: '!=', value: '!=', description: 'Does not contain', isMultiValue: false },\n};\n","import React from 'react';\n\nimport { QueryEditorHelpProps } from '@grafana/data';\n\nimport { PromQuery } from '../types';\n\nconst CHEAT_SHEET_ITEMS = [\n  {\n    title: 'Request Rate',\n    expression: 'rate(http_request_total[5m])',\n    label:\n      'Given an HTTP request counter, this query calculates the per-second average request rate over the last 5 minutes.',\n  },\n  {\n    title: '95th Percentile of Request Latencies',\n    expression: 'histogram_quantile(0.95, sum(rate(prometheus_http_request_duration_seconds_bucket[5m])) by (le))',\n    label: 'Calculates the 95th percentile of HTTP request rate over 5 minute windows.',\n  },\n  {\n    title: 'Alerts Firing',\n    expression: 'sort_desc(sum(sum_over_time(ALERTS{alertstate=\"firing\"}[24h])) by (alertname))',\n    label: 'Sums up the alerts that have been firing over the last 24 hours.',\n  },\n  {\n    title: 'Step',\n    label:\n      'Defines the graph resolution using a duration format (15s, 1m, 3h, ...). Small steps create high-resolution graphs but can be slow over larger time ranges. Using a longer step lowers the resolution and smooths the graph by producing fewer datapoints. If no step is given the resolution is calculated automatically.',\n  },\n];\n\nconst PromCheatSheet = (props: QueryEditorHelpProps<PromQuery>) => (\n  <div>\n    <h2>PromQL Cheat Sheet</h2>\n    {CHEAT_SHEET_ITEMS.map((item, index) => (\n      <div className=\"cheat-sheet-item\" key={index}>\n        <div className=\"cheat-sheet-item__title\">{item.title}</div>\n        {item.expression ? (\n          <button\n            type=\"button\"\n            className=\"cheat-sheet-item__example\"\n            onClick={(e) => props.onClickExample({ refId: 'A', expr: item.expression })}\n          >\n            <code>{item.expression}</code>\n          </button>\n        ) : null}\n        <div className=\"cheat-sheet-item__label\">{item.label}</div>\n      </div>\n    ))}\n  </div>\n);\n\nexport default PromCheatSheet;\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Button, Card, useStyles2 } from '@grafana/ui';\nimport { RawQuery } from 'app/plugins/datasource/prometheus/querybuilder/shared/RawQuery';\n\nimport promqlGrammar from '../promql';\n\nimport { promQueryModeller } from './PromQueryModeller';\nimport { PromQueryPattern } from './types';\n\ntype Props = {\n  pattern: PromQueryPattern;\n  hasNewQueryOption: boolean;\n  hasPreviousQuery: boolean | string;\n  selectedPatternName: string | null;\n  setSelectedPatternName: (name: string | null) => void;\n  onPatternSelect: (pattern: PromQueryPattern, selectAsNewQuery?: boolean) => void;\n};\n\nexport const QueryPattern = (props: Props) => {\n  const { pattern, onPatternSelect, hasNewQueryOption, hasPreviousQuery, selectedPatternName, setSelectedPatternName } =\n    props;\n\n  const styles = useStyles2(getStyles);\n  const lang = { grammar: promqlGrammar, name: 'promql' };\n\n  return (\n    <Card className={styles.card}>\n      <Card.Heading>{pattern.name}</Card.Heading>\n      <div className={styles.rawQueryContainer}>\n        <RawQuery\n          aria-label={`${pattern.name} raw query`}\n          query={promQueryModeller.renderQuery({\n            labels: [],\n            operations: pattern.operations,\n            binaryQueries: pattern.binaryQueries,\n          })}\n          lang={lang}\n          className={styles.rawQuery}\n        />\n      </div>\n      <Card.Actions>\n        {selectedPatternName !== pattern.name ? (\n          <Button\n            size=\"sm\"\n            aria-label=\"use this query button\"\n            onClick={() => {\n              if (hasPreviousQuery) {\n                // If user has previous query, we need to confirm that they want to apply this query pattern\n                setSelectedPatternName(pattern.name);\n              } else {\n                onPatternSelect(pattern);\n              }\n            }}\n          >\n            Use this query\n          </Button>\n        ) : (\n          <>\n            <div className={styles.spacing}>\n              {`If you would like to use this query, ${\n                hasNewQueryOption\n                  ? 'you can either apply this query pattern or create a new query'\n                  : 'this query pattern will be applied to your current query'\n              }.`}\n            </div>\n            <Button size=\"sm\" aria-label=\"back button\" fill=\"outline\" onClick={() => setSelectedPatternName(null)}>\n              Back\n            </Button>\n            <Button\n              size=\"sm\"\n              aria-label=\"apply query starter button\"\n              onClick={() => {\n                onPatternSelect(pattern);\n              }}\n            >\n              Apply query\n            </Button>\n            {hasNewQueryOption && (\n              <Button\n                size=\"sm\"\n                aria-label=\"create new query button\"\n                onClick={() => {\n                  onPatternSelect(pattern, true);\n                }}\n              >\n                Create new query\n              </Button>\n            )}\n          </>\n        )}\n      </Card.Actions>\n    </Card>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    card: css`\n      width: 49.5%;\n      display: flex;\n      flex-direction: column;\n    `,\n    rawQueryContainer: css`\n      flex-grow: 1;\n    `,\n    rawQuery: css`\n      background-color: ${theme.colors.background.primary};\n      padding: ${theme.spacing(1)};\n      margin-top: ${theme.spacing(1)};\n    `,\n    spacing: css`\n      margin-bottom: ${theme.spacing(1)};\n    `,\n  };\n};\n","import { css } from '@emotion/css';\nimport { capitalize } from 'lodash';\nimport React, { useMemo, useState } from 'react';\n\nimport { CoreApp, DataQuery, GrafanaTheme2 } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, Collapse, Modal, useStyles2 } from '@grafana/ui';\nimport { getNextRefIdChar } from 'app/core/utils/query';\n\nimport { PromQuery } from '../types';\n\nimport { promQueryModeller } from './PromQueryModeller';\nimport { QueryPattern } from './QueryPattern';\nimport { buildVisualQueryFromString } from './parsing';\nimport { PromQueryPattern, PromQueryPatternType } from './types';\n\ntype Props = {\n  isOpen: boolean;\n  query: PromQuery;\n  queries: DataQuery[] | undefined;\n  app?: CoreApp;\n  onClose: () => void;\n  onChange: (query: PromQuery) => void;\n  onAddQuery?: (query: PromQuery) => void;\n};\n\nexport const QueryPatternsModal = (props: Props) => {\n  const { isOpen, onClose, onChange, onAddQuery, query, queries, app } = props;\n  const [openTabs, setOpenTabs] = useState<string[]>([]);\n  const [selectedPatternName, setSelectedPatternName] = useState<string | null>(null);\n\n  const styles = useStyles2(getStyles);\n  const hasNewQueryOption = !!onAddQuery;\n  const hasPreviousQuery = useMemo(() => {\n    const visualQuery = buildVisualQueryFromString(query.expr ?? '');\n    // has anything entered in the query, metric, labels, operations, or binary queries\n    const hasOperations = visualQuery.query.operations.length > 0,\n      hasMetric = visualQuery.query.metric,\n      hasLabels = visualQuery.query.labels.length > 0,\n      hasBinaryQueries = visualQuery.query.binaryQueries ? visualQuery.query.binaryQueries.length > 0 : false;\n\n    return hasOperations || hasMetric || hasLabels || hasBinaryQueries;\n  }, [query.expr]);\n\n  const onPatternSelect = (pattern: PromQueryPattern, selectAsNewQuery = false) => {\n    const visualQuery = buildVisualQueryFromString(selectAsNewQuery ? '' : query.expr);\n    reportInteraction('grafana_prom_kickstart_your_query_selected', {\n      app: app ?? '',\n      editorMode: query.editorMode,\n      selectedPattern: pattern.name,\n      preSelectedOperationsCount: visualQuery.query.operations.length,\n      preSelectedLabelsCount: visualQuery.query.labels.length,\n      createNewQuery: hasNewQueryOption && selectAsNewQuery,\n    });\n\n    visualQuery.query.operations = pattern.operations;\n    visualQuery.query.binaryQueries = pattern.binaryQueries;\n    if (hasNewQueryOption && selectAsNewQuery) {\n      onAddQuery({\n        ...query,\n        refId: getNextRefIdChar(queries ?? [query]),\n        expr: promQueryModeller.renderQuery(visualQuery.query),\n      });\n    } else {\n      onChange({\n        ...query,\n        expr: promQueryModeller.renderQuery(visualQuery.query),\n      });\n    }\n    setSelectedPatternName(null);\n    onClose();\n  };\n\n  return (\n    <Modal aria-label=\"Kick start your query modal\" isOpen={isOpen} title=\"Kick start your query\" onDismiss={onClose}>\n      <div className={styles.spacing}>\n        Kick start your query by selecting one of these queries. You can then continue to complete your query.\n      </div>\n      {Object.values(PromQueryPatternType).map((patternType) => {\n        return (\n          <Collapse\n            aria-label={`open and close ${patternType} query starter card`}\n            key={patternType}\n            label={`${capitalize(patternType)} query starters`}\n            isOpen={openTabs.includes(patternType)}\n            collapsible={true}\n            onToggle={() =>\n              setOpenTabs((tabs) =>\n                // close tab if it's already open, otherwise open it\n                tabs.includes(patternType) ? tabs.filter((t) => t !== patternType) : [...tabs, patternType]\n              )\n            }\n          >\n            <div className={styles.cardsContainer}>\n              {promQueryModeller\n                .getQueryPatterns()\n                .filter((pattern) => pattern.type === patternType)\n                .map((pattern) => (\n                  <QueryPattern\n                    key={pattern.name}\n                    pattern={pattern}\n                    hasNewQueryOption={hasNewQueryOption}\n                    hasPreviousQuery={hasPreviousQuery}\n                    onPatternSelect={onPatternSelect}\n                    selectedPatternName={selectedPatternName}\n                    setSelectedPatternName={setSelectedPatternName}\n                  />\n                ))}\n            </div>\n          </Collapse>\n        );\n      })}\n      <Button aria-label=\"close kick start your query modal\" variant=\"secondary\" onClick={onClose}>\n        Close\n      </Button>\n    </Modal>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    cardsContainer: css`\n      display: flex;\n      flex-direction: row;\n      flex-wrap: wrap;\n      justify-content: space-between;\n    `,\n    spacing: css`\n      margin-bottom: ${theme.spacing(1)};\n    `,\n  };\n};\n","import { CoreApp } from '@grafana/data';\nimport store from 'app/core/store';\n\nimport { LegendFormatMode, PromQuery } from '../types';\n\nimport { QueryEditorMode } from './shared/types';\n\nconst queryEditorModeDefaultLocalStorageKey = 'PrometheusQueryEditorModeDefault';\n\nexport function changeEditorMode(query: PromQuery, editorMode: QueryEditorMode, onChange: (query: PromQuery) => void) {\n  // If empty query store new mode as default\n  if (query.expr === '') {\n    store.set(queryEditorModeDefaultLocalStorageKey, editorMode);\n  }\n\n  onChange({ ...query, editorMode });\n}\n\nfunction getDefaultEditorMode(expr: string, defaultEditor: QueryEditorMode = QueryEditorMode.Builder): QueryEditorMode {\n  // If we already have an expression default to code view\n  if (expr != null && expr !== '') {\n    return QueryEditorMode.Code;\n  }\n\n  const value: QueryEditorMode = store.get(queryEditorModeDefaultLocalStorageKey);\n  switch (value) {\n    case QueryEditorMode.Builder:\n    case QueryEditorMode.Code:\n      return value;\n    default:\n      return defaultEditor;\n  }\n}\n\n/**\n * Returns query with defaults, and boolean true/false depending on change was required\n */\nexport function getQueryWithDefaults(\n  query: PromQuery & { expr?: string },\n  app: CoreApp | undefined,\n  defaultEditor?: QueryEditorMode\n): PromQuery {\n  let result = query;\n\n  if (!query.editorMode) {\n    result = { ...query, editorMode: getDefaultEditorMode(query.expr, defaultEditor) };\n  }\n\n  // default query expr is now empty string, set in getDefaultQuery\n  // While expr is required in the types, it is not always defined at runtime, so we need to check for undefined and default to an empty string to prevent runtime errors\n  if (!query.expr) {\n    result = { ...result, expr: '', legendFormat: LegendFormatMode.Auto };\n  }\n\n  if (query.range == null && query.instant == null) {\n    // Default to range query\n    result = { ...result, range: true };\n\n    // In explore we default to both instant & range\n    if (app === CoreApp.Explore) {\n      result.instant = true;\n    }\n  }\n\n  // Unified Alerting does not support \"both\" for query type  fall back to \"range\".\n  const isBothInstantAndRange = query.instant && query.range;\n  if (app === CoreApp.UnifiedAlerting && isBothInstantAndRange) {\n    result = { ...result, instant: false, range: true };\n  }\n\n  return result;\n}\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2, toOption } from '@grafana/data';\nimport { EditorRows, FlexItem } from '@grafana/experimental';\nimport { AutoSizeInput, IconButton, Select, useStyles2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { binaryScalarDefs } from '../binaryScalarOperations';\nimport { PromVisualQueryBinary } from '../types';\n\nimport { PromQueryBuilder } from './PromQueryBuilder';\n\nexport interface Props {\n  nestedQuery: PromVisualQueryBinary;\n  datasource: PrometheusDatasource;\n  index: number;\n  onChange: (index: number, update: PromVisualQueryBinary) => void;\n  onRemove: (index: number) => void;\n  onRunQuery: () => void;\n  showExplain: boolean;\n}\n\nexport const NestedQuery = React.memo<Props>((props) => {\n  const { nestedQuery, index, datasource, onChange, onRemove, onRunQuery, showExplain } = props;\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.card}>\n      <div className={styles.header}>\n        <div className={styles.name}>Operator</div>\n        <Select\n          width=\"auto\"\n          options={operators}\n          value={toOption(nestedQuery.operator)}\n          onChange={(value) => {\n            onChange(index, {\n              ...nestedQuery,\n              operator: value.value!,\n            });\n          }}\n        />\n        <div className={styles.name}>Vector matches</div>\n        <div className={styles.vectorMatchWrapper}>\n          <Select<PromVisualQueryBinary['vectorMatchesType']>\n            width=\"auto\"\n            value={nestedQuery.vectorMatchesType || 'on'}\n            allowCustomValue\n            options={[\n              { value: 'on', label: 'on' },\n              { value: 'ignoring', label: 'ignoring' },\n            ]}\n            onChange={(val) => {\n              onChange(index, {\n                ...nestedQuery,\n                vectorMatchesType: val.value,\n              });\n            }}\n          />\n          <AutoSizeInput\n            className={styles.vectorMatchInput}\n            minWidth={20}\n            defaultValue={nestedQuery.vectorMatches}\n            onCommitChange={(evt) => {\n              onChange(index, {\n                ...nestedQuery,\n                vectorMatches: evt.currentTarget.value,\n                vectorMatchesType: nestedQuery.vectorMatchesType || 'on',\n              });\n            }}\n          />\n        </div>\n        <FlexItem grow={1} />\n        <IconButton name=\"times\" size=\"sm\" onClick={() => onRemove(index)} tooltip=\"Remove match\" />\n      </div>\n      <div className={styles.body}>\n        <EditorRows>\n          <PromQueryBuilder\n            showExplain={showExplain}\n            query={nestedQuery.query}\n            datasource={datasource}\n            onRunQuery={onRunQuery}\n            onChange={(update) => {\n              onChange(index, { ...nestedQuery, query: update });\n            }}\n          />\n        </EditorRows>\n      </div>\n    </div>\n  );\n});\n\nconst operators = binaryScalarDefs.map((def) => ({ label: def.sign, value: def.sign }));\n\nNestedQuery.displayName = 'NestedQuery';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    card: css({\n      label: 'card',\n      display: 'flex',\n      flexDirection: 'column',\n      gap: theme.spacing(0.5),\n    }),\n    header: css({\n      label: 'header',\n      padding: theme.spacing(0.5, 0.5, 0.5, 1),\n      gap: theme.spacing(1),\n      display: 'flex',\n      alignItems: 'center',\n    }),\n    name: css({\n      label: 'name',\n      whiteSpace: 'nowrap',\n    }),\n    body: css({\n      label: 'body',\n      paddingLeft: theme.spacing(2),\n    }),\n    vectorMatchInput: css({\n      label: 'vectorMatchInput',\n      marginLeft: -1,\n    }),\n    vectorMatchWrapper: css({\n      label: 'vectorMatchWrapper',\n      display: 'flex',\n    }),\n  };\n};\n","import React from 'react';\n\nimport { Stack } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { PromVisualQuery, PromVisualQueryBinary } from '../types';\n\nimport { NestedQuery } from './NestedQuery';\n\nexport interface Props {\n  query: PromVisualQuery;\n  datasource: PrometheusDatasource;\n  onChange: (query: PromVisualQuery) => void;\n  onRunQuery: () => void;\n  showExplain: boolean;\n}\n\nexport function NestedQueryList(props: Props) {\n  const { query, datasource, onChange, onRunQuery, showExplain } = props;\n  const nestedQueries = query.binaryQueries ?? [];\n\n  const onNestedQueryUpdate = (index: number, update: PromVisualQueryBinary) => {\n    const updatedList = [...nestedQueries];\n    updatedList.splice(index, 1, update);\n    onChange({ ...query, binaryQueries: updatedList });\n  };\n\n  const onRemove = (index: number) => {\n    const updatedList = [...nestedQueries.slice(0, index), ...nestedQueries.slice(index + 1)];\n    onChange({ ...query, binaryQueries: updatedList });\n  };\n\n  return (\n    <Stack direction=\"column\" gap={1}>\n      {nestedQueries.map((nestedQuery, index) => (\n        <NestedQuery\n          key={index.toString()}\n          nestedQuery={nestedQuery}\n          index={index}\n          onChange={onNestedQueryUpdate}\n          datasource={datasource}\n          onRemove={onRemove}\n          onRunQuery={onRunQuery}\n          showExplain={showExplain}\n        />\n      ))}\n    </Stack>\n  );\n}\n","import { cx } from '@emotion/css';\nimport React, { FormEvent, useState } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, RadioButtonList, Spinner, TextArea, Toggletip, useTheme2 } from '@grafana/ui';\n\nimport { buildVisualQueryFromString } from '../../parsing';\nimport { PromVisualQuery } from '../../types';\n\nimport { getStyles } from './PromQail';\nimport { QuerySuggestion } from './types';\n\nexport type Props = {\n  querySuggestion: QuerySuggestion;\n  order: number;\n  queryExplain: (idx: number) => void;\n  historical: boolean;\n  onChange: (query: PromVisualQuery) => void;\n  closeDrawer: () => void;\n  last: boolean;\n  prompt: string;\n  allSuggestions: string | undefined;\n};\n\nconst suggestionOptions: SelectableValue[] = [\n  { label: 'Yes', value: 'yes' },\n  { label: 'No', value: 'no' },\n];\nconst explationOptions: SelectableValue[] = [\n  { label: 'Too vague', value: 'too vague' },\n  { label: 'Too technical', value: 'too technical' },\n  { label: 'Inaccurate', value: 'inaccurate' },\n  { label: 'Other', value: 'other' },\n];\n\nexport function QuerySuggestionItem(props: Props) {\n  const { querySuggestion, order, queryExplain, historical, onChange, closeDrawer, last, allSuggestions, prompt } =\n    props;\n  const [showExp, updShowExp] = useState<boolean>(false);\n\n  const [gaveExplanationFeedback, updateGaveExplanationFeedback] = useState<boolean>(false);\n  const [gaveSuggestionFeedback, updateGaveSuggestionFeedback] = useState<boolean>(false);\n\n  const [suggestionFeedback, setSuggestionFeedback] = useState({\n    radioInput: '',\n    text: '',\n  });\n\n  const [explanationFeedback, setExplanationFeedback] = useState({\n    radioInput: '',\n    text: '',\n  });\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  const { query, explanation } = querySuggestion;\n\n  const feedbackToggleTip = (type: string) => {\n    const updateRadioFeedback = (value: string) => {\n      if (type === 'explanation') {\n        setExplanationFeedback({\n          ...explanationFeedback,\n          radioInput: value,\n        });\n      } else {\n        setSuggestionFeedback({\n          ...suggestionFeedback,\n          radioInput: value,\n        });\n      }\n    };\n\n    const updateTextFeedback = (e: FormEvent<HTMLTextAreaElement>) => {\n      if (type === 'explanation') {\n        setExplanationFeedback({\n          ...explanationFeedback,\n          text: e.currentTarget.value,\n        });\n      } else {\n        setSuggestionFeedback({\n          ...suggestionFeedback,\n          text: e.currentTarget.value,\n        });\n      }\n    };\n\n    const disabledButton = () =>\n      type === 'explanation' ? !explanationFeedback.radioInput : !suggestionFeedback.radioInput;\n\n    const questionOne =\n      type === 'explanation' ? 'Why was the explanation not helpful?' : 'Were the query suggestions helpful?';\n\n    return (\n      <div className={styles.suggestionFeedback}>\n        <div>\n          <div className={styles.feedbackQuestion}>\n            <h6>{questionOne}</h6>\n            <i>(Required)</i>\n          </div>\n          <RadioButtonList\n            name=\"default\"\n            options={type === 'explanation' ? explationOptions : suggestionOptions}\n            value={type === 'explanation' ? explanationFeedback.radioInput : suggestionFeedback.radioInput}\n            onChange={updateRadioFeedback}\n          />\n        </div>\n        <div className={cx(type === 'explanation' && styles.explationTextInput)}>\n          {type !== 'explanation' && (\n            <div className={styles.feedbackQuestion}>\n              <h6>How can we improve the query suggestions?</h6>\n            </div>\n          )}\n          <TextArea\n            type=\"text\"\n            aria-label=\"Promqail suggestion text\"\n            placeholder=\"Enter your feedback\"\n            value={type === 'explanation' ? explanationFeedback.text : suggestionFeedback.text}\n            onChange={updateTextFeedback}\n            cols={100}\n          />\n        </div>\n\n        <div className={styles.submitFeedback}>\n          <Button\n            variant=\"primary\"\n            size=\"sm\"\n            disabled={disabledButton()}\n            onClick={() => {\n              // submit the rudderstack event\n              if (type === 'explanation') {\n                explanationFeedbackEvent(\n                  explanationFeedback.radioInput,\n                  explanationFeedback.text,\n                  querySuggestion,\n                  historical,\n                  prompt\n                );\n                updateGaveExplanationFeedback(true);\n              } else {\n                suggestionFeedbackEvent(\n                  suggestionFeedback.radioInput,\n                  suggestionFeedback.text,\n                  allSuggestions ?? '',\n                  historical,\n                  prompt\n                );\n                updateGaveSuggestionFeedback(true);\n              }\n            }}\n          >\n            Submit\n          </Button>\n        </div>\n      </div>\n    );\n  };\n\n  return (\n    <>\n      <div className={styles.querySuggestion}>\n        <div title={query} className={cx(styles.codeText, styles.longCode)}>\n          {`${order}.  ${query}`}\n        </div>\n        <div className={styles.useButton}>\n          <Button\n            variant=\"primary\"\n            size=\"sm\"\n            onClick={() => {\n              reportInteraction('grafana_prometheus_promqail_use_query_button_clicked', {\n                query: querySuggestion.query,\n              });\n              const pvq = buildVisualQueryFromString(querySuggestion.query);\n              // check for errors!\n              onChange(pvq.query);\n              closeDrawer();\n            }}\n          >\n            Use\n          </Button>\n        </div>\n      </div>\n      <div>\n        <Button\n          fill=\"text\"\n          variant=\"secondary\"\n          icon={showExp ? 'angle-up' : 'angle-down'}\n          onClick={() => {\n            updShowExp(!showExp);\n            queryExplain(order - 1);\n          }}\n          className={cx(styles.bodySmall)}\n          size=\"sm\"\n        >\n          Explainer\n        </Button>\n        {!showExp && order !== 5 && <div className={styles.textPadding}></div>}\n\n        {showExp && !querySuggestion.explanation && (\n          <div className={styles.center}>\n            <Spinner />\n          </div>\n        )}\n        {showExp && querySuggestion.explanation && (\n          <>\n            <div className={cx(styles.bodySmall, styles.explainPadding)}>\n              <div className={styles.textPadding}>This query is trying to answer the question:</div>\n              <div className={styles.textPadding}>{explanation}</div>\n              <div className={styles.textPadding}>\n                Learn more with this{' '}\n                <a\n                  className={styles.doc}\n                  href={'https://prometheus.io/docs/prometheus/latest/querying/examples/#query-examples'}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                >\n                  Prometheus doc\n                </a>\n              </div>\n\n              <div className={cx(styles.rightButtons, styles.secondaryText)}>\n                Was this explanation helpful?\n                <div className={styles.floatRight}>\n                  {!gaveExplanationFeedback ? (\n                    <>\n                      <Button\n                        fill=\"outline\"\n                        variant=\"secondary\"\n                        size=\"sm\"\n                        className={styles.leftButton}\n                        onClick={() => {\n                          explanationFeedbackEvent('Yes', '', querySuggestion, historical, prompt);\n                          updateGaveExplanationFeedback(true);\n                        }}\n                      >\n                        Yes\n                      </Button>\n                      <Toggletip\n                        aria-label=\"Suggestion feedback\"\n                        content={feedbackToggleTip('explanation')}\n                        placement=\"bottom-end\"\n                        closeButton={true}\n                      >\n                        <Button variant=\"success\" size=\"sm\">\n                          No\n                        </Button>\n                      </Toggletip>\n                    </>\n                  ) : (\n                    'Thank you for your feedback!'\n                  )}\n                </div>\n              </div>\n            </div>\n\n            {!last && <hr />}\n          </>\n        )}\n        {last && (\n          <div className={cx(styles.feedbackStyle)}>\n            {!gaveSuggestionFeedback ? (\n              <Toggletip\n                aria-label=\"Suggestion feedback\"\n                content={feedbackToggleTip('suggestion')}\n                placement=\"bottom-end\"\n                closeButton={true}\n              >\n                <Button fill=\"outline\" variant=\"secondary\" size=\"sm\">\n                  Give feedback on suggestions\n                </Button>\n              </Toggletip>\n            ) : (\n              // do this weird thing because the toggle tip doesn't allow an extra close function\n              <Button fill=\"outline\" variant=\"secondary\" size=\"sm\" disabled={true}>\n                Thank you for your feedback!\n              </Button>\n            )}\n          </div>\n        )}\n      </div>\n    </>\n  );\n}\n\nfunction explanationFeedbackEvent(\n  radioInputFeedback: string,\n  textFeedback: string,\n  querySuggestion: QuerySuggestion,\n  historical: boolean,\n  prompt: string\n) {\n  const event = 'grafana_prometheus_promqail_explanation_feedback';\n\n  reportInteraction(event, {\n    helpful: radioInputFeedback,\n    textFeedback: textFeedback,\n    suggestionType: historical ? 'historical' : 'AI',\n    query: querySuggestion.query,\n    explanation: querySuggestion.explanation,\n    prompt: prompt,\n  });\n}\n\nfunction suggestionFeedbackEvent(\n  radioInputFeedback: string,\n  textFeedback: string,\n  allSuggestions: string,\n  historical: boolean,\n  prompt: string\n) {\n  const event = 'grafana_prometheus_promqail_suggestion_feedback';\n\n  reportInteraction(event, {\n    helpful: radioInputFeedback,\n    textFeedback: textFeedback,\n    suggestionType: historical ? 'historical' : 'AI',\n    allSuggestions: allSuggestions,\n    prompt: prompt,\n  });\n}\n","export type QuerySuggestion = {\n  query: string;\n  explanation: string;\n};\n\nexport enum SuggestionType {\n  Historical = 'historical',\n  AI = 'AI',\n}\n\nexport type Interaction = {\n  prompt: string;\n  suggestionType: SuggestionType;\n  suggestions: QuerySuggestion[];\n  isLoading: boolean;\n  explanationIsLoading: boolean;\n};\n","import { cx } from '@emotion/css';\nimport React, { useState } from 'react';\n\nimport { Button, useTheme2 } from '@grafana/ui';\n\nimport { PromVisualQuery } from '../../types';\n\nimport { getStyles, testIds } from './PromQail';\nimport { QuerySuggestionItem } from './QuerySuggestionItem';\nimport { QuerySuggestion, SuggestionType } from './types';\n\nexport type Props = {\n  querySuggestions: QuerySuggestion[];\n  suggestionType: SuggestionType;\n  closeDrawer: () => void;\n  nextInteraction: () => void;\n  queryExplain: (idx: number) => void;\n  onChange: (query: PromVisualQuery) => void;\n  prompt: string;\n};\n\nexport function QuerySuggestionContainer(props: Props) {\n  const { suggestionType, querySuggestions, closeDrawer, nextInteraction, queryExplain, onChange, prompt } = props;\n\n  const [hasNextInteraction, updateHasNextInteraction] = useState<boolean>(false);\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  let text, secondaryText, refineText;\n\n  if (suggestionType === SuggestionType.Historical) {\n    text = `Here are ${querySuggestions.length} query suggestions:`;\n    secondaryText = 'These queries are based off of historical data (top used queries) for your metric.';\n    refineText = 'I want to write a prompt';\n  } else if (suggestionType === SuggestionType.AI) {\n    text = text = 'Here is your query suggestion:';\n    secondaryText =\n      'This query is based off of natural language descriptions of the most commonly used PromQL queries.';\n    refineText = 'Refine prompt';\n  }\n\n  return (\n    <>\n      <div className={styles.textPadding}>{text}</div>\n      <div className={cx(styles.secondaryText, styles.bottomMargin)}>{secondaryText}</div>\n      <div className={styles.infoContainerWrapper}>\n        <div className={styles.infoContainer}>\n          {querySuggestions.map((qs: QuerySuggestion, idx: number) => {\n            return (\n              <QuerySuggestionItem\n                historical={suggestionType === SuggestionType.Historical}\n                querySuggestion={qs}\n                key={idx}\n                order={idx + 1}\n                queryExplain={queryExplain}\n                onChange={onChange}\n                closeDrawer={closeDrawer}\n                last={idx === querySuggestions.length - 1}\n                // for feedback rudderstack events\n                allSuggestions={querySuggestions.reduce((acc: string, qs: QuerySuggestion) => {\n                  return acc + '$$' + qs.query;\n                }, '')}\n                prompt={prompt ?? ''}\n              />\n            );\n          })}\n        </div>\n      </div>\n      {!hasNextInteraction && (\n        <div className={styles.nextInteractionHeight}>\n          <div className={cx(styles.afterButtons, styles.textPadding)}>\n            <Button\n              onClick={() => {\n                updateHasNextInteraction(true);\n                nextInteraction();\n              }}\n              data-testid={testIds.refinePrompt}\n              fill=\"outline\"\n              variant=\"secondary\"\n              size=\"md\"\n            >\n              {refineText}\n            </Button>\n          </div>\n          <div className={cx(styles.textPadding, styles.floatRight)}>\n            <Button fill=\"outline\" variant=\"secondary\" size=\"md\" onClick={closeDrawer}>\n              Cancel\n            </Button>\n          </div>\n        </div>\n      )}\n    </>\n  );\n}\n","import { getBackendSrv, logDebug } from '@grafana/runtime';\nimport { LLM_PLUGIN_ROUTE, setLLMPluginVersion } from './constants.js';\n\nasync function search(request) {\n  const response = await getBackendSrv().post(\"/api/plugins/grafana-llm-app/resources/vector/search\", request, {\n    headers: { \"Content-Type\": \"application/json\" }\n  });\n  return response.results;\n}\nlet loggedWarning = false;\nconst enabled = async () => {\n  try {\n    const settings = await getBackendSrv().get(`${LLM_PLUGIN_ROUTE}/settings`, void 0, void 0, {\n      showSuccessAlert: false,\n      showErrorAlert: false\n    });\n    if (!settings.enabled) {\n      return { enabled: false, ok: false, error: \"The Grafana LLM plugin is not enabled.\" };\n    }\n  } catch (e) {\n    logDebug(String(e));\n    logDebug(\"Failed to check if the vector service is enabled. This is expected if the Grafana LLM plugin is not installed, and the above error can be ignored.\");\n    loggedWarning = true;\n    return { enabled: false, ok: false, error: \"The Grafana LLM plugin is not installed.\" };\n  }\n  let response;\n  try {\n    response = await getBackendSrv().get(`${LLM_PLUGIN_ROUTE}/health`, void 0, void 0, {\n      showSuccessAlert: false,\n      showErrorAlert: false\n    });\n  } catch (e) {\n    if (!loggedWarning) {\n      logDebug(String(e));\n      logDebug(\"Failed to check if vector service is enabled. This is expected if the Grafana LLM plugin is not installed, and the above error can be ignored.\");\n      loggedWarning = true;\n    }\n    return { enabled: false, ok: false, error: \"The Grafana LLM plugin is not installed.\" };\n  }\n  const { details } = response;\n  if ((details == null ? void 0 : details.version) !== void 0) {\n    setLLMPluginVersion(details.version);\n  }\n  if ((details == null ? void 0 : details.vector) === void 0) {\n    return { enabled: false, ok: false, error: \"The Grafana LLM plugin is outdated; please update it.\" };\n  }\n  return typeof details.vector === \"boolean\" ? { enabled: details.vector, ok: details.vector } : details.vector;\n};\n\nexport { enabled, search };\n//# sourceMappingURL=vector.js.map\n","export const ExplainSystemPrompt = `You are an expert in Prometheus, the event monitoring and alerting application.\n\nYou are given relevant PromQL documentation, a type and description for a Prometheus metric, and a PromQL query on that metric. Using the provided information for reference, please explain what the output of a given query is in 1 sentences. Do not walk through what the functions do separately, make your answer concise. \n\nInput will be in the form:\n\n\nPromQL Documentation:\n<PromQL documentation>\n\nPromQL Metrics Metadata:\n<metric_name>(<metric type of the metric queried>): <description of what the metric means>\n\nPromQL Expression: \n<PromQL query>\n\nExamples of input and output\n----------\nPromQL Documentation:\nA counter is a cumulative metric that represents a single monotonically increasing counter whose value can only increase or be reset to zero on restart. For example, you can use a counter to represent the number of requests served, tasks completed, or errors.\ntopk (largest k elements by sample value)\nsum (calculate sum over dimensions)\nrate(v range-vector) calculates the per-second average rate of increase of the time series in the range vector. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for. \n\nPromQL Metrics Metadata:\ntraces_exporter_sent_spans(counter): Number of spans successfully sent to destination.\n\nPromQL Expression:\ntopk(3, sum by(cluster) (rate(traces_exporter_sent_spans{exporter=\"otlp\"}[5m])))\n\nThis query is trying to answer the question:\nWhat is the top 3 clusters that have successfully sent the most number of spans to the destination?\n`;\n\nexport type ExplainUserPromptParams = {\n  documentation: string;\n  metricName: string;\n  metricType: string;\n  metricMetadata: string;\n  query: string;\n};\n\nexport function GetExplainUserPrompt({\n  documentation,\n  metricName,\n  metricType,\n  metricMetadata,\n  query,\n}: ExplainUserPromptParams): string {\n  if (documentation === '') {\n    documentation = 'No documentation provided.';\n  }\n  if (metricMetadata === '') {\n    metricMetadata = 'No description provided.';\n  }\n  return `\n        PromQL Documentation: \n        ${documentation}\n\n        PromQL Metrics Metadata:\n        ${metricName}(${metricType}): ${metricMetadata}\n\n        PromQL Expression: \n        ${query}\n\n        This query is trying to answer the question:\n    `;\n}\n\nexport const SuggestSystemPrompt = `You are a Prometheus Query Language (PromQL) expert assistant inside Grafana.\nWhen the user asks a question, respond with a valid PromQL query and only the query.\n\nTo help you answer the question, you will receive:\n- List of potentially relevant PromQL templates with descriptions, ranked by semantic search score\n- Prometheus metric\n- Metric type\n- Available Prometheus metric labels\n- User question\n\nPolicy:\n- Do not invent labels names, you can only use the available labels\n- For rate queries, use the $__rate_interval variable`;\n\n// rewrite with a type\nexport type SuggestUserPromptParams = {\n  promql: string;\n  question: string;\n  metricType: string;\n  labels: string;\n  templates: string;\n};\n\nexport function GetSuggestUserPrompt({\n  promql,\n  question,\n  metricType,\n  labels,\n  templates,\n}: SuggestUserPromptParams): string {\n  if (templates === '') {\n    templates = 'No templates provided.';\n  } else {\n    templates = templates.replace(/\\n/g, '\\n  ');\n  }\n  return `Relevant PromQL templates:\n  ${templates}\n  \n  Prometheus metric: ${promql}\n  Metric type: ${metricType}\n  Available Prometheus metric labels: ${labels}\n  User question: ${question}\n  \n  \\`\\`\\`promql`;\n}\n","import { createSlice, PayloadAction } from '@reduxjs/toolkit';\n\nimport { PromVisualQuery } from '../../../types';\nimport { Interaction, SuggestionType } from '../types';\n\nexport const stateSlice = createSlice({\n  name: 'metrics-modal-state',\n  initialState: initialState(),\n  reducers: {\n    showExplainer: (state, action: PayloadAction<boolean>) => {\n      state.showExplainer = action.payload;\n    },\n    showStartingMessage: (state, action: PayloadAction<boolean>) => {\n      state.showStartingMessage = action.payload;\n    },\n    indicateCheckbox: (state, action: PayloadAction<boolean>) => {\n      state.indicateCheckbox = action.payload;\n    },\n    askForQueryHelp: (state, action: PayloadAction<boolean>) => {\n      state.askForQueryHelp = action.payload;\n    },\n    /*\n     * start working on a collection of interactions\n     * {\n     *  askForhelp y n\n     *  prompt question\n     *  queries querySuggestions\n     * }\n     *\n     */\n    addInteraction: (state, action: PayloadAction<{ suggestionType: SuggestionType; isLoading: boolean }>) => {\n      // AI or Historical?\n      const interaction = createInteraction(action.payload.suggestionType, action.payload.isLoading);\n      const interactions = state.interactions;\n      state.interactions = interactions.concat([interaction]);\n    },\n    updateInteraction: (state, action: PayloadAction<{ idx: number; interaction: Interaction }>) => {\n      // update the interaction by index\n      // will most likely be the last interaction but we might update previous by giving them cues of helpful or not\n      const index = action.payload.idx;\n      const updInteraction = action.payload.interaction;\n\n      state.interactions = state.interactions.map((interaction: Interaction, idx: number) => {\n        if (idx === index) {\n          return updInteraction;\n        }\n\n        return interaction;\n      });\n    },\n  },\n});\n\n/**\n * Initial state for PromQAIL\n * @param query the prometheus query with metric and possible labels\n */\nexport function initialState(query?: PromVisualQuery, showStartingMessage?: boolean): PromQailState {\n  return {\n    query: query ?? {\n      metric: '',\n      labels: [],\n      operations: [],\n    },\n    showExplainer: false,\n    showStartingMessage: showStartingMessage ?? true,\n    indicateCheckbox: false,\n    askForQueryHelp: false,\n    interactions: [],\n  };\n}\n\n/**\n * The PromQAIL state object\n */\nexport interface PromQailState {\n  query: PromVisualQuery;\n  showExplainer: boolean;\n  showStartingMessage: boolean;\n  indicateCheckbox: boolean;\n  askForQueryHelp: boolean;\n  interactions: Interaction[];\n}\n\nexport function createInteraction(suggestionType: SuggestionType, isLoading?: boolean): Interaction {\n  return {\n    suggestionType: suggestionType,\n    prompt: '',\n    suggestions: [],\n    isLoading: isLoading ?? false,\n    explanationIsLoading: false,\n  };\n}\n","import { QuerySuggestion } from '../types';\n\ninterface TemplateData {\n  template: string;\n  description: string;\n}\n\nexport const generalTemplates: TemplateData[] = [\n  {\n    template: 'metric_a{}',\n    description: 'Get the data for \"metric_a\"',\n  },\n  {\n    template: 'avg by(c) (metric_a{})',\n    description: 'Average of all series in \"metric_a\" grouped by the label \"c\"',\n  },\n  {\n    template: 'count by(d) (metric_a{})',\n    description: 'Number of series in the metric \"metric_a\" grouped by the label \"d\"',\n  },\n  {\n    template: 'sum by(g) (sum_over_time(metric_a{}[1h]))',\n    description:\n      'For each series in the metric \"metric_a\", sum all values over 1 hour, then group those series by label \"g\" and sum.',\n  },\n  {\n    template: 'count(metric_a{})',\n    description: 'Count of series in the metric \"metric_a\"',\n  },\n  {\n    template: '(metric_a{})',\n    description: 'Get the data for \"metric_a\"',\n  },\n  {\n    template: 'count_over_time(metric_a{}[1h])',\n    description: 'Number of series of metric_a in a 1 hour interval',\n  },\n  {\n    template: 'changes(metric_a{}[1m])',\n    description: 'Number of times the values of each series in metric_a have changed in 1 minute periods',\n  },\n  {\n    template: 'count(count by(g) (metric_a{}))',\n    description: 'Total number of series in metric_a',\n  },\n  {\n    template: 'last_over_time(metric_a{}[1h])',\n    description: 'For each series in metric_a, get the last value in the 1 hour period.',\n  },\n  {\n    template: 'sum by(g) (count_over_time(metric_a{}[1h]))',\n    description: 'Grouped sum over the label \"g\" of the number of series of metric_a in a 1 hour period',\n  },\n  {\n    template: 'count(metric_a{} == 99)',\n    description: 'Number of series of metric_a that have value 99',\n  },\n  {\n    template: 'min(metric_a{})',\n    description: 'At each timestamp, find the minimum of all series of the metric \"metric_a\"',\n  },\n  {\n    template: 'metric_a{} != 99',\n    description: 'Series of metric_a which do not have the value 99',\n  },\n  {\n    template: 'metric_a{} - 99',\n    description: 'metric_a minus 99',\n  },\n  {\n    template: 'quantile_over_time(0.99,metric_a{}[1h])',\n    description: 'The 99th quantile of values of metric_a in 1 hour',\n  },\n  {\n    template: 'count_values(\"aaaa\",metric_a{})',\n    description: 'Count number of label values for a label named \"aaaa\"',\n  },\n];\n\nexport const counterTemplates: TemplateData[] = [\n  {\n    template: 'sum by(d) (rate(metric_a{}[1h]))',\n    description:\n      'Sum of the rate of increase or decrease of the metric \"metric_a\" per 1 hour period, grouped by the label \"d\"',\n  },\n  {\n    template: 'rate(metric_a{}[1m])',\n    description: 'Rate of change of the metric \"metric_a\" over 1 minute',\n  },\n  {\n    template: 'sum by(a) (increase(metric_a{}[5m]))',\n    description:\n      'Taking the metric \"metric_a\" find the increase in 5 minute periods of each series and aggregate sum over the label \"a\"',\n  },\n  {\n    template: 'sum(rate(metric_a{}[1m]))',\n    description: 'Total rate of change of all series of metric \"metric_a\" in 1 minute intervals',\n  },\n  {\n    template: 'sum(increase(metric_a{}[10m]))',\n    description: 'Total increase for each series of metric \"metric_a\" in 10 minute intervals',\n  },\n  {\n    template: 'increase(metric_a{}[1h])',\n    description: 'Increase in all series of \"metric_a\" in 1 hour period',\n  },\n  {\n    template: 'sum by(d) (irate(metric_a{}[1h]))',\n    description: 'Sum of detailed rate of change of the metric \"metric_a\" over 1 hour grouped by label \"d\"',\n  },\n  {\n    template: 'irate(metric_a{}[1h])',\n    description: 'Detailed rate of change of the metric \"metric_a\" over 1 hour',\n  },\n  {\n    template: 'avg by(d) (rate(metric_a{}[1h]))',\n    description:\n      'Taking the rate of change of the metric \"metric_a\" in a 1 hour period, group by the label \"d\" and find the average of each group',\n  },\n  {\n    template: 'topk(5,sum by(g) (rate(metric_a{}[1h])))',\n    description: 'Top 5 of the summed groups \"g\" of the rate of change of metric_a',\n  },\n  {\n    template: 'sum(rate(metric_a{}[1h])) / sum(rate(metric_a{}[1h]))',\n    description: 'Relative sums of metric_a with different labels',\n  },\n  {\n    template: 'histogram_quantile(99,rate(metric_a{}[1h]))',\n    description: '99th percentile of the rate of change of metric_a in 1 hour periods',\n  },\n  {\n    template: 'avg(rate(metric_a{}[1m]))',\n    description: 'Average of the rate of all series of metric_a in 1 minute periods',\n  },\n  {\n    template: 'rate(metric_a{}[5m]) > 99',\n    description: 'Show series of metric_a only if their rate over 5 minutes is greater than 99',\n  },\n  {\n    template: 'count by(g) (rate(metric_a{}[1h]))',\n    description: 'Count of series of metric_a over all labels \"g\"',\n  },\n];\n\nexport const histogramTemplates: TemplateData[] = [\n  {\n    template: 'histogram_quantile(99,sum by(le) (rate(metric_a{}[1h])))',\n    description:\n      'Calculate the rate at which the metric \"metric_a\" is increasing or decreasing, summed over each bucket label \"le\", and then calculates the 99th percentile of those rates.',\n  },\n  {\n    template: 'histogram_quantile(99,sum by(g) (metric_a{}))',\n    description: '99th percentile of the sum of metric_a grouped by label \"g\"',\n  },\n  {\n    template: 'histogram_quantile(99,sum by(g) (irate(metric_a{}[1h])))',\n    description: '99th percentile of the grouped by \"g\" sum of the rate of each series in metric_a in an hour',\n  },\n  {\n    template: 'histogram_quantile(99,metric_a{})',\n    description: '99th percentile of metric_a',\n  },\n];\n\nexport const gaugeTemplates: TemplateData[] = [\n  {\n    template: 'sum by(c) (metric_a{})',\n    description: 'Sum the metric \"metric_a\" by each value in label \"c\"',\n  },\n  {\n    template: 'sum(metric_a{})',\n    description: 'Total sum of all the series of the metric named \"metric_a\"',\n  },\n  {\n    template: 'max by(dd) (metric_a{})',\n    description: 'Grouping the series the metric \"metric_a\" by the label \"dd\", get the maximum value of each group',\n  },\n  {\n    template: 'max(metric_a{})',\n    description: 'Maximum value of all series of the metric \"metric_a\" ',\n  },\n  {\n    template: 'avg(metric_a{})',\n    description: 'Average value of all the series of metric \"metric_a\"',\n  },\n  {\n    template: 'metric_a{} > 99',\n    description: 'Show only the series of metric \"metric_a\" which currently have value greater than 99',\n  },\n  {\n    template: 'metric_a{} / 99',\n    description: 'Values for \"metric_a\" all divided by 99',\n  },\n  {\n    template: 'metric_a{} == 99',\n    description: 'Show series of metric_a that have value 99',\n  },\n  {\n    template: 'sum_over_time(metric_a{}[1h])',\n    description: 'Sum each series of metric_a over 1 hour',\n  },\n  {\n    template: 'avg_over_time(metric_a{}[1h])',\n    description: 'Average of each series of metric_a in a 1 hour period',\n  },\n  {\n    template: 'sum(sum_over_time(metric_a{}[1h]))',\n    description: 'Sum of all values in all series in a 1 hour period',\n  },\n  {\n    template: 'delta(metric_a{}[1m])',\n    description: 'Span or delta (maximum - minimum) of values of the metric \"metric_a\" in a 1 minute period. ',\n  },\n  {\n    template: 'avg by(g) (avg_over_time(metric_a{}[1h]))',\n    description:\n      'For 1 hour, take each series and find the average, then group by label \"g\" and find the average of each group',\n  },\n  {\n    template: 'max_over_time(metric_a{}[1h])',\n    description: 'Maximum values of each series in metric \"metric_a\" in a 1 hour period',\n  },\n  {\n    template: 'metric_a{} * 99',\n    description: 'Values of metric_a multiplied by 99',\n  },\n  {\n    template: 'metric_a{} < 99',\n    description: 'Series of metric_a that have values less than 99',\n  },\n  {\n    template: 'max by() (max_over_time(metric_a{}[1h]))',\n    description: 'Find maximum value of all series in 1 hour periods',\n  },\n  {\n    template: 'topk(99,metric_a{})',\n    description: 'First 5 series of metric_a that have the highest values',\n  },\n  {\n    template: 'min by(g) (metric_a{})',\n    description: 'Minimum values of the series of metric_a grouped by label \"g\"',\n  },\n  {\n    template: 'topk(10,sum by(g) (metric_a{}))',\n    description: \"Top 10 of the series of metric_a grouped and summed by the label 'g'\",\n  },\n  {\n    template: 'avg(avg_over_time(metric_a{}[1h]))',\n    description: 'Average of all values inside a 1 hour period',\n  },\n  {\n    template: 'quantile by(h) (0.95,metric_a{})',\n    description: 'Calculate 95th percentile of metric_a when aggregated by the label \"h\"',\n  },\n  {\n    template: 'avg by(g) (metric_a{} > 99)',\n    description:\n      'Taking all series of metric_a with value greater than 99, group by label \"g\" and find the average of each group',\n  },\n  {\n    template: 'sum(metric_a{}) / 99',\n    description: 'Sum of all series of metric_a divided by 99',\n  },\n  {\n    template: 'count(sum by(g) (metric_a{}))',\n    description: 'Number of series of metric_a grouped by the label \"g\"',\n  },\n  {\n    template: 'max(max_over_time(metric_a{}[1h]))',\n    description: 'Find the max value of all series of metric_a in a 1 hour period',\n  },\n];\n\nfunction processTemplate(templateData: TemplateData, metric: string, labels: string): QuerySuggestion {\n  return {\n    query: templateData.template.replace('metric_a', metric).replace('{}', labels),\n    explanation: templateData.description.replace('metric_a', metric),\n  };\n}\n\nexport function getTemplateSuggestions(metricName: string, metricType: string, labels: string): QuerySuggestion[] {\n  let templateSuggestions: QuerySuggestion[] = [];\n  switch (metricType) {\n    case 'counter':\n      templateSuggestions = templateSuggestions.concat(\n        counterTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 2)\n      );\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 3)\n      );\n      break;\n    case 'gauge':\n      templateSuggestions = templateSuggestions.concat(\n        gaugeTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 2)\n      );\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 3)\n      );\n      break;\n    case 'histogram':\n      templateSuggestions = templateSuggestions.concat(\n        histogramTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 2)\n      );\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 3)\n      );\n      break;\n    default:\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 5)\n      );\n      break;\n  }\n  return templateSuggestions;\n}\n","import { AnyAction } from 'redux';\n\nimport { llms } from '@grafana/experimental';\nimport { reportInteraction } from '@grafana/runtime';\nimport { PrometheusDatasource } from 'app/plugins/datasource/prometheus/datasource';\nimport { getMetadataHelp, getMetadataType } from 'app/plugins/datasource/prometheus/language_provider';\n\nimport { promQueryModeller } from '../../../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../../../parsing';\nimport { PromVisualQuery } from '../../../types';\nimport {\n  ExplainSystemPrompt,\n  GetExplainUserPrompt,\n  SuggestSystemPrompt,\n  GetSuggestUserPrompt,\n  SuggestUserPromptParams,\n} from '../prompts';\nimport { Interaction, QuerySuggestion, SuggestionType } from '../types';\n\nimport { createInteraction, stateSlice } from './state';\nimport { getTemplateSuggestions } from './templates';\n\nconst OPENAI_MODEL_NAME = 'gpt-3.5-turbo-1106';\nconst promQLTemplatesCollection = 'grafana.promql.templates';\n// actions to update the state\nconst { updateInteraction } = stateSlice.actions;\n\ninterface TemplateSearchResult {\n  description: string | null;\n  metric_type: string | null;\n  promql: string | null;\n}\n\nexport function getExplainMessage(\n  query: string,\n  metric: string,\n  datasource: PrometheusDatasource\n): llms.openai.Message[] {\n  let metricMetadata = '';\n  let metricType = '';\n\n  const pvq = buildVisualQueryFromString(query);\n\n  if (datasource.languageProvider.metricsMetadata) {\n    metricType = getMetadataType(metric, datasource.languageProvider.metricsMetadata) ?? '';\n    metricMetadata = getMetadataHelp(metric, datasource.languageProvider.metricsMetadata) ?? '';\n  }\n\n  const documentationBody = pvq.query.operations\n    .map((op) => {\n      const def = promQueryModeller.getOperationDef(op.id);\n      if (!def) {\n        return '';\n      }\n      const title = def.renderer(op, def, '<expr>');\n      const body = def.explainHandler ? def.explainHandler(op, def) : def.documentation;\n\n      if (!body) {\n        return '';\n      }\n      return `### ${title}:\\n${body}`;\n    })\n    .filter((item) => item !== '')\n    .join('\\n');\n\n  return [\n    { role: 'system', content: ExplainSystemPrompt },\n    {\n      role: 'user',\n      content: GetExplainUserPrompt({\n        documentation: documentationBody,\n        metricName: metric,\n        metricType: metricType,\n        metricMetadata: metricMetadata,\n        query: query,\n      }),\n    },\n  ];\n}\n\nfunction getSuggestMessages({\n  promql,\n  question,\n  metricType,\n  labels,\n  templates,\n}: SuggestUserPromptParams): llms.openai.Message[] {\n  return [\n    { role: 'system', content: SuggestSystemPrompt },\n    { role: 'user', content: GetSuggestUserPrompt({ promql, question, metricType, labels, templates }) },\n  ];\n}\n\n/**\n * Calls the API and adds suggestions to the interaction\n *\n * @param dispatch\n * @param idx\n * @param interaction\n * @returns\n */\nexport async function promQailExplain(\n  dispatch: React.Dispatch<AnyAction>,\n  idx: number,\n  query: PromVisualQuery,\n  interaction: Interaction,\n  suggIdx: number,\n  datasource: PrometheusDatasource\n) {\n  // const enabled = await llms.openai.enabled();\n  // if (!enabled) {\n  //   return false;\n  // }\n\n  const suggestedQuery = interaction.suggestions[suggIdx].query;\n\n  const promptMessages = getExplainMessage(suggestedQuery, query.metric, datasource);\n  const interactionToUpdate = interaction;\n\n  return llms.openai\n    .streamChatCompletions({\n      model: OPENAI_MODEL_NAME,\n      messages: promptMessages,\n      temperature: 0,\n    })\n    .pipe(llms.openai.accumulateContent())\n    .subscribe((response) => {\n      const updatedSuggestions = interactionToUpdate.suggestions.map((sg: QuerySuggestion, sidx: number) => {\n        if (suggIdx === sidx) {\n          return {\n            query: interactionToUpdate.suggestions[suggIdx].query,\n            explanation: response,\n          };\n        }\n\n        return sg;\n      });\n\n      const payload = {\n        idx,\n        interaction: {\n          ...interactionToUpdate,\n          suggestions: updatedSuggestions,\n          explanationIsLoading: false,\n        },\n      };\n      dispatch(updateInteraction(payload));\n    });\n}\n\n/**\n * Check if sublist is fully contained in the superlist\n *\n * @param sublist\n * @param superlist\n * @returns true if fully contained, else false\n */\nfunction isContainedIn(sublist: string[], superlist: string[]): boolean {\n  for (const item of sublist) {\n    if (!superlist.includes(item)) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Guess the type of a metric, based on its name and its relation to other metrics available\n *\n * @param metric     - name of metric whose type to guess\n * @param allMetrics - list of all available metrics\n * @returns          - the guess of the type (string): counter,gauge,summary,histogram,'histogram,summary'\n */\nexport function guessMetricType(metric: string, allMetrics: string[]): string {\n  const synthetic_metrics = new Set<string>([\n    'up',\n    'scrape_duration_seconds',\n    'scrape_samples_post_metric_relabeling',\n    'scrape_series_added',\n    'scrape_samples_scraped',\n    'ALERTS',\n    'ALERTS_FOR_STATE',\n  ]);\n\n  if (synthetic_metrics.has(metric)) {\n    // these are all known to be counters\n    return 'counter';\n  }\n  if (metric.startsWith(':')) {\n    // probably recording rule\n    return 'gauge';\n  }\n  if (metric.endsWith('_info')) {\n    // typically series of 1s only, the labels are the useful part. TODO: add 'info' type\n    return 'counter';\n  }\n\n  if (metric.endsWith('_created') || metric.endsWith('_total')) {\n    // prometheus naming style recommends counters to have these suffixes.\n    return 'counter';\n  }\n\n  const underscoreIndex = metric.lastIndexOf('_');\n  if (underscoreIndex < 0) {\n    // No underscores in the name at all, very little info to go on. Guess\n    return 'gauge';\n  }\n\n  // See if the suffix is histogram-y or summary-y\n  const [root, suffix] = [metric.slice(0, underscoreIndex), metric.slice(underscoreIndex + 1)];\n\n  if (['bucket', 'count', 'sum'].includes(suffix)) {\n    // Might be histogram + summary\n    let familyMetrics = [`${root}_bucket`, `${root}_count`, `${root}_sum`, root];\n    if (isContainedIn(familyMetrics, allMetrics)) {\n      return 'histogram,summary';\n    }\n\n    // Might be a histogram, if so all these metrics should exist too:\n    familyMetrics = [`${root}_bucket`, `${root}_count`, `${root}_sum`];\n    if (isContainedIn(familyMetrics, allMetrics)) {\n      return 'histogram';\n    }\n\n    // Or might be a summary\n    familyMetrics = [`${root}_sum`, `${root}_count`, root];\n    if (isContainedIn(familyMetrics, allMetrics)) {\n      return 'summary';\n    }\n\n    // Otherwise it's probably just a counter!\n    return 'counter';\n  }\n\n  // One case above doesn't catch: summary or histogram,summary where the non-suffixed metric is chosen\n  const familyMetrics = [`${metric}_sum`, `${metric}_count`, metric];\n  if (isContainedIn(familyMetrics, allMetrics)) {\n    if (allMetrics.includes(`${metric}_bucket`)) {\n      return 'histogram,summary';\n    } else {\n      return 'summary';\n    }\n  }\n\n  // All else fails, guess gauge\n  return 'gauge';\n}\n\n/**\n * Generate a suitable filter structure for the VectorDB call\n * @param types: list of metric types to include in the result\n * @returns the structure to pass to the vectorDB call.\n */\nfunction generateMetricTypeFilters(types: string[]) {\n  return types.map((type) => ({\n    metric_type: {\n      $eq: type,\n    },\n  }));\n}\n\n/**\n * Taking in a metric name, try to guess its corresponding metric _family_ name\n * @param metric name\n * @returns metric family name\n */\nfunction guessMetricFamily(metric: string): string {\n  if (metric.endsWith('_bucket') || metric.endsWith('_count') || metric.endsWith('_sum')) {\n    return metric.slice(0, metric.lastIndexOf('_'));\n  }\n  return metric;\n}\n\n/**\n * Check if the LLM plugin is enabled.\n * @returns true if the LLM plugin is enabled.\n */\nexport async function isLLMPluginEnabled(): Promise<boolean> {\n  // Check if the LLM plugin is enabled.\n  // If not, we won't be able to make requests, so return early.\n  const openaiEnabled = llms.openai.enabled().then((response) => response.ok);\n  const vectorEnabled = llms.vector.enabled().then((response) => response.ok);\n  // combine 2 promises\n  return Promise.all([openaiEnabled, vectorEnabled]).then((results) => {\n    return results.every((result) => result);\n  });\n}\n\n/**\n * Calls the API and adds suggestions to the interaction\n *\n * @param dispatch\n * @param idx\n * @param interaction\n * @returns\n */\nexport async function promQailSuggest(\n  dispatch: React.Dispatch<AnyAction>,\n  idx: number,\n  query: PromVisualQuery,\n  labelNames: string[],\n  datasource: PrometheusDatasource,\n  interaction?: Interaction\n) {\n  // when you're not running promqail\n  // @ts-ignore llms types issue\n  const check = await isLLMPluginEnabled();\n\n  const interactionToUpdate = interaction ? interaction : createInteraction(SuggestionType.Historical);\n\n  // Decide metric type\n  let metricType = '';\n  // Makes sure we loaded the metadata for metrics. Usually this is done in the start() method of the\n  // provider but we only need the metadata here.\n  if (!datasource.languageProvider.metricsMetadata) {\n    await datasource.languageProvider.loadMetricsMetadata();\n  }\n  if (datasource.languageProvider.metricsMetadata) {\n    // `datasource.languageProvider.metricsMetadata` is a list of metric family names (with desired type)\n    // from the datasource metadata endoint, but unfortunately the expanded _sum, _count, _bucket raw\n    // metric names are also generated and populating this list (all of type counter). We want the metric\n    // family type, so need to guess the metric family name from the chosen metric name, and test if that\n    // metric family has a type specified.\n    const metricFamilyGuess = guessMetricFamily(query.metric);\n    metricType = getMetadataType(metricFamilyGuess, datasource.languageProvider.metricsMetadata) ?? '';\n  }\n  if (metricType === '') {\n    // fallback to heuristic guess\n    metricType = guessMetricType(query.metric, datasource.languageProvider.metrics);\n  }\n\n  if (!check || interactionToUpdate.suggestionType === SuggestionType.Historical) {\n    return new Promise<void>((resolve) => {\n      return setTimeout(() => {\n        const suggestions = getTemplateSuggestions(\n          query.metric,\n          metricType,\n          promQueryModeller.renderLabels(query.labels)\n        );\n\n        const payload = {\n          idx,\n          interaction: { ...interactionToUpdate, suggestions: suggestions, isLoading: false },\n        };\n        dispatch(updateInteraction(payload));\n        resolve();\n      }, 1000);\n    });\n  } else {\n    type SuggestionBody = {\n      metric: string;\n      labels: string;\n      prompt?: string;\n    };\n\n    // get all available labels\n    const metricLabels = await datasource.languageProvider.fetchSeriesLabelsMatch(query.metric);\n\n    let feedTheAI: SuggestionBody = {\n      metric: query.metric,\n      // drop __name__ label because it's not useful\n      labels: Object.keys(metricLabels)\n        .filter((label) => label !== '__name__')\n        .join(','),\n    };\n\n    // @ts-ignore llms types issue\n    let results: Array<llms.vector.SearchResult<TemplateSearchResult>> = [];\n    if (interaction?.suggestionType === SuggestionType.AI) {\n      feedTheAI = { ...feedTheAI, prompt: interaction.prompt };\n\n      // @ts-ignore llms types issue\n      results = await llms.vector.search<TemplateSearchResult>({\n        query: interaction.prompt,\n        collection: promQLTemplatesCollection,\n        topK: 5,\n        filter: {\n          $or: generateMetricTypeFilters(metricType.split(',').concat(['*'])),\n        },\n      });\n      reportInteraction('grafana_prometheus_promqail_vector_results', {\n        metric: query.metric,\n        prompt: interaction.prompt,\n        results: results,\n      });\n      // TODO: handle errors from vector search\n    }\n\n    const resultsString = results\n      .map((r) => {\n        return `${r.payload.promql} | ${r.payload.description} (score=${(r.score * 100).toFixed(1)})`;\n      })\n      .join('\\n');\n\n    const promptMessages = getSuggestMessages({\n      promql: query.metric,\n      question: interaction ? interaction.prompt : '',\n      metricType: metricType,\n      labels: labelNames.join(', '),\n      templates: resultsString,\n    });\n\n    return llms.openai\n      .streamChatCompletions({\n        model: OPENAI_MODEL_NAME,\n        messages: promptMessages,\n        temperature: 0.5,\n      })\n      .pipe(llms.openai.accumulateContent())\n      .subscribe((response) => {\n        const payload = {\n          idx,\n          interaction: {\n            ...interactionToUpdate,\n            suggestions: [\n              {\n                query: response,\n                explanation: '',\n              },\n            ],\n            isLoading: false,\n          },\n        };\n        dispatch(updateInteraction(payload));\n      });\n  }\n}\n","import { css, cx } from '@emotion/css';\nimport React, { useEffect, useReducer, useRef, useState } from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, Checkbox, Input, Spinner, useTheme2 } from '@grafana/ui';\nimport store from 'app/core/store';\n\nimport { PrometheusDatasource } from '../../../datasource';\nimport { PromVisualQuery } from '../../types';\n\nimport { QuerySuggestionContainer } from './QuerySuggestionContainer';\n// @ts-ignore until we can get these added for icons\nimport AI_Logo_color from './resources/AI_Logo_color.svg';\nimport { promQailExplain, promQailSuggest } from './state/helpers';\nimport { initialState, stateSlice } from './state/state';\nimport { Interaction, SuggestionType } from './types';\n\n// actions to update the state\nconst { showStartingMessage, indicateCheckbox, addInteraction, updateInteraction } = stateSlice.actions;\n\nexport type PromQailProps = {\n  query: PromVisualQuery;\n  closeDrawer: () => void;\n  onChange: (query: PromVisualQuery) => void;\n  datasource: PrometheusDatasource;\n};\n\nconst SKIP_STARTING_MESSAGE = 'SKIP_STARTING_MESSAGE';\n\nexport const PromQail = (props: PromQailProps) => {\n  const { query, closeDrawer, onChange, datasource } = props;\n  const skipStartingMessage = store.getBool(SKIP_STARTING_MESSAGE, false);\n\n  const [state, dispatch] = useReducer(stateSlice.reducer, initialState(query, !skipStartingMessage));\n\n  const [labelNames, setLabelNames] = useState<string[]>([]);\n\n  const suggestions = state.interactions.reduce((acc, int) => acc + int.suggestions.length, 0);\n\n  const responsesEndRef = useRef(null);\n\n  const scrollToBottom = () => {\n    if (responsesEndRef) {\n      // @ts-ignore for React.MutableRefObject\n      responsesEndRef?.current?.scrollIntoView({ behavior: 'smooth' });\n    }\n  };\n\n  useEffect(() => {\n    // only scroll when an interaction has been added or the suggestions have been updated\n    scrollToBottom();\n  }, [state.interactions.length, suggestions]);\n\n  useEffect(() => {\n    const fetchLabels = async () => {\n      let labelsIndex: Record<string, string[]>;\n      if (datasource.hasLabelsMatchAPISupport()) {\n        labelsIndex = await datasource.languageProvider.fetchSeriesLabelsMatch(query.metric);\n      } else {\n        labelsIndex = await datasource.languageProvider.fetchSeriesLabels(query.metric);\n      }\n      setLabelNames(Object.keys(labelsIndex));\n    };\n    fetchLabels();\n  }, [query, datasource]);\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  return (\n    <div className={styles.containerPadding}>\n      {/* Query Advisor */}\n      {/* header */}\n      <div className={styles.header}>\n        <h3>Query advisor</h3>\n        <Button icon=\"times\" fill=\"text\" variant=\"secondary\" onClick={closeDrawer} />\n      </div>\n      {/* Starting message */}\n      <div>\n        <div className={styles.iconSection}>\n          <img src={AI_Logo_color} alt=\"AI logo color\" /> Assistant\n        </div>\n        {state.showStartingMessage ? (\n          <>\n            <div className={styles.textPadding}>\n              This assistant can suggest queries based on your use case and the metric you want to query\n            </div>\n            <div className={styles.textPadding}>\n              The assistant will connect to OpenAI using your API key. The following information will be sent to OpenAI:\n            </div>\n            <div className={styles.dataList}>\n              <ul>\n                <li>Metrics</li>\n                <li>Labels</li>\n                <li>Metrics metadata</li>\n              </ul>\n            </div>\n            <div className={styles.textPadding}>Check with OpenAI to understand how your data is being used.</div>\n            <div>\n              AI-suggested queries may not always be the right one for your use case. Always take a moment to understand\n              the queries before using them.\n            </div>\n\n            {/* don't show this message again, store in localstorage */}\n            <div className={styles.textPadding}>\n              <Checkbox\n                checked={state.indicateCheckbox}\n                value={state.indicateCheckbox}\n                onChange={() => {\n                  const val = store.getBool(SKIP_STARTING_MESSAGE, false);\n                  store.set(SKIP_STARTING_MESSAGE, !val);\n                  dispatch(indicateCheckbox(!val));\n                }}\n                label=\"Don't show this message again\"\n              />\n            </div>\n            <div className={styles.rightButtonsWrapper}>\n              <div className={styles.rightButtons}>\n                <Button className={styles.leftButton} fill=\"outline\" variant=\"secondary\" onClick={closeDrawer}>\n                  Cancel\n                </Button>\n                <Button\n                  fill=\"solid\"\n                  variant=\"primary\"\n                  onClick={() => dispatch(showStartingMessage(false))}\n                  data-testid={testIds.securityInfoButton}\n                >\n                  Continue\n                </Button>\n              </div>\n            </div>\n          </>\n        ) : (\n          <div className={styles.bodySmall}>\n            {/* MAKE THIS TABLE RESPONSIVE */}\n            {/* FIT SUPER LONG METRICS AND LABELS IN HERE */}\n            <div className={styles.textPadding}>Here is the metric you have selected:</div>\n            <div className={styles.infoContainerWrapper}>\n              <div className={styles.infoContainer}>\n                <table className={styles.metricTable}>\n                  <tbody>\n                    <tr>\n                      <td className={styles.metricTableName}>metric</td>\n                      <td className={styles.metricTableValue}>{state.query.metric}</td>\n                      <td>\n                        <Button\n                          fill=\"outline\"\n                          variant=\"secondary\"\n                          onClick={closeDrawer}\n                          className={styles.metricTableButton}\n                          size={'sm'}\n                        >\n                          Choose new metric\n                        </Button>\n                      </td>\n                    </tr>\n                    {state.query.labels.map((label, idx) => {\n                      const text = idx === 0 ? 'labels' : '';\n                      return (\n                        <tr key={`${label.label}-${idx}`}>\n                          <td>{text}</td>\n                          <td className={styles.metricTableValue}>{`${label.label}${label.op}${label.value}`}</td>\n                          <td> </td>\n                        </tr>\n                      );\n                    })}\n                  </tbody>\n                </table>\n              </div>\n            </div>\n\n            {/* Ask if you know what you want to query? */}\n            {!state.askForQueryHelp && state.interactions.length === 0 && (\n              <>\n                <div className={styles.queryQuestion}>Do you know what you want to query?</div>\n                <div className={styles.rightButtonsWrapper}>\n                  <div className={styles.rightButtons}>\n                    <Button\n                      className={styles.leftButton}\n                      fill=\"solid\"\n                      variant=\"secondary\"\n                      data-testid={testIds.clickForHistorical}\n                      onClick={() => {\n                        const isLoading = true;\n                        const suggestionType = SuggestionType.Historical;\n                        dispatch(addInteraction({ suggestionType, isLoading }));\n                        reportInteraction('grafana_prometheus_promqail_know_what_you_want_to_query', {\n                          promVisualQuery: query,\n                          doYouKnow: 'no',\n                        });\n                        promQailSuggest(dispatch, 0, query, labelNames, datasource);\n                      }}\n                    >\n                      No\n                    </Button>\n                    <Button\n                      fill=\"solid\"\n                      variant=\"primary\"\n                      data-testid={testIds.clickForAi}\n                      onClick={() => {\n                        reportInteraction('grafana_prometheus_promqail_know_what_you_want_to_query', {\n                          promVisualQuery: query,\n                          doYouKnow: 'yes',\n                        });\n                        const isLoading = false;\n                        const suggestionType = SuggestionType.AI;\n                        dispatch(addInteraction({ suggestionType, isLoading }));\n                      }}\n                    >\n                      Yes\n                    </Button>\n                  </div>\n                </div>\n              </>\n            )}\n\n            {state.interactions.map((interaction: Interaction, idx: number) => {\n              return (\n                <div key={idx}>\n                  {interaction.suggestionType === SuggestionType.AI ? (\n                    <>\n                      <div className={styles.textPadding}>What kind of data do you want to see with your metric?</div>\n                      <div className={cx(styles.secondaryText, styles.bottomMargin)}>\n                        <div>You do not need to enter in a metric or a label again in the prompt.</div>\n                        <div>Example: I want to monitor request latency, not errors.</div>\n                      </div>\n                      <div className={styles.inputPadding}>\n                        <Input\n                          value={interaction.prompt}\n                          spellCheck={false}\n                          placeholder=\"Enter prompt\"\n                          disabled={interaction.suggestions.length > 0}\n                          onChange={(e) => {\n                            const prompt = e.currentTarget.value;\n\n                            const payload = {\n                              idx: idx,\n                              interaction: { ...interaction, prompt },\n                            };\n\n                            dispatch(updateInteraction(payload));\n                          }}\n                        />\n                      </div>\n                      {interaction.suggestions.length === 0 ? (\n                        interaction.isLoading ? (\n                          <>\n                            <div className={styles.loadingMessageContainer}>\n                              Waiting for OpenAI <Spinner className={styles.floatRight} />\n                            </div>\n                          </>\n                        ) : (\n                          <>\n                            <div className={styles.rightButtonsWrapper}>\n                              <div className={styles.rightButtons}>\n                                <Button\n                                  className={styles.leftButton}\n                                  fill=\"outline\"\n                                  variant=\"secondary\"\n                                  onClick={closeDrawer}\n                                >\n                                  Cancel\n                                </Button>\n                                <Button\n                                  className={styles.leftButton}\n                                  fill=\"outline\"\n                                  variant=\"secondary\"\n                                  onClick={() => {\n                                    // JUST SUGGEST QUERIES AND SHOW THE LIST\n                                    const newInteraction: Interaction = {\n                                      ...interaction,\n                                      suggestionType: SuggestionType.Historical,\n                                      isLoading: true,\n                                    };\n\n                                    const payload = {\n                                      idx: idx,\n                                      interaction: newInteraction,\n                                    };\n\n                                    reportInteraction('grafana_prometheus_promqail_suggest_query_instead', {\n                                      promVisualQuery: query,\n                                    });\n\n                                    dispatch(updateInteraction(payload));\n                                    promQailSuggest(dispatch, idx, query, labelNames, datasource, newInteraction);\n                                  }}\n                                >\n                                  Suggest queries instead\n                                </Button>\n                                <Button\n                                  fill=\"solid\"\n                                  variant=\"primary\"\n                                  data-testid={testIds.submitPrompt + idx}\n                                  onClick={() => {\n                                    const newInteraction: Interaction = {\n                                      ...interaction,\n                                      isLoading: true,\n                                    };\n\n                                    const payload = {\n                                      idx: idx,\n                                      interaction: newInteraction,\n                                    };\n\n                                    reportInteraction('grafana_prometheus_promqail_prompt_submitted', {\n                                      promVisualQuery: query,\n                                      prompt: interaction.prompt,\n                                    });\n\n                                    dispatch(updateInteraction(payload));\n                                    // add the suggestions in the API call\n                                    promQailSuggest(dispatch, idx, query, labelNames, datasource, interaction);\n                                  }}\n                                >\n                                  Submit\n                                </Button>\n                              </div>\n                            </div>\n                          </>\n                        )\n                      ) : (\n                        // LIST OF SUGGESTED QUERIES FROM AI\n                        <QuerySuggestionContainer\n                          suggestionType={SuggestionType.AI}\n                          querySuggestions={interaction.suggestions}\n                          closeDrawer={closeDrawer}\n                          nextInteraction={() => {\n                            const isLoading = false;\n                            const suggestionType = SuggestionType.AI;\n                            dispatch(addInteraction({ suggestionType, isLoading }));\n                          }}\n                          queryExplain={(suggIdx: number) =>\n                            interaction.suggestions[suggIdx].explanation === ''\n                              ? promQailExplain(dispatch, idx, query, interaction, suggIdx, datasource)\n                              : interaction.suggestions[suggIdx].explanation\n                          }\n                          onChange={onChange}\n                          prompt={interaction.prompt ?? ''}\n                        />\n                      )}\n                    </>\n                  ) : // HISTORICAL SUGGESTIONS\n                  interaction.isLoading ? (\n                    <>\n                      <div className={styles.loadingMessageContainer}>\n                        Waiting for OpenAI <Spinner className={styles.floatRight} />\n                      </div>\n                    </>\n                  ) : (\n                    // LIST OF SUGGESTED QUERIES FROM HISTORICAL DATA\n                    <QuerySuggestionContainer\n                      suggestionType={SuggestionType.Historical}\n                      querySuggestions={interaction.suggestions}\n                      closeDrawer={closeDrawer}\n                      nextInteraction={() => {\n                        const isLoading = false;\n                        const suggestionType = SuggestionType.AI;\n                        dispatch(addInteraction({ suggestionType, isLoading }));\n                      }}\n                      queryExplain={(suggIdx: number) =>\n                        interaction.suggestions[suggIdx].explanation === ''\n                          ? promQailExplain(dispatch, idx, query, interaction, suggIdx, datasource)\n                          : interaction.suggestions[suggIdx].explanation\n                      }\n                      onChange={onChange}\n                      prompt={interaction.prompt ?? ''}\n                    />\n                  )}\n                </div>\n              );\n            })}\n          </div>\n        )}\n      </div>\n      <div ref={responsesEndRef} />\n    </div>\n  );\n};\n\nexport const getStyles = (theme: GrafanaTheme2) => {\n  return {\n    sectionPadding: css({\n      padding: '20px',\n    }),\n    header: css({\n      display: 'flex',\n\n      button: {\n        marginLeft: 'auto',\n      },\n    }),\n    iconSection: css({\n      padding: '0 0 10px 0',\n      color: `${theme.colors.text.secondary}`,\n\n      img: {\n        paddingRight: '4px',\n      },\n    }),\n    rightButtonsWrapper: css({\n      display: 'flex',\n    }),\n    rightButtons: css({\n      marginLeft: 'auto',\n    }),\n    leftButton: css({\n      marginRight: '10px',\n    }),\n    dataList: css({\n      padding: '0px 28px 28px 28px',\n    }),\n    textPadding: css({\n      paddingBottom: '12px',\n    }),\n    containerPadding: css({\n      padding: '28px',\n    }),\n    infoContainer: css({\n      border: `${theme.colors.border.strong}`,\n      padding: '16px',\n      backgroundColor: `${theme.colors.background.secondary}`,\n      borderRadius: `8px`,\n      borderBottomLeftRadius: 0,\n    }),\n    infoContainerWrapper: css({\n      paddingBottom: '24px',\n    }),\n    metricTable: css({\n      width: '100%',\n    }),\n    metricTableName: css({\n      width: '15%',\n    }),\n    metricTableValue: css({\n      fontFamily: `${theme.typography.fontFamilyMonospace}`,\n      fontSize: `${theme.typography.bodySmall.fontSize}`,\n      overflow: 'scroll',\n      textWrap: 'nowrap',\n      maxWidth: '150px',\n      width: '60%',\n      maskImage: `linear-gradient(to right, rgba(0, 0, 0, 1) 90%, rgba(0, 0, 0, 0))`,\n    }),\n    metricTableButton: css({\n      float: 'right',\n    }),\n    queryQuestion: css({\n      textAlign: 'end',\n      padding: '8px 0',\n    }),\n    secondaryText: css({\n      color: `${theme.colors.text.secondary}`,\n    }),\n    loadingMessageContainer: css({\n      border: `${theme.colors.border.strong}`,\n      padding: `16px`,\n      backgroundColor: `${theme.colors.background.secondary}`,\n      marginBottom: `20px`,\n      borderRadius: `8px`,\n      color: `${theme.colors.text.secondary}`,\n      fontStyle: 'italic',\n    }),\n    floatRight: css({\n      float: 'right',\n    }),\n    codeText: css({\n      fontFamily: `${theme.typography.fontFamilyMonospace}`,\n      fontSize: `${theme.typography.bodySmall.fontSize}`,\n    }),\n    bodySmall: css({\n      fontSize: `${theme.typography.bodySmall.fontSize}`,\n    }),\n    explainPadding: css({\n      paddingLeft: '26px',\n    }),\n    bottomMargin: css({\n      marginBottom: '20px',\n    }),\n    topPadding: css({\n      paddingTop: '22px',\n    }),\n    doc: css({\n      textDecoration: 'underline',\n    }),\n    afterButtons: css({\n      display: 'flex',\n      justifyContent: 'flex-end',\n    }),\n    feedbackStyle: css({\n      margin: 0,\n      textAlign: 'right',\n      paddingTop: '22px',\n      paddingBottom: '22px',\n    }),\n    nextInteractionHeight: css({\n      height: '88px',\n    }),\n    center: css({\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center',\n    }),\n    inputPadding: css({\n      paddingBottom: '24px',\n    }),\n    querySuggestion: css({\n      display: 'flex',\n      flexWrap: 'nowrap',\n    }),\n    longCode: css({\n      width: '90%',\n      textWrap: 'nowrap',\n      overflow: 'scroll',\n      maskImage: `linear-gradient(to right, rgba(0, 0, 0, 1) 90%, rgba(0, 0, 0, 0))`,\n\n      div: {\n        display: 'inline-block',\n      },\n    }),\n    useButton: css({\n      marginLeft: 'auto',\n    }),\n    suggestionFeedback: css({\n      textAlign: 'left',\n    }),\n    feedbackQuestion: css({\n      display: 'flex',\n      padding: '8px 0px',\n      h6: { marginBottom: 0 },\n      i: {\n        marginTop: '1px',\n      },\n    }),\n    explationTextInput: css({\n      paddingLeft: '24px',\n    }),\n    submitFeedback: css({\n      padding: '16px 0',\n    }),\n  };\n};\n\nexport const testIds = {\n  promQail: 'prom-qail',\n  securityInfoButton: 'security-info-button',\n  clickForHistorical: 'click-for-historical',\n  clickForAi: 'click-for-ai',\n  submitPrompt: 'submit-prompt',\n  refinePrompt: 'refine-prompt',\n};\n","import { css } from '@emotion/css';\nimport React, { useState } from 'react';\n\nimport { DataSourceApi, PanelData } from '@grafana/data';\nimport { EditorRow } from '@grafana/experimental';\nimport { config, reportInteraction } from '@grafana/runtime';\nimport { Button, Drawer } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport promqlGrammar from '../../promql';\nimport { promQueryModeller } from '../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { OperationExplainedBox } from '../shared/OperationExplainedBox';\nimport { OperationList } from '../shared/OperationList';\nimport { OperationListExplained } from '../shared/OperationListExplained';\nimport { OperationsEditorRow } from '../shared/OperationsEditorRow';\nimport { QueryBuilderHints } from '../shared/QueryBuilderHints';\nimport { RawQuery } from '../shared/RawQuery';\nimport { QueryBuilderOperation } from '../shared/types';\nimport { PromVisualQuery } from '../types';\n\nimport { MetricsLabelsSection } from './MetricsLabelsSection';\nimport { NestedQueryList } from './NestedQueryList';\nimport { EXPLAIN_LABEL_FILTER_CONTENT } from './PromQueryBuilderExplained';\nimport { PromQail } from './promQail/PromQail';\nimport AI_Logo_color from './promQail/resources/AI_Logo_color.svg';\n\nexport interface Props {\n  query: PromVisualQuery;\n  datasource: PrometheusDatasource;\n  onChange: (update: PromVisualQuery) => void;\n  onRunQuery: () => void;\n  data?: PanelData;\n  showExplain: boolean;\n}\n\n// initial commit for hackathon-2023-08-promqail\n// AI/ML + Prometheus\nconst prometheusPromQAIL = config.featureToggles.prometheusPromQAIL;\n\nexport const PromQueryBuilder = React.memo<Props>((props) => {\n  const { datasource, query, onChange, onRunQuery, data, showExplain } = props;\n  const [highlightedOp, setHighlightedOp] = useState<QueryBuilderOperation | undefined>();\n  const [showDrawer, setShowDrawer] = useState<boolean>(false);\n\n  const lang = { grammar: promqlGrammar, name: 'promql' };\n\n  const initHints = datasource.getInitHints();\n\n  return (\n    <>\n      {prometheusPromQAIL && showDrawer && (\n        <Drawer scrollableContent={true} closeOnMaskClick={false} onClose={() => setShowDrawer(false)}>\n          <PromQail\n            query={query}\n            closeDrawer={() => setShowDrawer(false)}\n            onChange={onChange}\n            datasource={datasource}\n          />\n        </Drawer>\n      )}\n      <EditorRow>\n        <MetricsLabelsSection query={query} onChange={onChange} datasource={datasource} />\n      </EditorRow>\n      {initHints.length ? (\n        <div className=\"query-row-break\">\n          <div className=\"prom-query-field-info text-warning\">\n            {initHints[0].label}{' '}\n            {initHints[0].fix ? (\n              <button type=\"button\" className={'text-warning'}>\n                {initHints[0].fix.label}\n              </button>\n            ) : null}\n          </div>\n        </div>\n      ) : null}\n      {showExplain && (\n        <OperationExplainedBox\n          stepNumber={1}\n          title={<RawQuery query={`${query.metric} ${promQueryModeller.renderLabels(query.labels)}`} lang={lang} />}\n        >\n          {EXPLAIN_LABEL_FILTER_CONTENT}\n        </OperationExplainedBox>\n      )}\n      <OperationsEditorRow>\n        <OperationList<PromVisualQuery>\n          queryModeller={promQueryModeller}\n          // eslint-ignore\n          datasource={datasource as DataSourceApi}\n          query={query}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          highlightedOp={highlightedOp}\n        />\n        {prometheusPromQAIL && (\n          <div\n            className={css({\n              padding: '0 0 0 6px',\n            })}\n          >\n            <Button\n              variant={'secondary'}\n              onClick={() => {\n                reportInteraction('grafana_prometheus_promqail_ai_button_clicked', {\n                  metric: query.metric,\n                });\n                setShowDrawer(true);\n              }}\n              title={'Get query suggestions.'}\n              disabled={!query.metric}\n            >\n              <img height={16} src={AI_Logo_color} alt=\"AI logo black and white\" />\n              {'\\u00A0'}Get query suggestions\n            </Button>\n          </div>\n        )}\n        <QueryBuilderHints<PromVisualQuery>\n          datasource={datasource}\n          query={query}\n          onChange={onChange}\n          data={data}\n          queryModeller={promQueryModeller}\n          buildVisualQueryFromString={buildVisualQueryFromString}\n        />\n      </OperationsEditorRow>\n      {showExplain && (\n        <OperationListExplained<PromVisualQuery>\n          lang={lang}\n          query={query}\n          stepNumber={2}\n          queryModeller={promQueryModeller}\n          onMouseEnter={(op) => setHighlightedOp(op)}\n          onMouseLeave={() => setHighlightedOp(undefined)}\n        />\n      )}\n      {query.binaryQueries && query.binaryQueries.length > 0 && (\n        <NestedQueryList\n          query={query}\n          datasource={datasource}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          showExplain={showExplain}\n        />\n      )}\n    </>\n  );\n});\n\nPromQueryBuilder.displayName = 'PromQueryBuilder';\n","import React from 'react';\n\nimport { EditorFieldGroup, EditorRow } from '@grafana/experimental';\n\nimport promqlGrammar from '../../promql';\nimport { RawQuery } from '../shared/RawQuery';\n\nexport interface Props {\n  query: string;\n}\n\nexport function QueryPreview({ query }: Props) {\n  if (!query) {\n    return null;\n  }\n\n  return (\n    <EditorRow>\n      <EditorFieldGroup>\n        <RawQuery query={query} lang={{ grammar: promqlGrammar, name: 'promql' }} />\n      </EditorFieldGroup>\n    </EditorRow>\n  );\n}\n","import { createSlice, PayloadAction } from '@reduxjs/toolkit';\nimport React, { useEffect, useReducer } from 'react';\n\nimport { PanelData } from '@grafana/data';\nimport { config } from '@grafana/runtime';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { PromQuery } from '../../types';\nimport { promQueryModeller } from '../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { PromVisualQuery } from '../types';\n\nimport { PromQueryBuilder } from './PromQueryBuilder';\nimport { QueryPreview } from './QueryPreview';\nimport { getSettings, MetricsModalSettings } from './metrics-modal/state/state';\n\nexport interface Props {\n  query: PromQuery;\n  datasource: PrometheusDatasource;\n  onChange: (update: PromQuery) => void;\n  onRunQuery: () => void;\n  data?: PanelData;\n  showExplain: boolean;\n}\n\nexport interface State {\n  visQuery?: PromVisualQuery;\n  expr: string;\n}\n\nconst prometheusMetricEncyclopedia = config.featureToggles.prometheusMetricEncyclopedia;\n/**\n * This component is here just to contain the translation logic between string query and the visual query builder model.\n */\nexport function PromQueryBuilderContainer(props: Props) {\n  const { query, onChange, onRunQuery, datasource, data, showExplain } = props;\n  const [state, dispatch] = useReducer(stateSlice.reducer, { expr: query.expr });\n  // Only rebuild visual query if expr changes from outside\n  useEffect(() => {\n    dispatch(exprChanged(query.expr));\n\n    if (prometheusMetricEncyclopedia) {\n      dispatch(\n        setMetricsModalSettings({\n          useBackend: query.useBackend ?? false,\n          disableTextWrap: query.disableTextWrap ?? false,\n          fullMetaSearch: query.fullMetaSearch ?? false,\n          includeNullMetadata: query.includeNullMetadata ?? true,\n        })\n      );\n    }\n  }, [query]);\n\n  useEffect(() => {\n    datasource.languageProvider.start(data?.timeRange);\n  }, [data?.timeRange, datasource.languageProvider]);\n\n  const onVisQueryChange = (visQuery: PromVisualQuery) => {\n    const expr = promQueryModeller.renderQuery(visQuery);\n    dispatch(visualQueryChange({ visQuery, expr }));\n\n    if (prometheusMetricEncyclopedia) {\n      const metricsModalSettings = getSettings(visQuery);\n      onChange({ ...props.query, expr: expr, ...metricsModalSettings });\n    } else {\n      onChange({ ...props.query, expr: expr });\n    }\n  };\n\n  if (!state.visQuery) {\n    return null;\n  }\n\n  return (\n    <>\n      <PromQueryBuilder\n        query={state.visQuery}\n        datasource={datasource}\n        onChange={onVisQueryChange}\n        onRunQuery={onRunQuery}\n        data={data}\n        showExplain={showExplain}\n      />\n      <QueryPreview query={query.expr} />\n    </>\n  );\n}\n\nconst initialState: State = {\n  expr: '',\n};\n\nconst stateSlice = createSlice({\n  name: 'prom-builder-container',\n  initialState,\n  reducers: {\n    visualQueryChange: (state, action: PayloadAction<{ visQuery: PromVisualQuery; expr: string }>) => {\n      state.expr = action.payload.expr;\n      state.visQuery = action.payload.visQuery;\n    },\n    exprChanged: (state, action: PayloadAction<string>) => {\n      if (!state.visQuery || state.expr !== action.payload) {\n        state.expr = action.payload;\n        const parseResult = buildVisualQueryFromString(action.payload ?? '');\n\n        state.visQuery = parseResult.query;\n      }\n    },\n    setMetricsModalSettings: (state, action: PayloadAction<MetricsModalSettings>) => {\n      if (state.visQuery && prometheusMetricEncyclopedia) {\n        state.visQuery.useBackend = action.payload.useBackend;\n        state.visQuery.disableTextWrap = action.payload.disableTextWrap;\n        state.visQuery.fullMetaSearch = action.payload.fullMetaSearch;\n        state.visQuery.includeNullMetadata = action.payload.includeNullMetadata;\n      }\n    },\n  },\n});\n\nconst { visualQueryChange, exprChanged, setMetricsModalSettings } = stateSlice.actions;\n","import { css, cx } from '@emotion/css';\nimport React, { useEffect, useState } from 'react';\nimport { usePrevious } from 'react-use';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { IconButton, InlineLabel, Tooltip, useStyles2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../datasource';\nimport { PromQuery } from '../types';\n\ninterface Props {\n  onChange: (exemplar: boolean) => void;\n  datasource: PrometheusDatasource;\n  query: PromQuery;\n  'data-testid'?: string;\n}\n\nexport function PromExemplarField({ datasource, onChange, query, ...rest }: Props) {\n  const [error, setError] = useState<string | null>(null);\n  const styles = useStyles2(getStyles);\n  const prevError = usePrevious(error);\n\n  useEffect(() => {\n    if (!datasource.exemplarsAvailable) {\n      setError('Exemplars for this query are not available');\n      onChange(false);\n    } else if (query.instant && !query.range) {\n      setError('Exemplars are not available for instant queries');\n      onChange(false);\n    } else {\n      setError(null);\n      // If error is cleared, we want to change exemplar to true\n      if (prevError && !error) {\n        onChange(true);\n      }\n    }\n  }, [datasource.exemplarsAvailable, query.instant, query.range, onChange, prevError, error]);\n\n  const iconButtonStyles = cx(\n    {\n      [styles.activeIcon]: !!query.exemplar,\n    },\n    styles.eyeIcon\n  );\n\n  return (\n    <InlineLabel width=\"auto\" data-testid={rest['data-testid']}>\n      <Tooltip content={error ?? ''}>\n        <div className={styles.iconWrapper}>\n          Exemplars\n          <IconButton\n            name=\"eye\"\n            tooltip={!!query.exemplar ? 'Disable query with exemplars' : 'Enable query with exemplars'}\n            disabled={!!error}\n            className={iconButtonStyles}\n            onClick={() => {\n              onChange(!query.exemplar);\n            }}\n          />\n        </div>\n      </Tooltip>\n    </InlineLabel>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    eyeIcon: css`\n      margin-left: ${theme.spacing(2)};\n    `,\n    activeIcon: css`\n      color: ${theme.colors.primary.main};\n    `,\n    iconWrapper: css`\n      display: flex;\n      align-items: center;\n    `,\n  };\n}\n","import { css, cx } from '@emotion/css';\nimport { isEqual } from 'lodash';\nimport React, { memo, useCallback } from 'react';\nimport { usePrevious } from 'react-use';\n\nimport { InlineFormLabel, RadioButtonGroup } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../datasource';\nimport { PromQuery } from '../types';\n\nimport { PromExemplarField } from './PromExemplarField';\n\nexport interface PromExploreExtraFieldProps {\n  query: PromQuery;\n  onChange: (value: PromQuery) => void;\n  onRunQuery: () => void;\n  datasource: PrometheusDatasource;\n}\n\nexport const PromExploreExtraField = memo(({ query, datasource, onChange, onRunQuery }: PromExploreExtraFieldProps) => {\n  const rangeOptions = getQueryTypeOptions(true);\n  const prevQuery = usePrevious(query);\n\n  const onExemplarChange = useCallback(\n    (exemplar: boolean) => {\n      if (!isEqual(query, prevQuery) || exemplar !== query.exemplar) {\n        onChange({ ...query, exemplar });\n      }\n    },\n    [prevQuery, query, onChange]\n  );\n\n  function onChangeQueryStep(interval: string) {\n    onChange({ ...query, interval });\n  }\n\n  function onStepChange(e: React.SyntheticEvent<HTMLInputElement>) {\n    if (e.currentTarget.value !== query.interval) {\n      onChangeQueryStep(e.currentTarget.value);\n    }\n  }\n\n  function onReturnKeyDown(e: React.KeyboardEvent<HTMLInputElement>) {\n    if (e.key === 'Enter' && e.shiftKey) {\n      onRunQuery();\n    }\n  }\n\n  const onQueryTypeChange = getQueryTypeChangeHandler(query, onChange);\n\n  return (\n    <div aria-label=\"Prometheus extra field\" className=\"gf-form-inline\" data-testid={testIds.extraFieldEditor}>\n      {/*Query type field*/}\n      <div\n        data-testid={testIds.queryTypeField}\n        className={cx(\n          'gf-form explore-input-margin',\n          css`\n            flex-wrap: nowrap;\n          `\n        )}\n        aria-label=\"Query type field\"\n      >\n        <InlineFormLabel width=\"auto\">Query type</InlineFormLabel>\n\n        <RadioButtonGroup\n          options={rangeOptions}\n          value={query.range && query.instant ? 'both' : query.instant ? 'instant' : 'range'}\n          onChange={onQueryTypeChange}\n        />\n      </div>\n      {/*Step field*/}\n      <div\n        data-testid={testIds.stepField}\n        className={cx(\n          'gf-form',\n          css`\n            flex-wrap: nowrap;\n          `\n        )}\n        aria-label=\"Step field\"\n      >\n        <InlineFormLabel\n          width={6}\n          tooltip={\n            'Time units and built-in variables can be used here, for example: $__interval, $__rate_interval, 5s, 1m, 3h, 1d, 1y (Default if no unit is specified: s)'\n          }\n        >\n          Min step\n        </InlineFormLabel>\n        <input\n          type={'text'}\n          className=\"gf-form-input width-4\"\n          placeholder={'auto'}\n          onChange={onStepChange}\n          onKeyDown={onReturnKeyDown}\n          value={query.interval ?? ''}\n        />\n      </div>\n\n      <PromExemplarField onChange={onExemplarChange} datasource={datasource} query={query} />\n    </div>\n  );\n});\n\nPromExploreExtraField.displayName = 'PromExploreExtraField';\n\nexport function getQueryTypeOptions(includeBoth: boolean) {\n  const rangeOptions = [\n    { value: 'range', label: 'Range', description: 'Run query over a range of time' },\n    {\n      value: 'instant',\n      label: 'Instant',\n      description: 'Run query against a single point in time. For this query, the \"To\" time is used',\n    },\n  ];\n\n  if (includeBoth) {\n    rangeOptions.push({ value: 'both', label: 'Both', description: 'Run an Instant query and a Range query' });\n  }\n\n  return rangeOptions;\n}\n\nexport function getQueryTypeChangeHandler(query: PromQuery, onChange: (update: PromQuery) => void) {\n  return (queryType: string) => {\n    if (queryType === 'instant') {\n      onChange({ ...query, instant: true, range: false, exemplar: false });\n    } else if (queryType === 'range') {\n      onChange({ ...query, instant: false, range: true });\n    } else {\n      onChange({ ...query, instant: true, range: true });\n    }\n  };\n}\n\nexport const testIds = {\n  extraFieldEditor: 'prom-editor-extra-field',\n  stepField: 'prom-editor-extra-field-step',\n  queryTypeField: 'prom-editor-extra-field-query-type',\n};\n","import React, { useRef } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { EditorField } from '@grafana/experimental';\nimport { Select, AutoSizeInput } from '@grafana/ui';\n\nimport { LegendFormatMode } from '../../types';\n\nexport interface Props {\n  legendFormat: string | undefined;\n  onChange: (legendFormat: string) => void;\n  onRunQuery: () => void;\n}\n\nconst legendModeOptions = [\n  {\n    label: 'Auto',\n    value: LegendFormatMode.Auto,\n    description: 'Only includes unique labels',\n  },\n  { label: 'Verbose', value: LegendFormatMode.Verbose, description: 'All label names and values' },\n  { label: 'Custom', value: LegendFormatMode.Custom, description: 'Provide a naming template' },\n];\n\n/**\n * Tests for this component are on the parent level (PromQueryBuilderOptions).\n */\nexport const PromQueryLegendEditor = React.memo<Props>(({ legendFormat, onChange, onRunQuery }) => {\n  const mode = getLegendMode(legendFormat);\n  const inputRef = useRef<HTMLInputElement | null>(null);\n\n  const onLegendFormatChanged = (evt: React.FormEvent<HTMLInputElement>) => {\n    let newFormat = evt.currentTarget.value;\n    if (newFormat.length === 0) {\n      newFormat = LegendFormatMode.Auto;\n    }\n\n    if (newFormat !== legendFormat) {\n      onChange(newFormat);\n      onRunQuery();\n    }\n  };\n\n  const onLegendModeChanged = (value: SelectableValue<LegendFormatMode>) => {\n    switch (value.value!) {\n      case LegendFormatMode.Auto:\n        onChange(LegendFormatMode.Auto);\n        break;\n      case LegendFormatMode.Custom:\n        onChange('{{label_name}}');\n        setTimeout(() => {\n          inputRef.current?.focus();\n          inputRef.current?.setSelectionRange(2, 12, 'forward');\n        }, 10);\n        break;\n      case LegendFormatMode.Verbose:\n        onChange('');\n        break;\n    }\n    onRunQuery();\n  };\n\n  return (\n    <EditorField\n      label=\"Legend\"\n      tooltip=\"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname.\"\n    >\n      <>\n        {mode === LegendFormatMode.Custom && (\n          <AutoSizeInput\n            id=\"legendFormat\"\n            minWidth={22}\n            placeholder=\"auto\"\n            defaultValue={legendFormat}\n            onCommitChange={onLegendFormatChanged}\n            ref={inputRef}\n          />\n        )}\n        {mode !== LegendFormatMode.Custom && (\n          <Select\n            inputId=\"legend.mode\"\n            isSearchable={false}\n            placeholder=\"Select legend mode\"\n            options={legendModeOptions}\n            width={22}\n            onChange={onLegendModeChanged}\n            value={legendModeOptions.find((x) => x.value === mode)}\n          />\n        )}\n      </>\n    </EditorField>\n  );\n});\n\nPromQueryLegendEditor.displayName = 'PromQueryLegendEditor';\n\nfunction getLegendMode(legendFormat: string | undefined) {\n  // This special value means the new smart minimal series naming\n  if (legendFormat === LegendFormatMode.Auto) {\n    return LegendFormatMode.Auto;\n  }\n\n  // Missing or empty legend format is the old verbose behavior\n  if (legendFormat == null || legendFormat === '') {\n    return LegendFormatMode.Verbose;\n  }\n\n  return LegendFormatMode.Custom;\n}\n\nexport function getLegendModeLabel(legendFormat: string | undefined) {\n  const mode = getLegendMode(legendFormat);\n  if (mode !== LegendFormatMode.Custom) {\n    return legendModeOptions.find((x) => x.value === mode)?.label;\n  }\n  return legendFormat;\n}\n","import React, { SyntheticEvent } from 'react';\n\nimport { CoreApp, SelectableValue } from '@grafana/data';\nimport { EditorField, EditorRow, EditorSwitch } from '@grafana/experimental';\nimport { AutoSizeInput, RadioButtonGroup, Select } from '@grafana/ui';\n\nimport { getQueryTypeChangeHandler, getQueryTypeOptions } from '../../components/PromExploreExtraField';\nimport { PromQueryFormat } from '../../dataquery.gen';\nimport { PromQuery } from '../../types';\nimport { QueryOptionGroup } from '../shared/QueryOptionGroup';\n\nimport { FORMAT_OPTIONS, INTERVAL_FACTOR_OPTIONS } from './PromQueryEditorSelector';\nimport { getLegendModeLabel, PromQueryLegendEditor } from './PromQueryLegendEditor';\n\nexport interface UIOptions {\n  exemplars: boolean;\n  type: boolean;\n  format: boolean;\n  minStep: boolean;\n  legend: boolean;\n  resolution: boolean;\n}\n\nexport interface Props {\n  query: PromQuery;\n  app?: CoreApp;\n  onChange: (update: PromQuery) => void;\n  onRunQuery: () => void;\n}\n\nexport const PromQueryBuilderOptions = React.memo<Props>(({ query, app, onChange, onRunQuery }) => {\n  const onChangeFormat = (value: SelectableValue<PromQueryFormat>) => {\n    onChange({ ...query, format: value.value });\n    onRunQuery();\n  };\n\n  const onChangeStep = (evt: React.FormEvent<HTMLInputElement>) => {\n    onChange({ ...query, interval: evt.currentTarget.value });\n    onRunQuery();\n  };\n\n  const queryTypeOptions = getQueryTypeOptions(\n    app === CoreApp.Explore || app === CoreApp.Correlations || app === CoreApp.PanelEditor\n  );\n  const onQueryTypeChange = getQueryTypeChangeHandler(query, onChange);\n\n  const onExemplarChange = (event: SyntheticEvent<HTMLInputElement>) => {\n    const isEnabled = event.currentTarget.checked;\n    onChange({ ...query, exemplar: isEnabled });\n    onRunQuery();\n  };\n\n  const onIntervalFactorChange = (value: SelectableValue<number>) => {\n    onChange({ ...query, intervalFactor: value.value });\n    onRunQuery();\n  };\n\n  const formatOption = FORMAT_OPTIONS.find((option) => option.value === query.format) || FORMAT_OPTIONS[0];\n  const queryTypeValue = getQueryTypeValue(query);\n  const queryTypeLabel = queryTypeOptions.find((x) => x.value === queryTypeValue)!.label;\n\n  return (\n    <EditorRow>\n      <QueryOptionGroup\n        title=\"Options\"\n        collapsedInfo={getCollapsedInfo(query, formatOption.label!, queryTypeLabel, app)}\n      >\n        <PromQueryLegendEditor\n          legendFormat={query.legendFormat}\n          onChange={(legendFormat) => onChange({ ...query, legendFormat })}\n          onRunQuery={onRunQuery}\n        />\n        <EditorField\n          label=\"Min step\"\n          tooltip={\n            <>\n              An additional lower limit for the step parameter of the Prometheus query and for the{' '}\n              <code>$__interval</code> and <code>$__rate_interval</code> variables.\n            </>\n          }\n        >\n          <AutoSizeInput\n            type=\"text\"\n            aria-label=\"Set lower limit for the step parameter\"\n            placeholder={'auto'}\n            minWidth={10}\n            onCommitChange={onChangeStep}\n            defaultValue={query.interval}\n          />\n        </EditorField>\n        <EditorField label=\"Format\">\n          <Select value={formatOption} allowCustomValue onChange={onChangeFormat} options={FORMAT_OPTIONS} />\n        </EditorField>\n        <EditorField label=\"Type\">\n          <RadioButtonGroup options={queryTypeOptions} value={queryTypeValue} onChange={onQueryTypeChange} />\n        </EditorField>\n        {shouldShowExemplarSwitch(query, app) && (\n          <EditorField label=\"Exemplars\">\n            <EditorSwitch value={query.exemplar || false} onChange={onExemplarChange} />\n          </EditorField>\n        )}\n        {query.intervalFactor && query.intervalFactor > 1 && (\n          <EditorField label=\"Resolution\">\n            <Select\n              aria-label=\"Select resolution\"\n              isSearchable={false}\n              options={INTERVAL_FACTOR_OPTIONS}\n              onChange={onIntervalFactorChange}\n              value={INTERVAL_FACTOR_OPTIONS.find((option) => option.value === query.intervalFactor)}\n            />\n          </EditorField>\n        )}\n      </QueryOptionGroup>\n    </EditorRow>\n  );\n});\n\nfunction shouldShowExemplarSwitch(query: PromQuery, app?: CoreApp) {\n  if (app === CoreApp.UnifiedAlerting || !query.range) {\n    return false;\n  }\n\n  return true;\n}\n\nfunction getQueryTypeValue(query: PromQuery) {\n  return query.range && query.instant ? 'both' : query.instant ? 'instant' : 'range';\n}\n\nfunction getCollapsedInfo(query: PromQuery, formatOption: string, queryType: string, app?: CoreApp): string[] {\n  const items: string[] = [];\n\n  items.push(`Legend: ${getLegendModeLabel(query.legendFormat)}`);\n  items.push(`Format: ${formatOption}`);\n  items.push(`Step: ${query.interval ?? 'auto'}`);\n  items.push(`Type: ${queryType}`);\n\n  if (shouldShowExemplarSwitch(query, app)) {\n    if (query.exemplar) {\n      items.push(`Exemplars: true`);\n    } else {\n      items.push(`Exemplars: false`);\n    }\n  }\n  return items;\n}\n\nPromQueryBuilderOptions.displayName = 'PromQueryBuilderOptions';\n","import { isEqual, map } from 'lodash';\nimport React, { SyntheticEvent, useCallback, useEffect, useState } from 'react';\n\nimport { CoreApp, LoadingState, SelectableValue } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorHeader, EditorRows, FlexItem, Space } from '@grafana/experimental';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, ConfirmModal } from '@grafana/ui';\n\nimport { PromQueryEditorProps } from '../../components/types';\nimport { PromQueryFormat } from '../../dataquery.gen';\nimport { PromQuery } from '../../types';\nimport { QueryPatternsModal } from '../QueryPatternsModal';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { QueryEditorModeToggle } from '../shared/QueryEditorModeToggle';\nimport { QueryHeaderSwitch } from '../shared/QueryHeaderSwitch';\nimport { promQueryEditorExplainKey, useFlag } from '../shared/hooks/useFlag';\nimport { QueryEditorMode } from '../shared/types';\nimport { changeEditorMode, getQueryWithDefaults } from '../state';\n\nimport { PromQueryBuilderContainer } from './PromQueryBuilderContainer';\nimport { PromQueryBuilderOptions } from './PromQueryBuilderOptions';\nimport { PromQueryCodeEditor } from './PromQueryCodeEditor';\n\nexport const FORMAT_OPTIONS: Array<SelectableValue<PromQueryFormat>> = [\n  { label: 'Time series', value: 'time_series' },\n  { label: 'Table', value: 'table' },\n  { label: 'Heatmap', value: 'heatmap' },\n];\n\nexport const INTERVAL_FACTOR_OPTIONS: Array<SelectableValue<number>> = map([1, 2, 3, 4, 5, 10], (value: number) => ({\n  value,\n  label: '1/' + value,\n}));\n\ntype Props = PromQueryEditorProps;\n\nexport const PromQueryEditorSelector = React.memo<Props>((props) => {\n  const {\n    onChange,\n    onRunQuery,\n    data,\n    app,\n    onAddQuery,\n    datasource: { defaultEditor },\n    queries,\n  } = props;\n\n  const [parseModalOpen, setParseModalOpen] = useState(false);\n  const [queryPatternsModalOpen, setQueryPatternsModalOpen] = useState(false);\n  const [dataIsStale, setDataIsStale] = useState(false);\n  const { flag: explain, setFlag: setExplain } = useFlag(promQueryEditorExplainKey);\n\n  const query = getQueryWithDefaults(props.query, app, defaultEditor);\n  // This should be filled in from the defaults by now.\n  const editorMode = query.editorMode!;\n\n  const onEditorModeChange = useCallback(\n    (newMetricEditorMode: QueryEditorMode) => {\n      reportInteraction('user_grafana_prometheus_editor_mode_clicked', {\n        newEditor: newMetricEditorMode,\n        previousEditor: query.editorMode ?? '',\n        newQuery: !query.expr,\n        app: app ?? '',\n      });\n\n      if (newMetricEditorMode === QueryEditorMode.Builder) {\n        const result = buildVisualQueryFromString(query.expr || '');\n        // If there are errors, give user a chance to decide if they want to go to builder as that can lose some data.\n        if (result.errors.length) {\n          setParseModalOpen(true);\n          return;\n        }\n      }\n      changeEditorMode(query, newMetricEditorMode, onChange);\n    },\n    [onChange, query, app]\n  );\n\n  useEffect(() => {\n    setDataIsStale(false);\n  }, [data]);\n\n  const onChangeInternal = (query: PromQuery) => {\n    if (!isEqual(query, props.query)) {\n      setDataIsStale(true);\n    }\n    onChange(query);\n  };\n\n  const onShowExplainChange = (e: SyntheticEvent<HTMLInputElement>) => {\n    setExplain(e.currentTarget.checked);\n  };\n\n  return (\n    <>\n      <ConfirmModal\n        isOpen={parseModalOpen}\n        title=\"Parsing error: Switch to the builder mode?\"\n        body=\"There is a syntax error, or the query structure cannot be visualized when switching to the builder mode. Parts of the query may be lost. \"\n        confirmText=\"Continue\"\n        onConfirm={() => {\n          changeEditorMode(query, QueryEditorMode.Builder, onChange);\n          setParseModalOpen(false);\n        }}\n        onDismiss={() => setParseModalOpen(false)}\n      />\n      <QueryPatternsModal\n        isOpen={queryPatternsModalOpen}\n        onClose={() => setQueryPatternsModalOpen(false)}\n        query={query}\n        queries={queries}\n        app={app}\n        onChange={onChange}\n        onAddQuery={onAddQuery}\n      />\n      <EditorHeader>\n        <Button\n          aria-label={selectors.components.QueryBuilder.queryPatterns}\n          variant=\"secondary\"\n          size=\"sm\"\n          onClick={() => setQueryPatternsModalOpen((prevValue) => !prevValue)}\n        >\n          Kick start your query\n        </Button>\n        <QueryHeaderSwitch label=\"Explain\" value={explain} onChange={onShowExplainChange} />\n        <FlexItem grow={1} />\n        {app !== CoreApp.Explore && app !== CoreApp.Correlations && (\n          <Button\n            variant={dataIsStale ? 'primary' : 'secondary'}\n            size=\"sm\"\n            onClick={onRunQuery}\n            icon={data?.state === LoadingState.Loading ? 'spinner' : undefined}\n            disabled={data?.state === LoadingState.Loading}\n          >\n            Run queries\n          </Button>\n        )}\n        <QueryEditorModeToggle mode={editorMode} onChange={onEditorModeChange} />\n      </EditorHeader>\n      <Space v={0.5} />\n      <EditorRows>\n        {editorMode === QueryEditorMode.Code && (\n          <PromQueryCodeEditor {...props} query={query} showExplain={explain} onChange={onChangeInternal} />\n        )}\n        {editorMode === QueryEditorMode.Builder && (\n          <PromQueryBuilderContainer\n            query={query}\n            datasource={props.datasource}\n            onChange={onChangeInternal}\n            onRunQuery={props.onRunQuery}\n            data={data}\n            showExplain={explain}\n          />\n        )}\n        <PromQueryBuilderOptions query={query} app={props.app} onChange={onChange} onRunQuery={onRunQuery} />\n      </EditorRows>\n    </>\n  );\n});\n\nPromQueryEditorSelector.displayName = 'PromQueryEditorSelector';\n","import React from 'react';\n\nimport PromQueryField from './PromQueryField';\nimport { PromQueryEditorProps } from './types';\n\nexport function PromQueryEditorForAlerting(props: PromQueryEditorProps) {\n  const { datasource, query, range, data, onChange, onRunQuery } = props;\n\n  return (\n    <PromQueryField\n      datasource={datasource}\n      query={query}\n      onRunQuery={onRunQuery}\n      onChange={onChange}\n      history={[]}\n      range={range}\n      data={data}\n      data-testid={testIds.editor}\n    />\n  );\n}\n\nexport const testIds = {\n  editor: 'prom-editor-cloud-alerting',\n};\n","import React, { memo } from 'react';\n\nimport { CoreApp } from '@grafana/data';\n\nimport { PromQueryEditorSelector } from '../querybuilder/components/PromQueryEditorSelector';\n\nimport { PromQueryEditorForAlerting } from './PromQueryEditorForAlerting';\nimport { PromQueryEditorProps } from './types';\n\nexport function PromQueryEditorByApp(props: PromQueryEditorProps) {\n  const { app } = props;\n\n  switch (app) {\n    case CoreApp.CloudAlerting:\n      return <PromQueryEditorForAlerting {...props} />;\n    default:\n      return <PromQueryEditorSelector {...props} />;\n  }\n}\n\nexport default memo(PromQueryEditorByApp);\n","import { DataSourcePlugin } from '@grafana/data';\n\nimport PromCheatSheet from './components/PromCheatSheet';\nimport PromQueryEditorByApp from './components/PromQueryEditorByApp';\nimport { ConfigEditor } from './configuration/ConfigEditor';\nimport { PrometheusDatasource } from './datasource';\n\nexport const plugin = new DataSourcePlugin(PrometheusDatasource)\n  .setQueryEditor(PromQueryEditorByApp)\n  .setConfigEditor(ConfigEditor)\n  .setQueryEditorHelp(PromCheatSheet);\n"],"names":["createRangeOperation","name","isRangeOperationWithGrouping","params","getRangeVectorParamDef","defaultParams","paramChangedHandler","operationWithRangeVectorRenderer","addLokiOperation","op","def","opDocs","x","createRangeOperationWithGrouping","rangeOperation","getRangeAggregationWithGroupingRenderer","aggregation","grouping","model","innerExpr","restParamIndex","param","restParams","rangeVector","quantile","labelFilterRenderer","isConflictingFilter","operation","queryOperations","operationIsNegative","queryOperation","candidate","pipelineRenderer","strict","keepEmpty","labels","label","isRangeVectorFunction","getIndexOfOrLast","operations","queryModeller","condition","index","opDef","query","modeller","newOperation","existingRangeVectorFunction","placeToInsert","addNestedQueryHandler","getLineFilterRenderer","caseInsensitive","LokiQueryPatternType","LokiVisualQueryOperationCategory","LokiOperationId","LokiOperationOrder","lokiOperators","CHEAT_SHEET_ITEMS","props","item","e","QueryPattern","pattern","onPatternSelect","hasNewQueryOption","hasPreviousQuery","selectedPatternName","setSelectedPatternName","styles","getStyles","lang","promql","Card","RawQuery","Button","theme","QueryPatternsModal","isOpen","onClose","onChange","onAddQuery","queries","app","openTabs","setOpenTabs","visualQuery","hasOperations","hasMetric","hasLabels","hasBinaryQueries","selectAsNewQuery","Modal","patternType","Collapse","tabs","t","queryEditorModeDefaultLocalStorageKey","changeEditorMode","editorMode","store","getDefaultEditorMode","expr","defaultEditor","value","getQueryWithDefaults","result","isBothInstantAndRange","NestedQuery","nestedQuery","datasource","onRemove","onRunQuery","showExplain","Select","operators","val","AutoSizeInput","evt","FlexItem","IconButton","EditorRows","PromQueryBuilder","update","NestedQueryList","nestedQueries","onNestedQueryUpdate","updatedList","Stack","suggestionOptions","explationOptions","QuerySuggestionItem","querySuggestion","order","queryExplain","historical","closeDrawer","last","allSuggestions","prompt","showExp","updShowExp","gaveExplanationFeedback","updateGaveExplanationFeedback","gaveSuggestionFeedback","updateGaveSuggestionFeedback","suggestionFeedback","setSuggestionFeedback","explanationFeedback","setExplanationFeedback","explanation","feedbackToggleTip","type","updateRadioFeedback","updateTextFeedback","disabledButton","questionOne","RadioButtonList","TextArea","explanationFeedbackEvent","suggestionFeedbackEvent","pvq","Spinner","Toggletip","radioInputFeedback","textFeedback","event","SuggestionType","QuerySuggestionContainer","suggestionType","querySuggestions","nextInteraction","hasNextInteraction","updateHasNextInteraction","text","secondaryText","refineText","qs","idx","acc","testIds","search","request","loggedWarning","enabled","response","details","ExplainSystemPrompt","GetExplainUserPrompt","documentation","metricName","metricType","metricMetadata","SuggestSystemPrompt","GetSuggestUserPrompt","question","templates","stateSlice","initialState","state","action","interaction","createInteraction","interactions","updInteraction","showStartingMessage","isLoading","generalTemplates","counterTemplates","histogramTemplates","gaugeTemplates","processTemplate","templateData","metric","getTemplateSuggestions","templateSuggestions","OPENAI_MODEL_NAME","promQLTemplatesCollection","updateInteraction","getExplainMessage","documentationBody","title","body","getSuggestMessages","promQailExplain","dispatch","suggIdx","suggestedQuery","promptMessages","interactionToUpdate","updatedSuggestions","sg","sidx","payload","isContainedIn","sublist","superlist","guessMetricType","allMetrics","underscoreIndex","root","suffix","familyMetrics","generateMetricTypeFilters","types","guessMetricFamily","isLLMPluginEnabled","openaiEnabled","vectorEnabled","results","promQailSuggest","labelNames","check","metricFamilyGuess","resolve","suggestions","metricLabels","feedTheAI","resultsString","r","indicateCheckbox","addInteraction","SKIP_STARTING_MESSAGE","PromQail","skipStartingMessage","setLabelNames","int","responsesEndRef","scrollToBottom","labelsIndex","AI_Logo_color","Checkbox","Input","newInteraction","prometheusPromQAIL","config","data","highlightedOp","setHighlightedOp","showDrawer","setShowDrawer","initHints","Drawer","EditorRow","MetricsLabelsSection","OperationExplainedBox","OperationsEditorRow","OperationList","QueryBuilderHints","OperationListExplained","QueryPreview","EditorFieldGroup","prometheusMetricEncyclopedia","PromQueryBuilderContainer","exprChanged","setMetricsModalSettings","onVisQueryChange","visQuery","visualQueryChange","metricsModalSettings","parseResult","PromExemplarField","rest","error","setError","prevError","usePrevious","iconButtonStyles","InlineLabel","Tooltip","PromExploreExtraField","rangeOptions","getQueryTypeOptions","prevQuery","onExemplarChange","exemplar","onChangeQueryStep","interval","onStepChange","onReturnKeyDown","onQueryTypeChange","getQueryTypeChangeHandler","RadioButtonGroup","includeBoth","queryType","legendModeOptions","PromQueryLegendEditor","legendFormat","mode","getLegendMode","inputRef","onLegendFormatChanged","newFormat","onLegendModeChanged","EditorField","getLegendModeLabel","PromQueryBuilderOptions","onChangeFormat","onChangeStep","queryTypeOptions","isEnabled","onIntervalFactorChange","formatOption","FORMAT_OPTIONS","option","queryTypeValue","getQueryTypeValue","queryTypeLabel","QueryOptionGroup","getCollapsedInfo","shouldShowExemplarSwitch","EditorSwitch","INTERVAL_FACTOR_OPTIONS","items","PromQueryEditorSelector","parseModalOpen","setParseModalOpen","queryPatternsModalOpen","setQueryPatternsModalOpen","dataIsStale","setDataIsStale","explain","setExplain","useFlag","onEditorModeChange","newMetricEditorMode","onChangeInternal","onShowExplainChange","ConfirmModal","EditorHeader","selectors","prevValue","QueryHeaderSwitch","QueryEditorModeToggle","Space","PromQueryCodeEditor","PromQueryEditorForAlerting","range","PromQueryField","PromQueryEditorByApp","ConfigEditor"],"sourceRoot":""}