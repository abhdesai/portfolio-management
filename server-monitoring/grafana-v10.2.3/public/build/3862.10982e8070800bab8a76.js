"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3862],{63862:(B,L,r)=>{r.r(L),r.d(L,{default:()=>Je,getStyles:()=>le});var g=r(66681),p=r(56375),e=r(85960),N=r(10476),T=r(85745),R=r(47257),A=r(49199),h=r(13086),K=r(14607),b=r(97666),Q=r(7042),G=r(29165),ce=r(20519),me=r(57445),ue=r(24956),de=r(58712);const ge=de.C.injectEndpoints({endpoints:t=>({getRuleHistory:t.query({query:({ruleUid:n,from:s,to:a,limit:i=100})=>({url:"/api/v1/rules/history",params:{ruleUID:n,from:s,to:a,limit:i}})})})});var F=r(98724),fe=r(23595),pe=r(91671),Y=r(89933),ve=r(22799),$=r(78321),he=r(37166),ye=r(87474),Ee=r(75847),X=r(12173),k=1e3*60,z=60*24,q=z*30,_=z*365;function Se(t,n,s){var a,i,m;(0,X.Z)(2,arguments);var o=(0,pe.j)(),c=(a=(i=s?.locale)!==null&&i!==void 0?i:o.locale)!==null&&a!==void 0?a:Ee.Z;if(!c.formatDistance)throw new RangeError("locale must contain localize.formatDistance property");var y=(0,ve.Z)(t,n);if(isNaN(y))throw new RangeError("Invalid time value");var l=(0,ye.Z)((0,he.Z)(s),{addSuffix:!!s?.addSuffix,comparison:y}),u,x;y>0?(u=(0,$.Z)(n),x=(0,$.Z)(t)):(u=(0,$.Z)(t),x=(0,$.Z)(n));var M=String((m=s?.roundingMethod)!==null&&m!==void 0?m:"round"),E;if(M==="floor")E=Math.floor;else if(M==="ceil")E=Math.ceil;else if(M==="round")E=Math.round;else throw new RangeError("roundingMethod must be 'floor', 'ceil' or 'round'");var d=x.getTime()-u.getTime(),v=d/k,O=(0,Y.Z)(x)-(0,Y.Z)(u),S=(d-O)/k,C=s?.unit,f;if(C?f=String(C):v<1?f="second":v<60?f="minute":v<z?f="hour":S<q?f="day":S<_?f="month":f="year",f==="second"){var j=E(d/1e3);return c.formatDistance("xSeconds",j,l)}else if(f==="minute"){var W=E(v);return c.formatDistance("xMinutes",W,l)}else if(f==="hour"){var w=E(v/60);return c.formatDistance("xHours",w,l)}else if(f==="day"){var Z=E(S/z);return c.formatDistance("xDays",Z,l)}else if(f==="month"){var D=E(S/q);return D===12&&C!=="month"?c.formatDistance("xYears",1,l):c.formatDistance("xMonths",D,l)}else if(f==="year"){var U=E(S/_);return c.formatDistance("xYears",U,l)}throw new RangeError("unit must be 'second', 'minute', 'hour', 'day', 'month' or 'year'")}function xe(t,n){return(0,X.Z)(1,arguments),Se(t,Date.now(),n)}var Re=r(12537),Te=r(34340),ee=r(14591),H=r(13405);function Le(t){const n=t.reduce((s,a)=>{const i=s.get(a.timestamp);return i?i.push(a):s.set(a.timestamp,[a]),s},new Map);return new Map([...n].sort((s,a)=>a[0]-s[0]))}const te=e.memo(({records:t,commonLabels:n,onLabelClick:s,onRecordsRendered:a})=>{const i=(0,R.wW)(P),m=Le(t),o=new Map;return(0,e.useEffect)(()=>{a&&a(o)}),e.createElement("ul",{className:i.logsScrollable,"aria-label":"State history by timestamp"},Array.from(m.entries()).map(([c,y])=>e.createElement("li",{id:c.toString(10),key:c,"data-testid":c,ref:l=>l&&o.set(c,l),className:i.listItemWrapper},e.createElement(be,{time:c}),e.createElement("div",{className:i.logsContainer},y.map(({line:l})=>e.createElement(e.Fragment,{key:(0,p.uniqueId)()},e.createElement(ee.l,{state:l.previous,size:"sm",muted:!0}),e.createElement(b.J,{name:"arrow-right",size:"sm"}),e.createElement(ee.l,{state:l.current}),e.createElement(h.K,null,l.values&&e.createElement(J,{record:l.values})),e.createElement("div",null,l.labels&&e.createElement(Q.P,{tags:(0,H.r)(Object.entries(l.labels),n).map(([u,x])=>`${u}=${x}`),onClick:s}))))))))});te.displayName="LogRecordViewerByTimestamp";function Ue({records:t,commonLabels:n}){const s=useStyles2(P),a=groupBy(t,i=>JSON.stringify(i.line.labels));return React.createElement(React.Fragment,null,Object.entries(a).map(([i,m])=>React.createElement(Stack,{direction:"column",key:i},React.createElement("h4",null,React.createElement(TagList,{tags:omitLabels(Object.entries(m[0].line.labels??{}),n).map(([o,c])=>`${o}=${c}`)})),React.createElement("div",{className:s.logsContainer},m.map(({line:o,timestamp:c})=>React.createElement("div",{key:uniqueId()},React.createElement(AlertStateTag,{state:o.previous,size:"sm",muted:!0}),React.createElement(Icon,{name:"arrow-right",size:"sm"}),React.createElement(AlertStateTag,{state:o.current}),React.createElement(Stack,null,o.values&&React.createElement(J,{record:o.values})),React.createElement("div",null,dateTimeFormat(c))))))))}const be=({time:t})=>{const n=new Date(t),s=(0,R.wW)(P);return e.createElement("div",{className:s.timestampWrapper},e.createElement(h.K,{alignItems:"center",gap:1},e.createElement(b.J,{name:"clock-nine",size:"sm"}),e.createElement("span",{className:s.timestampText},(0,Re.dq)(n)),e.createElement("small",null,"(",xe(n)," ago)")))},J=e.memo(({record:t})=>{const n=Object.entries(t);return e.createElement(e.Fragment,null,n.map(([s,a])=>e.createElement(Te._,{key:s,label:s,value:a})))});J.displayName="AlertInstanceValues";const P=t=>({logsContainer:(0,g.css)`
    display: grid;
    grid-template-columns: max-content max-content max-content auto max-content;
    gap: ${t.spacing(2,1)};
    align-items: center;
  `,logsScrollable:(0,g.css)`
    height: 500px;
    overflow: scroll;

    flex: 1;
  `,timestampWrapper:(0,g.css)`
    color: ${t.colors.text.secondary};
  `,timestampText:(0,g.css)`
    color: ${t.colors.text.primary};
    font-size: ${t.typography.bodySmall.fontSize};
    font-weight: ${t.typography.fontWeightBold};
  `,listItemWrapper:(0,g.css)`
    background: transparent;
    outline: 1px solid transparent;

    transition:
      background 150ms,
      outline 150ms;
    padding: ${t.spacing(1)} ${t.spacing(1.5)};
  `});var Ie=r(53565),Ne=r(81517),ne=r(1713),Ce=r(99532),Me=r(7012);const ae=e.memo(({frames:t,timeRange:n,onPointerMove:s=p.noop})=>{const a=(0,R.l4)(),{setupCursorTracking:i}=Oe(s);return e.createElement(Ie.Z,{disableHeight:!0},({width:m})=>e.createElement(Ce.K,{frames:t,timeRange:n,timeZone:"browser",mode:Me.KN.Changes,height:18*t.length+50,width:m,showValue:ne.Jp.Never,theme:a,rowHeight:.8,legend:{calcs:[],displayMode:ne.jK.List,placement:"bottom",showLegend:!0},legendItems:[{label:"Normal",color:a.colors.success.main,yAxis:1},{label:"Pending",color:a.colors.warning.main,yAxis:1},{label:"Alerting",color:a.colors.error.main,yAxis:1},{label:"NoData",color:a.colors.info.main,yAxis:1},{label:"Mixed",color:a.colors.text.secondary,yAxis:1}]},o=>(i(o),null)))});function Oe(t){const n=(0,e.useRef)(new Ne.X({seriesIdx:0,pointIdx:0}));return(0,e.useEffect)(()=>{const a=n.current.subscribe(({seriesIdx:i,pointIdx:m})=>{t&&t(i,m)});return()=>{a.unsubscribe()}},[t]),{setupCursorTracking:a=>{a.setSync();const i=a.getTooltipInterpolator();i&&a.addHook("setCursor",m=>{i(o=>{if(o){const c=n.current.getValue();n.current.next({...c,seriesIdx:o})}},o=>{if(o){const c=n.current.getValue();n.current.next({...c,pointIdx:o})}},()=>{},m)})}}}ae.displayName="LogTimelineViewer";var re=r(58309),De=r(64282),Ae=r(70129),se=r(91470);function Fe(t,n){const s=(0,R.l4)();return(0,e.useMemo)(()=>{const a=t?.data?.values[0]??[],i=$e(a)?a:[],m=t?.data?.values[1]??[],o=i.reduce((d,v,O)=>{const S=m[O];return ze(S)&&d.push({timestamp:v,line:S}),d},[]),c=(0,p.groupBy)(o,d=>JSON.stringify(d.line.labels)),l=Object.keys(c).map(d=>Object.entries(JSON.parse(d))),u=(0,H.z)(l),x=n?(0,F.Zh)(n):[],E=Object.entries(c).filter(([d])=>{const v=JSON.parse(d);return(0,F.eD)(v,x)}).map(([d,v])=>je(d,v,u,s));return{historyRecords:o.filter(({line:d})=>d.labels&&(0,F.eD)(d.labels,x)),dataFrames:E,commonLabels:u,totalRecordsCount:o.length}},[t,n,s])}function $e(t){return t.every(n=>typeof n=="number")}function ze(t){return typeof t=="object"&&t!==null&&"current"in t&&"previous"in t}function je(t,n,s,a){const i=Object.entries(JSON.parse(t)),m={name:"time",type:re.fS.time,values:[...n.map(l=>l.timestamp),Date.now()],config:{displayName:"Time",custom:{fillOpacity:100}}},o=m.values.map((l,u)=>u);o.sort((0,Ae.Mo)(m));const c=[...n.map(l=>l.line.current),n.at(-1)?.line.current],y={fields:[{...m,values:m.values.map((l,u)=>m.values[o[u]])},{name:"state",type:re.fS.string,values:c.map((l,u)=>c[o[u]]),config:{displayName:(0,H.r)(i,s).map(([l,u])=>`${l}=${u}`).join(", "),color:{mode:"thresholds"},custom:{fillOpacity:100},mappings:[{type:se.Hi.ValueToText,options:{Alerting:{color:a.colors.error.main},Pending:{color:a.colors.warning.main},Normal:{color:a.colors.success.main},NoData:{color:a.colors.info.main}}}],thresholds:{mode:se.H3.Absolute,steps:[]}}}],length:m.values.length,name:t};return y.fields.forEach(l=>{l.display=(0,De.U)({field:l,theme:a})}),y}const Ze=12,Ve=({ruleUID:t})=>{const n=(0,R.wW)(le),[s,a]=(0,e.useState)(""),i=(0,e.useRef)(new Map),{getValues:m,setValue:o,register:c,handleSubmit:y}=(0,N.cI)({defaultValues:{query:""}}),{useGetRuleHistoryQuery:l}=ge,u=(0,e.useMemo)(()=>He(),[]),{currentData:x,isLoading:M,isError:E,error:d}=l({ruleUid:t,from:u.from.unix(),to:u.to.unix(),limit:250}),{dataFrames:v,historyRecords:O,commonLabels:S,totalRecordsCount:C}=Fe(x,s),{frameSubset:f,frameSubsetTimestamps:j,frameTimeRange:W}=Be(v),w=(0,e.useCallback)(I=>{const V=(0,F.vB)(m("query"),I);a(V),o("query",V)},[a,o,m]),Z=(0,e.useCallback)(()=>{a(""),o("query","")},[a,o]),D=(0,e.useRef)(void 0),U=(0,e.useCallback)((I,V)=>{D.current?.classList.remove(n.highlightedLogRecord);const we=j[V],ie=i.current.get(we);ie?.classList.add(n.highlightedLogRecord),D.current=ie},[j,n.highlightedLogRecord]);if(M)return e.createElement("div",null,"Loading...");if(E)return e.createElement(A.b,{title:"Error fetching the state history",severity:"error"},d instanceof Error?d.message:"Unable to fetch alert state history");const Pe=f.length<v.length,We=C>0?`No matches were found for the given filters among the ${C} instances`:"No state transitions have occurred in the last 30 days";return e.createElement("div",{className:n.fullSize},e.createElement("form",{onSubmit:y(I=>a(I.query))},e.createElement(oe,{...c("query"),showClearFilterSuffix:!!s,onClearFilterClick:Z}),e.createElement("input",{type:"submit",hidden:!0})),!(0,p.isEmpty)(S)&&e.createElement("div",{className:n.commonLabels},e.createElement(h.K,{gap:1,alignItems:"center"},e.createElement("strong",null,"Common labels"),e.createElement(K.u,{content:"Common labels are the ones attached to all of the alert instances"},e.createElement(b.J,{name:"info-circle"}))),e.createElement(Q.P,{tags:S.map(I=>I.join("="))})),(0,p.isEmpty)(f)?e.createElement(e.Fragment,null,e.createElement("div",{className:n.emptyState},We,C>0&&e.createElement(G.zx,{variant:"secondary",type:"button",onClick:Z},"Clear filters"))):e.createElement(e.Fragment,null,e.createElement("div",{className:n.graphWrapper},e.createElement(ae,{frames:f,timeRange:W,onPointerMove:U})),Pe&&e.createElement("div",{className:n.moreInstancesWarning},e.createElement(h.K,{direction:"row",alignItems:"center",gap:1},e.createElement(b.J,{name:"exclamation-triangle",size:"sm"}),e.createElement("small",null,`Only showing ${f.length} out of ${v.length} instances. Click on the labels to narrow down the results`))),e.createElement(te,{records:O,commonLabels:S,onRecordsRendered:I=>i.current=I,onLabelClick:w})))};function Be(t){return(0,e.useMemo)(()=>{const n=(0,p.take)(t,Ze),s=(0,p.sortBy)((0,p.uniq)(n.flatMap(y=>y.fields[0].values))),a=Math.min(...s),i=Math.max(...s),m=(0,T.CQ)(a),o=(0,T.CQ)(i);return{frameSubset:n,frameSubsetTimestamps:s,frameTimeRange:{from:m,to:o,raw:{from:m,to:o}}}},[t])}const oe=e.forwardRef(({showClearFilterSuffix:t,onClearFilterClick:n,...s},a)=>e.createElement(ce.g,{label:e.createElement(me._,{htmlFor:"instancesSearchInput"},e.createElement(h.K,{gap:.5},e.createElement("span",null,"Filter instances"),e.createElement(fe.z,{content:e.createElement(e.Fragment,null,"Use label matcher expression (like ",e.createElement("code",null,"{foo=bar}"),") or click on an instance label to filter instances")},e.createElement(b.J,{name:"info-circle",size:"sm"}))))},e.createElement(ue.I,{id:"instancesSearchInput",prefix:e.createElement(b.J,{name:"search"}),suffix:t&&e.createElement(G.zx,{fill:"text",icon:"times",size:"sm",onClick:n},"Clear"),placeholder:"Filter instances",ref:a,...s})));oe.displayName="SearchFieldInput";function He(){const t=(0,T.CQ)().subtract(30,"days"),n=(0,T.CQ)();return{from:t,to:n,raw:{from:t,to:n}}}const le=t=>({fullSize:(0,g.css)`
    min-width: 100%;
    height: 100%;

    display: flex;
    flex-direction: column;
  `,graphWrapper:(0,g.css)`
    padding: ${t.spacing()} 0;
  `,emptyState:(0,g.css)`
    color: ${t.colors.text.secondary};

    display: flex;
    flex-direction: column;
    gap: ${t.spacing(2)};
    align-items: center;
    margin: auto auto;
  `,moreInstancesWarning:(0,g.css)`
    color: ${t.colors.warning.text};
    padding: ${t.spacing()};
  `,commonLabels:(0,g.css)`
    display: grid;
    grid-template-columns: max-content auto;
  `,highlightedLogRecord:(0,g.css)`
    background: ${t.colors.primary.transparent} !important;
    outline: 1px solid ${t.colors.primary.shade} !important;
  `}),Je=Ve},13405:(B,L,r)=>{r.d(L,{r:()=>e,z:()=>N});var g=r(56375),p=r.n(g);function e(T,R){return T.filter(A=>!R.find(h=>JSON.stringify(h)===JSON.stringify(A)))}function N(T){const R=T.flatMap(h=>h);return(0,g.uniqBy)(R.filter(h=>R.filter(b=>(0,g.isEqual)(h,b)).length===Object.keys(T).length),h=>JSON.stringify(h))}},87474:(B,L,r)=>{r.d(L,{Z:()=>g});function g(p,e){if(p==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var N in e)Object.prototype.hasOwnProperty.call(e,N)&&(p[N]=e[N]);return p}},37166:(B,L,r)=>{r.d(L,{Z:()=>p});var g=r(87474);function p(e){return(0,g.Z)({},e)}}}]);

//# sourceMappingURL=3862.10982e8070800bab8a76.js.map