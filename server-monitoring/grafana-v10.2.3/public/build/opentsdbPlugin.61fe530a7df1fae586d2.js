"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3168],{30728:(Be,q,g)=>{g.r(q),g.d(q,{plugin:()=>Pe});var _=g(41466),t=g(85960),oe=g(90857),ie=g(42337),ce=g(51637),$=g(20519),x=g(27436),D=g(24956);const J=[{label:"<=2.1",value:1},{label:"==2.2",value:2},{label:"==2.3",value:3}],G=[{label:"second",value:1},{label:"millisecond",value:2}],me=s=>{const{onChange:e,value:a}=s,r=(0,t.useId)();return t.createElement(t.Fragment,null,t.createElement(ce.C,{label:"OpenTSDB settings"},t.createElement($.g,{htmlFor:`select-version-${r}`,label:"Version"},t.createElement(x.Ph,{inputId:`select-version-${r}`,options:J,value:J.find(l=>l.value===a.jsonData.tsdbVersion)??J[0],onChange:ee("tsdbVersion",a,e),width:20})),t.createElement($.g,{htmlFor:`select-resolution-${r}`,label:"Resolution"},t.createElement(x.Ph,{inputId:`select-resolution-${r}`,options:G,value:G.find(l=>l.value===a.jsonData.tsdbResolution)??G[0],onChange:ee("tsdbResolution",a,e),width:20})),t.createElement($.g,{htmlFor:`lookup-input-${r}`,label:"Lookup limit"},t.createElement(D.I,{id:`lookup-input-${r}`,type:"number",value:a.jsonData.lookupLimit??1e3,onChange:ge("lookupLimit",a,e),width:20}))))},ee=(s,e,a)=>r=>{a({...e,jsonData:{...e.jsonData,[s]:r.value}})},ge=(s,e,a)=>r=>{a({...e,jsonData:{...e.jsonData,[s]:r.currentTarget.value}})},ue=s=>{const{options:e,onOptionsChange:a}=s;return t.createElement(t.Fragment,null,t.createElement(ie.E,{defaultUrl:"http://localhost:4242",dataSourceConfig:e,onChange:a,secureSocksDSProxyEnabled:oe.config.secureSocksDSProxyEnabled}),t.createElement(me,{value:e,onChange:a}))};var B=g(66681),te=g(86734),z=g(47257),b=g(11248),E=g(68921),U=g(114),K=g(5999);const de=(0,B.css)({paddingRight:"4px"});function fe({query:s,onChange:e,onRunQuery:a,aggregators:r,fillPolicies:l,tsdbVersion:c}){const i=r.map(o=>(0,b.E)(o)),n=l.map(o=>(0,b.E)(o));return t.createElement("div",{className:"gf-form-inline","data-testid":ae.section},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:8,tooltip:t.createElement("div",null,"Leave interval blank for auto or for example use ",t.createElement("code",null,"1m"))},"Down sample"),t.createElement(D.I,{width:25,className:de,"data-testid":ae.interval,placeholder:"interval",value:s.downsampleInterval??"",onChange:o=>{const m=o.currentTarget.value;e({...s,downsampleInterval:m})},onBlur:()=>a()})),t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:"auto",className:"query-keyword"},"Aggregator"),t.createElement(x.Ph,{className:"gf-form-input",value:s.downsampleAggregator?(0,b.E)(s.downsampleAggregator):void 0,options:i,onChange:({value:o})=>{o&&(e({...s,downsampleAggregator:o}),a())}})),c>=2&&t.createElement("div",{className:"gf-form"},t.createElement(U.W,{className:"width-6 query-keyword"},"Fill"),t.createElement(x.Ph,{inputId:"opentsdb-fillpolicy-select",value:s.downsampleFillPolicy?(0,b.E)(s.downsampleFillPolicy):void 0,options:n,onChange:({value:o})=>{o&&(e({...s,downsampleFillPolicy:o}),a())}})),t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword"},"Disable downsampling"),t.createElement(K.x,{value:s.disableDownsampling??!1,onChange:()=>{const o=s.disableDownsampling??!1;e({...s,disableDownsampling:!o}),a()}})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const ae={section:"opentsdb-downsample",interval:"downsample-interval"};var pe=g(97812),W=g.n(pe),u=g(56375),se=g(29165),F=g(97666);function he({query:s,onChange:e,onRunQuery:a,suggestTagKeys:r,filterTypes:l,suggestTagValues:c}){const i=(0,z.wW)(se.gN),[n,o]=(0,t.useState)(),[m,h]=(0,t.useState)(),[p,N]=(0,t.useState)(!1),[T,y]=(0,t.useState)("iliteral_or"),[C,I]=(0,t.useState)(""),[v,A]=(0,t.useState)(""),[O,S]=(0,t.useState)(!1),[R,X]=(0,t.useState)(""),Y=l.map(d=>(0,b.E)(d));function f(){N(!p)}function P(){if(s.tags&&(0,u.size)(s.tags)>0){X("Please remove tags to use filters, tags and filters are mutually exclusive.");return}if(!p){N(!0);return}const d={type:T,tagk:C,filter:v,groupBy:O};s.filters=s.filters?s.filters.concat([d]):[d],y("literal_or"),I(""),A(""),S(!1),e(s),a(),f()}function M(d){s.filters?.splice(d,1),e(s),a()}function Ae(d,V){M(V),I(d.tagk),A(d.filter),y(d.type),S(d.groupBy),P()}const Me=" ",De=(0,t.useCallback)((d,V)=>{const Z=d.value??"";return V.split(Me).reduce((Le,Re)=>Le&&Z.toLowerCase().includes(Re.toLowerCase()),!0)},[]),Ke=W()(d=>c(d),350);return t.createElement("div",{className:"gf-form-inline","data-testid":Q.section},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:8,tooltip:t.createElement("div",null,"Filters does not work with tags, either of the two will work but not both.")},"Filters"),s.filters&&s.filters.map((d,V)=>t.createElement(E.c,{key:V,width:"auto","data-testid":Q.list+V},d.tagk," = ",d.type,"(",d.filter,"), groupBy = ",""+d.groupBy,t.createElement("button",{type:"button",className:i,onClick:()=>Ae(d,V)},t.createElement(F.J,{name:"pen"})),t.createElement("button",{type:"button",className:i,onClick:()=>M(V),"data-testid":Q.remove},t.createElement(F.J,{name:"times"})))),!p&&t.createElement("button",{className:"gf-form-label",type:"button",onClick:f,"aria-label":"Add filter"},t.createElement(F.J,{name:"plus"}))),p&&t.createElement("div",{className:"gf-form-inline"},t.createElement("div",{className:"gf-form"},t.createElement(x.Ph,{inputId:"opentsdb-suggested-tagk-select",className:"gf-form-input",value:C?(0,b.E)(C):void 0,placeholder:"key",allowCustomValue:!0,filterOption:De,onOpenMenu:async()=>{h(!0);const V=(await r(s)).map(Z=>(0,b.E)(Z));o(V),h(!1)},isLoading:m,options:n,onChange:({value:d})=>{d&&I(d)}})),t.createElement("div",{className:"gf-form"},t.createElement(U.W,{className:"width-4 query-keyword"},"Type"),t.createElement(x.Ph,{inputId:"opentsdb-aggregator-select",value:T?(0,b.E)(T):void 0,options:Y,onChange:({value:d})=>{d&&y(d)}})),t.createElement("div",{className:"gf-form"},t.createElement(x.qb,{inputId:"opentsdb-suggested-tagv-select",className:"gf-form-input",value:v?(0,b.E)(v):void 0,placeholder:"filter",allowCustomValue:!0,loadOptions:Ke,defaultOptions:[],onChange:({value:d})=>{d&&A(d)}})),t.createElement(E.c,{width:5,className:"query-keyword"},"Group by"),t.createElement(K.x,{value:O,onChange:()=>{S(!O)}}),t.createElement("div",{className:"gf-form"},R&&t.createElement("div",{className:"gf-form-label",title:R,"data-testid":Q.error},t.createElement(F.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})),t.createElement("div",{className:"gf-form-label"},t.createElement("button",{type:"button",className:i,onClick:P},"add filter"),t.createElement("button",{type:"button",className:i,onClick:f},t.createElement(F.J,{name:"times"}))))),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const Q={section:"opentsdb-filter",list:"opentsdb-filter-list",error:"opentsdb-filter-error",remove:"opentsdb-filter-remove"};function ve({query:s,onChange:e,onRunQuery:a,suggestMetrics:r,aggregators:l}){const c=l.map(n=>(0,b.E)(n)),i=W()(n=>r(n),350);return t.createElement("div",{className:"gf-form-inline","data-testid":re.section},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:8,className:"query-keyword"},"Metric"),t.createElement(x.qb,{width:25,inputId:"opentsdb-metric-select",className:"gf-form-input",value:s.metric?(0,b.E)(s.metric):void 0,placeholder:"Metric name",allowCustomValue:!0,loadOptions:i,defaultOptions:[],onChange:({value:n})=>{n&&(e({...s,metric:n}),a())}})),t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:"auto",className:"query-keyword"},"Aggregator"),t.createElement(x.Ph,{inputId:"opentsdb-aggregator-select",className:"gf-form-input",value:s.aggregator?(0,b.E)(s.aggregator):void 0,options:c,onChange:({value:n})=>{n&&(e({...s,aggregator:n}),a())}})),t.createElement("div",{className:"gf-form max-width-20"},t.createElement(E.c,{className:"query-keyword",width:6,tooltip:t.createElement("div",null,"Use patterns like $tag_tagname to replace part of the alias for a tag value")},"Alias"),t.createElement(D.I,{"data-testid":re.alias,placeholder:"series alias",value:s.alias??"",onChange:n=>{const o=n.currentTarget.value;e({...s,alias:o})},onBlur:()=>a()})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const re={section:"opentsdb-metricsection",alias:"metric-alias"};function Ee({query:s,onChange:e,onRunQuery:a,tsdbVersion:r}){return t.createElement("div",{className:"gf-form-inline","data-testid":L.section},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:8},"Rate"),t.createElement(K.x,{"data-testid":L.shouldComputeRate,value:s.shouldComputeRate??!1,onChange:()=>{const l=s.shouldComputeRate??!1;e({...s,shouldComputeRate:!l}),a()}})),s.shouldComputeRate&&t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:"auto"},"Counter"),t.createElement(K.x,{"data-testid":L.isCounter,value:s.isCounter??!1,onChange:()=>{const l=s.isCounter??!1;e({...s,isCounter:!l}),a()}})),s.shouldComputeRate&&s.isCounter&&t.createElement("div",{className:"gf-form"},t.createElement(U.W,{width:"auto",className:"query-keyword"},"Counter max"),t.createElement(D.I,{"data-testid":L.counterMax,placeholder:"max value",value:s.counterMax??"",onChange:l=>{const c=l.currentTarget.value;e({...s,counterMax:c})},onBlur:()=>a()}),t.createElement(U.W,{width:"auto",className:"query-keyword"},"Reset value"),t.createElement(D.I,{"data-testid":L.counterResetValue,placeholder:"reset value",value:s.counterResetValue??"",onChange:l=>{const c=l.currentTarget.value;e({...s,counterResetValue:c})},onBlur:()=>a()})),r>2&&t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:"auto"},"Explicit tags"),t.createElement(K.x,{"data-testid":L.explicitTags,value:s.explicitTags??!1,onChange:()=>{const l=s.explicitTags??!1;e({...s,explicitTags:!l}),a()}})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const L={section:"opentsdb-rate",shouldComputeRate:"opentsdb-shouldComputeRate",isCounter:"opentsdb-is-counter",counterMax:"opentsdb-counter-max",counterResetValue:"opentsdb-counter-reset-value",explicitTags:"opentsdb-explicit-tags"};function be({query:s,onChange:e,onRunQuery:a,suggestTagKeys:r,suggestTagValues:l,tsdbVersion:c}){const i=(0,z.wW)(se.gN),[n,o]=(0,t.useState)(),[m,h]=(0,t.useState)(),[p,N]=(0,t.useState)(!1),[T,y]=(0,t.useState)(""),[C,I]=(0,t.useState)(""),[v,A]=(0,t.useState)("");function O(){N(!p)}function S(){if(s.filters&&(0,u.size)(s.filters)>0){A("Please remove filters to use tags, tags and filters are mutually exclusive.");return}if(!p){N(!0);return}if(s.tags&&(0,u.has)(s.tags,T)){const f="Duplicate tag key '"+T+"'.";A(f);return}s.tags||(s.tags={}),s.tags[T]=C,y(""),I(""),e(s),a(),O()}function R(f){delete s.tags[f],e(s),a()}function X(f,P){R(f),y(f),I(P),S()}const Y=W()(f=>l(f),350);return t.createElement("div",{className:"gf-form-inline","data-testid":j.section},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{className:"query-keyword",width:8,tooltip:c>=2?t.createElement("div",null,"Please use filters, tags are deprecated in opentsdb 2.2"):void 0},"Tags"),s.tags&&Object.keys(s.tags).map((f,P)=>{const M=s.tags[f];return t.createElement(E.c,{key:P,width:"auto","data-testid":j.list+P},f,"=",M,t.createElement("button",{type:"button",className:i,onClick:()=>X(f,M)},t.createElement(F.J,{name:"pen"})),t.createElement("button",{type:"button",className:i,onClick:()=>R(f),"data-testid":j.remove},t.createElement(F.J,{name:"times"})))}),!p&&t.createElement("button",{className:"gf-form-label",type:"button",onClick:O,"aria-label":"Add tag"},t.createElement(F.J,{name:"plus"}))),p&&t.createElement("div",{className:"gf-form-inline"},t.createElement("div",{className:"gf-form"},t.createElement(x.Ph,{inputId:"opentsdb-suggested-tagk-select",className:"gf-form-input",value:T?(0,b.E)(""+T):void 0,placeholder:"key",allowCustomValue:!0,onOpenMenu:async()=>{h(!0);const P=(await r(s)).map(M=>(0,b.E)(M));o(P),h(!1)},isLoading:m,options:n,onChange:({value:f})=>{f&&y(f)}})),t.createElement("div",{className:"gf-form"},t.createElement(x.qb,{inputId:"opentsdb-suggested-tagv-select",className:"gf-form-input",value:C?(0,b.E)(C):void 0,placeholder:"value",allowCustomValue:!0,loadOptions:Y,defaultOptions:[],onChange:({value:f})=>{f&&I(f)}})),t.createElement("div",{className:"gf-form"},v&&t.createElement("div",{className:"gf-form-label",title:v,"data-testid":j.error},t.createElement(F.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})),t.createElement("div",{className:"gf-form-label"},t.createElement("button",{type:"button",className:i,onClick:S},"add tag"),t.createElement("button",{type:"button",className:i,onClick:O},t.createElement(F.J,{name:"times"}))))),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const j={section:"opentsdb-tag",list:"opentsdb-tag-list",error:"opentsdb-tag-error",remove:"opentsdb-tag-remove"};function Te({datasource:s,onRunQuery:e,onChange:a,query:r,range:l,queries:c}){const i=(0,z.wW)(ye),[n,o]=(0,t.useState)(["avg","sum","min","max","dev","zimsum","mimmin","mimmax"]),m=["none","nan","null","zero"],[h,p]=(0,t.useState)(["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"]),N=s.tsdbVersion;r.aggregator||(r.aggregator="sum"),r.downsampleAggregator||(r.downsampleAggregator="avg"),r.downsampleFillPolicy||(r.downsampleFillPolicy="none"),(0,t.useEffect)(()=>{s.getAggregators().then(v=>{v.length!==0&&o(v)})},[s]),(0,t.useEffect)(()=>{s.getFilterTypes().then(v=>{v.length!==0&&p(v)})},[s]);async function T(v){return s.metricFindQuery(`metrics(${v})`).then(I)}async function y(v){return s.metricFindQuery(`suggest_tagv(${v})`).then(I)}async function C(v){return s.suggestTagKeys(v)}function I(v){const A=s.getVariables().map(S=>({value:te.QX.escapeHtml(S),description:S})),O=v.map(S=>({value:te.QX.escapeHtml(S.text),description:S.text}));return A.concat(O)}return t.createElement("div",{className:i.container,"data-testid":we.editor},t.createElement("div",{className:i.visualEditor},t.createElement(ve,{query:r,onChange:a,onRunQuery:e,suggestMetrics:T,aggregators:n}),t.createElement(fe,{query:r,onChange:a,onRunQuery:e,aggregators:n,fillPolicies:m,tsdbVersion:N}),N>=2&&t.createElement(he,{query:r,onChange:a,onRunQuery:e,filterTypes:h,suggestTagValues:y,suggestTagKeys:C}),t.createElement(be,{query:r,onChange:a,onRunQuery:e,suggestTagValues:y,suggestTagKeys:C,tsdbVersion:N}),t.createElement(Ee,{query:r,onChange:a,onRunQuery:e,tsdbVersion:N})))}function ye(s){return{container:(0,B.css)`
      display: flex;
    `,visualEditor:(0,B.css)`
      flex-grow: 1;
    `,toggleButton:(0,B.css)`
      margin-left: ${s.spacing(.5)};
    `}}const we={editor:"opentsdb-editor"};var Ne=g(1050),Ce=g(59069),H=g(21964),k=g(81838),Se=g(85431),w=g(98231),ne=g(45878),xe=g(13446),le=g(85445),Ve=g(31683);const Fe=s=>{const{query:e,onChange:a}=s,[r,l]=(0,t.useState)(e.target??""),[c,i]=(0,t.useState)(e.isGlobal??!1),n=(m,h)=>{a({...e,[m]:h,fromAnnotations:!0})},o=m=>{m=!m,i(m),n("isGlobal",m)};return t.createElement("div",{className:"gf-form-group"},t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:12},"OpenTSDB metrics query"),t.createElement(D.I,{value:r,onChange:m=>l(m.currentTarget.value??""),onBlur:()=>n("target",r),placeholder:"events.eventname"})),t.createElement("div",{className:"gf-form"},t.createElement(E.c,{width:12},"Show Global Annotations?"),t.createElement(K.x,{value:c,onChange:m=>o(c)})))},Ie=s=>({fromAnnotations:!0,target:s.target??"",name:s.name??"",isGlobal:s.isGlobal??!1}),ke=s=>{const e=s.target&&typeof s.target!="string"?s.target:Ie(s);return s.target=e,s};class Oe extends _.MF{constructor(e,a=(0,Ve.J)()){super(e),this.templateSrv=a,this.type="opentsdb",this.url=e.url,this.name=e.name,this.withCredentials=e.withCredentials,this.basicAuth=e.basicAuth,e.jsonData=e.jsonData||{},this.tsdbVersion=e.jsonData.tsdbVersion||1,this.tsdbResolution=e.jsonData.tsdbResolution||1,this.lookupLimit=e.jsonData.lookupLimit||1e3,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null,this.annotations={QueryEditor:Fe,prepareAnnotation:ke}}query(e){if(e.targets.some(n=>n.fromAnnotations)){const n=[];for(const o of e.targets)o.target&&n.push(new Ne.y(m=>{this.annotationEvent(e,o).then(h=>m.next({data:[(0,ne.g0)(h)]})).catch(h=>m.next({data:[(0,ne.g0)([])]})).finally(()=>m.complete())}));return(0,Ce.T)(...n)}const a=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),r=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),l=[];(0,u.each)(e.targets,n=>{n.metric&&l.push(this.convertTargetToQuery(n,e,this.tsdbVersion))});const c=(0,u.compact)(l);if((0,u.isEmpty)(c))return(0,H.of)({data:[]});const i={};return(0,u.each)(c,n=>{n.filters&&n.filters.length>0?(0,u.each)(n.filters,o=>{i[o.tagk]=!0}):(0,u.each)(n.tags,(o,m)=>{i[m]=!0})}),e.targets=(0,u.filter)(e.targets,n=>n.hide!==!0),this.performTimeSeriesQuery(c,a,r).pipe((0,Se.K)(n=>{throw n?.data?.error?.message||"Error performing time series query."}),(0,w.U)(n=>{const o=this.mapMetricsToTargets(n.data,e,this.tsdbVersion);return{data:(0,u.map)(n.data,(h,p)=>(p=o[p],p===-1&&(p=0),this._saveTagKeys(h),this.transformMetricData(h,i,e.targets[p],e,this.tsdbResolution)))}}))}annotationEvent(e,a){const r=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),l=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),c=[],i=[];c.push({aggregator:"sum",metric:a.target});const n=(0,u.compact)(c);return(0,k.n)(this.performTimeSeriesQuery(n,r,l).pipe((0,w.U)(o=>{if(o.data[0]){let m=o.data[0].annotations;a.isGlobal&&(m=o.data[0].globalAnnotations),m&&(0,u.each)(m,h=>{const p={text:h.description,time:Math.floor(h.startTime)*1e3,annotation:a};i.push(p)})}return i})))}targetContainsTemplate(e){if(e.filters&&e.filters.length>0){for(let a=0;a<e.filters.length;a++)if(this.templateSrv.containsTemplate(e.filters[a].filter))return!0}if(e.tags&&Object.keys(e.tags).length>0){for(const a in e.tags)if(this.templateSrv.containsTemplate(e.tags[a]))return!0}return!1}performTimeSeriesQuery(e,a,r){let l=!1;this.tsdbResolution===2&&(l=!0);const c={start:a,queries:e,msResolution:l,globalAnnotations:!0};this.tsdbVersion===3&&(c.showQuery=!0),r&&(c.end=r);const i={method:"POST",url:this.url+"/api/query",data:c};return this._addCredentialOptions(i),(0,le.i)().fetch(i)}suggestTagKeys(e){const a=e.metric??"";return Promise.resolve(this.tagKeys[a]||[])}_saveTagKeys(e){const a=Object.keys(e.tags);(0,u.each)(e.aggregateTags,r=>{a.push(r)}),this.tagKeys[e.metric]=a}_performSuggestQuery(e,a){return this._get("/api/suggest",{type:a,q:e,max:this.lookupLimit}).pipe((0,w.U)(r=>r.data))}_performMetricKeyValueLookup(e,a){if(!e||!a)return(0,H.of)([]);const r=a.split(",").map(n=>n.trim()),l=r[0];let c=l+"=*";r.length>1&&(c+=","+r.splice(1).join(","));const i=e+"{"+c+"}";return this._get("/api/search/lookup",{m:i,limit:this.lookupLimit}).pipe((0,w.U)(n=>{n=n.data.results;const o=[];return(0,u.each)(n,m=>{o.indexOf(m.tags[l])===-1&&o.push(m.tags[l])}),o}))}_performMetricKeyLookup(e){return e?this._get("/api/search/lookup",{m:e,limit:1e3}).pipe((0,w.U)(a=>{a=a.data.results;const r=[];return(0,u.each)(a,l=>{(0,u.each)(l.tags,(c,i)=>{r.indexOf(i)===-1&&r.push(i)})}),r})):(0,H.of)([])}_get(e,a){const r={method:"GET",url:this.url+e,params:a};return this._addCredentialOptions(r),(0,le.i)().fetch(r)}_addCredentialOptions(e){(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers={Authorization:this.basicAuth})}metricFindQuery(e){if(!e)return Promise.resolve([]);let a;try{a=this.templateSrv.replace(e,{},"distributed")}catch(y){return Promise.reject(y)}const r=y=>(0,u.map)(y,C=>({text:C})),l=/metrics\((.*)\)/,c=/tag_names\((.*)\)/,i=/tag_values\((.*?),\s?(.*)\)/,n=/suggest_tagk\((.*)\)/,o=/suggest_tagv\((.*)\)/,m=a.match(l);if(m)return(0,k.n)(this._performSuggestQuery(m[1],"metrics").pipe((0,w.U)(r)));const h=a.match(c);if(h)return(0,k.n)(this._performMetricKeyLookup(h[1]).pipe((0,w.U)(r)));const p=a.match(i);if(p)return(0,k.n)(this._performMetricKeyValueLookup(p[1],p[2]).pipe((0,w.U)(r)));const N=a.match(n);if(N)return(0,k.n)(this._performSuggestQuery(N[1],"tagk").pipe((0,w.U)(r)));const T=a.match(o);return T?(0,k.n)(this._performSuggestQuery(T[1],"tagv").pipe((0,w.U)(r))):Promise.resolve([])}testDatasource(){return(0,k.n)(this._performSuggestQuery("cpu","metrics").pipe((0,w.U)(()=>({status:"success",message:"Data source is working"}))))}getAggregators(){return this.aggregatorsPromise?this.aggregatorsPromise:(this.aggregatorsPromise=(0,k.n)(this._get("/api/aggregators").pipe((0,w.U)(e=>e.data&&(0,u.isArray)(e.data)?e.data.sort():[]))),this.aggregatorsPromise)}getFilterTypes(){return this.filterTypesPromise?this.filterTypesPromise:(this.filterTypesPromise=(0,k.n)(this._get("/api/config/filters").pipe((0,w.U)(e=>e.data?Object.keys(e.data).sort():[]))),this.filterTypesPromise)}transformMetricData(e,a,r,l,c){const i=this.createMetricLabel(e,r,a,l),n=[];return(0,u.each)(e.dps,(o,m)=>{c===2?n.push([o,m*1]):n.push([o,m*1e3])}),{target:i,datapoints:n}}createMetricLabel(e,a,r,l){if(a.alias){const n=(0,u.clone)(l.scopedVars||{});return(0,u.each)(e.tags,(o,m)=>{n["tag_"+m]={value:o}}),this.templateSrv.replace(a.alias,n)}let c=e.metric;const i=[];return(0,u.isEmpty)(e.tags)||(0,u.each)((0,u.toPairs)(e.tags),n=>{(0,u.has)(r,n[0])&&i.push(n[0]+"="+n[1])}),(0,u.isEmpty)(i)||(c+="{"+i.join(", ")+"}"),c}convertTargetToQuery(e,a,r){if(!e.metric||e.hide)return null;const l=this.interpolateVariablesInQuery(e,a.scopedVars);if(e.shouldComputeRate&&(l.rate=!0,l.rateOptions={counter:!!e.isCounter},e.counterMax&&e.counterMax.length&&(l.rateOptions.counterMax=parseInt(e.counterMax,10)),e.counterResetValue&&e.counterResetValue.length&&(l.rateOptions.resetValue=parseInt(e.counterResetValue,10)),r>=2&&(l.rateOptions.dropResets=!l.rateOptions.counterMax&&(!l.rateOptions.ResetValue||l.rateOptions.ResetValue===0))),!e.disableDownsampling){let c=this.templateSrv.replace(e.downsampleInterval||a.interval);c.match(/\.[0-9]+s/)&&(c=parseFloat(c)*1e3+"ms"),l.downsample=c+"-"+e.downsampleAggregator,e.downsampleFillPolicy&&e.downsampleFillPolicy!=="none"&&(l.downsample+="-"+e.downsampleFillPolicy)}return e.explicitTags&&(l.explicitTags=!0),l}interpolateVariablesInFilters(e,a){e.filters=e.filters?.map(r=>(r.tagk=this.templateSrv.replace(r.tagk,a,"pipe"),r.filter=this.templateSrv.replace(r.filter,a,"pipe"),r))}getVariables(){return this.templateSrv.getVariables().map(e=>`$${e.name}`)}mapMetricsToTargets(e,a,r){let l,c;return(0,u.map)(e,i=>r===3?i.query.index:(0,u.findIndex)(a.targets,n=>n.filters&&n.filters.length>0?n.metric===i.metric:n.metric===i.metric&&(0,u.every)(n.tags,(o,m)=>(l=this.templateSrv.replace(o,a.scopedVars,"pipe"),c=l.split("|"),(0,u.includes)(c,i.tags[m])||l==="*"))))}interpolateVariablesInQueries(e,a){return e.length?e.map(r=>this.interpolateVariablesInQuery(r,a)):e}interpolateVariablesInQuery(e,a){const r=(0,u.cloneDeep)(e);if(r.metric=this.templateSrv.replace(e.metric,a,"pipe"),r.aggregator="avg",e.aggregator&&(r.aggregator=this.templateSrv.replace(e.aggregator)),r.filters&&r.filters.length>0)this.interpolateVariablesInFilters(r,a);else if(r.tags)for(const l in r.tags)r.tags[l]=this.templateSrv.replace(r.tags[l],a,"pipe");return r}convertToTSDBTime(e,a,r){return e==="now"?null:(e=xe.parse(e,a,r),e.valueOf())}}const Pe=new _.hf(Oe).setQueryEditor(Te).setConfigEditor(ue)}}]);

//# sourceMappingURL=opentsdbPlugin.61fe530a7df1fae586d2.js.map