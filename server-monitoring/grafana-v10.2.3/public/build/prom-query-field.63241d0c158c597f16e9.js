"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6031],{38545:(Z,P,i)=>{i.d(P,{O:()=>s,t:()=>x});var w=i(36862);function s(h,L,m,b){if(!h)return!1;const N=D(L,b);if(!N.length)return!1;let d=N;if(h!==L){const C=D(h,b);d=N.flatMap(B=>C.filter($=>B.text===$.text)||B)}return d.map(C=>R(h,m,C)).filter(v)}function D(h,L){const m=[];return L.parse(h).iterate({enter:N=>{if(N.type.id===w._A){const d=N.node;m.push({node:d,text:h.substring(d.from,d.to)})}}}),m}function R(h,L,m){if(L.length===1){const d=m.node.from===m.node.to,C=d&&m.node.parent?m.node.parent:m.node,B=d?h.substring(C.from,C.to):m.text;return{startLineNumber:1,startColumn:C.from+1,endLineNumber:1,endColumn:C.to+1,error:B}}let b=0,N=0;for(let d=0;d<L.length;d++){if(N=b+L[d].length,m.node.from>N){b+=L[d].length+1;continue}return{startLineNumber:d+1,startColumn:m.node.from-b+1,endLineNumber:d+1,endColumn:m.node.to-b+1,error:m.text}}return null}function v(h){return h!==null}const x={__interval:{text:"1s",value:"1s"},__rate_interval:{text:"1s",value:"1s"},__auto:{text:"1s",value:"1s"},__interval_ms:{text:"1000",value:1e3},__range_ms:{text:"1000",value:1e3},__range_s:{text:"1",value:1},__range:{text:"1s",value:"1s"}}},63562:(Z,P,i)=>{i.r(P),i.d(P,{default:()=>$e});var w=i(66681),s=i(88190),D=i(56375),R={id:"promql",extensions:[".promql"],aliases:["Prometheus","prometheus","prom","Prom","promql","Promql","promQL","PromQL"],mimetypes:[],loader:function(){return Promise.all([i.e(8744),i.e(9773)]).then(i.bind(i,31175))}},v=i(85960),x=i(16858),h=i(90308),L=i(92369),m=i(47257),b=i(26927),N=i(38545);function d(){const e=new Map;return e.set("expandSuggestionDocs",(!0).toString()),{onDidChangeValue:t=>{},onDidChangeTarget:t=>{},onWillSaveState:t=>{},get:(t,n,r)=>e.get(t)??r,getBoolean:(t,n,r)=>{const o=e.get(t);return o!==void 0?o==="true":r},getNumber:(t,n,r)=>{const o=e.get(t);return o!==void 0?parseInt(o,10):r},store:(t,n,r,o)=>{n==null?e.delete(t):e.set(t,n.toString())},remove:(t,n)=>{e.delete(t)},keys:(t,n)=>Array.from(e.keys()),logStorage:()=>{console.log("logStorage: not implemented")},migrate:()=>Promise.resolve(void 0),isNew:t=>!0,flush:t=>Promise.resolve(void 0)}}let C=null;function B(){return C===null&&(C={storageService:d()}),C}var $=i(64065),ae=i(87438);class K extends Error{constructor(t){super("should never happen")}}async function G(e){return(await e.getAllMetricNames()).map(n=>({type:"METRIC_NAME",label:n.name,insertText:n.name,detail:`${n.name} : ${n.type}`,documentation:n.help}))}const Y=ae.r8.map(e=>({type:"FUNCTION",label:e.label,insertText:e.insertText??"",detail:e.detail,documentation:e.documentation}));async function X(e){const t=await G(e);return[...Y,...t]}const ue=["$__interval","$__range","$__rate_interval","1m","5m","10m","30m","1h","1d"].map(e=>({type:"DURATION",label:e,insertText:e}));async function ce(e){return(await e.getHistory()).slice(0,10).map(n=>({type:"HISTORY",label:n,insertText:n}))}function k(e,t){const n=[...t];return e!==void 0&&n.push({name:"__name__",value:e,op:"="}),`{${n.map(o=>`${o.name}${o.op}"${(0,$.U9)(o.value)}"`).join(",")}}`}async function de(e,t,n){if(e===void 0&&t.length===0)return n.getAllLabelNames();{const r=k(e,t);return await n.getSeriesLabels(r,t)}}async function J(e,t,n,r,o){return(await de(e,r,o)).map(a=>({type:"LABEL_NAME",label:a,insertText:`${a}${t}`,triggerOnInsert:n}))}async function me(e,t,n){return J(e,"=",!0,t,n)}async function ge(e,t,n){return J(e,"",!1,t,n)}async function fe(e,t,n,r){if(e===void 0&&n.length===0)return r.getLabelValues(t);{const o=k(e,n);return await r.getSeriesValues(t,o)}}async function pe(e,t,n,r,o){return(await fe(e,t,r,o)).map(a=>({type:"LABEL_VALUE",label:a,insertText:n?a:`"${a}"`}))}async function he(e,t){switch(e.type){case"IN_DURATION":return ue;case"IN_FUNCTION":return X(t);case"AT_ROOT":return X(t);case"EMPTY":{const n=await G(t);return[...await ce(t),...Y,...n]}case"IN_LABEL_SELECTOR_NO_LABEL_NAME":return me(e.metricName,e.otherLabels,t);case"IN_GROUPING":return ge(e.metricName,e.otherLabels,t);case"IN_LABEL_SELECTOR_WITH_LABEL_NAME":return pe(e.metricName,e.labelName,e.betweenQuotes,e.otherLabels,t);default:throw new K(e)}}function Ne(e,t){switch(t){case"parent":return e.parent;case"firstChild":return e.firstChild;case"lastChild":return e.lastChild;case"nextSibling":return e.nextSibling;default:throw new K(t)}}function p(e,t){let n=e;for(const[r,o]of t)if(n=Ne(n,r),n===null||n.type.id!==o)return null;return n}function F(e,t){return t.slice(e.from,e.to)}function Ce(e){const t=e.slice(1,e.length-1);if(e.startsWith('"')&&e.endsWith('"'))return t.replace(/\\"/,'"');if(e.startsWith("'")&&e.endsWith("'"))return t.replace(/\\'/,"'");if(e.startsWith("`")&&e.endsWith("`"))return t;throw new Error("FIXME: invalid string literal")}function ve(e,t){return e.every((n,r)=>n===t[r])}const U=0,Le=[{path:[s.m$,s.m6],fun:Re},{path:[s.vD],fun:Ie},{path:[s.yY],fun:Me},{path:[s.nv,s.Zm],fun:q},{path:[U,s.Zm],fun:q},{path:[U,s.uM],fun:Ae},{path:[s.XT],fun:Te}],ye=new Map([[s.M5,"="],[s.f0,"=~"],[s.IJ,"!="],[s.JW,"!~"]]);function Ee(e){const t=e.firstChild;return t===null?null:ye.get(t.type.id)??null}function be(e,t){if(e.type.id!==s.Zm)return null;const n=p(e,[["firstChild",s.m0]]);if(n===null)return null;const r=p(n,[["nextSibling",s.e8]]);if(r===null)return null;const o=Ee(r);if(o===null)return null;const l=p(e,[["lastChild",s.nv]]);if(l===null)return null;const a=F(n,t),g=Ce(F(l,t));return{name:a,value:g,op:o}}function j(e,t){if(e.type.id!==s.m$)return[];let n=p(e,[["firstChild",s.z5]]);const r=[];for(;n!==null;){const o=p(n,[["lastChild",s.Zm]]);if(o===null)return[];const l=be(o,t);l!==null&&r.push(l),n=p(n,[["firstChild",s.z5]])}return r.reverse(),r}function Se(e){let t=e.firstChild;const n=[];for(;t!==null;)n.push(t),t=t.nextSibling;return n}function H(e,t){if(e.type.id===t)return e;const n=Se(e);for(const r of n){const o=H(r,t);if(o!==null)return o}return null}function Te(e,t,n){const r=p(e,[["parent",s.Ip],["parent",s.aZ]]);if(r===null)return null;const o=r.getChild(s.yY);if(o===null)return null;const l=H(o,s.tz);if(l===null)return null;const a=p(l,[["firstChild",s.xb]]);return a===null?null:{type:"IN_GROUPING",metricName:F(a,t),otherLabels:[]}}function q(e,t,n){const r=!e.type.isError,o=p(e,[["parent",s.Zm]]);if(o===null)return null;const l=p(o,[["firstChild",s.m0]]);if(l===null)return null;const a=F(l,t),g=p(o,[["parent",s.z5]]);if(g===null)return null;let _=g,S=null;for(;S===null;){const f=_.parent;if(f===null)return null;const{id:W}=f.type;switch(W){case s.z5:_=f;continue;case s.m$:S=f;continue;default:return null}}const y=j(S,t).filter(f=>f.name!==a),E=p(S,[["parent",s.m6],["firstChild",s.tz],["firstChild",s.xb]]);return E===null?{type:"IN_LABEL_SELECTOR_WITH_LABEL_NAME",labelName:a,betweenQuotes:r,otherLabels:y}:{type:"IN_LABEL_SELECTOR_WITH_LABEL_NAME",metricName:F(E,t),labelName:a,betweenQuotes:r,otherLabels:y}}function Ie(e,t,n){return{type:"AT_ROOT"}}function Me(e,t,n){return{type:"IN_FUNCTION"}}function Ae(e,t,n){return{type:"IN_DURATION"}}function Oe(e){return H(e,U)!==null}function Re(e,t,n){if(Oe(e))return null;const r=p(e,[["firstChild",s.z5]]);if(r!==null&&!t.slice(r.to,n).includes(","))return null;const o=p(e,[["parent",s.m6],["firstChild",s.tz],["firstChild",s.xb]]),l=j(e,t);return o===null?{type:"IN_LABEL_SELECTOR_NO_LABEL_NAME",otherLabels:l}:{type:"IN_LABEL_SELECTOR_NO_LABEL_NAME",metricName:F(o,t),otherLabels:l}}function xe(e,t){const n=e.cursorAt(t);for(;;){if(n.from===t&&n.to===t){const{node:r}=n;if(r.type.isError)return r}if(!n.next())break}return null}function Pe(e,t){if(e==="")return{type:"EMPTY"};const n=s.E2.parse(e),r=xe(n,t),o=r!=null?r.cursor():n.cursorAt(t),l=o.node,a=[o.type.id];for(;o.parent();)a.push(o.type.id);for(let g of Le)if(ve(g.path,a))return g.fun(l,e,t);return null}function we(){return{showWords:!1}}function De(e,t){switch(e){case"DURATION":return t.languages.CompletionItemKind.Unit;case"FUNCTION":return t.languages.CompletionItemKind.Variable;case"HISTORY":return t.languages.CompletionItemKind.Snippet;case"LABEL_NAME":return t.languages.CompletionItemKind.Enum;case"LABEL_VALUE":return t.languages.CompletionItemKind.EnumMember;case"METRIC_NAME":return t.languages.CompletionItemKind.Constructor;default:throw new K(e)}}function Be(e,t){return{triggerCharacters:["{",",","[","(","=","~"," ",'"'],provideCompletionItems:(r,o)=>{const l=r.getWordAtPosition(o),a=l!=null?e.Range.lift({startLineNumber:o.lineNumber,endLineNumber:o.lineNumber,startColumn:l.startColumn,endColumn:l.endColumn}):e.Range.fromPositions(o),g={column:o.column,lineNumber:o.lineNumber};if(window.getSelection){const y=window.getSelection()?.toString();y&&y.length>0&&(g.column=g.column-y.length)}const _=r.getOffsetAt(g),S=Pe(r.getValue(),_);return(S!=null?he(S,t):Promise.resolve([])).then(y=>{const E=y.length.toString().length;return{suggestions:y.map((f,W)=>({kind:De(f.type,e),label:f.label,insertText:f.insertText,detail:f.detail,documentation:f.documentation,sortText:W.toString().padStart(E,"0"),range:a,command:f.triggerOnInsert?{id:"editor.action.triggerSuggest",title:""}:void 0}))}})}}}const Fe={codeLens:!1,contextmenu:!1,fixedOverflowWidgets:!0,folding:!1,fontSize:14,lineDecorationsWidth:8,lineNumbers:"off",minimap:{enabled:!1},overviewRulerBorder:!1,overviewRulerLanes:0,padding:{top:4,bottom:5},renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0,alwaysConsumeMouseWheel:!1},scrollBeyondLastLine:!1,suggest:we(),suggestFontSize:12,wordWrap:"on"},_e=2,V=R.id;let ee=!1;function We(e){if(ee===!1){ee=!0;const{aliases:t,extensions:n,mimetypes:r,loader:o}=R;e.languages.register({id:V,aliases:t,extensions:n,mimetypes:r}),o().then(l=>{e.languages.setMonarchTokensProvider(V,l.language),e.languages.setLanguageConfiguration(V,l.languageConfiguration)})}}const Ve=(e,t)=>({container:(0,w.css)`
      border-radius: ${e.shape.radius.default};
      border: 1px solid ${e.components.input.borderColor};
    `,placeholder:(0,w.css)`
      ::after {
        content: '${t}';
        font-family: ${e.typography.fontFamilyMonospace};
        opacity: 0.6;
      }
    `}),$e=e=>{const t=(0,h.Z)(),n=(0,v.useRef)(B()),r=(0,v.useRef)(null),{languageProvider:o,history:l,onBlur:a,onRunQuery:g,initialValue:_,placeholder:S,onChange:z,datasource:y}=e,E=(0,x.Z)(o),Q=(0,x.Z)(l),f=(0,x.Z)(g),W=(0,x.Z)(a),Ke=(0,x.Z)(z),te=(0,v.useRef)(null),Ue=(0,m.l4)(),ne=Ve(Ue,S);return(0,v.useEffect)(()=>()=>{te.current?.()},[]),v.createElement("div",{"aria-label":L.wl.components.QueryField.container,className:ne.container,ref:r},v.createElement(b.o,{overrideServices:n.current,options:Fe,language:"promql",value:_,beforeMount:u=>{We(u)},onMount:(u,T)=>{const re=u.createContextKey("isEditorFocused"+t,!1);u.onDidBlurEditorWidget(()=>{re.set(!1),W.current(u.getValue())}),u.onDidFocusEditorText(()=>{re.set(!0)});const He=()=>Promise.resolve(Q.current.map(c=>c.query.expr).filter(c=>c!==void 0)),ze=()=>{const{metrics:c,metricsMetadata:I}=E.current,O=c.map(M=>{const A=I?.[M];return{name:M,help:A?.help??"",type:A?.type??""}});return Promise.resolve(O)},Qe=()=>Promise.resolve(E.current.getLabelKeys()),Ze=c=>E.current.getLabelValues(c),Ge=E.current.getSeriesValues,Ye=E.current.getSeriesLabels,oe=Be(T,{getHistory:He,getAllMetricNames:ze,getAllLabelNames:Qe,getLabelValues:Ze,getSeriesValues:Ge,getSeriesLabels:Ye}),Xe={...oe,provideCompletionItems:(c,I,O,M)=>u.getModel()?.id!==c.id?{suggestions:[]}:oe.provideCompletionItems(c,I,O,M)},{dispose:ke}=T.languages.registerCompletionItemProvider(V,Xe);te.current=ke;const se=()=>{const c=r.current;if(c!==null){const I=u.getContentHeight();c.style.height=`${I+_e}px`,c.style.width="100%";const O=c.clientWidth;u.layout({width:O,height:I})}};u.onDidContentSizeChange(se),se();const Je=(0,D.debounce)(()=>{const c=u.getValue();Ke.current(c)},E.current.datasource.getDebounceTimeInMilliseconds());if(u.getModel()?.onDidChangeContent(()=>{Je()}),u.addCommand(T.KeyMod.Shift|T.KeyCode.Enter,()=>{f.current(u.getValue())},"isEditorFocused"+t),u.addCommand(T.KeyMod.CtrlCmd|T.KeyCode.KeyK,function(){i.g.dispatchEvent(new KeyboardEvent("keydown",{key:"k",metaKey:!0}))}),S){const c=[{range:new T.Range(1,1,1,1),options:{className:ne.placeholder,isWholeLine:!0}}];let I=[];const O=()=>{const M=u.getModel();if(!M)return;const A=M.getValueLength()===0?c:[];I=M.deltaDecorations(I,A)};O(),u.onDidChangeModelContent(O),u.onDidChangeModelContent(M=>{const A=u.getModel();if(!A)return;const le=A.getValue(),je=((0,N.O)(le,y.interpolateString(le,N.t),A.getLinesContent(),s.E2)||[]).map(({error:ie,...qe})=>({message:`${ie?`Error parsing "${ie}"`:"Parse error"}. The query appears to be incorrect and could fail to be executed.`,severity:T.MarkerSeverity.Error,...qe}));T.editor.setModelMarkers(A,"owner",je)})}}}))}},16858:(Z,P,i)=>{i.d(P,{Z:()=>D});var w=i(85960),s=function(R){var v=(0,w.useRef)(R);return v.current=R,v};const D=s}}]);

//# sourceMappingURL=prom-query-field.63241d0c158c597f16e9.js.map