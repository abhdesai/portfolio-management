"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6450],{6450:(Sr,Ce,d)=>{d.r(Ce),d.d(Ce,{plugin:()=>hr});var tt=d(41466),p=d(56375),s=d(85960),N=d(52219),le=d(51637),U=d(20519),V=d(27436),_=d(49199),at=d(42337),Q=d(84933),A=d(24956),ee=d(67954);const be="Direct browser access in the InfluxDB datasource is no longer available. Switch to server access mode.",G="default";var E=(t=>(t.InfluxQL="InfluxQL",t.Flux="Flux",t.SQL="SQL",t))(E||{}),Y=d(81368),ie=d(44706);const te=20,rt=t=>{const{options:{jsonData:e,secureJsonData:a,secureJsonFields:r}}=t,n=(0,p.uniqueId)("influxdb-flux-config");return s.createElement(s.Fragment,null,s.createElement(Y.Z,null,s.createElement(Q._,{labelWidth:te,label:"Organization",htmlFor:`${n}-org`},s.createElement(A.I,{id:`${n}-org`,className:"width-20",value:e.organization||"",onChange:(0,N._R)(t,"organization")}))),s.createElement(Y.Z,null,s.createElement(Q._,{labelWidth:te,label:"Token"},s.createElement(ie.m4,{isConfigured:!!(r&&r.token),value:a?.token||"",label:"Token","aria-label":"Token",className:"width-20",onReset:()=>(0,N.Mf)(t,"token"),onChange:(0,N.fi)(t,"token")}))),s.createElement(Y.Z,null,s.createElement(Q._,{labelWidth:te,label:"Default Bucket"},s.createElement(A.I,{className:"width-20",placeholder:"default bucket",value:e.defaultBucket||"",onChange:(0,N._R)(t,"defaultBucket")}))),s.createElement(Y.Z,null,s.createElement(Q._,{labelWidth:te,label:"Min time interval",tooltip:`A lower limit for the auto group by time interval. Recommended to be set to write frequency,
				for example 1m if your data is written every minute.`},s.createElement(A.I,{className:"width-20",placeholder:"10s",value:e.timeInterval||"",onChange:(0,N._R)(t,"timeInterval")}))))};var I=d(66681),K=d(47257),O=d(114);const Ae=[{label:"GET",value:"GET"},{label:"POST",value:"POST"}],z=20,xe=t=>{const{options:e,onOptionsChange:a}=t,{database:r,jsonData:n,secureJsonData:l,secureJsonFields:i}=e,o=(0,K.wW)(nt),u=(0,p.uniqueId)("influxdb-influxql-config");return s.createElement(s.Fragment,null,s.createElement(_.b,{severity:"info",title:"Database Access"},s.createElement("p",null,"Setting the database for this datasource does not deny access to other databases. The InfluxDB query syntax allows switching the database in the query. For example:",s.createElement("code",null,"SHOW MEASUREMENTS ON _internal")," or",s.createElement("code",null,'SELECT * FROM "_internal".."database" LIMIT 10'),s.createElement("br",null),s.createElement("br",null),"To support data isolation and security, make sure appropriate permissions are configured in InfluxDB.")),s.createElement(U.g,{horizontal:!0,label:s.createElement(O.W,{width:z},"Database"),className:o.horizontalField,htmlFor:`${u}-db`},s.createElement(A.I,{id:`${u}-db`,className:"width-20",value:n.dbName??r,onChange:c=>{a({...e,database:"",jsonData:{...n,dbName:c.currentTarget.value}})}})),s.createElement(U.g,{horizontal:!0,label:s.createElement(O.W,{width:z},"User"),className:o.horizontalField,htmlFor:`${u}-user`},s.createElement(A.I,{id:`${u}-user`,className:"width-20",value:e.user||"",onChange:(0,N.z_)(t,"user")})),s.createElement(U.g,{horizontal:!0,label:s.createElement(O.W,{width:z},"Password"),className:o.horizontalField},s.createElement(ie.m4,{isConfigured:!!(i&&i.password),value:l?.password||"",label:"Password","aria-label":"Password",className:"width-20",onReset:()=>(0,N.Mf)(t,"password"),onChange:(0,N.fi)(t,"password")})),s.createElement(U.g,{horizontal:!0,label:s.createElement(O.W,{width:z,tooltip:`You can use either GET or POST HTTP method to query your InfluxDB database. The POST
          method allows you to perform heavy requests (with a lots of WHERE clause) while the GET method
          will restrict you and return an error if the query is too large.`},"HTTP Method"),htmlFor:`${u}-http-method`,className:o.horizontalField},s.createElement(V.Ph,{inputId:`${u}-http-method`,className:"width-20",value:Ae.find(c=>c.value===e.jsonData.httpMode),options:Ae,defaultValue:e.jsonData.httpMode,onChange:(0,N.nx)(t,"httpMode")})),s.createElement(U.g,{horizontal:!0,label:s.createElement(O.W,{width:z,tooltip:"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example 1m if your data is written every minute."},"Min time interval"),className:o.horizontalField},s.createElement(A.I,{className:"width-20",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:(0,N._R)(t,"timeInterval")})))},nt=t=>({horizontalField:(0,I.css)({justifyContent:"initial",margin:`0 ${t.spacing(.5)} ${t.spacing(.5)} 0`})}),st=(t,e)=>{t([...e,{key:"",value:""}])},lt=(t,e,a)=>{const r=[...a];r.splice(t,1),e(r)},it=(t,e,a,r)=>{const n=[...e];n[a].key=t,r(n)},ot=(t,e,a,r)=>{const n=[...e];n[a].value=t,r(n)},ut=t=>{const{options:{jsonData:e,secureJsonData:a,secureJsonFields:r}}=t,n=e?.metadata?.length?e?.metadata?.map(o=>({key:Object.keys(o)[0],value:Object.values(o)[0]})):[{key:"",value:""}],[l,i]=(0,s.useState)(n);return(0,s.useEffect)(()=>{const{onOptionsChange:o,options:u}=t,c=l?.map(m=>({[m.key]:m.value})),f={...u.jsonData,metadata:c};o({...u,jsonData:f})},[l]),s.createElement("div",null,s.createElement("div",{className:"gf-form"},s.createElement("h6",null,"Token")),s.createElement("div",null,s.createElement(Q._,{labelWidth:20,label:"Token"},s.createElement(ie.m4,{width:40,name:"token",type:"text",value:a?.token||"",onReset:()=>(0,N.Mf)(t,"token"),onChange:(0,N.fi)(t,"token"),isConfigured:r?.token}))),s.createElement("div",null,s.createElement("div",{className:"gf-form"},s.createElement("h6",null,"MetaData")),l?.map((o,u)=>s.createElement(Y.Z,{key:u,style:{flexFlow:"row"}},s.createElement(Q._,{labelWidth:20,label:"Key"},s.createElement(A.I,{key:u,width:40,name:"key",type:"text",value:l[u]?.key||"",placeholder:"key",onChange:c=>it(c.currentTarget.value.trim(),l,u,i)})),s.createElement(Q._,{labelWidth:20,label:"Value"},s.createElement(A.I,{key:u,width:40,name:"value",type:"text",value:l[u]?.value?.toString()??"",placeholder:"value",onChange:c=>ot(c.currentTarget.value.trim(),l,u,i)})),u+1>=l.length&&s.createElement(O.W,{as:"button",className:"",onClick:()=>st(i,l),width:"auto"},"+"),u>0&&s.createElement(O.W,{as:"button",className:"",width:"auto",onClick:()=>lt(u,i,l)},"-")))))},W={[E.InfluxQL]:{label:"InfluxQL",value:E.InfluxQL,description:"The InfluxDB SQL-like query language."},[E.SQL]:{label:"SQL",value:E.SQL,description:"Native SQL language. Supported in InfluxDB 3.0"},[E.Flux]:{label:"Flux",value:E.Flux,description:"Supported in InfluxDB 2.x and 1.8+"}},ct=[W[E.InfluxQL],W[E.Flux]],mt=[W[E.InfluxQL],W[E.SQL],W[E.Flux]];class dt extends s.PureComponent{constructor(e){super(e),this.state={maxSeries:""},this.versionNotice={Flux:"Support for Flux in Grafana is currently in beta",SQL:"Support for SQL in Grafana is currently in alpha"},this.onVersionChanged=a=>{const{options:r,onOptionsChange:n}=this.props,l={...r,jsonData:{...r.jsonData,version:a.value}};if(a.value===E.Flux){l.access="proxy",l.basicAuth=!0,l.jsonData.httpMode="POST";const{user:i,database:o,...u}=l;n(u)}else n(l)},this.state.maxSeries=e.options.jsonData.maxSeries?.toString()||"",this.htmlPrefix=(0,p.uniqueId)("influxdb-config")}renderJsonDataOptions(){switch(this.props.options.jsonData.version){case E.InfluxQL:return s.createElement(xe,{...this.props});case E.Flux:return s.createElement(rt,{...this.props});case E.SQL:return s.createElement(ut,{...this.props});default:return s.createElement(xe,{...this.props})}}render(){const{options:e,onOptionsChange:a}=this.props,r=e.access==="direct";return s.createElement(s.Fragment,null,s.createElement(le.C,null,s.createElement("h3",{className:"page-heading"},"Query language"),s.createElement(U.g,null,s.createElement(V.Ph,{"aria-label":"Query language",className:"width-30",value:W[e.jsonData.version??E.InfluxQL],options:ee.config.featureToggles.influxdbSqlSupport?mt:ct,defaultValue:W[E.InfluxQL],onChange:this.onVersionChanged}))),e.jsonData.version!==E.InfluxQL&&s.createElement(_.b,{severity:"info",title:this.versionNotice[e.jsonData.version]},s.createElement("p",null,"Please report any issues to: ",s.createElement("br",null),s.createElement("a",{href:"https://github.com/grafana/grafana/issues/new/choose"},"https://github.com/grafana/grafana/issues"))),r&&s.createElement(_.b,{title:"Error",severity:"error"},be),s.createElement(at.E,{showAccessOptions:r,dataSourceConfig:e,defaultUrl:"http://localhost:8086",onChange:a,secureSocksDSProxyEnabled:ee.config.secureSocksDSProxyEnabled}),s.createElement(le.C,null,s.createElement("h3",{className:"page-heading"},"InfluxDB Details"),this.renderJsonDataOptions(),s.createElement(Q._,{labelWidth:20,label:"Max series",tooltip:"Limit the number of series/tables that Grafana will process. Lower this number to prevent abuse, and increase it if you have lots of small time series and not all are shown. Defaults to 1000."},s.createElement(A.I,{placeholder:"1000",type:"number",className:"width-20",value:this.state.maxSeries,onChange:n=>{this.setState({maxSeries:n.currentTarget.value});const l=parseInt(n.currentTarget.value,10);(0,N.tp)(this.props,"maxSeries",Number.isFinite(l)?l:void 0)}}))))}}const ft=dt;var ae=d(49531),T=d(69482);const oe=[],S={Aggregations:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function Re(t){const e=oe[t.type];if(!e)throw{message:"Could not find query part "+t.type};return new T.XN(t,e)}function v(t){oe[t.type]=new T.zU(t),t.category.push(oe[t.type])}const ue=[];function pt(t,e){return e+' AS "'+t.params[0]+'"'}function Ne(t){const e=t.params[0];if(e==="*")return"*";let a=`"${e}"`;return e.endsWith("::tag")&&(a=`"${e.slice(0,-5)}"::tag`),e.endsWith("::field")&&(a=`"${e.slice(0,-7)}"::field`),a}function x(t,e){for(let a=0;a<t.length;a++){const r=t[a];if(r.def.category===S.Aggregations){if(r.def.type===e.def.type)return;if(r.def.type==="count"&&e.def.type==="distinct")break;if(r.def.type==="distinct"){const n=t.length>=a+2;if(e.def.type!=="count"&&n)t[a+1].def.category===S.Aggregations&&t.splice(a+1,1);else if(e.def.type==="count"){(!n||t[a+1].def.type!=="count")&&t.splice(a+1,0,e);return}}t[a]=e;return}if(r.def.category===S.Selectors){t[a]=e;return}}t.splice(1,0,e)}function w(t,e){let a;for(a=0;a<t.length;a++){const r=t[a];if(r.def.category===S.Math||r.def.category===S.Aliasing)break}t.splice(a,0,e)}function gt(t,e){const a=t.length;if(a>0){if(t[a-1].def.type==="math"){t[a-1]=e;return}if(a>1&&t[a-2].def.type==="math"){t[a-2]=e;return}else if(t[a-1].def.type==="alias"){t.splice(a-1,0,e);return}}t.push(e)}function ht(t,e){const a=t.length;if(a>0&&t[a-1].def.type==="alias"){t[a-1]=e;return}t.push(e)}function yt(t,e,a){const r=(0,p.map)(t,n=>Re({type:n.def.type,params:(0,p.clone)(n.params)}));a.selectModels.push(r)}v({type:"field",addStrategy:yt,category:S.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:Ne}),v({type:"count",addStrategy:x,category:S.Aggregations,params:[],defaultParams:[],renderer:T.D}),v({type:"distinct",addStrategy:x,category:S.Aggregations,params:[],defaultParams:[],renderer:T.D}),v({type:"integral",addStrategy:x,category:S.Aggregations,params:[],defaultParams:[],renderer:T.D}),v({type:"mean",addStrategy:x,category:S.Aggregations,params:[],defaultParams:[],renderer:T.D}),v({type:"median",addStrategy:x,category:S.Aggregations,params:[],defaultParams:[],renderer:T.D}),v({type:"mode",addStrategy:x,category:S.Aggregations,params:[],defaultParams:[],renderer:T.D}),v({type:"sum",addStrategy:x,category:S.Aggregations,params:[],defaultParams:[],renderer:T.D}),v({type:"derivative",addStrategy:w,category:S.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:T.D}),v({type:"spread",addStrategy:w,category:S.Transformations,params:[],defaultParams:[],renderer:T.D}),v({type:"non_negative_derivative",addStrategy:w,category:S.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:T.D}),v({type:"difference",addStrategy:w,category:S.Transformations,params:[],defaultParams:[],renderer:T.D}),v({type:"non_negative_difference",addStrategy:w,category:S.Transformations,params:[],defaultParams:[],renderer:T.D}),v({type:"moving_average",addStrategy:w,category:S.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:T.D}),v({type:"cumulative_sum",addStrategy:w,category:S.Transformations,params:[],defaultParams:[],renderer:T.D}),v({type:"stddev",addStrategy:w,category:S.Transformations,params:[],defaultParams:[],renderer:T.D}),v({type:"time",category:ue,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:T.D}),v({type:"fill",category:ue,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:T.D}),v({type:"elapsed",addStrategy:w,category:S.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:T.D}),v({type:"holt_winters",addStrategy:w,category:S.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:T.D}),v({type:"holt_winters_with_fit",addStrategy:w,category:S.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:T.D}),v({type:"bottom",addStrategy:x,category:S.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:T.D}),v({type:"first",addStrategy:x,category:S.Selectors,params:[],defaultParams:[],renderer:T.D}),v({type:"last",addStrategy:x,category:S.Selectors,params:[],defaultParams:[],renderer:T.D}),v({type:"max",addStrategy:x,category:S.Selectors,params:[],defaultParams:[],renderer:T.D}),v({type:"min",addStrategy:x,category:S.Selectors,params:[],defaultParams:[],renderer:T.D}),v({type:"percentile",addStrategy:x,category:S.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:T.D}),v({type:"top",addStrategy:x,category:S.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:T.D}),v({type:"tag",category:ue,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:Ne}),v({type:"math",addStrategy:gt,category:S.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:T.C7}),v({type:"alias",addStrategy:ht,category:S.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:pt});const B={create:Re,getCategories:()=>S,replaceAggregationAdd:x};class P{constructor(e,a,r){this.selectModels=[],this.target=e,this.templateSrv=a,this.scopedVars=r,e.policy=e.policy||G,e.resultFormat=e.resultFormat||"time_series",e.orderByTime=e.orderByTime||"ASC",e.tags=e.tags||[],e.groupBy=e.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],e.select=e.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}updateProjection(){this.selectModels=(0,p.map)(this.target.select,e=>(0,p.map)(e,B.create)),this.groupByParts=(0,p.map)(this.target.groupBy,B.create)}updatePersistedParts(){this.target.select=(0,p.map)(this.selectModels,e=>(0,p.map)(e,a=>({type:a.def.type,params:a.params})))}hasGroupByTime(){return(0,p.find)(this.target.groupBy,e=>e.type==="time")}hasFill(){return(0,p.find)(this.target.groupBy,e=>e.type==="fill")}addGroupBy(e){let a=e.match(/^(\w+)\((.*)\)$/);if(!a||!this.target.groupBy)return;const r=a[1],n=a[2],l=B.create({type:r,params:[n]}),i=this.target.groupBy.length;i===0?this.target.groupBy.push(l.part):r==="time"?this.target.groupBy.splice(0,0,l.part):r==="tag"?this.target.groupBy[i-1].type==="fill"?this.target.groupBy.splice(i-1,0,l.part):this.target.groupBy.push(l.part):this.target.groupBy.push(l.part),this.updateProjection()}removeGroupByPart(e,a){const r=B.getCategories();e.def.type==="time"&&(this.target.groupBy=(0,p.filter)(this.target.groupBy,n=>n.type!=="fill"),this.target.select=(0,p.map)(this.target.select,n=>(0,p.filter)(n,l=>{const i=B.create(l);return!(i.def.category===r.Aggregations||i.def.category===r.Selectors)}))),this.target.groupBy.splice(a,1),this.updateProjection()}removeSelect(e){this.target.select.splice(e,1),this.updateProjection()}removeSelectPart(e,a){if(a.def.type==="field"){if(this.selectModels.length>1){const r=(0,p.indexOf)(this.selectModels,e);this.selectModels.splice(r,1)}}else{const r=(0,p.indexOf)(e,a);e.splice(r,1)}this.updatePersistedParts()}addSelectPart(e,a){const r=B.create({type:a});r.def.addStrategy(e,r,this),this.updatePersistedParts()}isOperatorTypeHandler(e,a,r){let n;if(e==="Is Not"?e="!=":e="=",r.endsWith("::tag"))return n="'"+a.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'",{operator:e,value:n};let l=a.toLowerCase();return isNaN(parseFloat(a))?["true","false"].includes(l)?n=l:n="'"+a.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'":n=a,{operator:e,value:n}}renderTagCondition(e,a,r){let n="",l=e.operator,i=e.value;if(a>0&&(n=(e.condition||"AND")+" "),l||(/^\/.*\/$/.test(i)?l="=~":l="="),l!=="=~"&&l!=="!~")if(r&&(i=this.templateSrv.replace(i,this.scopedVars)),l.startsWith("Is")){let u=this.isOperatorTypeHandler(l,i,e.key);l=u.operator,i=u.value}else(!l.startsWith(">")&&!l.startsWith("<")||l==="<>")&&(i="'"+i.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'");else r&&(i=this.templateSrv.replace(i,this.scopedVars,"regex"));let o=`"${e.key}"`;return e.key.endsWith("::tag")&&(o=`"${e.key.slice(0,-5)}"::tag`),e.key.endsWith("::field")&&(o=`"${e.key.slice(0,-7)}"::field`),n+o+" "+l+" "+i}getMeasurementAndPolicy(e){let a=this.target.policy,r=this.target.measurement||"measurement";return r.match("^/.*/$")?e&&(r=this.templateSrv.replace(r,this.scopedVars,"regex")):r='"'+r+'"',a!==G?a='"'+this.target.policy+'".':a="",a+r}interpolateQueryStr(e,a,r){return!a.multi&&!a.includeAll?e:typeof e=="string"?(0,ae.yI)(e):"("+(0,p.map)(e,ae.yI).join("|")+")"}render(e){const a=this.target;if(a.rawQuery)return e?this.templateSrv.replace(a.query,this.scopedVars,this.interpolateQueryStr):a.query;let r="SELECT ",n,l;for(n=0;n<this.selectModels.length;n++){const u=this.selectModels[n];let c="";for(l=0;l<u.length;l++)c=u[l].render(c);n>0&&(r+=", "),r+=c}r+=" FROM "+this.getMeasurementAndPolicy(e)+" WHERE ";const i=(0,p.map)(a.tags,(u,c)=>this.renderTagCondition(u,c,e));i.length>0&&(r+="("+i.join(" ")+") AND "),r+="$timeFilter";let o="";for(n=0;n<this.groupByParts.length;n++){const u=this.groupByParts[n];n>0&&(o+=u.def.type==="fill"?" ":", "),o+=u.render("")}return o.length&&(r+=" GROUP BY "+o),a.fill&&(r+=" fill("+a.fill+")"),a.orderByTime==="DESC"&&(r+=" ORDER BY time DESC"),a.limit&&(r+=" LIMIT "+a.limit),a.slimit&&(r+=" SLIMIT "+a.slimit),a.tz&&(r+=" tz('"+a.tz+"')"),r}renderAdhocFilters(e){return(0,p.map)(e,(r,n)=>this.renderTagCondition(r,n,!0)).join(" ")}}function Oe(t){const e=(0,p.cloneDeep)(t);return new P(e).render(!1)}function Et(t){if(t.policy!==void 0&&t.resultFormat!==void 0&&t.orderByTime!==void 0&&t.tags!==void 0&&t.groupBy!==void 0&&t.select!==void 0)return t;const e=(0,p.cloneDeep)(t);return new P(e).target}function St(t,e,a){const r=(0,p.cloneDeep)(t),n=new P(r);return n.addSelectPart(n.selectModels[a],e),n.target}function vt(t,e,a){const r=(0,p.cloneDeep)(t),n=new P(r),l=n.selectModels[a];return n.removeSelectPart(l,l[e]),n.target}function Tt(t,e,a,r){const n=[...t.select??[]];return n[e]=[...n[e]],n[e][a]={...n[e][a],params:r},{...t,select:n}}function It(t,e){const a=(0,p.cloneDeep)(t),r=new P(a);return r.addGroupBy(e),r.target}function Ct(t,e){const a=(0,p.cloneDeep)(t),r=new P(a);return r.removeGroupByPart(r.groupByParts[e],e),r.target}function bt(t,e,a){const r=[...t.groupBy??[]];return r[e]={...r[e],params:a},{...t,groupBy:r}}var ce=d(12399),$=d(42206),At=d(62577),re=d(29165),xt=d(89703),F=d(68921);const Rt=[{label:"Show buckets",description:"List the available buckets (table)",value:"buckets()"},{label:"Simple query",description:"filter by measurement and field",value:`from(bucket: "db/rp")
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> filter(fn: (r) =>
    r._measurement == "example-measurement" and
    r._field == "example-field"
  )`},{label:"Grouped Query",description:"Group by (min/max/sum/median)",value:`// v.windowPeriod is a variable referring to the current optimized window period (currently: $interval)
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_measurement"] == "measurement1" or r["_measurement"] =~ /^.*?regex.*$/)
  |> filter(fn: (r) => r["_field"] == "field2" or r["_field"] =~ /^.*?regex.*$/)
  |> aggregateWindow(every: v.windowPeriod, fn: mean|median|max|count|derivative|sum)
  |> yield(name: "some-name")`},{label:"Filter by value",description:"Results between a min/max",value:`// v.bucket, v.timeRangeStart, and v.timeRange stop are all variables supported by the flux plugin and influxdb
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_value"] >= 10 and r["_value"] <= 20)`},{label:"Schema Exploration: (measurements)",description:"Get a list of measurement using flux",value:`import "influxdata/influxdb/v1"
v1.measurements(bucket: v.bucket)`},{label:"Schema Exploration: (fields)",description:"Return every possible key in a single table",value:`from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> keys()
  |> keep(columns: ["_value"])
  |> group()
  |> distinct()`},{label:"Schema Exploration: (tag keys)",description:"Get a list of tag keys using flux",value:`import "influxdata/influxdb/v1"
v1.tagKeys(bucket: v.bucket)`},{label:"Schema Exploration: (tag values)",description:"Get a list of tag values using flux",value:`import "influxdata/influxdb/v1"
v1.tagValues(
    bucket: v.bucket,
    tag: "host",
    predicate: (r) => true,
    start: -1d
)`}];class Nt extends s.PureComponent{constructor(){super(...arguments),this.onFluxQueryChange=e=>{this.props.onChange({...this.props.query,query:e}),this.props.onRunQuery()},this.onSampleChange=e=>{this.props.onChange({...this.props.query,query:e.value}),this.forceUpdate(),this.props.onRunQuery()},this.getSuggestions=()=>{const e=[{label:"v.timeRangeStart",kind:$.k.Property,detail:"The start time"},{label:"v.timeRangeStop",kind:$.k.Property,detail:"The stop time"},{label:"v.windowPeriod",kind:$.k.Property,detail:"based on max data points"},{label:"v.defaultBucket",kind:$.k.Property,detail:"bucket configured in the datsource"},{label:"v.organization",kind:$.k.Property,detail:"org configured for the datsource"}],a=(0,ce.J)();return a.getVariables().forEach(r=>{const n="${"+r.name+"}";let l=a.replace(n);l===n&&(l=""),e.push({label:n,kind:$.k.Text,detail:`(Template Variable) ${l}`})}),e},this.editorDidMountCallbackHack=e=>{setTimeout(()=>e.layout(),100)}}render(){const{query:e,theme:a}=this.props,r=Ot(a),n=s.createElement("div",null,"Type: ",s.createElement("i",null,"ctrl+space")," to show template variable suggestions ",s.createElement("br",null),"Many queries can be copied from Chronograf");return s.createElement(s.Fragment,null,s.createElement(At.p,{height:"100%",containerStyles:r.editorContainerStyles,language:"sql",value:e.query||"",onBlur:this.onFluxQueryChange,onSave:this.onFluxQueryChange,showMiniMap:!1,showLineNumbers:!0,getSuggestions:this.getSuggestions,onEditorDidMount:this.editorDidMountCallbackHack}),s.createElement("div",{className:(0,I.cx)("gf-form-inline",r.editorActions)},s.createElement(re.Qj,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/latest/query-data/get-started/"},"Flux language syntax"),s.createElement(xt.X,{options:Rt,value:"Sample query",onChange:this.onSampleChange,className:(0,I.css)`
              margin-top: -${a.spacing(.5)};
              margin-left: ${a.spacing(.5)};
            `}),s.createElement("div",{className:"gf-form gf-form--grow"},s.createElement("div",{className:"gf-form-label gf-form-label--grow"})),s.createElement(F.c,{width:5,tooltip:n},"Help")))}}const Ot=t=>({editorContainerStyles:(0,I.css)`
    height: 200px;
    max-width: 100%;
    resize: vertical;
    overflow: auto;
    background-color: ${t.isDark?t.colors.background.canvas:t.colors.background.primary};
    padding-bottom: ${t.spacing(1)};
  `,editorActions:(0,I.css)`
    margin-top: 6px;
  `}),me=(0,K.HE)(Nt);var Lt=d(25797),Dt=d(95347),C=d(30980),wt=d(64782),Ft=d(11012);function Pt(t){const e=[];for(const a of t){let r="text";switch(a.type?.toUpperCase()){case"BOOLEAN":case"BOOL":{r="boolean";break}case"BYTES":case"VARCHAR":{r="text";break}case"FLOAT":case"FLOAT64":case"INT":case"INTEGER":case"INT64":case"NUMERIC":case"BIGNUMERIC":{r="number";break}case"DATE":{r="date";break}case"TIMESTAMP(NANOSECOND, NONE)":case"DATETIME":{r="datetime";break}case"TIME":{r="time";break}case"TIMESTAMP":{r="datetime";break}case"GEOGRAPHY":{r="text";break}default:break}e.push({...a,raqbFieldType:r,icon:Mt(a.type.toUpperCase())})}return e}function Mt(t){switch(t){case"TIME":case"DATETIME":case"TIMESTAMP":return"clock-nine";case"BOOLEAN":return"toggle-off";case"INTEGER":case"FLOAT":case"FLOAT64":case"INT":case"SMALLINT":case"BIGINT":case"TINYINT":case"BYTEINT":case"INT64":case"NUMERIC":case"DECIMAL":return"calculator-alt";case"CHAR":case"VARCHAR":case"STRING":case"BYTES":case"TEXT":case"TINYTEXT":case"MEDIUMTEXT":case"LONGTEXT":return"text";case"GEOGRAPHY":return"map";default:return}}var Le=d(33696);function Qt(t){return t[0]==='"'&&t[t.length-1]==='"'?t.substring(1,t.length-1).replace(/""/g,'"'):t[0]==="`"&&t[t.length-1]==="`"?t.substring(1,t.length-1):t}function De(t){return"'"+t.replace(/'/g,"''")+"'"}function we({sql:t,dataset:e,table:a}){let r="";if(!t||!(0,Le.IC)(t.columns))return r;if(r+=(0,Le.zE)(t.columns),e&&a&&(r+=`FROM ${e}.${a} `),r+="WHERE time >= $__timeFrom AND time <= $__timeTo ",t.whereString&&(r+=`AND ${t.whereString} `),t.groupBy?.[0]?.property.name){const n=t.groupBy.map(l=>l.property.name).filter(l=>!(0,p.isEmpty)(l));r+=`GROUP BY ${n.join(", ")} `}return t.orderBy?.property.name&&(r+=`ORDER BY ${t.orderBy.property.name} `),t.orderBy?.property.name&&t.orderByDirection&&(r+=`${t.orderByDirection} `),Bt(t.limit)&&(r+=`LIMIT ${t.limit}`),r}const Bt=t=>t!==void 0&&t>=0;function de(t){return kt(t)?t:`"${t}"`}function kt(t){const e=/^[a-zA-Z_][a-zA-Z0-9_$]*$/g.test(t);return!Ut.includes(t.toUpperCase())&&e}const Ut=["ACCESSIBLE","ADD","ALL","ALTER","ANALYZE","AND","AS","ASC","ASENSITIVE","BEFORE","BETWEEN","BIGINT","BINARY","BLOB","BOTH","BY","CALL","CASCADE","CASE","CHANGE","CHAR","CHARACTER","CHECK","COLLATE","COLUMN","CONDITION","CONSTRAINT","CONTINUE","CONVERT","CREATE","CROSS","CUBE","CUME_DIST","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","CURSOR","DATABASE","DATABASES","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DECLARE","DEFAULT","DELAYED","DELETE","DENSE_RANK","DESC","DESCRIBE","DETERMINISTIC","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","EACH","ELSE","ELSEIF","EMPTY","ENCLOSED","ESCAPED","EXCEPT","EXISTS","EXIT","EXPLAIN","FALSE","FETCH","FIRST_VALUE","FLOAT","FLOAT4","FLOAT8","FOR","FORCE","FOREIGN","FROM","FULLTEXT","FUNCTION","GENERATED","GET","GRANT","GROUP","GROUPING","GROUPS","HAVING","HIGH_PRIORITY","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IF","IGNORE","IN","INDEX","INFILE","INNER","INOUT","INSENSITIVE","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERSECT","INTERVAL","INTO","IO_AFTER_GTIDS","IO_BEFORE_GTIDS","IS","ITERATE","JOIN","JSON_TABLE","KEY","KEYS","KILL","LAG","LAST_VALUE","LATERAL","LEAD","LEADING","LEAVE","LEFT","LIKE","LIMIT","LINEAR","LINES","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOOP","LOW_PRIORITY","MASTER_BIND","MASTER_SSL_VERIFY_SERVER_CERT","MATCH","MAXVALUE","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","MODIFIES","NATURAL","NOT","NO_WRITE_TO_BINLOG","NTH_VALUE","NTILE","NULL","NUMERIC","OF","ON","OPTIMIZE","OPTIMIZER_COSTS","OPTION","OPTIONALLY","OR","ORDER","OUT","OUTER","OUTFILE","OVER","PARTITION","PERCENT_RANK","PRECISION","PRIMARY","PROCEDURE","PURGE","RANGE","RANK","READ","READS","READ_WRITE","REAL","RECURSIVE","REFERENCES","REGEXP","RELEASE","RENAME","REPEAT","REPLACE","REQUIRE","RESIGNAL","RESTRICT","RETURN","REVOKE","RIGHT","RLIKE","ROW","ROWS","ROW_NUMBER","SCHEMA","SCHEMAS","SECOND_MICROSECOND","SELECT","SENSITIVE","SEPARATOR","SET","SHOW","SIGNAL","SMALLINT","SPATIAL","SPECIFIC","SQL","SQLEXCEPTION","SQLSTATE","SQLWARNING","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SSL","STARTING","STORED","STRAIGHT_JOIN","SYSTEM","TABLE","TERMINATED","THEN","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRIGGER","TRUE","UNDO","UNION","UNIQUE","UNLOCK","UNSIGNED","UPDATE","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUES","VARBINARY","VARCHAR","VARCHARACTER","VARYING","VIRTUAL","WHEN","WHERE","WHILE","WINDOW","WITH","WRITE","XOR","YEAR_MONTH","ZEROFILL"];function Vt(t){return`SELECT table_name FROM information_schema.tables WHERE table_schema = ${t!==void 0?j(t):"database()"} ORDER BY table_name`}function vr(){return"SELECT DISTINCT TABLE_SCHEMA from information_schema.TABLES where TABLE_TYPE != 'SYSTEM VIEW' ORDER BY TABLE_SCHEMA"}function Gt(t,e){let a="SELECT column_name, data_type FROM information_schema.columns WHERE ";return a+=Wt(t,e),a+=" ORDER BY column_name",a}function Wt(t,e){let a="";if(t.includes(".")){const r=t.split(".");return a="table_schema = "+j(r[0]),a+=" AND table_name = "+j(r[1]),a}else return a=`table_schema = ${e!==void 0?j(e):"database()"} AND table_name = `+j(t),a}function j(t){return De(Qt(t))}var $t=d(70993);const Ht=({getMeta:t})=>(e,a)=>({...a&&(0,$t.h)(e,a),customStatementPlacement:Kt,customSuggestionKinds:zt(t)}),Fe={afterDatabase:"afterDatabase"},Yt={tablesWithinDatabase:"tablesWithinDatabase"},fe="FROM",Kt=()=>[{id:Fe.afterDatabase,resolve:(t,e,a)=>!!(t?.is(C.iv.Delimiter,".")&&e?.value===fe&&(a?.is(C.iv.IdentifierQuote)||a?.isIdentifier())&&t?.getPreviousUntil(C.iv.Keyword,[C.iv.IdentifierQuote],fe)?.filter(r=>r.isIdentifier()).length===1)}],zt=t=>()=>[{id:C.is.Tables,overrideDefault:!0,suggestionsResolver:async e=>{const a=ge(e.currentToken);return(await t({schema:a})).map(pe(e))}},{id:C.is.Columns,overrideDefault:!0,suggestionsResolver:async e=>{const a=Xt(e.currentToken),r=ge(a),n=jt(a);return!r||!n?[]:(await t({schema:r,table:n})).map(pe(e))}},{id:Yt.tablesWithinDatabase,applyTo:[Fe.afterDatabase],suggestionsResolver:async e=>{const a=ge(e.currentToken);return(await t({schema:a})).map(pe(e))}}];function pe(t){return function(e){return{label:e.name,insertText:e.completion??e.name,command:{id:"editor.action.triggerSuggest",title:""},kind:C.cm.Field,sortText:C.G8.High,range:{...t.range,startColumn:t.range.endColumn,endColumn:t.range.endColumn}}}}function ge(t){if(t?.isIdentifier()&&t.value[t.value.length-1]!==".")return t.value;if(t?.is(C.iv.Delimiter,"."))return t.getPreviousOfType(C.iv.Identifier)?.value;if(t?.is(C.iv.IdentifierQuote))return t.getPreviousOfType(C.iv.Identifier)?.value||t.getNextOfType(C.iv.Identifier)?.value}function jt(t){return t?.getNextOfType(C.iv.Identifier)?.value}const qt=t=>(t?.getPreviousOfType(C.iv.Keyword,"SELECT")??null)?.getNextOfType(C.iv.Keyword,fe),Xt=t=>{const a=qt(t)?.getNextOfType(C.iv.Identifier);return a?.isKeyword()&&a.next?.is(C.iv.Parenthesis,"(")?null:a};class Jt extends wt.D{constructor(e,a=(0,ce.J)()){super(e),this.instanceSettings=e,this.templateSrv=a}getQueryModel(){return{quoteLiteral:De}}getSqlLanguageDefinition(){if(this.sqlLanguageDefinition!==void 0)return this.sqlLanguageDefinition;const e={getMeta:a=>this.fetchMeta(a)};return this.sqlLanguageDefinition={id:"flightsql",completionProvider:Ht(e),formatter:Ft._},this.sqlLanguageDefinition}async fetchDatasets(){return Promise.resolve(["iox"])}async fetchTables(e){const a=Vt(e),n=(await this.runSql(a,{refId:"tables"})).map(l=>de(l[0]));return n.unshift(...this.getTemplateVariables()),n}async fetchFields(e){if(!e.dataset||!e.table)return[];const a=this.templateSrv.replace(e.table),r=Gt(a,e.dataset),l=(await this.runSql(r,{refId:"fields"})).map(i=>({name:i[0],text:i[0],value:de(i[0]),type:i[1],label:i[0]}));return l.unshift(...this.getTemplateVariables().map(i=>({name:i,text:i,value:de(i),type:"",label:i}))),Pt(l)}getTemplateVariables(){return this.templateSrv.getVariables().map(e=>`$${e.name}`)}async fetchMeta(e){const a=this.instanceSettings.jsonData.database;return!e?.schema&&a?(await this.fetchTables(a)).map(n=>({name:n,completion:`${a}.${n}`,kind:C.cm.Class})):!e?.schema&&!a?(await this.fetchDatasets()).map(n=>({name:n,completion:`${n}.`,kind:C.cm.Module})):!e?.table&&(!a||e?.schema)?(await this.fetchTables(e?.schema)).map(n=>({name:n,completion:n,kind:C.cm.Class})):e?.table&&e.schema?(await this.fetchFields({dataset:e.schema,table:e.table})).map(n=>({name:n.name,completion:n.value,kind:C.cm.Field})):[]}getDB(){return this.db!==void 0?this.db:{datasets:()=>this.fetchDatasets(),tables:e=>this.fetchTables(e),fields:e=>this.fetchFields(e),validateQuery:(e,a)=>Promise.resolve({query:e,error:"",isError:!1,isValid:!0}),dsID:()=>this.id,toRawSql:we,functions:()=>["VARIANCE","STDDEV"],getEditorLanguageDefinition:()=>this.getSqlLanguageDefinition()}}}class Zt extends s.PureComponent{constructor(e){super(e);const{datasource:a}=e;this.datasource=new Jt({url:a.urls[0],access:a.access,id:a.id,jsonData:{allowCleartextPasswords:!1,tlsAuth:!1,tlsAuthWithCACert:!1,tlsSkipVerify:!1,maxIdleConns:1,maxOpenConns:1,maxIdleConnsAuto:!0,connMaxLifetime:1,timezone:"",user:"",database:"",url:a.urls[0],timeInterval:""},meta:a.meta,name:a.name,readOnly:!1,type:a.type,uid:a.uid},a.templateSrv)}transformQuery(e){const a=(0,Dt.Y)(e);return{...a,dataset:"iox",sql:{...a.sql,limit:void 0}}}render(){const{query:e,theme:a,onRunQuery:r,onChange:n}=this.props,l=_t(a),i=()=>r(),o=c=>{n({...c})},u=s.createElement("div",null,"Type: ",s.createElement("i",null,"ctrl+space")," to show template variable suggestions ",s.createElement("br",null),"Many queries can be copied from Chronograf");return s.createElement(s.Fragment,null,s.createElement(_.b,{title:"Warning",severity:"warning"},"InfluxDB SQL support is currently in alpha state. It does not have all the features."),s.createElement(Lt.M,{datasource:this.datasource,query:this.transformQuery(e),onRunQuery:i,onChange:o,queryHeaderProps:{dialect:"influx"}}),s.createElement("div",{className:(0,I.cx)("gf-form-inline",l.editorActions)},s.createElement(re.Qj,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/cloud-serverless/query-data/sql/"},"SQL language syntax"),s.createElement("div",{className:"gf-form gf-form--grow"},s.createElement("div",{className:"gf-form-label gf-form-label--grow"})),s.createElement(F.c,{width:5,tooltip:u},"Help")))}}const _t=t=>({editorContainerStyles:(0,I.css)`
    height: 200px;
    max-width: 100%;
    resize: vertical;
    overflow: auto;
    background-color: ${t.isDark?t.colors.background.canvas:t.colors.background.primary};
    padding-bottom: ${t.spacing(1)};
  `,editorActions:(0,I.css)`
    margin-top: 6px;
  `}),ea=(0,K.HE)(Zt);var ta=d(77980);const aa=({isRaw:t,onChange:e})=>{const[a,r]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{r(!1)},[t]),t?s.createElement(s.Fragment,null,s.createElement(re.zx,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{r(!0)}}),s.createElement(ta.s,{isOpen:a,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{e(!1)},onDismiss:()=>{r(!1)}})):s.createElement(re.zx,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{e(!0)}})};var he=d(7073),ra=d(74042);const Pe=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"},{label:"Logs",value:"logs"}],Me="time_series";var na=d(69690);function ne(t){const[e,a]=(0,s.useState)(t),r=(0,na.Z)(t);return(0,s.useEffect)(()=>{r!==t&&e!==t&&a(t)},[t,e,r]),[e,a]}const sa=({query:t,onChange:e,onRunQuery:a})=>{const[r,n]=ne(t.query),[l,i]=ne(t.alias),o=(0,s.useId)(),u=(0,s.useId)(),c=t.resultFormat??Me,f=()=>{e({...t,query:r,alias:l,resultFormat:c}),a()};return s.createElement("div",null,s.createElement(he.K,{"aria-label":"query",rows:3,spellCheck:!1,placeholder:"InfluxDB Query",onBlur:f,onChange:m=>{n(m.currentTarget.value)},value:r??""}),s.createElement(ra.Lh,null,s.createElement(F.c,{htmlFor:u},"Format as"),s.createElement(V.Ph,{inputId:u,onChange:m=>{e({...t,resultFormat:m.value}),a()},value:c,options:Pe}),s.createElement(F.c,{htmlFor:o},"Alias by"),s.createElement(A.I,{id:o,type:"text",spellCheck:!1,placeholder:"Naming pattern",onBlur:f,onChange:m=>{i(m.currentTarget.value)},value:l??""})))};var H=d(77197);const ye=t=>{let e="",{type:a,templateService:r,scopedVars:n,database:l,measurement:i,retentionPolicy:o,tags:u,withKey:c,withMeasurementFilter:f}=t;switch(a){case"RETENTION_POLICIES":return'SHOW RETENTION POLICIES on "'+l+'"';case"FIELDS":return!i||i===""?"SHOW FIELD KEYS":(i&&!i.match(/^\/.*\/|^$/)&&(i='"'+i+'"',o&&o!==G&&(o='"'+o+'"',i=o+"."+i)),"SHOW FIELD KEYS FROM "+i);case"TAG_KEYS":e="SHOW TAG KEYS";break;case"TAG_VALUES":e="SHOW TAG VALUES";break;case"MEASUREMENTS":e="SHOW MEASUREMENTS",f&&(e+=" WITH MEASUREMENT =~ /(?i)"+(0,ae.yI)(f)+"/");break;default:return e}if(i&&(!i.match("^/.*/")&&!i.match(/^merge\(.*\)/)&&(i='"'+i+'"'),o&&o!==G&&(o='"'+o+'"',i=o+"."+i),i!==""&&(e+=" FROM "+i)),c){let m=c;m.endsWith("::tag")&&(m=m.slice(0,-5)),e+=' WITH KEY = "'+m+'"'}if(u&&u.length>0){const m=(0,p.reduce)(u,(g,h)=>(h.key&&h.key===c||h.operator===">"||h.operator==="<"||g.push(la(h,g.length,r,n,!0)),g),[]);m.length>0&&(e+=" WHERE "+m.join(" "))}return a==="MEASUREMENTS"&&(e+=" LIMIT 100"),e};function la(t,e,a,r,n){let l="",i=t.operator,o=t.value;e>0&&(l=(t.condition||"AND")+" "),i||(/^\/.*\/$/.test(t.value)?i="=~":i="="),(o===""||i!=="=~"&&i!=="!~")&&(o="'"+o.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"),i!=="=~"&&i!=="!~"?n?o=a.replace(o,r):i!==">"&&i!=="<"&&(o="'"+o.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"):n&&(o=a.replace(o,r,"regex"));let u=`"${t.key}"`;return t.key.endsWith("::tag")&&(u=`"${t.key.slice(0,-5)}"::tag`),t.key.endsWith("::field")&&(u=`"${t.key.slice(0,-7)}"::field`),l+u+" "+i+" "+o}const q=async t=>{const{type:e,datasource:a,scopedVars:r,measurement:n,retentionPolicy:l,tags:i,withKey:o,withMeasurementFilter:u}=t,c=ye({type:e,scopedVars:r,measurement:n,retentionPolicy:l,tags:i,withKey:o,withMeasurementFilter:u,templateService:a.templateSrv,database:a.database}),f=l?a.templateSrv.replace(l,{},"regex"):"",m={query:c,policy:f,rawQuery:!0,refId:"metadataQuery"};if(ee.default.featureToggles.influxdbBackendMigration)return a.runMetadataQuery(m);{const g={policy:m.policy};return a.metricFindQuery(c,g)}};async function ia(t){return(await q({type:"RETENTION_POLICIES",datasource:t})).map(a=>a.text)}async function oa(t,e,a){return(await q({type:"MEASUREMENTS",datasource:t,tags:e,withMeasurementFilter:a})).map(n=>n.text)}async function ua(t,e,a){return(await q({type:"TAG_KEYS",datasource:t,measurement:e,retentionPolicy:a})).map(n=>n.text)}async function ca(t,e,a,r,n){return a.endsWith("::field")?[]:(await q({type:"TAG_VALUES",tags:e,withKey:a,datasource:t,measurement:r,retentionPolicy:n})).map(i=>i.text)}async function Qe(t,e,a){return(await q({type:"FIELDS",datasource:t,measurement:e,retentionPolicy:a})).map(n=>n.text)}function Be(t,e){return t.filter(a=>a.key.endsWith("::tag")||e.has(a.key+"::tag"))}function L(t){return{label:t,value:t}}function X(t){if(t==null)throw new Error("value must not be nullish");return t}function ma(){const t=B.getCategories(),e=[];return Object.keys(t).forEach(r=>{const n=t[r].map(l=>L(l.type));e.push({label:r,options:n})}),e}async function da(t,e){const a=await e(),r={...t},n=new P(r),l=[];return n.hasFill()||l.push(L("fill(null)")),n.hasGroupByTime()||l.push(L("time($interval)")),a.forEach(i=>{l.push(L(`tag(${i})`))}),l}function fa(t,e){const a=B.create(t).def,r=(t.params??[]).map(n=>n.toString());if(r.length!==a.params.length)throw new Error("Invalid query-segment");return r.map((n,l)=>{const i=a.params[l];return i.dynamicLookup?{value:n,options:X(e.get(`${a.type}_${l}`))}:i.options!=null?{value:n,options:()=>Promise.resolve(i.options)}:{value:n,options:null}})}function ke(t,e){return t.map(a=>({name:a.type,params:fa(a,e)}))}function pa(t){return(0,ce.J)().getVariables().map(t)}function Ee(t,e,a){let r=pa(e);return a&&(r=r.filter(n=>n.indexOf(a)>-1)),t.then(n=>[...r,...n])}function Ue(t){return`/^$${t.name}$/`}function ga(t){return`$${t.name}`}const Se=(0,I.css)({paddingRight:"4px"}),ha=(0,I.cx)("width-8",Se),ya=({format:t,inputId:e,onChange:a})=>s.createElement(V.Ph,{inputId:e,className:ha,onChange:r=>{a(X(r.value))},value:t,options:Pe});var ve=d(37890),Ea=d(97812),Sa=d.n(Ea),va=d(85954);const Ve=(0,I.css)({minWidth:"160px"}),Ge=t=>t,Ta=({loadOptions:t,allowCustomValue:e,onChange:a,onClose:r})=>{const n=Sa()(t,1e3,{leading:!0});return s.createElement("div",{className:Ve},s.createElement(V.qb,{formatCreateLabel:Ge,defaultOptions:!0,autoFocus:!0,isOpen:!0,onCloseMenu:r,allowCustomValue:e,loadOptions:n,onChange:a,createOptionPosition:"first"}))},Ia=({loadOptions:t,allowCustomValue:e,onChange:a,onClose:r})=>{const[n,l]=(0,va.Z)(t,[t]);return(0,s.useEffect)(()=>{l("")},[l,t]),s.createElement("div",{className:Ve},s.createElement(V.Ph,{isLoading:n.loading,formatCreateLabel:Ge,autoFocus:!0,isOpen:!n.loading,onCloseMenu:r,allowCustomValue:e,options:n.value??[],onChange:a,createOptionPosition:"first"}))},Ca=({loadOptions:t,filterByLoadOptions:e,allowCustomValue:a,onChange:r,onClose:n})=>e?s.createElement(Ta,{loadOptions:t,allowCustomValue:a,onChange:r,onClose:n}):s.createElement(Ia,{loadOptions:t,allowCustomValue:a,onChange:r,onClose:n}),ba=({initialValue:t,onChange:e,onClose:a})=>{const[r,n]=ne(t);return s.createElement(A.I,{autoFocus:!0,type:"text",spellCheck:!1,onBlur:a,onKeyDown:l=>{l.key==="Enter"&&e(r)},onChange:l=>{n(l.currentTarget.value)},value:r})},Aa=(0,I.css)({width:"auto",cursor:"pointer"}),k=({value:t,buttonClassName:e,loadOptions:a,filterByLoadOptions:r,allowCustomValue:n,onChange:l})=>{const[i,o]=(0,s.useState)(!1);if(i)return a!==void 0?s.createElement(Ca,{loadOptions:a,filterByLoadOptions:r??!1,allowCustomValue:n,onChange:u=>{o(!1),l(u)},onClose:()=>{o(!1)}}):s.createElement(ba,{initialValue:t,onClose:()=>{o(!1)},onChange:u=>{o(!1),l({value:u,label:u})}});{const u=(0,I.cx)(Aa,e);return s.createElement(O.W,{as:"button",className:u,onClick:()=>{o(!0)}},t)}},xa=({policy:t,measurement:e,onChange:a,getPolicyOptions:r,getMeasurementOptions:n})=>{const l=async()=>{const o=await r();return(o.some(c=>c===G)?o:[G,...o]).map(L)},i=async o=>(await n(o)).map(L);return s.createElement(s.Fragment,null,s.createElement(k,{allowCustomValue:!0,value:t??"using default policy",loadOptions:l,onChange:o=>{a(o.value,e)}}),s.createElement(k,{allowCustomValue:!0,value:e??"select measurement",loadOptions:i,filterByLoadOptions:!0,onChange:o=>{a(t,o.value)}}),e&&s.createElement(ve._,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{a(t,void 0)}}))},se=({value:t,onChange:e,isWide:a,placeholder:r})=>{const[n,l]=ne(t),i=()=>{e(n===""?void 0:n)};return s.createElement(s.Fragment,null,s.createElement(A.I,{placeholder:r,className:(0,I.cx)(a??!1?"width-14":"width-8",Se),type:"text",spellCheck:!1,onBlur:i,onChange:o=>{l(o.currentTarget.value)},value:n??""}))},Ra=[{label:"ascending",value:"ASC"},{label:"descending",value:"DESC"}],Na=(0,I.cx)("width-9",Se),Oa=({value:t,onChange:e,inputId:a})=>s.createElement(s.Fragment,null,s.createElement(V.Ph,{inputId:a,className:Na,onChange:r=>{e(X(r.value))},value:t,options:Ra})),We=({loadOptions:t,allowCustomValue:e,onAdd:a})=>s.createElement(k,{value:"+",loadOptions:t,allowCustomValue:e,onChange:r=>{a(X(r.value))}}),La=(0,I.css)({paddingRight:"0",marginRight:"0"}),Da=(0,I.css)({paddingLeft:"0",paddingRight:"0",marginLeft:"0",marginRight:"0"}),wa=t=>(0,I.cx)("gf-form-label",(0,I.css)({paddingLeft:"0",lineHeight:t.typography.body.lineHeight,fontSize:t.typography.body.fontSize})),Fa=({name:t,params:e,onChange:a})=>{const r=(0,K.l4)(),n=(0,s.useMemo)(()=>wa(r),[r]),l=(i,o)=>{const u=e.map(c=>c.value);u[o]=i,a(u)};return s.createElement("div",{className:n},s.createElement("button",{className:(0,I.cx)("gf-form-label",La)},t),"(",e.map((i,o)=>{const{value:u,options:c}=i,f=o===e.length-1,m=c!==null?()=>c().then(g=>g.map(L)):void 0;return s.createElement(s.Fragment,{key:o},s.createElement(k,{allowCustomValue:!0,value:u,buttonClassName:Da,loadOptions:m,onChange:g=>{l(X(g.value),o)}}),!f&&",")}),")")},$e=({parts:t,getNewPartOptions:e,onAddNewPart:a,onRemovePart:r,onChange:n})=>s.createElement(s.Fragment,null,t.map((l,i)=>s.createElement(s.Fragment,{key:i},s.createElement(Fa,{name:l.name,params:l.params,onRemove:()=>{r(i)},onChange:o=>{n(i,o)}}),s.createElement(ve._,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{r(i)}}))),s.createElement(We,{loadOptions:e,onAdd:a}));function He(t){return/^\/.*\/$/.test(t)}function Ye(t){return t.operator??(He(t.value)?"=~":"=")}function Ke(t,e){return e?void 0:t.condition??"AND"}function Pa(t,e){const a=t==="=~"||t==="!~";return He(e)?a?t:"=~":a?"=":t}const Ma=["=","!=","<>","<",">",">=","<=","=~","!~","Is","Is Not"],Qa=["AND","OR"],Ba=Ma.map(L),ka=Qa.map(L),Ua=()=>Promise.resolve(ka),Va=()=>Promise.resolve(Ba),Ga=({tag:t,isFirst:e,onRemove:a,onChange:r,getTagKeyOptions:n,getTagValueOptions:l})=>{const i=Ye(t),o=Ke(t,e),u=()=>n().catch(f=>(console.error(f),[])).then(f=>f.map(L)),c=()=>l(t.key).then(f=>f.map(L));return s.createElement("div",{className:"gf-form"},o!=null&&s.createElement(k,{value:o,loadOptions:Ua,onChange:f=>{r({...t,condition:f.value})}}),s.createElement(k,{allowCustomValue:!0,value:t.key,loadOptions:u,onChange:f=>{const{value:m}=f;m===void 0?a():r({...t,key:m??""})}}),s.createElement(k,{value:i,loadOptions:Va,onChange:f=>{r({...t,operator:f.value})}}),s.createElement(k,{allowCustomValue:!0,value:t.value,loadOptions:c,onChange:f=>{const m=f.value??"";r({...t,value:m,operator:Pa(i,m)})}}),s.createElement(ve._,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{a()}}))},Wa=({tags:t,onChange:e,getTagKeyOptions:a,getTagValueOptions:r})=>{const n=(u,c)=>{const f=t.map((m,g)=>c===g?u:m);e(f)},l=u=>{const c=t.filter((f,m)=>m!==u);e(c)},i=()=>a().then(u=>u.map(L)),o=(u,c)=>{const f={key:u,value:"select tag value"},m={key:f.key,value:f.value,operator:Ye(f),condition:Ke(f,c)};e([...t,m])};return s.createElement(s.Fragment,null,t.map((u,c)=>s.createElement(Ga,{tag:u,isFirst:c===0,key:c,onChange:f=>{n(f,c)},onRemove:()=>{l(c)},getTagKeyOptions:a,getTagValueOptions:r})),s.createElement(We,{allowCustomValue:!0,loadOptions:i,onAdd:u=>{o(u,t.length===0)}}))},$a=t=>{const e=(0,s.useId)(),a=`influxdb-qe-format-as-${e}`,r=`influxdb-qe-order-by${e}`,n=(0,K.wW)(Ha),l=Et(t.query),{datasource:i}=t,{measurement:o,policy:u}=l,c=(0,s.useMemo)(async()=>{const y=(await ua(i,o,u)).map(R=>`${R}::tag`),b=(await Qe(i,o||"",u)).map(R=>`${R}::field`);return new Set([...y,...b])},[o,u,i]),f=(0,s.useMemo)(()=>{const y=new Map([["field_0",()=>o!==void 0?Qe(i,o,u):Promise.resolve([])]]);return(l.select??[]).map(b=>ke(b,y))},[o,u,l.select,i]),m=(0,s.useMemo)(()=>async()=>[...await c],[c]),g=(0,s.useMemo)(()=>{const y=new Map([["tag_0",m]]);return ke(l.groupBy??[],y)},[m,l.groupBy]),h=y=>{t.onChange(y),t.onRunQuery()},D=(y,b)=>{h({...l,policy:y,measurement:b})},Z=y=>{h({...l,tags:y.length===0?void 0:y})};return s.createElement("div",null,s.createElement(H.f,{label:"FROM",fill:!0},s.createElement(xa,{policy:u,measurement:o,getPolicyOptions:()=>Ee(ia(i),ga),getMeasurementOptions:y=>Ee(c.then(b=>oa(i,Be(l.tags??[],b),y===""?void 0:y)),Ue,y),onChange:D}),s.createElement(O.W,{width:"auto",className:n.inlineLabel},"WHERE"),s.createElement(Wa,{tags:l.tags??[],onChange:Z,getTagKeyOptions:m,getTagValueOptions:y=>Ee(c.then(b=>ca(i,Be(l.tags??[],b),y)),Ue)})),f.map((y,b)=>s.createElement(H.f,{key:b,label:b===0?"SELECT":"",fill:!0},s.createElement($e,{parts:y,getNewPartOptions:()=>Promise.resolve(ma()),onChange:(R,yr)=>{const Er=Tt(l,b,R,yr);h(Er)},onAddNewPart:R=>{h(St(l,R,b))},onRemovePart:R=>{h(vt(l,R,b))}}))),s.createElement(H.f,{label:"GROUP BY",fill:!0},s.createElement($e,{parts:g,getNewPartOptions:()=>da(l,m),onChange:(y,b)=>{const R=bt(l,y,b);h(R)},onAddNewPart:y=>{h(It(l,y))},onRemovePart:y=>{h(Ct(l,y))}})),s.createElement(H.f,{label:"TIMEZONE",fill:!0},s.createElement(se,{placeholder:"(optional)",value:l.tz,onChange:y=>{h({...l,tz:y})}}),s.createElement(O.W,{htmlFor:r,width:"auto",className:n.inlineLabel},"ORDER BY TIME"),s.createElement(Oa,{inputId:r,value:l.orderByTime==="DESC"?"DESC":"ASC",onChange:y=>{h({...l,orderByTime:y})}})),s.createElement(H.f,{label:"LIMIT",fill:!0},s.createElement(se,{placeholder:"(optional)",value:l.limit?.toString(),onChange:y=>{h({...l,limit:y})}}),s.createElement(O.W,{width:"auto",className:n.inlineLabel},"SLIMIT"),s.createElement(se,{placeholder:"(optional)",value:l.slimit?.toString(),onChange:y=>{h({...l,slimit:y})}})),s.createElement(H.f,{htmlFor:a,label:"FORMAT AS",fill:!0},s.createElement(ya,{inputId:a,format:l.resultFormat??Me,onChange:y=>{h({...l,resultFormat:y})}}),l.resultFormat!=="table"&&s.createElement(s.Fragment,null,s.createElement(O.W,{width:"auto",className:n.inlineLabel},"ALIAS"),s.createElement(se,{isWide:!0,placeholder:"Naming pattern",value:l.alias,onChange:y=>{h({...l,alias:y})}}))))};function Ha(t){return{inlineLabel:(0,I.css)`
      color: ${t.colors.primary.text};
    `}}const Ya=({query:t,onChange:e,onRunQuery:a,datasource:r})=>{switch(r.version){case E.Flux:return s.createElement("div",{className:"gf-form-query-content"},s.createElement(me,{query:t,onChange:e,onRunQuery:a,datasource:r}));case E.SQL:return s.createElement(ea,{datasource:r,query:t,onChange:e,onRunQuery:a});case E.InfluxQL:default:return s.createElement("div",{className:(0,I.css)({display:"flex"})},s.createElement("div",{className:(0,I.css)({flexGrow:1})},t.rawQuery?s.createElement(sa,{query:t,onChange:e,onRunQuery:a}):s.createElement($a,{query:t,onChange:e,onRunQuery:a,datasource:r})),s.createElement(aa,{isRaw:t.rawQuery??!1,onChange:n=>{e({...t,query:Oe(t),rawQuery:n}),a()}}))}},Ka=[{title:"Getting started",label:"Start by selecting a measurement and field from the dropdown above. You can then use the tag selector to further narrow your search."}],za=()=>s.createElement("div",null,s.createElement("h2",null,"InfluxDB Cheat Sheet"),Ka.map(t=>s.createElement("div",{className:"cheat-sheet-item",key:t.title},s.createElement("div",{className:"cheat-sheet-item__title"},t.title),s.createElement("div",{className:"cheat-sheet-item__label"},t.label))));function ja(){return s.createElement(za,null)}class qa extends s.PureComponent{constructor(){super(...arguments),this.onRefresh=()=>{}}render(){let{query:e,datasource:a,onChange:r}=this.props;switch(a.version){case E.Flux:return s.createElement(me,{datasource:a,query:{refId:"A",query:e},onRunQuery:this.onRefresh,onChange:n=>r(n.query)});case E.SQL:return s.createElement(le.C,null,s.createElement(U.g,{htmlFor:"influx-sql-variable-query"},s.createElement(he.K,{id:"influx-sql-variable-query",defaultValue:e||"",placeholder:"metric name or tags query",rows:1,onBlur:n=>r(n.currentTarget.value)})));case E.InfluxQL:default:return s.createElement("div",{className:"gf-form-inline"},s.createElement(F.c,{width:10},"Query"),s.createElement("div",{className:"gf-form-inline gf-form--grow"},s.createElement(he.K,{defaultValue:e||"",placeholder:"metric name or tags query",rows:1,className:"gf-form-input",onBlur:n=>r(n.currentTarget.value)})))}}}var ze=d(9360),Xa=d(1050),Ja=d(59069),J=d(81838),Te=d(21964),Ie=d(98231),Za=d(85431),_a=d(45878),er=d(13446),M=d(58309),tr=d(32063),je=d(43071),qe=d(85445),ar=d(31683),Tr=d(59210),rr=d(76588);const nr=t=>{const{query:e,onChange:a}=t,[r,n]=(0,s.useState)(e.query??""),[l,i]=(0,s.useState)(e.textColumn??""),[o,u]=(0,s.useState)(e.tagsColumn??""),[c,f]=(0,s.useState)(e?.timeEndColumn??""),[m]=(0,s.useState)(e?.titleColumn??""),g=(h,D)=>{a({...e,[h]:D,rawQuery:!0,fromAnnotations:!0,textEditor:!0})};return s.createElement("div",{className:"gf-form-group"},s.createElement("div",{className:"gf-form"},s.createElement(F.c,{width:12},"InfluxQL Query"),s.createElement(A.I,{value:r,onChange:h=>n(h.currentTarget.value??""),onBlur:()=>g("query",r),placeholder:"select text from events where $timeFilter limit 1000"})),s.createElement(F.c,{width:12,tooltip:s.createElement("div",null,"If your influxdb query returns more than one field you need to specify the column names below. An annotation event is composed of a title, tags, and an additional text field. Optionally you can map the timeEnd column for region annotation usage.")},"Field mappings"),s.createElement("div",{className:"gf-form-group"},s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(F.c,{width:12},"Text"),s.createElement(A.I,{value:l,onChange:h=>i(h.currentTarget.value??""),onBlur:()=>g("textColumn",l)})),s.createElement("div",{className:"gf-form"},s.createElement(F.c,{width:12},"Tags"),s.createElement(A.I,{value:o,onChange:h=>u(h.currentTarget.value??""),onBlur:()=>g("tagsColumn",o)})),s.createElement("div",{className:"gf-form"},s.createElement(F.c,{width:12},"TimeEnd"),s.createElement(A.I,{value:c,onChange:h=>f(h.currentTarget.value??""),onBlur:()=>g("timeEndColumn",c)})),s.createElement("div",{className:"gf-form ng-hide"},s.createElement(F.c,{width:12},"Title"),s.createElement(A.I,{defaultValue:m})))))};var Xe=d(32610);class Je{constructor(e){this.series=e.series,this.alias=e.alias,this.annotation=e.annotation,this.meta=e.meta,this.refId=e.refId}getTimeSeries(){const e=[];let a,r;return this.series.length===0||(0,p.each)(this.series,n=>{const l=n.columns.length,i=(0,p.map)(n.tags,(o,u)=>u+": "+o);for(r=1;r<l;r++){let o=n.name;const u=n.columns[r];u!=="value"&&(o=o+"."+u),this.alias?o=this._getSeriesName(n,r):n.tags&&(o=o+" {"+i.join(", ")+"}");const c=[];if(n.values)for(a=0;a<n.values.length;a++)c[a]=[n.values[a][r],n.values[a][0]];e.push({title:o,target:o,datapoints:c,tags:n.tags,meta:this.meta,refId:this.refId})}}),e}_getSeriesName(e,a){const r=/\$(\w+)|\[\[([\s\S]+?)\]\]/g,n=e.name.split(".");return this.alias.replace(r,(l,i,o)=>{const u=i||o,c=parseInt(u,10);if(u==="m"||u==="measurement")return e.name;if(u==="col")return e.columns[a];if(!isNaN(c))return n[c]??l;if(u.indexOf("tag_")!==0)return l;const f=u.replace("tag_","");return e.tags?e.tags[f]:l})}getAnnotations(){const e=[];return(0,p.each)(this.series,a=>{let r=null,n=null,l=null;const i=[];let o=null;(0,p.each)(a.columns,(u,c)=>{if(u==="time"){n=c;return}if(u!=="sequence_number"){if(u===this.annotation.titleColumn){r=c;return}if((0,p.includes)((this.annotation.tagsColumn||"").replace(" ","").split(","),u)){i.push(c);return}if(u===this.annotation.textColumn){o=c;return}if(u===this.annotation.timeEndColumn){l=c;return}!r&&o!==c&&(r=c)}}),(0,p.each)(a.values,u=>{const c={annotation:this.annotation,time:+new Date(u[n]),title:u[r],timeEnd:u[l],tags:(0,p.flatten)(i.filter(f=>u[f]).map(f=>u[f].split(","))),text:u[o]};e.push(c)})}),e}getTable(){const e=new Xe.Z;let a,r;return e.refId=this.refId,e.meta=this.meta,this.series.length===0||(0,p.each)(this.series,(n,l)=>{if(l===0){const i=n.columns[0],o=i==="time"?{text:"Time",type:M.fS.time}:{text:i};for(e.columns.push(o),(0,p.each)((0,p.keys)(n.tags),u=>{e.columns.push({text:u})}),r=1;r<n.columns.length;r++)e.columns.push({text:n.columns[r]})}if(n.values)for(a=0;a<n.values.length;a++){const i=n.values[a],o=[i[0]];if(n.tags)for(const u in n.tags)n.tags.hasOwnProperty(u)&&o.push(n.tags[u]);for(r=1;r<i.length;r++)o.push(i[r]);e.rows.push(o)}}),e}}const sr=t=>{const e={refId:"",query:t.query??"",queryType:"tags",fromAnnotations:!0,tagsColumn:t.tagsColumn??"",textColumn:t.textColumn??"",timeEndColumn:t.timeEndColumn??"",titleColumn:t.titleColumn??"",name:t.name??""};return t.target&&t.target.limit&&(e.limit=t.target.limit),t.target&&t.target.matchAny&&(e.matchAny=t.target.matchAny),t.target&&t.target.tags&&(e.tags=t.target.tags),t.target&&t.target.type&&(e.type=t.target.type),e},lr=t=>(t.target=t.target&&!t.target?.query?sr(t):t.target,t);class ir{parse(e,a){if(!a?.results||a.results.length===0)return[];const r=a.results[0];if(!r.series)return[];const n=e.toLowerCase(),l=n.indexOf("show retention policies")>=0,i=n.indexOf("show field keys")>=0||l,o=new Set;return(0,p.each)(r.series,u=>{(0,p.each)(u.values,c=>{(0,p.isArray)(c)?i?o.add(c[0].toString()):c[1]!==void 0?o.add(c[1].toString()):o.add(c[0].toString()):o.add(c.toString())})}),Array.from(o).map(u=>({text:u}))}getTable(e,a,r){let n=new Xe.Z;if(e.length>0)if(n.meta={...r,executedQueryString:e[0].meta?.executedQueryString},n.refId=a.refId,n=ur(e,n,a),e[0].fields[1]&&e[0].fields[1].labels){let l=(0,p.groupBy)(e,u=>u.fields[1].labels?Object.values(u.fields[1].labels):null);const i=Object.keys(l),o=Object.values(l);for(let u=0;u<o.length;u++)n=Ze(o[u],n,[...i[u].split(",")])}else n=Ze(e,n,[]);return n}async transformAnnotationResponse(e,a,r){const n=(0,je.z1)(a,[r]);if(!n)return[];const l=this.getTable(n.data,r,{}),i=[];let o=0,u=0,c=0,f=0;const m=[];return(0,p.each)(l.columns,(g,h)=>{if(g.text.toLowerCase()==="time"){u=h;return}if(g.text===e.titleColumn){o=h;return}if(or(g.text,e.tagsColumn)){m.push(h);return}if(e.textColumn&&g.text.includes(e.textColumn)){f=h;return}if(g.text===e.timeEndColumn){c=h;return}!o&&f!==h&&(o=h)}),(0,p.each)(l.rows,g=>{const h={annotation:e,time:+new Date(g[u]),title:g[o],timeEnd:g[c],tags:(0,p.flatten)(m.filter(D=>g[D]).map(D=>g[D].split(","))),text:g[f]};i.push(h)}),i}}function or(t,e){const a=(e||"").replace(" ","").split(",");for(const r of a)if(r!==""&&t.includes(r))return!0;return!1}function ur(t,e,a){const r=cr(a);t[0].fields.forEach(n=>{n.name.toLowerCase()==="time"?e.columns.push({text:"Time",type:M.fS.time}):n.name.toLowerCase()==="value"&&n.labels&&Object.keys(n.labels).forEach(l=>{e.columns.push({text:l})})}),t[0].refId==="metricFindQuery"&&t.forEach(n=>{n.name&&e.columns.push({text:n.name})});for(let n=0;n<r.length;n++)e.columns.push({text:r[n]});return a.rawQuery&&r.length===0&&mr(a.query,t)&&t[0].refId!=="metricFindQuery"&&t.map(n=>{n.name&&e.columns.push({text:n.name})}),e}function Ze(t,e,a){const r=t[0].fields[0].values;for(let n=0;n<r.length;n++){const l=r[n],i=t.map(o=>o.fields[1]?o.fields[1].values[n]:null);i.indexOf(null)<0&&e.rows.push([l,...a,...i])}return e}function cr(t){let e=[];t.select?.forEach(r=>{const n=r.filter(l=>l.type!=="field");if(n.length>0){const l=n.find(i=>i.type==="alias");l?e.push(l.params?.[0].toString()??""):e.push(n[0].type)}else r[0]&&r[0].params&&r[0].params[0]&&e.push(r[0].params[0].toString())});let a=[];return e.forEach(r=>{a.push(_e(r,r,a,0))}),a}function _e(t,e,a,r){return a.indexOf(e)>-1?(r++,_e(t,t+"_"+r,a,r)):e}function mr(t,e){const r=e.map(i=>i.name).every(i=>i&&t?i.split(".").every(u=>t.toLowerCase().includes(u.toLowerCase())):!1),l=["*","SHOW"].some(i=>t?t.toLowerCase().includes(i.toLowerCase()):!1);return r||l}class dr extends tr.CK{constructor(e,a=(0,ar.J)()){super(e),this.templateSrv=a,this.type="influxdb",this.urls=(e.url??"").split(",").map(n=>n.trim()),this.username=e.username??"",this.password=e.password??"",this.name=e.name,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.access=e.access;const r=e.jsonData??{};this.database=r.dbName??e.database,this.interval=r.timeInterval,this.httpMode=r.httpMode||"GET",this.responseParser=new ir,this.version=r.version??E.InfluxQL,this.isProxyAccess=e.access==="proxy",this.version===E.Flux?this.annotations={QueryEditor:me}:this.annotations={QueryEditor:nr,prepareAnnotation:lr}}query(e){if(!this.isProxyAccess){const a=new Error(be);return(0,ze._)(()=>a)}return this._query(e)}_query(e){const a={...e,targets:e.targets.filter(r=>r.hide!==!0)};if(a.targets.some(r=>r.fromAnnotations)){const r=[];for(const n of a.targets)n.query&&r.push(new Xa.y(l=>{this.annotationEvents(a,n).then(i=>l.next({data:[(0,_a.g0)(i)]})).catch(i=>l.error(new Error(i))).finally(()=>l.complete())}));return(0,Ja.T)(...r)}return this.version===E.InfluxQL&&!this.isMigrationToggleOnAndIsAccessProxy()?this.classicQuery(e):super.query(a)}getQueryDisplayText(e){switch(this.version){case E.Flux:return e.query;case E.SQL:return we(e);case E.InfluxQL:return new P(e).render(!1);default:return""}}filterQuery(e){return this.version===E.Flux?!!e.query:!0}applyTemplateVariables(e,a){const{__interval:r,__interval_ms:n,...l}=a||{};if(this.version===E.Flux)return{...e,query:this.templateSrv.replace(e.query??"",l)};if((this.version===E.SQL||this.isMigrationToggleOnAndIsAccessProxy())&&(e=this.applyVariables(e,l),e.adhocFilters?.length)){const i=(e.adhocFilters??[]).map(o=>{const{condition:u,...c}=o;return c});e.tags=[...e.tags??[],...i]}return e}targetContainsTemplate(e){const a=this.version===E.Flux?e.query:Oe(e);return this.templateSrv.containsTemplate(a)}interpolateVariablesInQueries(e,a){return!e||e.length===0?[]:e.map(r=>this.version===E.Flux?{...r,datasource:this.getRef(),query:this.templateSrv.replace(r.query??"",a,this.interpolateQueryExpr)}:{...r,datasource:this.getRef(),...this.applyVariables(r,a)})}applyVariables(e,a){const r={...e};return e.groupBy&&(r.groupBy=e.groupBy.map(n=>({...n,params:n.params?.map(l=>this.templateSrv.replace(l.toString(),void 0,this.interpolateQueryExpr))}))),e.select&&(r.select=e.select.map(n=>n.map(l=>({...l,params:l.params?.map(i=>this.templateSrv.replace(i.toString(),void 0,this.interpolateQueryExpr))})))),e.tags&&(r.tags=e.tags.map(n=>({...n,value:this.templateSrv.replace(n.value,a,this.interpolateQueryExpr)}))),{...r,adhocFilters:this.templateSrv.getAdhocFilters(this.name)??[],query:this.templateSrv.replace(e.query??"",a,this.interpolateQueryExpr),rawSql:this.templateSrv.replace(e.rawSql??"",a,this.interpolateQueryExpr),alias:this.templateSrv.replace(e.alias??"",a),limit:this.templateSrv.replace(e.limit?.toString()??"",a,this.interpolateQueryExpr),measurement:this.templateSrv.replace(e.measurement??"",a,this.interpolateQueryExpr),policy:this.templateSrv.replace(e.policy??"",a,this.interpolateQueryExpr),slimit:this.templateSrv.replace(e.slimit?.toString()??"",a,this.interpolateQueryExpr),tz:this.templateSrv.replace(e.tz??"",a)}}interpolateQueryExpr(e=[],a){if(!a.multi&&!a.includeAll)return gr(e);if(typeof e=="string")return et(e);const r=e.map(n=>et(n));return r.length===1?r[0]:r.join("|")}async runMetadataQuery(e){return(0,J.n)(super.query({targets:[e]})).then(this.toMetricFindValue)}async metricFindQuery(e,a){if(this.version===E.Flux||this.version===E.SQL||this.isMigrationToggleOnAndIsAccessProxy()){const n={refId:"metricFindQuery",query:e,rawQuery:!0,...this.version===E.SQL?{rawSql:e,format:rr.ws.Table}:{}};return(0,J.n)(super.query({...a??{},targets:[n]})).then(this.toMetricFindValue)}const r=this.templateSrv.replace(e,a?.scopedVars,this.interpolateQueryExpr);return(0,J.n)(this._seriesQuery(r,a)).then(n=>this.responseParser.parse(e,n))}toMetricFindValue(e){return(e.data??[]).map(n=>(0,je.S9)(n)).flat().filter((n,l,i)=>l===i.findIndex(o=>o.text===n.text))}getTagKeys(e){const a=ye({type:"TAG_KEYS",templateService:this.templateSrv,database:this.database});return this.metricFindQuery(a)}getTagValues(e){const a=ye({type:"TAG_VALUES",templateService:this.templateSrv,database:this.database,withKey:e.key});return this.metricFindQuery(a)}_seriesQuery(e,a){if(!e)return(0,Te.of)({results:[]});if(a&&a.range){const r=this.getTimeFilter({rangeRaw:a.range,timezone:a.timezone});e=e.replace("$timeFilter",r)}return this._influxRequest(this.httpMode,"/query",{q:e,epoch:"ms"},a)}serializeParams(e){return e?(0,p.reduce)(e,(a,r,n)=>(r==null||a.push(encodeURIComponent(n)+"="+encodeURIComponent(r)),a),[]).join("&"):""}_influxRequest(e,a,r,n){const l=this.urls.shift();this.urls.push(l);const i={};this.username&&(i.u=this.username,i.p=this.password),n&&n.database?i.db=n.database:this.database&&(i.db=this.database),n?.policy&&n.policy!==G&&(i.rp=n.policy);const{q:o}=r;e==="POST"&&(0,p.has)(r,"q")?((0,p.extend)(i,(0,p.omit)(r,["q"])),r=this.serializeParams((0,p.pick)(r,["q"]))):(e==="GET"||e==="POST")&&((0,p.extend)(i,r),r=null);const u={method:e,url:l+a,params:i,data:r,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return u.headers=u.headers||{},(this.basicAuth||this.withCredentials)&&(u.withCredentials=!0),this.basicAuth&&(u.headers.Authorization=this.basicAuth),e==="POST"&&(u.headers["Content-type"]="application/x-www-form-urlencoded"),(0,qe.i)().fetch(u).pipe((0,Ie.U)(c=>{const{data:f}=c;if(f&&(f.executedQueryString=o,f.results)){const m=c.data.results.filter(g=>g.error);if(m.length>0)throw{message:"InfluxDB Error: "+m[0].error,data:f}}return f}),(0,Za.K)(c=>c.cancelled?(0,Te.of)(c):(0,ze._)(this.handleErrors(c))))}handleErrors(e){const a={message:e&&e.status||e&&e.message||"Unknown error during query transaction. Please check JS console logs."};return(Number.isInteger(e.status)&&e.status!==0||e.status>=300)&&(e.data&&e.data.error?(a.message="InfluxDB Error: "+e.data.error,a.data=e.data,a.config=e.config):(a.message="Network Error: "+e.statusText+"("+e.status+")",a.data=e.data,a.config=e.config)),a}getTimeFilter(e){const a=this.getInfluxTime(e.rangeRaw.from,!1,e.timezone),r=this.getInfluxTime(e.rangeRaw.to,!0,e.timezone);return"time >= "+a+" and time <= "+r}getInfluxTime(e,a,r){let n;if((0,p.isString)(e)){if(e==="now")return"now()";const l=/^now-(\d+)([dhms])$/.exec(e);if(l){const i=parseInt(l[1],10),o=l[2];return"now() - "+i+o}if(n=er.parse(e,a,r),!n)throw new Error("unable to parse date");e=n}return e.valueOf()+"ms"}isMigrationToggleOnAndIsAccessProxy(){return ee.default.featureToggles.influxdbBackendMigration&&this.access==="proxy"}classicQuery(e){let a=this.getTimeFilter(e);const r=e.scopedVars,n=(0,p.cloneDeep)(e.targets),l=[];let i,o,u=(0,p.map)(n,m=>m.hide?"":(l.push(m),r.interval=r.__interval,new P(m,this.templateSrv,r).render(!0))).reduce((m,g)=>(g!==""&&(m+=";"+g),m));if(u==="")return(0,Te.of)({data:[]});const c=this.templateSrv.getAdhocFilters(this.name),f=e.targets.flatMap(m=>m.adhocFilters??[]);if(c?.length||f?.length){const m=c?.length?c:f,g=new P({refId:"A"},this.templateSrv,r);a+=" AND "+g.renderAdhocFilters(m)}return r.timeFilter={value:a},u=this.templateSrv.replace(u,r),this._seriesQuery(u,e).pipe((0,Ie.U)(m=>{if(!m||!m.results)return{data:[]};const g=[];for(i=0;i<m.results.length;i++){const h=m.results[i];if(!h||!h.series)continue;const D=l[i];let Z=D.alias;Z&&(Z=this.templateSrv.replace(D.alias,e.scopedVars));const y={executedQueryString:m.executedQueryString},b=new Je({refId:D.refId,series:m.results[i].series,alias:Z,meta:y});switch(D.resultFormat){case"logs":y.preferredVisualisationType="logs";case"table":{g.push(b.getTable());break}default:{const R=b.getTimeSeries();for(o=0;o<R.length;o++)g.push(pr(R[o]));break}}}return{data:g}}))}async annotationEvents(e,a){if(this.version===E.Flux)return Promise.reject({message:"Flux requires the standard annotation query"});if(!a.query)return Promise.reject({message:"Query missing in annotation definition"});if(this.isMigrationToggleOnAndIsAccessProxy()){const l={refId:"metricFindQuery",datasource:this.getRef(),query:this.templateSrv.replace(a.query,void 0,this.interpolateQueryExpr),rawQuery:!0};return(0,J.n)((0,qe.i)().fetch({url:"/api/ds/query",method:"POST",headers:this.getRequestHeaders(),data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[l]},requestId:a.name}).pipe((0,Ie.U)(async i=>await this.responseParser.transformAnnotationResponse(a,i,l))))}const r=this.getTimeFilter({rangeRaw:e.range.raw,timezone:e.timezone});let n=a.query.replace("$timeFilter",r);return n=this.templateSrv.replace(n,void 0,this.interpolateQueryExpr),(0,J.n)(this._seriesQuery(n,e)).then(l=>{if(!l||!l.results||!l.results[0])throw{message:"No results in response from InfluxDB"};return new Je({series:l.results[0].series,annotation:a}).getAnnotations()})}}function fr(t){const e=t.find(r=>r!==null);if(e===void 0)return M.fS.number;const a=typeof e;switch(a){case"string":return M.fS.string;case"boolean":return M.fS.boolean;case"number":return M.fS.number;default:throw new Error(`InfluxQL: invalid value type ${a}`)}}function pr(t){const e=[],a=[],r=t.datapoints;for(const o of r)a.push(o[0]),e.push(o[1]);const n={name:M.Ls,type:M.fS.time,config:{},values:e},l={name:M.M5,type:fr(a),config:{displayNameFromDS:t.title},values:a,labels:t.tags},i=[n,l];return{name:t.target,refId:t.refId,meta:t.meta,fields:i,length:a.length}}function gr(t){return typeof t=="string"&&isNaN(parseFloat(t))?(0,ae.yI)(t):t}function et(t){return typeof t!="string"||(t=t.replace(/\\/g,"\\\\\\\\"),t=t.replace(/[$^*{}\[\]\'+?.()|]/g,"$&")),t}const hr=new tt.hf(dr).setConfigEditor(ft).setQueryEditor(Ya).setVariableQueryEditor(qa).setQueryEditorHelp(ja)}}]);

//# sourceMappingURL=6450.d8fcdf6b584c553d5cdb.js.map