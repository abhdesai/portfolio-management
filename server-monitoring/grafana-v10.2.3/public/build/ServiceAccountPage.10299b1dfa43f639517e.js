"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[687],{21906:(Ee,k,a)=>{a.r(k),a.d(k,{ServiceAccountPageUnconnected:()=>pe,default:()=>Re});var e=a(85960),s=a(36752),y=a(58715),S=a(74042),D=a(29165),T=a(75064),i=a(77980),P=a(20989),v=a(49683),r=a(95162),K=a(88879),V=a(41879);const Q=t=>{const n=V.contextSrv.hasPermissionInMetadata(r.AccessControlAction.ServiceAccountsPermissionsWrite,t.serviceAccount);return e.createElement(K.P,{title:"Permissions",addPermissionTitle:"Add permission",buttonLabel:"Add permission",resource:"serviceaccounts",resourceId:t.serviceAccount.id,canSetPermissions:n})};var H=a(39042),u=a(66681),B=a(12537),m=a(47257),p=a(57445),c=a(79055),l=a(80932),O=a(56152),g=a(24956),h=a(16783);const R=({label:t,value:n,inputType:o,disabled:E,onChange:f})=>{const x=(0,e.useRef)(null),[d,W]=(0,e.useState)(n),[$,C]=(0,e.useState)(!1),N=(0,m.wW)(F),ae=`${t}-input`;(0,e.useEffect)(()=>{$&&ue()},[$]);const oe=()=>{C(!0)},ie=()=>{C(!1),W(n||"")},se=(Z,U)=>{U!==O.G.Invalid&&W(Z.target.value)},de=(Z,U)=>{U!==O.G.Invalid&&W(Z.target.value)},ue=()=>{x?.current?.focus()},me=()=>{C(!1),f&&f(d)};return e.createElement("tr",null,e.createElement("td",null,e.createElement(p._,{htmlFor:ae},t)),e.createElement("td",{className:"width-25",colSpan:2},!E&&$?e.createElement(g.I,{id:ae,type:o,defaultValue:n,onBlur:de,onChange:se,ref:x,width:30}):e.createElement("span",{className:(0,u.cx)({[N.disabled]:E})},n)),e.createElement("td",null,f&&e.createElement(h.p,{closeOnConfirm:!0,confirmText:"Save",onConfirm:me,onClick:oe,onCancel:ie,disabled:E},"Edit")))},F=t=>({disabled:(0,u.css)`
      color: ${t.colors.text.secondary};
    `});var L=a(84184),z=a(95831);const w=({label:t,serviceAccount:n,roleOptions:o,onRoleChange:E})=>{const f=`${t}-input`,x=v.Vt.hasPermissionInMetadata(r.AccessControlAction.ServiceAccountsWrite,n);return e.createElement("tr",null,e.createElement("td",null,e.createElement(p._,{htmlFor:f},t)),v.Vt.licensedAccessControlEnabled()?e.createElement("td",{colSpan:3},e.createElement(L.R,{userId:n.id,orgId:n.orgId,basicRole:n.role,onBasicRoleChange:E,roleOptions:o,basicRoleDisabled:!x,disabled:n.isDisabled})):e.createElement(e.Fragment,null,e.createElement("td",null,e.createElement(z.A,{width:24,inputId:f,"aria-label":"Role",value:n.role,disabled:n.isExternal||n.isDisabled,onChange:E})),e.createElement("td",{colSpan:2})))};function A({serviceAccount:t,timeZone:n,onChange:o}){const E=(0,m.wW)(I),f=v.Vt.hasPermission(r.AccessControlAction.ServiceAccountsWrite),[x,d]=e.useState([]),W=C=>{o({...t,role:C})},$=C=>{o({...t,name:C})};return e.useEffect(()=>{async function C(){try{if(v.Vt.hasPermission(r.AccessControlAction.ActionRolesList)){let N=await(0,l.ul)(t.orgId);d(N)}}catch{console.error("Error loading options for service account")}}v.Vt.licensedAccessControlEnabled()&&C()},[t.orgId]),e.createElement("div",{className:E.section},e.createElement("h3",null,"Information"),e.createElement("table",{className:"filter-table"},e.createElement("tbody",null,e.createElement(R,{label:"Name",value:t.name,onChange:t.isExternal?void 0:$,disabled:!f||t.isDisabled}),e.createElement(R,{label:"ID",value:t.login,disabled:t.isDisabled}),e.createElement(w,{label:"Roles",serviceAccount:t,onRoleChange:W,roleOptions:x}),e.createElement(R,{label:"Creation date",value:(0,B.dq)(t.createdAt,{timeZone:n}),disabled:t.isDisabled}),t.isExternal&&t.requiredBy&&e.createElement("tr",null,e.createElement("td",null,e.createElement(p._,null,"Used by")),e.createElement("td",null,e.createElement(c.h,{href:`/plugins/${t.requiredBy}`},t.requiredBy))))))}const I=t=>({section:(0,u.css)`
    margin-bottom: ${t.spacing(4)};
  `});var X=a(81573),Y=a(14607),_=a(97666);const ee=({tokens:t,timeZone:n,tokenActionsDisabled:o,onDelete:E})=>{const f=(0,m.l4)(),x=b(f);return e.createElement("table",{className:(0,u.cx)(x.section,"filter-table")},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",null,"Name"),e.createElement("th",null,"Expires"),e.createElement("th",null,"Created"),e.createElement("th",null,"Last used at"),e.createElement("th",null),e.createElement("th",null))),e.createElement("tbody",null,t.map(d=>e.createElement("tr",{key:d.id,className:x.tableRow(d.hasExpired||d.isRevoked)},e.createElement("td",null,d.name),e.createElement("td",null,e.createElement(ce,{timeZone:n,token:d})),e.createElement("td",null,te(n,d.created)),e.createElement("td",null,j(n,d.lastUsedAt)),e.createElement("td",{className:"width-1 text-center"},d.isRevoked&&e.createElement(q,null)),e.createElement("td",null,e.createElement(X.m,{"aria-label":`Delete service account token ${d.name}`,size:"sm",onConfirm:()=>E(d),disabled:o}))))))};function j(t,n){return n?(0,B.dq)(n,{timeZone:t}):"Never"}function te(t,n){return n?(0,B.dq)(n,{timeZone:t}):"No expiration date"}function le(t){const n=Math.ceil(t/86400);return`Expires in ${n>1?`${n} days`:`${n} day`}`}const q=()=>{const t=(0,m.wW)(b);return e.createElement("span",{className:t.hasExpired},"Revoked",e.createElement("span",{className:t.tooltipContainer},e.createElement(Y.u,{content:"This token has been publicly exposed. Please rotate this token"},e.createElement(_.J,{name:"exclamation-triangle",className:t.toolTipIcon}))))},ce=({timeZone:t,token:n})=>{const o=(0,m.wW)(b);return n.expiration?n.secondsUntilExpiration?e.createElement("span",{className:o.secondsUntilExpiration},le(n.secondsUntilExpiration)):n.hasExpired?e.createElement("span",{className:o.hasExpired},"Expired",e.createElement("span",{className:o.tooltipContainer},e.createElement(Y.u,{content:"This token has expired"},e.createElement(_.J,{name:"exclamation-triangle",className:o.toolTipIcon})))):e.createElement("span",null,te(t,n.expiration)):e.createElement("span",{className:o.neverExpire},"Never")},b=t=>({tableRow:n=>(0,u.css)`
    color: ${n?t.colors.text.secondary:t.colors.text.primary};
  `,tooltipContainer:(0,u.css)`
    margin-left: ${t.spacing(1)};
  `,toolTipIcon:(0,u.css)`
    color: ${t.colors.error.text};
  `,secondsUntilExpiration:(0,u.css)`
    color: ${t.colors.warning.text};
  `,hasExpired:(0,u.css)`
    color: ${t.colors.error.text};
  `,neverExpire:(0,u.css)`
    color: ${t.colors.text.secondary};
  `,section:(0,u.css)`
    margin-bottom: ${t.spacing(4)};
  `});var ve=a(66585),G=a(85445),Te=a(91),xe=a(78105),ne=a(28970);const J="/api/serviceaccounts";function fe(t){return async n=>{n((0,ne.s3)());try{const o=await(0,G.i)().get(`${J}/${t}`,(0,xe.y)());n((0,ne.P4)(o))}catch(o){console.error(o)}finally{n((0,ne.LA)())}}}function he(t){return async n=>{await(0,G.i)().patch(`${J}/${t.id}?accesscontrol=true`,{...t}),n(fe(t.id))}}function ye(t){return async()=>{await(0,G.i)().delete(`${J}/${t}`),Te.E1.push("/org/serviceaccounts")}}function Pe(t,n,o){return async E=>{const f=await(0,G.i)().post(`${J}/${t}/tokens`,n);o(f.key),E(re(t))}}function Ae(t,n){return async o=>{await(0,G.i)().delete(`${J}/${t}/tokens/${n}`),o(re(t))}}function re(t){return async n=>{try{const o=await(0,G.i)().get(`${J}/${t}/tokens`);n((0,ne.e7)(o))}catch(o){console.error(o)}}}function Ie(t){return{serviceAccount:t.serviceAccountProfile.serviceAccount,tokens:t.serviceAccountProfile.tokens,isLoading:t.serviceAccountProfile.isLoading,timezone:(0,y.Z)(t.user)}}const Me={createServiceAccountToken:Pe,deleteServiceAccount:ye,deleteServiceAccountToken:Ae,loadServiceAccount:fe,loadServiceAccountTokens:re,updateServiceAccount:he},Oe=(0,s.connect)(Ie,Me),pe=({match:t,serviceAccount:n,tokens:o,timezone:E,isLoading:f,createServiceAccountToken:x,deleteServiceAccount:d,deleteServiceAccountToken:W,loadServiceAccount:$,loadServiceAccountTokens:C,updateServiceAccount:N})=>{const[ae,oe]=(0,e.useState)(""),[ie,se]=(0,e.useState)(!1),[de,ue]=(0,e.useState)(!1),[me,Z]=(0,e.useState)(!1),U=parseInt(t.params.id,10),ge=n.isDisabled||n.isExternal||!v.Vt.hasPermission(r.AccessControlAction.ServiceAccountsWrite),De=v.Vt.hasPermission(r.AccessControlAction.ServiceAccountsWrite),Le=v.Vt.hasPermissionInMetadata(r.AccessControlAction.ServiceAccountsPermissionsRead,n),be={text:n.name,img:n.avatarUrl,subTitle:"Manage settings for an individual service account."};(0,e.useEffect)(()=>{$(U),C(U),v.Vt.licensedAccessControlEnabled()&&(0,ve.bX)()},[$,C,U]);const $e=M=>{N(M)},Ce=M=>()=>{ue(M)},Se=M=>()=>{Z(M)},Ne=()=>{d(n.id)},Be=()=>{N({...n,isDisabled:!0}),Z(!1)},We=()=>{N({...n,isDisabled:!1})},Ue=M=>{W(n?.id,M.id)},ke=M=>{x(n?.id,M,oe)},Ke=()=>{se(!1),oe("")};return e.createElement(P.T,{navId:"serviceaccounts",pageNav:be},e.createElement(P.T.Contents,{isLoading:f},e.createElement("div",null,n&&!n.isExternal&&e.createElement(S.Lh,{spacing:"md",height:"auto",justify:"flex-end"},e.createElement(D.zx,{type:"button",variant:"destructive",onClick:Ce(!0),disabled:!v.Vt.hasPermission(r.AccessControlAction.ServiceAccountsDelete)},"Delete service account"),n.isDisabled?e.createElement(D.zx,{type:"button",variant:"secondary",onClick:We,disabled:!De},"Enable service account"):e.createElement(D.zx,{type:"button",variant:"secondary",onClick:Se(!0),disabled:!De},"Disable service account")),n&&n.isExternal&&e.createElement(S.Lh,{spacing:"md",height:"auto",justify:"flex-end"},e.createElement(T.h,{disabled:!0,name:"lock",size:"md",tooltip:"This is a managed service account and cannot be modified."})),n&&e.createElement(A,{serviceAccount:n,timeZone:E,onChange:$e}),e.createElement(S.Lh,{justify:"space-between",height:"auto"},e.createElement("h3",null,"Tokens"),!n.isExternal&&e.createElement(D.zx,{onClick:()=>se(!0),disabled:ge},"Add service account token")),o&&e.createElement(ee,{tokens:o,timeZone:E,onDelete:Ue,tokenActionsDisabled:ge}),!n.isExternal&&Le&&e.createElement(Q,{serviceAccount:n})),e.createElement(i.s,{isOpen:de,title:"Delete service account",body:"Are you sure you want to delete this service account?",confirmText:"Delete service account",onConfirm:Ne,onDismiss:Ce(!1)}),e.createElement(i.s,{isOpen:me,title:"Disable service account",body:"Are you sure you want to disable this service account?",confirmText:"Disable service account",onConfirm:Be,onDismiss:Se(!1)}),e.createElement(H.m,{isOpen:ie,token:ae,serviceAccountLogin:n.login,onCreateToken:ke,onClose:Ke})))},Re=Oe(pe)},39042:(Ee,k,a)=>{a.d(k,{m:()=>H});var e=a(66681),s=a(85960),y=a(90308),S=a(90857),D=a(47257),T=a(7288),i=a(20519),P=a(24956),v=a(5106),r=a(68594),K=a(29165),V=a(55855);const Q=[{label:"No expiration",value:!1},{label:"Set expiration date",value:!0}],H=({isOpen:m,token:p,serviceAccountLogin:c,onCreateToken:l,onClose:O})=>{const g=new Date;g.setDate(g.getDate()+1);const h=new Date;S.config.tokenExpirationDayLimit!==void 0&&S.config.tokenExpirationDayLimit>-1?h.setDate(h.getDate()+S.config.tokenExpirationDayLimit+1):h.setDate(864e13);const R=S.config.tokenExpirationDayLimit!==void 0&&S.config.tokenExpirationDayLimit>0,[F,L]=(0,s.useState)(""),[z,w]=(0,s.useState)(""),[A,I]=(0,s.useState)(R),[X,Y]=(0,s.useState)(g),[_,ee]=(0,s.useState)(X!==""),j=(0,D.wW)(B);(0,s.useEffect)(()=>{m&&L(`${c}-${(0,y.Z)()}`)},[c,m]);const te=b=>{ee(b!==""),Y(b)},le=()=>{l({name:z||F,secondsToLive:A?u(X):void 0})},q=()=>{w(""),L(""),I(R),Y(g),ee(X!==""),O()},ce=p?"Service account token created":"Add service account token";return s.createElement(T.u,{isOpen:m,title:ce,onDismiss:q,className:j.modal,contentClassName:j.modalContent},p?s.createElement(s.Fragment,null,s.createElement(i.g,{label:"Token",description:"Copy the token now as you will not be able to see it again. Losing a token requires creating a new one."},s.createElement("div",{className:j.modalTokenRow},s.createElement(P.I,{name:"tokenValue",value:p,readOnly:!0}),s.createElement(V.m,{className:j.modalCopyToClipboardButton,variant:"primary",size:"md",icon:"copy",getText:()=>p},"Copy clipboard"))),s.createElement(T.u.ButtonRow,null,s.createElement(V.m,{variant:"primary",getText:()=>p,onClipboardCopy:q},"Copy to clipboard and close"),s.createElement(K.zx,{variant:"secondary",onClick:q},"Close"))):s.createElement("div",null,s.createElement(i.g,{label:"Display name",description:"Name to easily identify the token",required:!0},s.createElement(P.I,{name:"tokenName",value:z,placeholder:F,onChange:b=>{w(b.currentTarget.value)}})),s.createElement(i.g,{label:"Expiration"},s.createElement(v.S,{options:Q,value:A,onChange:I,size:"md"})),A&&s.createElement(i.g,{label:"Expiration date"},s.createElement(r.d,{onChange:te,value:X,placeholder:"",minDate:g,maxDate:h})),s.createElement(T.u.ButtonRow,null,s.createElement(K.zx,{onClick:le,disabled:A&&!_},"Generate token"))))},u=m=>{const p=new Date(m),c=new Date;return Math.ceil((p.getTime()-c.getTime())/1e3)},B=m=>({modal:(0,e.css)`
      width: 550px;
    `,modalContent:(0,e.css)`
      overflow: visible;
    `,modalTokenRow:(0,e.css)`
      display: flex;
    `,modalCopyToClipboardButton:(0,e.css)`
      margin-left: ${m.spacing(.5)};
    `})},66585:(Ee,k,a)=>{a.d(k,{R5:()=>B,TL:()=>V,XE:()=>m,Xd:()=>r,bX:()=>v,fT:()=>H,oO:()=>p,yN:()=>Q});var e=a(56375),s=a.n(e),y=a(85445),S=a(80932),D=a(41879),T=a(95162),i=a(28970);const P="/api/serviceaccounts";function v(){return async c=>{try{if(D.contextSrv.licensedAccessControlEnabled()&&D.contextSrv.hasPermission(T.AccessControlAction.ActionRolesList)){const l=await(0,S.ul)();c((0,i.Dn)(l))}}catch(l){console.error(l)}}}function r({withLoadingIndicator:c}={withLoadingIndicator:!1}){return async(l,O)=>{try{if(D.contextSrv.hasPermission(T.AccessControlAction.ServiceAccountsRead)){c&&l((0,i.pN)());const{perPage:g,page:h,query:R,serviceAccountStateFilter:F}=O().serviceAccounts,L=await(0,y.i)().get(`/api/serviceaccounts/search?perpage=${g}&page=${h}&query=${R}${u(F)}&accesscontrol=true`);if(D.contextSrv.licensedAccessControlEnabled()){l((0,i.Fy)());const z=D.contextSrv.user.orgId,w=L?.serviceAccounts.map(I=>I.id),A=await(0,y.i)().post("/api/access-control/users/roles/search",{userIds:w,orgId:z});L.serviceAccounts.forEach(I=>{I.roles=A?A[I.id]||[]:[]}),l((0,i.BR)())}l((0,i.Ub)(L))}}catch(g){console.error(g)}finally{l((0,i.dt)())}}}const K=(0,e.debounce)(c=>c(r()),500,{leading:!0});function V(c){return async l=>{await(0,y.i)().patch(`${P}/${c.id}?accesscontrol=true`,{...c}),l(r())}}function Q(c){return async l=>{await(0,y.i)().delete(`${P}/${c}`),l(r())}}function H(c,l,O){return async g=>{const h=await(0,y.i)().post(`${P}/${c}/tokens`,l);O(h.key),g(r())}}const u=c=>{switch(c){case T.ServiceAccountStateFilter.WithExpiredTokens:return"&expiredTokens=true";case T.ServiceAccountStateFilter.Disabled:return"&disabled=true";case T.ServiceAccountStateFilter.External:return"&external=true";default:return""}};function B(c){return async l=>{l((0,i.aj)(c)),K(l)}}function m(c){return async l=>{l((0,i.M4)(c)),l(r())}}function p(c){return async l=>{l((0,i.PJ)(c)),l(r())}}}}]);

//# sourceMappingURL=ServiceAccountPage.10299b1dfa43f639517e.js.map