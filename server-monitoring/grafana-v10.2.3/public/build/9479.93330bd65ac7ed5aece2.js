"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9479],{33223:(oe,F,l)=>{l.d(F,{a:()=>C});var v=l(85960),O=l(66681),U=l(84933),n=l(6089),L=l(24956),y=l(15889),w=Object.defineProperty,W=Object.defineProperties,_=Object.getOwnPropertyDescriptors,$=Object.getOwnPropertySymbols,P=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable,N=(Q,f,A)=>f in Q?w(Q,f,{enumerable:!0,configurable:!0,writable:!0,value:A}):Q[f]=A,S=(Q,f)=>{for(var A in f||(f={}))P.call(f,A)&&N(Q,A,f[A]);if($)for(var A of $(f))E.call(f,A)&&N(Q,A,f[A]);return Q},T=(Q,f)=>W(Q,_(f));const C=({config:Q,onChange:f,className:A})=>{const K=G=>{f(T(S({},Q),{jsonData:T(S({},Q.jsonData),{keepCookies:G})}))},x=G=>{f(T(S({},Q),{jsonData:T(S({},Q.jsonData),{timeout:parseInt(G.currentTarget.value,10)})}))},te={container:(0,O.css)({maxWidth:578})};return v.createElement(y._,{title:"Advanced HTTP settings",className:(0,O.cx)(te.container,A)},v.createElement(U._,{htmlFor:"advanced-http-cookies",label:"Allowed cookies",labelWidth:24,tooltip:"Grafana proxy deletes forwarded cookies by default. Specify cookies by name that should be forwarded to the data source.",disabled:Q.readOnly,grow:!0},v.createElement(n.B,{id:"advanced-http-cookies",placeholder:"New cookie (hit enter to add)",tags:Q.jsonData.keepCookies,onChange:K})),v.createElement(U._,{htmlFor:"advanced-http-timeout",label:"Timeout",labelWidth:24,tooltip:"HTTP request timeout in seconds",disabled:Q.readOnly,grow:!0},v.createElement(L.I,{id:"advanced-http-timeout",type:"number",min:0,placeholder:"Timeout in seconds","aria-label":"Timeout in seconds",value:Q.jsonData.timeout,onChange:x})))}},76581:(oe,F,l)=>{l.d(F,{i:()=>n});var v=l(66681),O=l(85960),U=l(47257);const n=({hideLine:y=!1})=>{const w=(0,U.wW)(L);return y?O.createElement("hr",{className:w.dividerHideLine}):O.createElement("hr",{className:w.divider})},L=y=>({divider:(0,v.css)({margin:y.spacing(4,0)}),dividerHideLine:(0,v.css)({border:"none",margin:y.spacing(3,0)})})},42056:(oe,F,l)=>{l.d(F,{I:()=>P});var v=l(66681),O=l(85960),U=l(52219),n=l(15889),L=l(47257),y=l(81368),w=l(84933),W=l(5999),_=l(7033);function $({options:N,onOptionsChange:S}){const T=(0,L.wW)(E);return O.createElement("div",{className:T.container},O.createElement(y.Z,{className:T.row},O.createElement(w._,{tooltip:"Displays the node graph above the trace view. Default: disabled",label:"Enable node graph",labelWidth:26},O.createElement(W.x,{id:"enableNodeGraph",value:N.jsonData.nodeGraph?.enabled,onChange:C=>(0,U.tp)({onOptionsChange:S,options:N},"nodeGraph",{...N.jsonData.nodeGraph,enabled:C.currentTarget.checked})}))))}const P=({options:N,onOptionsChange:S})=>{let T=N.type;return T+=N.type==="tempo"?"/configure-tempo-data-source/#node-graph":"/#node-graph",O.createElement(n._,{title:"Node graph",description:O.createElement(_.W,{description:"Show or hide the node graph visualization.",suffix:T,feature:"the node graph"})},O.createElement($,{options:N,onOptionsChange:S}))},E=N=>({infoText:(0,v.css)({label:"infoText",paddingBottom:N.spacing(2),color:N.colors.text.secondary}),container:(0,v.css)({label:"container",width:"100%"}),row:(0,v.css)({label:"row",alignItems:"baseline"})})},261:(oe,F,l)=>{l.d(F,{Y:()=>C});var v=l(66681),O=l(85960),U=l(52219),n=l(57773),L=l(47257),y=l(81368),w=l(84933),W=l(29165),_=l(24956),$=l(40715),P=l(7033),E=l(42177),N=l(7734),S=l(29724);function T({options:f,onOptionsChange:A}){const K=(0,L.wW)(Q);return O.createElement("div",{className:(0,v.css)({width:"100%"})},O.createElement(y.Z,{className:K.row},O.createElement(w._,{tooltip:"The Prometheus data source the trace is going to navigate to",label:"Data source",labelWidth:26},O.createElement($.q,{inputId:"trace-to-metrics-data-source-picker",pluginId:"prometheus",current:f.jsonData.tracesToMetrics?.datasourceUid,noDefault:!0,width:40,onChange:x=>(0,U.tp)({onOptionsChange:A,options:f},"tracesToMetrics",{...f.jsonData.tracesToMetrics,datasourceUid:x.uid})})),f.jsonData.tracesToMetrics?.datasourceUid?O.createElement(W.zx,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,U.tp)({onOptionsChange:A,options:f},"tracesToMetrics",{...f.jsonData.tracesToMetrics,datasourceUid:void 0})}},"Clear"):null),O.createElement(y.Z,null,O.createElement(E.w,{label:(0,S.mH)("start"),tooltip:(0,S.rr)("start","-2m"),value:f.jsonData.tracesToMetrics?.spanStartTimeShift||"",onChange:x=>{(0,U.tp)({onOptionsChange:A,options:f},"tracesToMetrics",{...f.jsonData.tracesToMetrics,spanStartTimeShift:x})},placeholder:"-2m",isInvalidError:S.Ny})),O.createElement(y.Z,null,O.createElement(E.w,{label:(0,S.mH)("end"),tooltip:(0,S.rr)("end","2m"),value:f.jsonData.tracesToMetrics?.spanEndTimeShift||"",onChange:x=>{(0,U.tp)({onOptionsChange:A,options:f},"tracesToMetrics",{...f.jsonData.tracesToMetrics,spanEndTimeShift:x})},placeholder:"2m",isInvalidError:S.Ny})),O.createElement(y.Z,null,O.createElement(w._,{tooltip:"Tags that will be used in the metrics query",label:"Tags",labelWidth:26},O.createElement(N.a,{values:f.jsonData.tracesToMetrics?.tags??[],onChange:x=>(0,U.tp)({onOptionsChange:A,options:f},"tracesToMetrics",{...f.jsonData.tracesToMetrics,tags:x})}))),f.jsonData.tracesToMetrics?.queries?.map((x,te)=>O.createElement("div",{key:te,className:K.queryRow},O.createElement(w._,{label:"Link Label",labelWidth:26,tooltip:"Descriptive label for the linked query"},O.createElement(_.I,{label:"Link Label",type:"text",allowFullScreen:!0,value:x.name,width:40,onChange:G=>{let ge=f.jsonData.tracesToMetrics?.queries.slice()??[];ge[te].name=G.currentTarget.value,(0,U.tp)({onOptionsChange:A,options:f},"tracesToMetrics",{...f.jsonData.tracesToMetrics,queries:ge})}})),O.createElement(w._,{label:"Query",labelWidth:10,tooltip:"The Prometheus query that will run when navigating from a trace to metrics. Interpolate tags using the `$__tags` keyword",grow:!0},O.createElement(_.I,{label:"Query",type:"text",allowFullScreen:!0,value:x.query,onChange:G=>{const ge=(f.jsonData.tracesToMetrics?.queries??[]).map((fe,le)=>le===te?{...fe,query:G.currentTarget.value}:fe);(0,U.tp)({onOptionsChange:A,options:f},"tracesToMetrics",{...f.jsonData.tracesToMetrics,queries:ge})}})),O.createElement(W.zx,{variant:"destructive",title:"Remove query",icon:"times",type:"button",onClick:()=>{let G=f.jsonData.tracesToMetrics?.queries.slice();G?.splice(te,1),(0,U.tp)({onOptionsChange:A,options:f},"tracesToMetrics",{...f.jsonData.tracesToMetrics,queries:G})}}))),O.createElement(W.zx,{variant:"secondary",title:"Add query",icon:"plus",type:"button",onClick:()=>{(0,U.tp)({onOptionsChange:A,options:f},"tracesToMetrics",{...f.jsonData.tracesToMetrics,queries:[...f.jsonData.tracesToMetrics?.queries??[],{query:""}]})}},"Add query"))}const C=({options:f,onOptionsChange:A})=>{let K=f.type;return K+=f.type==="tempo"?"/configure-tempo-data-source/#trace-to-metrics":"/#trace-to-metrics",O.createElement(n.K,{title:"Trace to metrics",description:O.createElement(P.W,{description:"Navigate from a trace span to the selected data source's metrics.",suffix:K,feature:"trace to metrics"}),isCollapsible:!0,isInitiallyOpen:!0},O.createElement(T,{options:f,onOptionsChange:A}))},Q=f=>({infoText:(0,v.css)`
    padding-bottom: ${f.spacing(2)};
    color: ${f.colors.text.secondary};
  `,row:(0,v.css)`
    label: row;
    align-items: baseline;
  `,queryRow:(0,v.css)`
    label: queryRow;
    display: flex;
    flex-flow: wrap;
  `})},20691:(oe,F,l)=>{l.d(F,{n:()=>y});var v=l(85960),O=l(49289);const U=v.lazy(()=>Promise.all([l.e(4639),l.e(7142)]).then(l.bind(l,23685))),n=w=>v.createElement(v.Suspense,{fallback:null},v.createElement(U,{...w})),L=w=>{const W=(0,v.useRef)(null),{onRunQuery:_,onChange:$,...P}=w,E=S=>{W.current=S,$(S),_()},N=S=>{$(S)};return v.createElement(n,{onRunQuery:E,onBlur:N,onChange:$,...P})};class y extends v.PureComponent{constructor(W){super(W),this._isMounted=!1,this.onChangeQuery=(_,$)=>{const{query:P,onChange:E,onRunQuery:N}=this.props;if(E){const S={...P,expr:_};E(S),$&&N&&N()}},this.state={labelsLoaded:!1}}async componentDidMount(){this._isMounted=!0,await this.props.datasource.languageProvider.start(this.props.range),this._isMounted&&this.setState({labelsLoaded:!0})}componentWillUnmount(){this._isMounted=!1}componentDidUpdate(W){const{range:_,datasource:{languageProvider:$}}=this.props;(0,O.rf)(_,W.range)&&$.fetchLabels({timeRange:_})}render(){const{ExtraFieldElement:W,query:_,datasource:$,history:P,onRunQuery:E,range:N}=this.props,S=this.props.placeholder??"Enter a Loki query (run with Shift+Enter)";return v.createElement(v.Fragment,null,v.createElement("div",{className:"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1","data-testid":this.props["data-testid"]},v.createElement("div",{className:"gf-form--grow flex-shrink-1 min-width-15"},v.createElement(L,{datasource:$,history:P??[],onChange:this.onChangeQuery,onRunQuery:E,initialValue:_.expr??"",placeholder:S,timeRange:N}))),W)}}},49289:(oe,F,l)=>{l.d(F,{Hk:()=>$,U9:()=>w,_z:()=>P,aC:()=>E,iS:()=>W,k:()=>N,rf:()=>n,tU:()=>_});var v=l(60134);function O(S){return U(S/1e3)}function U(S){return Math.floor(S/60)}function n(S,T){if(S&&T){const C=O(S.from.valueOf())===O(T.from.valueOf()),Q=O(S.to.valueOf())===O(T.to.valueOf());return!(C&&Q)}return!1}const L=/[*+?()|\\.\[\]{}^$]/g;function y(S){return S.replace(L,"\\$&")}function w(S){return S.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/"/g,'\\"')}function W(S){return S.replace(/\\n/g,`
`).replace(/\\"/g,'"').replace(/\\\\/g,"\\")}function _(S){return w(y(S))}function $(S,T){return P(T)?_(S):w(S)}function P(S){return!!(S&&(S.includes("=~")||S.includes("!~")))}function E(S){const T=["b","kib","Kib","kb","KB","mib","Mib","mb","MB","gib","Gib","gb","GB","tib","Tib","tb","TB","pib","Pib","pb","PB","eib","Eib","eb","EB"],C=new RegExp(`^(?:-?\\d+(?:\\.\\d+)?)(?:${T.join("|")})$`);return!!S.match(C)}function N(S,T,C){if(!T||C===void 0)return null;const Q=T.fields.find(f=>f.name==="labelTypes")?.values[C];if(!Q)return null;switch(Q[S]){case"I":return v.JG.Indexed;case"S":return v.JG.StructuredMetadata;case"P":return v.JG.Parsed;default:return null}}},60134:(oe,F,l)=>{l.d(F,{JG:()=>y,sb:()=>n,EM:()=>O,Z3:()=>w,$o:()=>U});var v=(W=>(W.Builder="builder",W.Code="code",W))(v||{}),O=(W=>(W.Instant="instant",W.Range="range",W.Stream="stream",W))(O||{}),U=(W=>(W.DataSample="dataSample",W.LogsSample="logsSample",W.LogsVolume="logsVolume",W))(U||{}),n=(W=>(W.Backward="backward",W.Forward="forward",W))(n||{}),L=(W=>(W.Stream="streams",W.Vector="vector",W.Matrix="matrix",W))(L||{}),y=(W=>(W.Indexed="I",W.StructuredMetadata="S",W.Parsed="P",W))(y||{}),w=(W=>(W[W.LabelNames=0]="LabelNames",W[W.LabelValues=1]="LabelValues",W))(w||{})},15880:(oe,F,l)=>{l.d(F,{d:()=>P});var v=l(66681),O=l(85960),U=l(45220),n=l(1930),L=l(90857),y=l(47257),w=l(8655),W=l(13086),_=l(14607),$=l(97666);function P({title:T,children:C,collapsedInfo:Q,queryStats:f}){const[A,K]=(0,U.Z)(!1),x=(0,y.wW)(E);return O.createElement("div",{className:x.wrapper},O.createElement(w.U,{className:x.collapse,collapsible:!0,isOpen:A,onToggle:K,label:O.createElement(W.K,{gap:0},O.createElement("h6",{className:x.title},T),!A&&O.createElement("div",{className:x.description},Q.map((te,G)=>O.createElement("span",{key:G},te))))},O.createElement("div",{className:x.body},C)),f&&L.config.featureToggles.lokiQuerySplitting&&O.createElement(_.u,{content:"Note: the query will be split into multiple parts and executed in sequence. Query limits will only apply each individual part."},O.createElement($.J,{tabIndex:0,name:"info-circle",className:x.tooltip,size:"sm"})),f&&O.createElement("p",{className:x.stats},N(f)))}const E=T=>({collapse:(0,v.css)({backgroundColor:"unset",border:"unset",marginBottom:0,["> button"]:{padding:T.spacing(0,1)}}),wrapper:(0,v.css)({width:"100%",display:"flex",justifyContent:"space-between",alignItems:"baseline"}),title:(0,v.css)({flexGrow:1,overflow:"hidden",fontSize:T.typography.bodySmall.fontSize,fontWeight:T.typography.fontWeightMedium,margin:0}),description:(0,v.css)({color:T.colors.text.secondary,fontSize:T.typography.bodySmall.fontSize,fontWeight:T.typography.bodySmall.fontWeight,paddingLeft:T.spacing(2),gap:T.spacing(2),display:"flex"}),body:(0,v.css)({display:"flex",gap:T.spacing(2),flexWrap:"wrap"}),stats:(0,v.css)({margin:"0px",color:T.colors.text.secondary,fontSize:T.typography.bodySmall.fontSize}),tooltip:(0,v.css)({marginRight:T.spacing(.25)})}),N=T=>T.message?T.message:`This query will process approximately ${S(T)}.`,S=T=>{const{text:C,suffix:Q}=(0,n.Cf)("bytes")(T.bytes,1);return C+Q}},59479:(oe,F,l)=>{l.r(F),l.d(F,{plugin:()=>Ln});var v=l(41466),O=l(43471),U=l(2384),n=l(85960),L=l(43183),y=l(90857);function w(){return(0,L.ff)("grafana_traces_cheatsheet_clicked",{datasourceType:"tempo",grafana_version:y.config.buildInfo.version}),n.createElement("div",null,n.createElement("h2",{id:"tempo-cheat-sheet"},"Tempo Cheat Sheet"),n.createElement("p",null,"Tempo is a trace id lookup store. Enter a trace id in the above field and hit \u201CRun Query\u201D to retrieve your trace. Tempo is generally paired with other datasources such as Loki or Prometheus to find traces."),n.createElement("p",null,"Here are some"," ",n.createElement("a",{href:"https://grafana.com/docs/tempo/latest/guides/instrumentation/",target:"blank"},"instrumentation examples")," ","to get you started with trace discovery through logs and metrics (exemplars)."))}var W=l(66681),_=l(7288),$=l(85447),P=l(81368),E=l(84933),N=l(74042),S=l(5106),T=l(29165),C=l(47257),Q=l(84041),f=l(114),A=l(20691),K=l(81502);const x=(e,t)=>{const a=e?` (${e})`:"";return`${t||"Error"}${a}. Please check the server logs for more details.`};async function te(e){if(!e)return;const t=(0,K.F)();try{return await t.get(e)}catch(a){console.error("Failed to load data source",a);return}}function G({logsDatasourceUid:e,onChange:t,onRunQuery:a,query:r}){const s=(0,Q.Z)(()=>te(e),[e]);if(s.loading)return null;const o=s.value;return o?n.createElement(n.Fragment,null,n.createElement(f.W,null,"Tempo uses ",o.name," to find traces."),n.createElement(A.n,{datasource:o,onChange:t,onRunQuery:a,query:r.linkedQuery??{refId:"linked"},history:[]})):e?e&&!o?n.createElement("div",{className:"text-warning"},"Loki search datasource is configured but the data source no longer exists. Please configure existing data source to use the search."):null:n.createElement("div",{className:"text-warning"},"Please set up a Loki search datasource in the datasource settings.")}var ge=l(11248),fe=l(18678),le=l(85445),he=l(12399),ua=l(15820),Ee=l(49199),ae=l(27436),Re=l(24956),Pt=l(88492),ce=l(93991),ue=l(59767),H=l(56375),qe=l(81838),B=l(21964),He=l(16226),da=l(9360),Qt=l(59069),bt=l(3404),J=l(98231),Pe=l(85431),Je=l(25066),Rt=l(83286),et=l(76793),ma=l(58664),Wa=l.n(ma),ie=l(23757),Dt=l(71244),Ve=l(85745),pa=l(173),ga=l(81223),ee=l(58309),fa=l(32063),De=l(1713),_e=l(65512),M=l(11738);const ha={wordPattern:/(-?\d*\.\d\w*)|([^`~!#%^&*()\-=+\[{\]}\\|;:'",.<>\/?\s]+)/g,brackets:[["{","}"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{}},Ct=["=","!=",">","<",">=","<=","=~","!~"],Oa=["=","!="],Sa=["=","!=","=~","!~"],Ta=["=","!=",">","<",">=","<="],$e=["duration","kind","name","rootName","rootServiceName","status","statusMessage","traceDuration"],It=["resource","span"],va=["avg","min","max","sum","count","by"],Nt=$e.concat(It),ya={ignoreCase:!1,defaultToken:"",tokenPostfix:".traceql",keywords:Nt,operators:Ct,statusValues:["ok","unset","error","false","true"],functions:va,symbols:/[=><!~?:&|+\-*\/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,tokenizer:{root:[[/\/\/.*/,"comment"],[/\/\*.*\*\//,"comment"],[/[0-9]+(.[0-9]+)?(us|Âµs|ns|ms|s|m|h)/,"number"],[/^\s*[0-9A-Fa-f]+\s*$/,"tag"],[`(?:${Nt.join("|")})`,{cases:{"@keywords":"keyword","@default":"tag"}}],[/(?:\w|[.]|"(?:\\"|\\\\|[^\\"])*")+/,{cases:{"@functions":"predefined","@statusValues":"type","@default":"tag"}}],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/([^\w])(")/,[{token:""},{token:"string",next:"@string_double"}]],[/([^\w])(')/,[{token:""},{token:"string",next:"@string_single"}]],[/[{}()\[\]]/,"delimiter.bracket"],[/@symbols/,{cases:{"@operators":"delimiter","@default":""}}],[/(@digits)[eE]([\-+]?(@digits))?[fFdD]?/,"number.float"],[/(@digits)\.(@digits)([eE][\-+]?(@digits))?[fFdD]?/,"number.float"],[/0(@octaldigits)[Ll]?/,"number.octal"],[/0[bB](@binarydigits)[Ll]?/,"number.binary"],[/(@digits)[fFdD]/,"number.float"],[/(@digits)[lL]?/,"number"]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]]}},Ea={id:"traceql",extensions:[".traceql"],aliases:["tempo","traceql"],mimetypes:[],def:{language:ya,languageConfiguration:ha}},Pa={comment:{pattern:/\/\/.*/},"span-set":{pattern:/\{[^}]*}/,inside:{filter:{pattern:/([\w.\/-]+)?(\s*)(([!=+\-<>~]+)\s*("([^"\n&]+)?"?|([^"\n\s&|}]+))?)/g,inside:{comment:{pattern:/#.*/},"label-key":{pattern:/[a-z_.][\w./_-]*(?=\s*(=|!=|>|<|>=|<=|=~|!~))/,alias:"attr-name"},"label-value":{pattern:/("(?:\\.|[^\\"])*")|(\w+)/,alias:"attr-value"}}},punctuation:/[}{&|]/}},number:/\b-?\d+((\.\d*)?([eE][+-]?\d+)?)?\b/,operator:new RegExp("/[-+*/=%^~]|&&?|\\|?\\||!=?|<(?:=>?|<|>)?|>[>=]?|","i"),punctuation:/[{};()`,.]/},tt=e=>`{${e.filter(t=>t.tag&&t.operator&&t.value?.length).map(t=>`${xt(t)}${t.tag}${t.operator}${Qa(t)}`).join(" && ")}}`,Qa=e=>Array.isArray(e.value)&&e.value.length>1?`"${e.value.join("|")}"`:e.valueType==="string"?`"${e.value}"`:e.value,xt=e=>$e.find(t=>t===e.tag)?"":(e.scope===M.NM.Resource||e.scope===M.NM.Span?e.scope?.toLowerCase():"")+".",at=e=>xt(e)+e.tag,ba=e=>e.tag==="name"?"Span Name":e.tag==="service.name"&&e.scope===M.NM.Resource?"Service Name":(0,H.startCase)(at(e)),Ra=(e,t)=>[...$e,...e].filter(a=>!t.includes(a)),Fe=e=>(0,H.uniq)(e.map(t=>t.name&&t.name!=="intrinsic"&&t.tags?t.tags:[]).flat()),Da=e=>(0,H.uniq)(e.map(t=>t.tags?t.tags:[]).flat()),rt=(e,t)=>(0,H.uniq)(e.map(a=>a.name&&a.name===t&&a.tags?a.tags:[]).flat());function nt(e,t,a){const r=e.slice(0);return r[t]=a,r}const Mt=e=>{const t={label:e,value:e};switch(e){case"=":t.description="Equals";break;case"!=":t.description="Not equals";break;case">":t.description="Greater";break;case">=":t.description="Greater or Equal";break;case"<":t.description="Less";break;case"<=":t.description="Less or Equal";break;case"=~":t.description="Matches regex";break;case"!~":t.description="Does not match regex";break}return t};var st=(e=>(e[e.LabelNames=0]="LabelNames",e[e.LabelValues=1]="LabelValues",e))(st||{});const Ca=[{label:"Label names",value:0},{label:"Label values",value:1}],it="TempoDatasourceVariableQueryEditor-VariableQuery",Ia=({onChange:e,query:t,datasource:a})=>{const[r,s]=(0,n.useState)(t.label||""),[o,i]=(0,n.useState)(t.type),[c,u]=(0,n.useState)([]);(0,n.useEffect)(()=>{o===1&&a.labelNamesQuery().then(h=>{u(h.map(({text:g})=>({label:g,value:g})))})},[a,t,o]);const d=h=>{i(h.value),h.value!==void 0&&e({type:h.value,label:r,refId:it})},p=h=>{const g=h.value||"";s(g),o!==void 0&&e({type:o,label:g,refId:it})},m=()=>{o!==void 0&&e({type:o,label:r,refId:it})};return n.createElement(n.Fragment,null,n.createElement(P.Z,null,n.createElement(E._,{label:"Query type",labelWidth:20},n.createElement(ae.Ph,{"aria-label":"Query type",onChange:d,onBlur:m,value:o,options:Ca,width:32}))),o===1&&n.createElement(P.Z,null,n.createElement(E._,{label:"Label",labelWidth:20},n.createElement(ae.Ph,{"aria-label":"Label",onChange:p,onBlur:m,value:{label:r,value:r},options:c,width:32,allowCustomValue:!0}))))};var z=l(40449);class Lt extends v.iL{constructor(t,a){super(),this.request=async(r,s={})=>(await this.datasource.metadataRequest(r,s))?.data,this.start=async()=>(this.startTask||(this.startTask=this.fetchTags().then(()=>[])),this.startTask),this.setV1Tags=r=>{this.tagsV1=r},this.setV2Tags=r=>{this.tagsV2=r},this.getTags=r=>this.tagsV2&&r?r===M.NM.Unscoped?Fe(this.tagsV2):rt(this.tagsV2,r):this.tagsV1?(this.tagsV1.find(s=>s==="status")||this.tagsV1.push("status"),this.tagsV1):[],this.getMetricsSummaryTags=r=>this.tagsV2&&r?r===M.NM.Unscoped?Fe(this.tagsV2):rt(this.tagsV2,r):this.tagsV1?this.tagsV1:[],this.getTraceqlAutocompleteTags=r=>{if(this.tagsV2){if(r){if(r===M.NM.Unscoped)return Fe(this.tagsV2)}else return Fe(this.tagsV2);return rt(this.tagsV2,r)}else if(this.tagsV1)return this.tagsV1.find(s=>s==="status")||this.tagsV1.push("status"),this.tagsV1;return[]},this.getAutocompleteTags=()=>this.tagsV2?Da(this.tagsV2):this.tagsV1?(this.tagsV1.find(r=>r==="status.code")||this.tagsV1.push("status.code"),this.tagsV1):[],this.encodeTag=r=>encodeURIComponent(encodeURIComponent(r)),this.datasource=t,Object.assign(this,a)}async fetchTags(){let t,a;try{a=await this.request("/api/v2/search/tags",[])}catch{t=await this.request("/api/search/tags",[])}a&&a.scopes?this.setV2Tags(a.scopes):t&&this.setV1Tags(t.tagNames)}async getOptionsV1(t){const a=this.encodeTag(t),r=await this.request(`/api/search/tag/${a}/values`);let s=[];return r&&r.tagValues&&(s=r.tagValues.map(o=>({value:o,label:o}))),s}async getOptionsV2(t,a){const r=this.encodeTag(t),s=await this.request(`/api/v2/search/tag/${r}/values`,a?{q:a}:{});let o=[];return s&&s.tagValues&&s.tagValues.forEach(i=>{i.value&&o.push({type:i.type,value:i.value,label:i.value})}),o}}var At=l(45878),Na=l(38070);function xa(e,t,a){let r;if(!e.length)return Ce;const s={};e.forEach(i=>{const c=La(i.series,t);i.series.forEach(u=>{s[u.key]={name:`${u.key}`,type:ee.fS.string,config:Aa(u,c,a),values:[]}})}),r=(0,At.at)({name:"Metrics Summary",refId:"metrics-summary",fields:[...Object.values(s).sort((i,c)=>i.name.localeCompare(c.name)),{name:"kind",type:ee.fS.string,config:{displayNameFromDS:"Kind",custom:{width:150}}},{name:"spanCount",type:ee.fS.number,config:{displayNameFromDS:"Span count",custom:{width:150}}},{name:"errorPercentage",type:ee.fS.number,config:{displayNameFromDS:"Error",unit:"percent",custom:{width:150}}},Ye("p50"),Ye("p90"),Ye("p95"),Ye("p99")],meta:{preferredVisualisationType:"table"}});const o=e.map(Ma);r.length=o.length;for(const i of o)for(const c of r.fields)c.values.push(i[c.name]);return r=(0,At.aK)(r,0),[r]}const Ma=e=>{const t=e.errorSpanCount?Oe(e.errorSpanCount)/Oe(e.spanCount)*100:"0%",a={kind:"server",spanCount:Oe(e.spanCount),errorPercentage:t,p50:Oe(e.p50),p90:Oe(e.p90),p95:Oe(e.p95),p99:Oe(e.p99)};return e.series.forEach(r=>{a[`${r.key}`]=Ua(r)||""}),a},La=(e,t)=>{const a=e.map(o=>{const i=o.value.type===3||o.value.type===4,c=o.value.type===8||o.value.type===9,u=i||c?"":'"';return`${o.key}=${u}\${__data.fields["`+o.key+`"]}${u}`});let r="";const s=t.indexOf("}");if(s!==-1){const o=t.substring(s+1);r=t.substring(0,s),a.length>0&&(r+=t.replace(/\s/g,"").includes("{}")?"":" && ",r+=`${a.join(" && ")} && kind=server`,r+="}"),r+=`${o}`}else r=`{${a.join(" && ")} && kind=server} | ${t}`;return r},Aa=(e,t,a)=>{const r={displayNameFromDS:e.key,noValue:"<no value>",links:[{title:"Query in explore",url:"",internal:{datasourceUid:a.uid,datasourceName:a.name,query:{query:t,queryType:"traceql"}}}]};return e.value.type===7?{...r,unit:"ns"}:{...r}},je="",Ua=e=>{if(!e.value.type)return je;switch(e.value.type){case 3:return e.value.n;case 4:return e.value.f;case 5:return e.value.s;case 6:return e.value.b;case 7:return e.value.d;case 8:return wa(e.value.status);case 9:return Va(e.value.kind);default:return je}},wa=e=>{if(!e)return je;switch(e){case 0:return"error";case 1:return"ok";default:return"unset"}},Va=e=>{if(!e)return je;switch(e){case 1:return"internal";case 2:return"client";case 3:return"server";case 4:return"producer";case 5:return"consumer";default:return"unspecified"}},Ye=e=>({name:e,type:ee.fS.number,config:{displayNameFromDS:e,unit:"ns",custom:{width:150}}}),Oe=e=>{const t=parseInt(e,10);return isNaN(t)?0:t},Ce=new Na.v({name:"Metrics Summary",refId:"metrics-summary",fields:[],meta:{preferredVisualisationType:"table"}});var Se=l(29262),_a=l(72336),ot=l(90308),$a=l(68898),Fa=l(37634),ja=l(78942);function Ya(){return(0,ot.Z)()}function Ba(e,t,a,r){const s=a.range;let o,i=ie.Gu.NotStarted;const c=performance.now();return(0,ja.gj)().getStream({scope:$a.z.DataSource,namespace:t.uid,path:`search/${Ya()}`,data:{...e,SpansPerSpanSet:e.spss??Ie,timeRange:{from:s.from.toISOString(),to:s.to.toISOString()}}}).pipe((0,_a.o)(u=>{if("message"in u&&u?.message){const d=u.message.data.values[2][0];if(d===M.sY.Done||d===M.sY.Error)return!1}return!0},!0)).pipe((0,J.U)(u=>{if("message"in u&&u?.message){const p=performance.now()-c,m=u.message.data.values[0][0],h=u.message.data.values[1][0],g=u.message.data.values[2][0],b=u.message.data.values[3][0];switch(g){case M.sY.Done:i=ie.Gu.Done;break;case M.sY.Streaming:i=ie.Gu.Streaming;break;case M.sY.Error:throw new Error(b)}o=[ka(h,g,p),...(0,Se.KZ)(m,r,e.tableType)]}return{data:o||[],state:i}}))}function ka(e,t,a){const r={steps:[{color:"blue",value:-1/0},{color:"green",value:75}],mode:Fa.H.Absolute};return{refId:"streaming-progress",name:"Streaming Progress",length:1,fields:[{name:"state",type:ee.fS.string,values:[(0,H.capitalize)(t.toString())],config:{displayNameFromDS:"State"}},{name:"elapsedTime",type:ee.fS.number,values:[a],config:{unit:"ms",displayNameFromDS:"Elapsed Time"}},{name:"totalBlocks",type:ee.fS.number,values:[e.totalBlocks],config:{displayNameFromDS:"Total Blocks"}},{name:"completedJobs",type:ee.fS.number,values:[e.completedJobs],config:{displayNameFromDS:"Completed Jobs"}},{name:"totalJobs",type:ee.fS.number,values:[e.totalJobs],config:{displayNameFromDS:"Total Jobs"}},{name:"progress",type:ee.fS.number,values:[t===M.sY.Done?100:(e.completedJobs||0)/(e.totalJobs||1)*100],config:{displayNameFromDS:"Progress",unit:"percent",min:0,max:100,custom:{cellOptions:{type:"gauge",mode:"gradient"}},thresholds:r}}],meta:{preferredVisualisationType:"table"}}}var Xa=l(23361);class Ga extends Xa.Mg{constructor(t){super(),this.datasource=t,this.editor=Ia}query(t){if(!this.datasource)throw new Error("Datasource not initialized");const a=this.datasource.executeVariableQuery(t.targets[0]);return(0,He.D)(a).pipe((0,J.U)(r=>({data:r})))}}const Te=20,Ie=3;var za=(e=>(e.streaming="streaming",e))(za||{});const Ka={streaming:"2.2.0"},Za="2.1.0";class qa extends fa.CK{constructor(t,a=(0,he.J)()){super(t),this.instanceSettings=t,this.templateSrv=a,this.uploadedJson=null,this.init=async()=>{const r=await(0,qe.n)(this._request("/api/status/buildinfo").pipe((0,J.U)(s=>s),(0,Pe.K)(s=>(console.error("Failure in retrieving build information",s.data.message),(0,B.of)({error:s,data:{version:null}})))));this.tempoVersion=r.data.version},this.handleMetricsSummary=(r,s,o)=>{if((0,L.ff)("grafana_traces_metrics_summary_queried",{datasourceType:"tempo",app:o.app??"",grafana_version:y.config.buildInfo.version,filterCount:r.groupBy?.length??0}),s==="{}")return(0,B.of)({error:{message:"Please ensure you do not have an empty query. This is so filters are applied and the metrics summary is not generated from all spans."},data:Ce});const i=r.groupBy?this.formatGroupBy(r.groupBy):"";return this._request("/api/metrics/summary",{q:s,groupBy:i,start:o.range.from.unix(),end:o.range.to.unix()}).pipe((0,J.U)(c=>c.data.summaries?c.data.summaries.some(d=>d.series.length>0)?{data:xa(c.data.summaries,s,this.instanceSettings)}:{error:{message:x("No series data. Ensure you are using an up to date version of Tempo")},data:Ce}:{error:{message:x(`No summary data for '${i}'. Note: the metrics summary API only considers spans of kind = server. You can check if the attributes exist by running a TraceQL query like { attr_key = attr_value && kind = server }`)},data:Ce}),(0,Pe.K)(c=>(0,B.of)({error:{message:x(c.data.message)},data:Ce})))},this.formatGroupBy=r=>r?.filter(s=>s.tag).map(s=>s.scope===M.NM.Unscoped?`.${s.tag}`:s.scope!==M.NM.Intrinsic?`${s.scope}.${s.tag}`:s.tag).join(", "),this.hasGroupBy=r=>r.groupBy?.find(s=>s.tag),this.getLokiSearchDS=()=>{const r=this.tracesToLogs?.lokiSearch!==!1&&this.lokiSearch===void 0?this.tracesToLogs?.datasourceUid:void 0;return this.lokiSearch?.datasourceUid??r},this.tracesToLogs=t.jsonData.tracesToLogs,this.serviceMap=t.jsonData.serviceMap,this.search=t.jsonData.search,this.nodeGraph=t.jsonData.nodeGraph,this.lokiSearch=t.jsonData.lokiSearch,this.traceQuery=t.jsonData.traceQuery,this.languageProvider=new Lt(this),this.search?.filters||(this.search={...this.search,filters:[{id:"service-name",tag:"service.name",operator:"=",scope:M.NM.Resource},{id:"span-name",tag:"name",operator:"=",scope:M.NM.Span}]}),this.variables=new Ga(this)}async executeVariableQuery(t){if(t.type===void 0)return new Promise(()=>[]);switch(t.type){case st.LabelNames:return await this.labelNamesQuery();case st.LabelValues:return this.labelValuesQuery(t.label);default:throw Error("Invalid query type",t.type)}}async labelNamesQuery(){return await this.languageProvider.fetchTags(),this.languageProvider.getAutocompleteTags().filter(a=>a!==void 0).map(a=>({text:a}))}async labelValuesQuery(t){if(!t)return[];let a;try{const r=(this.languageProvider.tagsV2||[]).flatMap(o=>o.tags.map(i=>({scope:o.name,name:i}))).find(o=>o.name===t)?.scope;if(!r)throw Error(`Scope for tag ${t} not found`);const s=r==="intrinsic"?t:`${r}.${t}`;a=await this.languageProvider.getOptionsV2(s)}catch{a=await this.languageProvider.getOptionsV1(t)}return a.filter(r=>r.value!==void 0).map(r=>({text:r.value}))}isFeatureAvailable(t){const a=this.tempoVersion??Za;try{return Wa().gte(a,Ka[t])}catch{return!0}}query(t){const a=[],r=t.targets.filter(i=>!i.hide),s=(0,H.groupBy)(r,i=>i.queryType||"traceql");if(s.clear)return(0,B.of)({data:[],state:ie.Gu.Done});const o=this.getLokiSearchDS();if(o&&s.search?.length>0){(0,L.ff)("grafana_traces_loki_search_queried",{datasourceType:"tempo",app:t.app??"",grafana_version:y.config.buildInfo.version,hasLinkedQueryExpr:!!(s.search[0].linkedQuery?.expr&&s.search[0].linkedQuery?.expr!=="")});const i=(0,_e.ak)();a.push((0,He.D)(i.get(o)).pipe((0,Je.z)(c=>{const u={...t,targets:s.search.map(m=>m.linkedQuery)},p=c.instanceSettings.jsonData.derivedFields?.filter(m=>m.datasourceUid===this.uid&&m.matcherRegex).map(m=>m.matcherRegex)||[];return!p||p.length===0?(0,da._)(()=>new Error("No Loki datasource configured for search. Set up Derived Fields for traces in a Loki datasource settings and link it to this Tempo datasource.")):c.query(u).pipe((0,J.U)(m=>m.error?m:(0,Se.RY)(m,this.uid,this.name,p)))})))}if(s.nativeSearch?.length)try{(0,L.ff)("grafana_traces_search_queried",{datasourceType:"tempo",app:t.app??"",grafana_version:y.config.buildInfo.version,hasServiceName:!!s.nativeSearch[0].serviceName,hasSpanName:!!s.nativeSearch[0].spanName,resultLimit:s.nativeSearch[0].limit??"",hasSearch:!!s.nativeSearch[0].search,minDuration:s.nativeSearch[0].minDuration??"",maxDuration:s.nativeSearch[0].maxDuration??""});const i={startTime:t.range.from.unix(),endTime:t.range.to.unix()},c=this.applyVariables(s.nativeSearch[0],t.scopedVars),u=this.buildSearchQuery(c,i);a.push(this._request("/api/search",u).pipe((0,J.U)(d=>({data:[(0,Se.n4)(d.data.traces,this.instanceSettings)]})),(0,Pe.K)(d=>(0,B.of)({error:{message:x(d.data.message)},data:[]}))))}catch(i){return(0,B.of)({error:{message:i instanceof Error?i.message:"Unknown error occurred"},data:[]})}if(s.traceql?.length)try{const c=this.applyVariables(s.traceql[0],t.scopedVars)?.query||"",u=/^[0-9A-Fa-f]*$/;c.trim().match(u)?((0,L.ff)("grafana_traces_traceID_queried",{datasourceType:"tempo",app:t.app??"",grafana_version:y.config.buildInfo.version,hasQuery:c!==""}),a.push(this.handleTraceIdQuery(t,s.traceql))):((0,L.ff)("grafana_traces_traceql_queried",{datasourceType:"tempo",app:t.app??"",grafana_version:y.config.buildInfo.version,query:c??"",streaming:y.config.featureToggles.traceQLStreaming}),y.config.featureToggles.traceQLStreaming&&this.isFeatureAvailable("streaming")?a.push(this.handleStreamingSearch(t,s.traceql,c)):a.push(this._request("/api/search",{q:c,limit:t.targets[0].limit??Te,spss:t.targets[0].spss??Ie,start:t.range.from.unix(),end:t.range.to.unix()}).pipe((0,J.U)(d=>({data:(0,Se.KZ)(d.data.traces,this.instanceSettings,s.traceql[0].tableType)})),(0,Pe.K)(d=>(0,B.of)({error:{message:x(d.data.message)},data:[]})))))}catch(i){return(0,B.of)({error:{message:i instanceof Error?i.message:"Unknown error occurred"},data:[]})}if(s.traceqlSearch?.length)try{if(y.config.featureToggles.metricsSummary){const c=s.traceqlSearch.find(u=>this.hasGroupBy(u));c&&a.push(this.handleMetricsSummary(c,tt(c.filters),t))}const i=y.config.featureToggles.metricsSummary?s.traceqlSearch.filter(c=>!this.hasGroupBy(c)):s.traceqlSearch;if(i.length>0){const c=tt(i[0].filters),u=this.templateSrv.replace(c,t.scopedVars);(0,L.ff)("grafana_traces_traceql_search_queried",{datasourceType:"tempo",app:t.app??"",grafana_version:y.config.buildInfo.version,query:u??"",streaming:y.config.featureToggles.traceQLStreaming}),y.config.featureToggles.traceQLStreaming&&this.isFeatureAvailable("streaming")?a.push(this.handleStreamingSearch(t,i,u)):a.push(this._request("/api/search",{q:u,limit:t.targets[0].limit??Te,spss:t.targets[0].spss??Ie,start:t.range.from.unix(),end:t.range.to.unix()}).pipe((0,J.U)(d=>({data:(0,Se.KZ)(d.data.traces,this.instanceSettings,s.traceqlSearch[0].tableType)})),(0,Pe.K)(d=>(0,B.of)({error:{message:x(d.data.message)},data:[]}))))}}catch(i){return(0,B.of)({error:{message:i instanceof Error?i.message:"Unknown error occurred"},data:[]})}if(s.upload?.length)if(this.uploadedJson){(0,L.ff)("grafana_traces_json_file_uploaded",{datasourceType:"tempo",app:t.app??"",grafana_version:y.config.buildInfo.version});const i=JSON.parse(this.uploadedJson),c=i.batches,u=Array.isArray(i)&&i.some(d=>d?.meta?.preferredVisualisationType==="nodeGraph");c?a.push((0,B.of)((0,Se.IM)(i.batches,this.nodeGraph?.enabled))):u?a.push((0,B.of)({data:i,state:ie.Gu.Done})):a.push((0,B.of)({error:{message:"Unable to parse uploaded data."},data:[]}))}else a.push((0,B.of)({data:[],state:ie.Gu.Done}));if(this.serviceMap?.datasourceUid&&s.serviceMap?.length>0){(0,L.ff)("grafana_traces_service_graph_queried",{datasourceType:"tempo",app:t.app??"",grafana_version:y.config.buildInfo.version,hasServiceMapQuery:!!s.serviceMap[0].serviceMapQuery});const i=this.serviceMap.datasourceUid,c=this.uid;a.push(Ha(t,i,c).pipe((0,Rt.b)(u=>Ja(t,u,i).pipe((0,Rt.b)(d=>er(t,d,i,c))))))}return(0,Qt.T)(...a)}applyTemplateVariables(t,a){return this.applyVariables(t,a)}interpolateVariablesInQueries(t,a){return!t||t.length===0?[]:t.map(r=>({...r,datasource:this.getRef(),...this.applyVariables(r,a)}))}applyVariables(t,a){const r={...t};return t.linkedQuery&&(r.linkedQuery={...t.linkedQuery,expr:this.templateSrv.replace(t.linkedQuery?.expr??"",a)}),{...r,query:this.templateSrv.replace(t.query??"",a,De.b8.Pipe),serviceName:this.templateSrv.replace(t.serviceName??"",a),spanName:this.templateSrv.replace(t.spanName??"",a),search:this.templateSrv.replace(t.search??"",a),minDuration:this.templateSrv.replace(t.minDuration??"",a),maxDuration:this.templateSrv.replace(t.maxDuration??"",a)}}handleTraceIdQuery(t,a){const r=a.filter(o=>o.query).map(o=>({...o,query:o.query?.trim(),queryType:"traceId"}));if(!r.length)return bt.E;const s=this.traceIdQueryRequest(t,r);return super.query(s).pipe((0,J.U)(o=>o.error?o:(0,Se.Jk)(o,this.instanceSettings,this.nodeGraph?.enabled)))}traceIdQueryRequest(t,a){const r={...t,targets:a};return this.traceQuery?.timeShiftEnabled?r.range=t.range&&{...t.range,from:t.range.from.subtract(Dt.intervalToMs(this.traceQuery?.spanStartTimeShift||"30m"),"milliseconds"),to:t.range.to.add(Dt.intervalToMs(this.traceQuery?.spanEndTimeShift||"30m"),"milliseconds")}:r.range={from:(0,Ve.CQ)(0),to:(0,Ve.CQ)(0),raw:{from:(0,Ve.CQ)(0),to:(0,Ve.CQ)(0)}},r}handleStreamingSearch(t,a,r){return r===""?bt.E:(0,Qt.T)(...a.map(s=>Ba({...s,query:r},this,t,this.instanceSettings)))}async metadataRequest(t,a={}){return await(0,qe.n)(this._request(t,a,{method:"GET",hideFromInspector:!0}))}_request(t,a,r){const s=a?pa.Cj.serializeParams(a):"",o=`${this.instanceSettings.url}${t}${s.length?`?${s}`:""}`,i={...r,url:o};return(0,le.i)().fetch(i)}async testDatasource(){const t={headers:{},method:"GET",url:`${this.instanceSettings.url}/api/echo`};return await(0,qe.n)((0,le.i)().fetch(t).pipe((0,Je.z)(()=>(0,B.of)({status:"success",message:"Data source successfully connected."})),(0,Pe.K)(a=>(0,B.of)({status:"error",message:x(a.data.message,"Unable to connect with Tempo")}))))}getQueryDisplayText(t){if(t.queryType==="nativeSearch"){let a=[];for(const r of["serviceName","spanName","search","minDuration","maxDuration","limit"])t.hasOwnProperty(r)&&t[r]&&a.push(`${(0,H.startCase)(r)}: ${t[r]}`);return a.join(", ")}return t.query??""}buildSearchQuery(t,a){let r=t.search??"",s=(0,H.pick)(t,["minDuration","maxDuration","limit"]);if(s=(0,H.pickBy)(s,H.identity),t.serviceName&&(r+=` service.name="${t.serviceName}"`),t.spanName&&(r+=` name="${t.spanName}"`),s.limit||(s.limit=Te),s.minDuration){if(s.minDuration=this.templateSrv.replace(s.minDuration??""),!(0,fe.IA)(s.minDuration))throw new Error("Please enter a valid min duration.");s.minDuration=s.minDuration.replace(/\s/g,"")}if(s.maxDuration){if(s.maxDuration=this.templateSrv.replace(s.maxDuration??""),!(0,fe.IA)(s.maxDuration))throw new Error("Please enter a valid max duration.");s.maxDuration=s.maxDuration.replace(/\s/g,"")}if(!Number.isInteger(s.limit)||s.limit<=0)throw new Error("Please enter a valid limit.");let o={tags:r,...s};return a&&(o.start=a.startTime,o.end=a.endTime),o}}function lt(e,t){return(0,He.D)((0,_e.ak)().get(t)).pipe((0,Je.z)(a=>a.query(e)))}function Ha(e,t,a){const r=ct(e);return lt(r,t).pipe((0,et.q)(),(0,J.U)(s=>{const o=s.find(p=>!!p.error);if(o)throw new Error(x(o.error?.message));const{nodes:i,edges:c}=(0,z.BC)(s,e.range);if(i.fields.length>0&&c.fields.length>0){const p=i.fields[0].values.length,m=c.fields[0].values.length;(0,L.ff)("grafana_traces_service_graph_size",{datasourceType:"tempo",grafana_version:y.config.buildInfo.version,nodeLength:p,edgeLength:m})}const{serviceMapIncludeNamespace:u,refId:d}=e.targets[0];return i.refId=d,c.refId=d,u?(i.fields[0].config=Be(t,a,"__data.fields.title","__data.fields[0]",void 0,{targetNamespace:"__data.fields.subtitle"}),c.fields[0].config=Be(t,a,"__data.fields.targetName","__data.fields.target","__data.fields.sourceName",{targetNamespace:"__data.fields.targetNamespace",sourceNamespace:"__data.fields.sourceNamespace"})):(i.fields[0].config=Be(t,a,"__data.fields.id","__data.fields[0]"),c.fields[0].config=Be(t,a,"__data.fields.target","__data.fields.target","__data.fields.source")),{nodes:i,edges:c,state:ie.Gu.Done}}))}function Ja(e,t,a){const r=ct(e);return r.targets=Vt([ve(z.rB,z.T1,e)]),lt(r,a).pipe((0,et.q)(),(0,J.U)(s=>{const o=s.find(i=>!!i.error);if(o)throw new Error(x(o.error?.message));return{rates:s[0]?.data??[],nodes:t.nodes,edges:t.edges}}))}function er(e,t,a,r){let s=[],o="",i=[],c=[];if(t.rates[0]&&e.app===ga.zj.Explore){const p=t.rates[0].fields.find(m=>m.name==="span_name");p&&p.values&&(c=p.values)}else t.rates&&t.rates.map(p=>{const m=p.fields.find(h=>h.labels?.span_name);m&&c.push(m.labels?.span_name)});const u=tr(c);u.length>0&&(o=ve(z.$C,'span_name=~"'+u.join("|")+'"',e),s.push(o),u.map(p=>{const m=ve(z.vO,'span_name=~"'+p+'"',e);i.push(m),s.push(m)}));const d=ct(e);return d.targets=Vt(s),lt(d,a).pipe((0,et.q)(),(0,J.U)(p=>{const m=p.find(g=>!!g.error);if(m)throw new Error(x(m.error?.message));const h=ar(e,t,p[0],o,i,a,r);return h.fields.length===0?{data:[t.nodes,t.edges],state:ie.Gu.Done}:{data:[h,t.nodes,t.edges],state:ie.Gu.Done}}))}function Qe(e,t,a,r){return{url:"",title:e,internal:{query:{expr:t,range:!r,exemplar:!r,instant:r},datasourceUid:a,datasourceName:(0,_e.ak)().getDataSourceSettingsByUid(a)?.name??""}}}function tr(e){return e.map(t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\\\$&"))}function Be(e,t,a,r,s,o){let i=s?`client="\${${s}}",`:"",c=`server="\${${a}}"`,u="server";if(o!==void 0){const{targetNamespace:d}=o;if(c+=`,server_service_namespace="\${${d}}"`,u+=", server_service_namespace",i){const{sourceNamespace:p}=o;i+=`client_service_namespace="\${${p}}",`,u+=", client_service_namespace"}}return{links:[Qe("Request rate",`sum by (client, ${u})(rate(${z.Yt}{${i}${c}}[$__rate_interval]))`,e,!1),Qe("Request histogram",`histogram_quantile(0.9, sum(rate(${z.NZ}{${i}${c}}[$__rate_interval])) by (le, client, ${u}))`,e,!1),Qe("Failed request rate",`sum by (client, ${u})(rate(${z.yf}{${i}${c}}[$__rate_interval]))`,e,!1),Ut("View traces",`\${${r}}`,"",t)]}}function Ut(e,t,a,r){let s={refId:"A",queryType:"traceqlSearch",filters:[]};return t!==""&&s.filters.push({id:"service-name",scope:M.NM.Resource,tag:"service.name",value:t,operator:"=",valueType:"string"}),a!==""&&s.filters.push({id:"span-name",scope:M.NM.Span,tag:"name",value:a,operator:"=",valueType:"string"}),{url:"",title:e,internal:{query:s,datasourceUid:r,datasourceName:(0,_e.ak)().getDataSourceSettingsByUid(r)?.name??""}}}function ct(e){return{...e,targets:z.t3.map(t=>{const{serviceMapQuery:a,serviceMapIncludeNamespace:r}=e.targets[0];return{format:"table",refId:t,expr:`sum by (client, server${r?", client_service_namespace, server_service_namespace":""}) (rate(${t}${a||""}[$__range]))`,instant:!0}})}}function ar(e,t,a,r,s,o,i){let c={fields:[]};const u=t.rates.filter(m=>m.refId===ve(z.rB,z.T1,e)),d=a.data.filter(m=>m.refId===r),p=a.data.filter(m=>s.includes(m.refId??""));if(u.length>0&&u[0].fields?.length>2&&(c.fields.push({...u[0].fields[1],name:"Name",config:{filterable:!1}}),c.fields.push({...u[0].fields[2],name:"Rate",config:{links:[Qe("Rate",ut(ve(z.rB,'span_name="${__data.fields[0]}"',e)),o,!1)],decimals:2}}),c.fields.push({...u[0].fields[2],name:"  ",labels:null,config:{color:{mode:"continuous-BlPu"},custom:{cellOptions:{mode:De.QH.Lcd,type:De.h2.Gauge}},decimals:3}})),d.length>0&&d[0].fields?.length>2){const m=d[0].fields[1]?.values??[],h=d[0].fields[2]?.values??[];let g={};m.map((q,R)=>{g[q]={value:h[R]}});const b=wt({...u},g);c.fields.push({...d[0].fields[2],name:"Error Rate",values:b,config:{links:[Qe("Error Rate",ut(ve(z.$C,'span_name="${__data.fields[0]}"',e)),o,!1)],decimals:2}}),c.fields.push({...d[0].fields[2],name:"   ",values:b,labels:null,config:{color:{mode:"continuous-RdYlGr"},custom:{cellOptions:{mode:De.QH.Lcd,type:De.h2.Gauge}},decimals:3}})}if(p.length>0){let m={};p.forEach(h=>{if(h.fields.length>1){const g=h.refId?.includes('span_name=~"')?'span_name=~"':'span_name="',b=h.refId?.split(g)[1].split('"}')[0];m[b]={value:h.fields[1].values[0]}}}),Object.keys(m).length>0&&c.fields.push({...p[0].fields[1],name:"Duration (p90)",values:wt({...u},m),config:{links:[Qe("Duration",ut(ve(z.vO,'span_name="${__data.fields[0]}"',e)),o,!1)],unit:"s"}})}return c.fields.length>0&&c.fields[0].values&&c.fields.push({name:"Links",type:ee.fS.string,values:c.fields[0].values.map(()=>"Tempo"),config:{links:[Ut("Tempo","","${__data.fields[0]}",i)]}}),c}function ve(e,t,a){let r=a.targets[0]?.serviceMapQuery??"";const s=r.match(/^{(.*)}$/);s?.length&&(r=s[1]),r=r.replace("client","service").replace("server","service");const o=r.includes("span_name")?e.params.concat(r):e.params.concat(r).concat(t).filter(i=>i);return e.expr.replace("{}","{"+o.join(",")+"}")}function ut(e){return e=e.replace("topk(5, ","").replace(" by (span_name))",""),e.replace("__range","__rate_interval")}function wt(e,t){const a=e[0]?.fields[1]?.values??[];let r=[];for(let s=0;s<a.length;s++)Object.keys(t).includes(a[s])?r.push(t[a[s]].value):r.push("0");return r}function Vt(e){return e.map(t=>({refId:t,expr:t,instant:!0}))}var _t=l(62577),be=l(12263);class rr{constructor(t){this.triggerCharacters=["="," "],this.cachedValues={},this.languageProvider=t.languageProvider}provideCompletionItems(t,a){if(!(this.monaco&&this.editor))throw new Error("provideCompletionItems called before CompletionProvider was initialized");if(this.editor.getModel()?.id!==t.id)return{suggestions:[]};const{range:r,offset:s}=sr(this.monaco,t,a),o=this.getSituation(t.getValue(),s);return this.getCompletions(o).then(c=>{const u=c.length.toString().length;return{suggestions:c.map((p,m)=>({kind:nr(p.type,this.monaco),label:p.label,insertText:p.insertText,sortText:m.toString().padStart(u,"0"),range:r}))}})}async getTagValues(t){let a;return this.cachedValues.hasOwnProperty(t)?a=this.cachedValues[t]:(a=await this.languageProvider.getOptionsV1(t),this.cachedValues[t]=a),a}async getCompletions(t){switch(t.type){case"UNKNOWN":return[];case"EMPTY":return this.getTagsCompletions();case"IN_NAME":return this.getTagsCompletions();case"IN_VALUE":const a=await this.getTagValues(t.tagName),r=[],s=o=>`"${o.label}"`;return a.forEach(o=>{o?.label&&r.push({label:o.label,insertText:s(o),type:"TAG_VALUE"})}),r;default:throw new Error(`Unexpected situation ${t}`)}}getTagsCompletions(){return this.languageProvider.getAutocompleteTags().sort((a,r)=>a.localeCompare(r,void 0,{sensitivity:"accent"})).map(a=>({label:a,insertText:a,type:"TAG_NAME"}))}getSituation(t,a){if(t===""||a===0||t[t.length-1]===" ")return{type:"EMPTY"};const r=t.substring(0,a),s=/(?<key>[^= ]+)(?<equals>=)?(?<value>([^ "]+)|"([^"]*)")?/,o=r.match(new RegExp(s,"g"));if(o?.length){const c=o[o.length-1].match(s);if(c){const u=c.groups?.key,d=c.groups?.equals;return u?d?{type:"IN_VALUE",tagName:u}:{type:"IN_NAME"}:{type:"EMPTY"}}}return{type:"EMPTY"}}}function nr(e,t){switch(e){case"TAG_NAME":return t.languages.CompletionItemKind.Enum;case"KEYWORD":return t.languages.CompletionItemKind.Keyword;case"OPERATOR":return t.languages.CompletionItemKind.Operator;case"TAG_VALUE":return t.languages.CompletionItemKind.EnumMember;case"SCOPE":return t.languages.CompletionItemKind.Class;default:throw new Error(`Unexpected CompletionType: ${e}`)}}function sr(e,t,a){const r=t.getWordAtPosition(a),s=r!=null?e.Range.lift({startLineNumber:a.lineNumber,endLineNumber:a.lineNumber,startColumn:r.startColumn,endColumn:r.endColumn}):e.Range.fromPositions(a),o={column:a.column,lineNumber:a.lineNumber};return{offset:t.getOffsetAt(o),range:s}}const ir={id:"tagsfield",extensions:[".tagsfield"],aliases:["tagsfield"],mimetypes:[],def:{language:{ignoreCase:!1,defaultToken:"",tokenPostfix:".tagsfield",operators:["="],symbols:/[=><!~?:&|+\-*\/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,integersuffix:/(ll|LL|u|U|l|L)?(ll|LL|u|U|l|L)?/,floatsuffix:/[fFlL]?/,tokenizer:{root:[[/[a-z_.][\w./_-]*(?=\s*(=|!=|>|<|>=|<=|=~|!~))/,"tag"],[/[a-zA-Z_.]\w*/,{cases:{"@default":"identifier"}}],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],{include:"@whitespace"},[/[{}()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/@symbols/,{cases:{"@operators":"delimiter","@default":""}}],[/\d+/,"number"],[/\d*\d+[eE]([\-+]?\d+)?(@floatsuffix)/,"number.float"],[/\d*\.\d+([eE][\-+]?\d+)?(@floatsuffix)/,"number.float"],[/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/,"number.hex"],[/0[0-7']*[0-7](@integersuffix)/,"number.octal"],[/0[bB][0-1']*[0-1](@integersuffix)/,"number.binary"],[/\d[\d']*\d(@integersuffix)/,"number"],[/\d(@integersuffix)/,"number"]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],clauses:[[/[^(,)]/,"tag"],[/\)/,"identifier","@pop"]],whitespace:[[/[ \t\r\n]+/,"white"]]}},languageConfiguration:{wordPattern:/(-?\d*\.\d\w*)|([^`~!#%^&*()\-=+\[{\]}\\|;:'",.<>\/?\s]+)/g,brackets:[["{","}"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{}}}};function or(e){const{onChange:t,onBlur:a,placeholder:r}=e,s=ur(e.datasource),o=(0,C.l4)(),i=mr(o,r);return n.createElement(_t.p,{value:e.value,language:Ne,onBlur:a,onChange:t,containerStyles:i.queryField,monacoOptions:{folding:!1,fontSize:14,lineNumbers:"off",overviewRulerLanes:0,renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0},scrollBeyondLastLine:!1,wordWrap:"on"},onBeforeEditorMount:dr,onEditorDidMount:(c,u)=>{s(c,u),lr(c,u,i),cr(c)}})}function lr(e,t,a){const r=[{range:new t.Range(1,1,1,1),options:{className:a.placeholder,isWholeLine:!0}}];let s=[];const o=()=>{const i=e.getModel();if(!i)return;const c=i.getValueLength()===0?r:[];s=i.deltaDecorations(s,c)};o(),e.onDidChangeModelContent(o)}function cr(e){const t=e.getDomNode(),a=()=>{if(t){const r=Math.min(1e3,e.getContentHeight()),s=parseInt(t.style.width,10);t.style.width=`${s}px`,t.style.height=`${r}px`,e.layout({width:s,height:r})}};e.onDidContentSizeChange(a),a()}function ur(e){const t=(0,n.useRef)(new rr({languageProvider:e.languageProvider}));(0,n.useEffect)(()=>{(async()=>{try{await e.languageProvider.start()}catch(s){s instanceof Error&&(0,ue.WI)((0,be.$l)((0,ce.t_)("Error",s)))}})()},[e]);const a=(0,n.useRef)(null);return(0,n.useEffect)(()=>()=>{a.current?.()},[]),(r,s)=>{t.current.editor=r,t.current.monaco=s;const{dispose:o}=s.languages.registerCompletionItemProvider(Ne,t.current);a.current=o}}let $t=!1;const Ne="tagsfield";function dr(e){if(!$t){$t=!0;const{aliases:t,extensions:a,mimetypes:r,def:s}=ir;e.languages.register({id:Ne,aliases:t,extensions:a,mimetypes:r}),e.languages.setMonarchTokensProvider(Ne,s.language),e.languages.setLanguageConfiguration(Ne,s.languageConfiguration)}}const mr=(e,t)=>({queryField:(0,W.css)`
      border-radius: ${e.shape.radius.default};
      border: 1px solid ${e.components.input.borderColor};
      flex: 1;
    `,placeholder:(0,W.css)`
      ::after {
        content: '${t}';
        font-family: ${e.typography.fontFamilyMonospace};
        opacity: 0.3;
      }
    `}),Ft="e.g. 1.2s, 100ms",Wr=({datasource:e,query:t,onChange:a,onBlur:r,onRunQuery:s})=>{const o=(0,C.wW)(pr),i=(0,n.useMemo)(()=>new Lt(e),[e]),[c,u]=(0,n.useState)(),[d,p]=(0,n.useState)(),[m,h]=(0,n.useState)(null),[g,b]=(0,n.useState)({}),[q,R]=(0,n.useState)({serviceName:!1,spanName:!1}),V=(0,n.useCallback)(async(I,k="")=>{const pe=I==="serviceName"?"service.name":"name";R(X=>({...X,[I]:!0}));try{return(await i.getOptionsV1(pe)).filter(D=>D.value?(0,ua.C)(D.value,k).found:!1)}catch(X){return(0,le.kW)(X)&&X?.status===404?h(X):X instanceof Error&&(0,ue.WI)((0,Pt.$l)((0,ce.t_)("Error",X))),[]}finally{R(X=>({...X,[I]:!1}))}},[i]);(0,n.useEffect)(()=>{(async()=>{try{const[k,pe]=await Promise.all([V("serviceName"),V("spanName")]);t.serviceName&&(0,he.J)().containsTemplate(t.serviceName)&&k.push((0,ge.E)(t.serviceName)),u(k),t.spanName&&(0,he.J)().containsTemplate(t.spanName)&&pe.push((0,ge.E)(t.spanName)),p(pe)}catch(k){(0,le.kW)(k)&&k?.status===404?h(k):k instanceof Error&&(0,ue.WI)((0,Pt.$l)((0,ce.t_)("Error",k)))}})()},[i,V,t.serviceName,t.spanName]);const se=I=>{I.key==="Enter"&&(I.shiftKey||I.ctrlKey)&&s()},Ue=(0,n.useCallback)(I=>{a({...t,search:I})},[a,t]),re=(0,he.J)();return n.createElement(n.Fragment,null,n.createElement("div",{className:o.container},n.createElement(Ee.b,{title:"Deprecated query type",severity:"warning"},"This query type has been deprecated and will be removed in Grafana v10.3. Please migrate to another Tempo query type."),n.createElement(P.Z,null,n.createElement(E._,{label:"Service Name",labelWidth:14,grow:!0},n.createElement(ae.Ph,{inputId:"service",options:c,onOpenMenu:()=>{V("serviceName")},isLoading:q.serviceName,value:c?.find(I=>I?.value===t.serviceName)||t.serviceName,onChange:I=>{a({...t,serviceName:I?.value})},placeholder:"Select a service",isClearable:!0,onKeyDown:se,"aria-label":"select-service-name",allowCustomValue:!0}))),n.createElement(P.Z,null,n.createElement(E._,{label:"Span Name",labelWidth:14,grow:!0},n.createElement(ae.Ph,{inputId:"spanName",options:d,onOpenMenu:()=>{V("spanName")},isLoading:q.spanName,value:d?.find(I=>I?.value===t.spanName)||t.spanName,onChange:I=>{a({...t,spanName:I?.value})},placeholder:"Select a span",isClearable:!0,onKeyDown:se,"aria-label":"select-span-name",allowCustomValue:!0}))),n.createElement(P.Z,null,n.createElement(E._,{label:"Tags",labelWidth:14,grow:!0,tooltip:"Values should be in logfmt."},n.createElement(or,{placeholder:"http.status_code=200 error=true",value:t.search||"",onChange:Ue,onBlur:r,datasource:e}))),n.createElement(P.Z,null,n.createElement(E._,{label:"Min Duration",invalid:!!g.minDuration,labelWidth:14,grow:!0},n.createElement(Re.I,{id:"minDuration",value:t.minDuration||"",placeholder:Ft,onBlur:()=>{const I=re.replace(t.minDuration??"");t.minDuration&&!(0,fe.IA)(I)?b({...g,minDuration:!0}):b({...g,minDuration:!1})},onChange:I=>a({...t,minDuration:I.currentTarget.value}),onKeyDown:se}))),n.createElement(P.Z,null,n.createElement(E._,{label:"Max Duration",invalid:!!g.maxDuration,labelWidth:14,grow:!0},n.createElement(Re.I,{id:"maxDuration",value:t.maxDuration||"",placeholder:Ft,onBlur:()=>{const I=re.replace(t.maxDuration??"");t.maxDuration&&!(0,fe.IA)(I)?b({...g,maxDuration:!0}):b({...g,maxDuration:!1})},onChange:I=>a({...t,maxDuration:I.currentTarget.value}),onKeyDown:se}))),n.createElement(P.Z,null,n.createElement(E._,{label:"Limit",invalid:!!g.limit,labelWidth:14,grow:!0,tooltip:"Maximum number of returned results"},n.createElement(Re.I,{id:"limit",value:t.limit||"",placeholder:`Default: ${Te}`,type:"number",onChange:I=>{let k=I.currentTarget.value?parseInt(I.currentTarget.value,10):void 0;k&&(!Number.isInteger(k)||k<=0)?b({...g,limit:!0}):b({...g,limit:!1}),a({...t,limit:I.currentTarget.value?parseInt(I.currentTarget.value,10):void 0})},onKeyDown:se})))),m?n.createElement(Ee.b,{title:"Unable to connect to Tempo search",severity:"info",className:o.alert},"Please ensure that Tempo is configured with search enabled. If you would like to hide this tab, you can configure it in the ",n.createElement("a",{href:`/datasources/edit/${e.uid}`},"datasource settings"),"."):null)},pr=e=>({container:(0,W.css)`
    max-width: 500px;
  `,alert:(0,W.css)`
    max-width: 75ch;
    margin-top: ${e.spacing(2)};
  `});var jt=l(82564),gr=l(16972),dt=l(73688),Yt=l(15910),fr=l(15880);const mt=n.memo(({onChange:e,query:t})=>{t.hasOwnProperty("limit")||(t.limit=Te),t.hasOwnProperty("tableType")||(t.tableType=M.Mt.Traces);const a=i=>{e({...t,limit:parseInt(i.currentTarget.value,10)})},r=i=>{e({...t,spss:parseInt(i.currentTarget.value,10)})},s=i=>{e({...t,tableType:i})},o=[`Limit: ${t.limit||Te}`,`Spans Limit: ${t.spss||Ie}`,`Table Format: ${t.tableType===M.Mt.Traces?"Traces":"Spans"}`];return n.createElement(n.Fragment,null,n.createElement(jt.p,null,n.createElement(fr.d,{title:"Options",collapsedInfo:o},n.createElement(dt.S,{label:"Limit",tooltip:"Maximum number of traces to return."},n.createElement(Yt.H,{className:"width-4",placeholder:"auto",type:"number",min:1,defaultValue:t.limit||Te,onCommitChange:a,value:t.limit})),n.createElement(dt.S,{label:"Span Limit",tooltip:"Maximum number of spans to return for each span set."},n.createElement(Yt.H,{className:"width-4",placeholder:"auto",type:"number",min:1,defaultValue:t.spss||Ie,onCommitChange:r,value:t.spss})),n.createElement(dt.S,{label:"Table Format",tooltip:"How the query data should be displayed in the results table"},n.createElement(S.S,{options:[{label:"Traces",value:M.Mt.Traces},{label:"Spans",value:M.Mt.Spans}],value:t.tableType,onChange:s})))))});mt.displayName="TempoQueryBuilderOptions";const hr=/^(\$\w+)|(\d+(?:\.\d)?\d*(?:us|Âµs|ns|ms|s|m|h))$/,Or=()=>({noBoxShadow:(0,W.css)`
    box-shadow: none;
    *:focus {
      box-shadow: none;
    }
  `}),Bt=({filter:e,operators:t,updateFilter:a})=>{const r=(0,C.wW)(Or);let s=!1;return typeof e.value=="string"&&(s=e.value?!hr.test(e.value.concat("")):!1),n.createElement(N.Lh,{spacing:"none"},n.createElement(ae.Ph,{className:r.noBoxShadow,inputId:`${e.id}-operator`,options:t.map(Mt),value:e.operator,onChange:o=>{a({...e,operator:o?.value})},isClearable:!1,"aria-label":`select ${e.id} operator`,allowCustomValue:!0,width:8}),n.createElement(Re.I,{className:r.noBoxShadow,value:e.value,onChange:o=>{a({...e,value:o.currentTarget.value})},placeholder:"e.g. 100ms, 1.2s","aria-label":`select ${e.id} value`,invalid:s,width:18}))};var ke=l(37890);const xe=({label:e,tooltip:t,children:a})=>n.createElement(P.Z,null,n.createElement(E._,{label:e,labelWidth:28,grow:!0,tooltip:t},a)),Sr=e=>{const{datasource:t,onChange:a,query:r,isTagsLoading:s}=e,o=(0,C.wW)(Tr),i=()=>(0,ot.Z)().slice(0,8);(0,n.useEffect)(()=>{(!r.groupBy||r.groupBy.length===0)&&a({...r,groupBy:[{id:i(),scope:M.NM.Span}]})},[a,r]);const c=h=>t.languageProvider.getMetricsSummaryTags(h.scope),u=()=>{p({id:i(),scope:M.NM.Span})},d=h=>{a({...r,groupBy:r.groupBy?.filter(g=>g.id!==h.id)})},p=h=>{const g={...r};g.groupBy||=[];const b=g.groupBy.findIndex(q=>q.id===h.id);b>=0?g.groupBy=nt(g.groupBy,b,h):g.groupBy.push(h),a(g)},m=Object.values(M.NM).map(h=>({label:h,value:h}));return n.createElement(xe,{label:"Aggregate by",tooltip:"Select one or more tags to see the metrics summary. Note: the metrics summary API only considers spans of kind = server."},n.createElement(n.Fragment,null,r.groupBy?.map((h,g)=>n.createElement("div",{key:h.id},n.createElement(N.Lh,{spacing:"none",width:"auto"},n.createElement(ae.Ph,{"aria-label":`Select scope for filter ${g+1}`,onChange:b=>{p({...h,scope:b?.value,tag:""})},options:m,placeholder:"Select scope",value:h.scope}),n.createElement(ae.Ph,{"aria-label":`Select tag for filter ${g+1}`,isClearable:!0,isLoading:s,key:h.tag,onChange:b=>{p({...h,tag:b?.value})},options:c(h)?.map(b=>({label:b,value:b})),placeholder:"Select tag",value:h.tag||""}),n.createElement(ke._,{"aria-label":`Remove tag for filter ${g+1}`,icon:"times",onClick:()=>d(h),tooltip:"Remove tag",variant:"secondary"}),g===(r.groupBy?.length??0)-1&&n.createElement("span",{className:o.addFilter},n.createElement(ke._,{"aria-label":"Add tag",icon:"plus",onClick:()=>u(),tooltip:"Add tag",variant:"secondary"})))))))},Tr=e=>({addFilter:(0,W.css)`
    margin-left: ${e.spacing(2)};
  `}),vr=()=>({dropdown:(0,W.css)`
    box-shadow: none;
  `}),Wt=({filter:e,datasource:t,updateFilter:a,deleteFilter:r,isTagsLoading:s,tags:o,setError:i,hideScope:c,hideTag:u,hideValue:d,allowDelete:p,query:m})=>{const h=(0,C.wW)(vr),g=(0,n.useMemo)(()=>at(e),[e]),[b,q]=(0,n.useState)(e.operator),[R,V]=(0,n.useState)(e.value),se=async()=>{try{return e.tag?await t.languageProvider.getOptionsV2(g,m):[]}catch(D){(0,le.kW)(D)&&D?.status===404?i(D):D instanceof Error&&(0,ue.WI)((0,be.$l)((0,ce.t_)("Error",D)))}return[]},{loading:Ue,value:re}=(0,Q.Z)(se,[g,t.languageProvider,i,m]);e.value&&!Array.isArray(e.value)&&re&&!re.find(D=>D.value===e.value)&&re.push({label:e.value.toString(),value:e.value.toString(),type:e.valueType}),(0,n.useEffect)(()=>{Array.isArray(e.value)&&e.value.length>1&&e.operator!=="=~"&&e.operator!=="!~"&&(q(e.operator),a({...e,operator:"=~"})),Array.isArray(e.value)&&e.value.length<=1&&(R?.length||0)>1&&a({...e,operator:b,value:e.value[0]})},[R,b,a,e]),(0,n.useEffect)(()=>{V(e.value)},[e.value]);const I=Object.values(M.NM).filter(D=>D!==M.NM.Intrinsic).map(D=>({label:D,value:D})),k=re?.filter(D=>D.type===re[0]?.type),pe=re?.length===k?.length?re?.[0]?.type:void 0;let X=Ct;switch(pe){case"keyword":X=Oa;break;case"string":X=Sa;break;case"int":case"float":X=Ta}const we=D=>{const Et=(0,he.J)().getVariables();return[...D||[],...Et.map(ca=>({label:`$${ca.name}`,value:`$${ca.name}`}))]};return n.createElement(N.Lh,{spacing:"none",width:"auto"},!c&&n.createElement(ae.Ph,{className:h.dropdown,inputId:`${e.id}-scope`,options:we(I),value:e.scope,onChange:D=>{a({...e,scope:D?.value})},placeholder:"Select scope","aria-label":`select ${e.id} scope`}),!u&&n.createElement(ae.Ph,{className:h.dropdown,inputId:`${e.id}-tag`,isLoading:s,options:we((e.tag!==void 0?(0,H.uniq)([e.tag,...o]):o).map(D=>({label:D,value:D}))),value:e.tag,onChange:D=>{a({...e,tag:D?.value})},placeholder:"Select tag",isClearable:!0,"aria-label":`select ${e.id} tag`,allowCustomValue:!0}),n.createElement(ae.Ph,{className:h.dropdown,inputId:`${e.id}-operator`,options:we(X.map(Mt)),value:e.operator,onChange:D=>{a({...e,operator:D?.value})},isClearable:!1,"aria-label":`select ${e.id} operator`,allowCustomValue:!0,width:8}),!d&&n.createElement(ae.Ph,{className:h.dropdown,inputId:`${e.id}-value`,isLoading:Ue,options:we(re),value:e.value,onChange:D=>{Array.isArray(D)?a({...e,value:D.map(Et=>Et.value),valueType:D[0]?.type||pe}):a({...e,value:D?.value,valueType:D?.type||pe})},placeholder:"Select value",isClearable:!1,"aria-label":`select ${e.id} value`,allowCustomValue:!0,isMulti:!0,allowCreateWhileLoading:!0}),p&&n.createElement(ke._,{variant:"secondary",icon:"times",onClick:()=>r?.(e),tooltip:"Remove tag","aria-label":`remove tag with ID ${e.id}`}))},yr=()=>({vertical:(0,W.css)`
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  `,horizontal:(0,W.css)`
    display: flex;
    flex-direction: row;
    gap: 1rem;
  `}),kt=({updateFilter:e,deleteFilter:t,filters:a,datasource:r,setError:s,staticTags:o,isTagsLoading:i,hideValues:c,query:u})=>{const d=(0,C.wW)(yr),p=()=>(0,ot.Z)().slice(0,8),m=(0,n.useCallback)(()=>e({id:p(),operator:"=",scope:M.NM.Span}),[e]);(0,n.useEffect)(()=>{a?.length||m()},[a,m]);const h=g=>{const b=r.languageProvider.getTags(g.scope);return Ra(b,o)};return n.createElement("div",{className:d.vertical},a?.map((g,b)=>n.createElement("div",{className:d.horizontal,key:g.id},n.createElement(Wt,{filter:g,datasource:r,setError:s,updateFilter:e,tags:h(g),isTagsLoading:i,deleteFilter:t,allowDelete:!0,hideValue:c,query:u}),b===a.length-1&&n.createElement(ke._,{variant:"secondary",icon:"plus",onClick:m,title:"Add tag"}))))},Er=["min-duration","max-duration","status"],Pr=({datasource:e,query:t,onChange:a})=>{const r=(0,C.wW)(Qr),[s,o]=(0,n.useState)(null),[i,c]=(0,n.useState)(!0),[u,d]=(0,n.useState)(""),p=(0,he.J)(),m=(0,n.useCallback)(R=>{const V={...t};V.filters||=[];const se=V.filters.findIndex(Ue=>Ue.id===R.id);se>=0?V.filters=nt(V.filters,se,R):V.filters.push(R),a(V)},[a,t]),h=R=>{a({...t,filters:t.filters.filter(V=>V.id!==R.id)})};(0,n.useEffect)(()=>{d(tt(t.filters||[]))},[t]);const g=(0,n.useCallback)(R=>t.filters?.find(V=>V.id===R),[t.filters]);(0,n.useEffect)(()=>{(async()=>{try{await e.languageProvider.start(),c(!1)}catch(V){V instanceof Error&&(0,ue.WI)((0,be.$l)((0,ce.t_)("Error",V)))}})()},[e]),(0,n.useEffect)(()=>{e.search?.filters?.filter(R=>R.value).forEach(R=>{g(R.id)||m(R)})},[e.search?.filters,g,m]);const b=e.search?.filters?.map(R=>R.tag)||[];b.push("duration");const q=(t.filters||[]).filter(R=>!Er.includes(R.id)&&(e.search?.filters?.findIndex(V=>V.id===R.id)||0)===-1);return n.createElement(n.Fragment,null,n.createElement("div",{className:r.container},n.createElement("div",null,e.search?.filters?.map(R=>R.tag&&n.createElement(xe,{key:R.id,label:ba(R),tooltip:`Filter your search by ${at(R)}. To modify the default filters shown for search visit the Tempo datasource configuration page.`},n.createElement(Wt,{filter:g(R.id)||R,datasource:e,setError:o,updateFilter:m,tags:[],hideScope:!0,hideTag:!0,query:u}))),n.createElement(xe,{label:"Status"},n.createElement(Wt,{filter:g("status")||{id:"status",tag:"status",scope:M.NM.Intrinsic,operator:"="},datasource:e,setError:o,updateFilter:m,tags:[],hideScope:!0,hideTag:!0,query:u})),n.createElement(xe,{label:"Span Duration",tooltip:"The span duration, i.e.	end - start time of the span. Accepted units are ns, ms, s, m, h"},n.createElement(N.Lh,{spacing:"sm"},n.createElement(Bt,{filter:g("min-duration")||{id:"min-duration",tag:"duration",operator:">",valueType:"duration"},operators:[">",">="],updateFilter:m}),n.createElement(Bt,{filter:g("max-duration")||{id:"max-duration",tag:"duration",operator:"<",valueType:"duration"},operators:["<","<="],updateFilter:m}))),n.createElement(xe,{label:"Tags"},n.createElement(kt,{filters:q,datasource:e,setError:o,updateFilter:m,deleteFilter:h,staticTags:b,isTagsLoading:i,query:u})),y.config.featureToggles.metricsSummary&&n.createElement(Sr,{datasource:e,onChange:a,query:t,isTagsLoading:i})),n.createElement(jt.p,null,n.createElement(gr.U,{query:p.replace(u),lang:{grammar:Pa,name:"traceql"}})),n.createElement(mt,{onChange:a,query:t})),s?n.createElement(Ee.b,{title:"Unable to connect to Tempo search",severity:"info",className:r.alert},"Please ensure that Tempo is configured with search enabled. If you would like to hide this tab, you can configure it in the ",n.createElement("a",{href:`/datasources/edit/${e.uid}`},"datasource settings"),"."):null)},Qr=e=>({alert:(0,W.css)`
    max-width: 75ch;
    margin-top: ${e.spacing(2)};
  `,container:(0,W.css)`
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    flex-direction: column;
  `});var br=l(88819);function Rr({graphDatasourceUid:e,query:t,onChange:a}){const r=(0,C.wW)(Cr),s=(0,Q.Z)(()=>te(e),[e]),[o,i]=(0,n.useState)(void 0);if((0,n.useEffect)(()=>{async function d(p){const m=await p.getTagKeys({filters:[{key:"__name__",operator:"=~",value:"traces_service_graph_request_server_seconds_sum|traces_service_graph_request_total|traces_service_graph_request_failed_total",condition:""}]});i(!!m.length)}!s.loading&&s.value&&d(s.value)},[s]),s.loading)return null;const c=s.value;if(!e)return pt("No service graph datasource selected","Please set up a service graph datasource in the datasource settings",r);if(e&&!c)return pt("No service graph data found","Service graph datasource is configured but the data source no longer exists. Please configure existing data source to use the service graph functionality",r);const u=Dr(t.serviceMapQuery||"");return n.createElement("div",null,n.createElement(P.Z,null,n.createElement(E._,{label:"Filter",labelWidth:14,grow:!0},n.createElement(br.F,{datasource:{uid:e},filters:u,baseFilters:[{key:"__name__",operator:"=~",value:"traces_service_graph_request_total|traces_spanmetrics_calls_total",condition:""}],addFilter:d=>{a({...t,serviceMapQuery:gt([...u,d])})},removeFilter:d=>{const p=[...u];p.splice(d,1),a({...t,serviceMapQuery:gt(p)})},changeFilter:(d,p)=>{const m=[...u];m.splice(d,1,p),a({...t,serviceMapQuery:gt(m)})}}))),o===!1?pt("No service graph data found","Please ensure that service graph metrics are set up correctly",r):null)}function pt(e,t,a){return n.createElement(Ee.b,{title:e,severity:"info",className:a.alert},t," according to the"," ",n.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://grafana.com/docs/grafana/latest/datasources/tempo/service-graph/",className:a.link},"Tempo documentation"),".")}function Dr(e){let t,a=[];const r=/([\w_]+)(=|!=|<|>|=~|!~)"(.*?)"/g;for(;(t=r.exec(e))!==null;)a.push({key:t[1],operator:t[2],value:t[3],condition:""});return a}function gt(e){return`{${e.map(t=>`${t.key}${t.operator}"${t.value}"`).join(",")}}`}const Cr=e=>({alert:(0,W.css)`
    max-width: 75ch;
    margin-top: ${e.spacing(2)};
  `,link:(0,W.css)`
    color: ${e.colors.text.link};
    text-decoration: underline;
  `}),Ir={};var Nr=(e=>(e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.INTERNAL=1]="INTERNAL",e[e.SERVER=2]="SERVER",e[e.CLIENT=3]="CLIENT",e[e.PRODUCER=4]="PRODUCER",e[e.CONSUMER=5]="CONSUMER",e))(Nr||{}),Xt=l(45098);const Gt=Xt.WQ.deserialize({version:14,states:"/YO]QPOOP!^OPOOO]QPO'#CkO#QQPO'#CjO%eQQO'#ClOOQO'#DP'#DPOOQO'#DO'#DOO%lQPO'#DOO%qQSO'#C{OOQO'#C|'#C|O%yQPO'#C|O&UQPO'#DRO&ZQPO'#DSO&`QSO'#DUOOQO'#Cj'#CjQ&eQPOOOOQO'#C`'#C`P'SOpO'#C^POOO)C>})C>}O'_QPO,59VO'fQSO,59hO'qQPO,59TO(cQPO,58zO(jQPO,59VO(jQPO,59VO(jQPO,59VO(jQPO,59VO(jQPO,59VO(jQPO,59VO(jQPO,59VOOQO'#Co'#CoOOQO'#Cu'#CuO(oQWO'#CuO)WQSO'#CwO)]QPO'#CwO#[QQO'#CmO)bQWO,59WO#[QQO'#CmOOQO'#Cm'#CmOOQO,59W,59WO#[QQO,59jO)pQPO,59hO)pQPO,59gOOQO,59h,59hO#[QQO,59mO#[QQO,59nOOQO,59p,59pO]QPO,58zO]QPO,58zO]QPO,58zO]QPO,58zO]QPO,58zO]QPO,58zO]QPO,58zO]QPO,58zO]QPO,58zPOOO'#DV'#DVP*eOpO,58xPOOO,58x,58xOOQO1G.q1G.qOOQO1G/S1G/SOOQO1G.o1G.oOOQO1G.f1G.fO(jQPO'#CkO+bQPO1G.qO,ZQPO1G.qO,bQPO1G.qO-ZQPO1G.qO-bQPO1G.qO-iQPO1G.qO-pQSO,59cOOQO,59c,59cO-{QSO,59cO.QQWO,59XO#[QQO,59XO#[QQO,59XO#[QQO,59XOOQO1G.r1G.rO.`QWO,59XO.tQWO1G/UO)pQPO'#C|O/SQ`O1G/RO/zQWO1G/XO0YQWO'#DTO0kQPO1G/YO1eQPO1G.fO2^QPO1G.fO2eQPO1G.fO3^QPO1G.fO3eQPO1G.fO3lQPO1G.fO4eQPO1G.fO4lQPO1G.fPOOO-E7T-E7TPOOO1G.d1G.dO4sQPO,59VOOQO1G.}1G.}O5_QPO1G.}OOQO1G.s1G.sO5uQWO1G.sO5|QWO1G.sOOQO7+$p7+$pO6TQSO,59hOOQO7+$s7+$sO#[QQO,59oOOQO7+$t7+$tO6]QSO7+$iO6bQWO1G/ZOOQO<<HT<<HT",stateData:"7Q~O|OSPOS}PQ~OeXOfXOgXOhXO!RQO!USO!WYO!pUO!qTO!rTO!sTO!tTO!uZO!v[O!x]O~O}aO~OTgOUhOVjOWiOXkOYlO!TmOZ^X[^X~Oz^X!S^X~P!cOdnOenOfnOgnOhnOjpOmrOnrO!RsO!WuO!XuO!YnO!ZnO![nO!]nO!^nO!_nO!`nO!anO!bnO!cnO!dnO!enO!foO!goO!hoO!ioO!joO!koO!loO!moO!noO!oqO~O!VwO~P#[O!RxO~OqyOtzO~Oe{Of{Og{O~O!R|O~O!R}O~O!y!OO~OT!POU!QOV!ROW!SOX!TOY!UOZ!WO[!XO!T!VO~O!O!YO!P!YO!Q![O~O!S!]O~P!cOqyOtzO!S!^O~O!S!_OTSXUSXVSXWSXXSXYSXZSX[SX!TSX~O!S!`O~P&eO!R!aO~O!o!hOTiXYiXbiX!ViX!SiX!wiX~Ol!iO~O!o!jO~OT!mOY!nOb!lO!V!oO~OeXOfXOgXOhXO!R!rO!WYO!pUO!qTO!rTO!sTO!tTO~O!O!YO!P!YO!Q#QO~OUhOVjOWiOXkO!TmOY_iZ_i[_iz_i!S_i~OT_i~P*pOUhOT_iV_iX_iY_iZ_i[_iz_i!T_i!S_i~OW_i~P+iOWiO~P+iOUhOVjOWiOT_iY_iZ_i[_iz_i!T_i!S_i~OX_i~P,iOTgO~P*pOXkO~P,iOl#SOm#TOn#TO~Ol#SO~OT!mOY!nOb!lO!S#UO~OT!mOY!nOb!lO!Vaa!Saa!waa~OT!mOY!nOb!lO!S#XO~OqyOToiUoiVoiWoiXoiYoiZoi[oizoi!Toi!Soi~OT!mOY!nOb!lO!S#ZO~OT!mOY!nOb!lO!SwX!wwX~O!S#]O!w#[O~OU!QOV!ROW!SOX!TO!T!VOYSiZSi[SizSi!SSi~OTSi~P0sOU!QOTSiVSiXSiYSiZSi[SizSi!TSi!SSi~OW!SO~P1lOWSi~P1lOU!QOV!ROW!SOTSiYSiZSi[SizSi!TSi!SSi~OXSi~P2lOT!PO~P0sOX!TO~P2lOT!POU!QOV!ROW!SOX!TOY!UO!T!VO[SizSi!SSi~OZSi~P3sOZ!WO~P3sOTgOUhOVjOWiOXkOYlO!S!]O!TmO~O!o#^O~Ob!lOYai!Vai!Sai!wai~OTai~P5dOT!mO~P5dOqyO!S!^O~Ol#`O~OT!mOY!nOb!lO!Swi!wwi~OfgePqbjmjnln~",goto:"&tzPP{P!OPPPPPPPP!q#O#_$W$eP%TPPPPP%TP%TPPP$W%aP%y&ZP$W$W&k$W&nRbPQ_OQfQQ!`!QQ!w!PQ!x!RQ!y!SQ!z!TQ!{!UQ!|!VQ!}!WR#O!Xg`OQ!P!Q!R!S!T!U!V!W!Xd`O!P!Q!R!S!T!U!V!W!XReQdRO!P!Q!R!S!T!U!V!W!XQcQQ!]hQ!bgQ!ciQ!djQ!ekQ!flQ!gmR#R!ag^OQ!P!Q!R!S!T!U!V!W!XQtSQ!ksQ!puQ!qxQ!t|Q!u}Q#U!lQ#V!mQ#W!nR#_#[evSsux|}!l!m!n#[dWO!P!Q!R!S!T!U!V!W!XQdQQ!^yQ!szR#Y!rmXOQyz!P!Q!R!S!T!U!V!W!X!rmVOQyz!P!Q!R!S!T!U!V!W!X!rR!v}Q!ZaR#P!Z",nodeNames:"\u26A0 LineComment BlockComment TraceQL SpansetPipelineExpression And Gt Desc Lt Anc Or Pipe ExperimentalOp WrappedSpansetPipeline SpansetPipeline SpansetExpression SpansetFilter FieldExpression FieldOp Static String Integer Float Duration TemplateVariable IntrinsicField Parent AttributeField Identifier Resource Span ScalarFilter ScalarExpression ScalarOp Aggregate AggregateExpression ComparisonOp GroupOperation SelectOperation SelectArgs CoalesceOperation",maxTerm:87,skippedNodes:[0,1,2,41],repeatNodeCount:1,tokenData:"#EX~R!XX^$npq$nqr%crs&ktu)_uv.Svw.Zxy.fyz.sz{.S{|.S|}.x}!O.}!O!P/W!P!Q/q!Q![0l!^!_3u!_!`4Z!`!a4e!c!}(W#Q#R.S#R#S(W#T#U4y#U#V6p#V#W7x#W#XKp#X#Y!!k#Y#Z!%n#Z#](W#]#^!(n#^#_(W#_#`!-i#`#a(W#a#b!/}#b#c!3P#c#d!6p#d#e!7x#e#f(W#f#g!?|#g#h#!Y#h#i#3T#i#j#<b#j#o(W#o#p#Di#p#q#Dn#q#r#D{#r#s#EQ#y#z$n$f$g$n#BY#BZ$n$IS$I_$n$I|$JO$n$JT$JU$n$KV$KW$n&FU&FV$n~$sY|~X^$npq$n#y#z$n$f$g$n#BY#BZ$n$IS$I_$n$I|$JO$n$JT$JU$n$KV$KW$n&FU&FV$n!`%hS!XS!^!_%t!_!`&R!`!a&Y#r#s&br%yP[r!^!_%|r&RO[rh&YOtWb`r&_P[r!`!a%|![&kOtW[rb`[&nVOr&krs'Ts#O&k#O#P)O#P;'S&k;'S;=`)X<%lO&k['[UdSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(WW'qVOr'nrs(Ws#O'n#O#P(o#P;'S'n;'S;=`(x<%lO'nW(]UlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(WW(rQrs'n#O#P'nW({P;=`<%l'n[)RQrs&k#O#P&k[)[P;=`<%l&k^)bVrs)w!O!P*a!Q![*a!c!}*a#R#S*a#T#o*a#o#p+XU)zVOr)wrs*as#O)w#O#P*x#P;'S)w;'S;=`+R<%lO)wU*fUhUrs)w!O!P*a!Q![*a!c!}*a#R#S*a#T#o*aU*{Qrs)w#O#P)wU+UP;=`<%l)w^+[Urs+n!O!P,W!Q![,W!c!},W#R#S,W#T#o,W^+qVOr+nrs,Ws#O+n#O#P-s#P;'S+n;'S;=`-|<%lO+n^,ZWrs+n!O!P,W!Q![,W![!],s!c!},W#R#S,W#T#o,W#q#r-l^,vT!O!P-V!Q![-V!c!}-V#R#S-V#T#o-V^-YU!O!P-V!Q![-V!c!}-V#R#S-V#T#o-V#q#r-l^-sOhUlW^-vQrs+n#O#P+n^.PP;=`<%l+n!Y.ZOqxb`~.^Pvw.a~.fOT~^.kP!RUyz.nW.sO!yW~.xO!S~~.}O!w~!`/WO!WUqxb`n/_U!oflWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W~/xQqxb`z{0O!P!Q0T~0TO}~~0YSP~OY0TZ;'S0T;'S;=`0f<%lO0T~0iP;=`<%l0T^0s[eUlWrs'n!O!P1i!Q![0l!c!}(W#R#S(W#T#[(W#[#]2k#]#a(W#a#b3U#b#g(W#g#h2k#h#o(W^1nUlWrs'n!O!P(W!Q![2Q!c!}(W#R#S(W#T#o(W^2XUfUlWrs'n!O!P(W!Q![2Q!c!}(W#R#S(W#T#o(W^2rUgUlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W^3]WgUlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#g(W#g#h2k#h#o(W![4OQtWWrb`!^!_4U!_!`&Rr4ZOXrh4bPtWb`#r#s&R![4nQtWUrb`!_!`&R!`!a4tr4yOVrY5OWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#j(W#j#k5h#k#o(WY5mWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#Z(W#Z#[6V#[#o(WY6^U!sQlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(WY6uWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#m(W#m#n7_#n#o(WY7fU!uQlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W^7}[lWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#[(W#[#]8s#]#`(W#`#a>`#a#c(W#c#dAc#d#o(W[8xWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#](W#]#^9b#^#o(W[9gWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#`(W#`#a:P#a#o(W[:UWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#W(W#W#X:n#X#o(W[:sWlWrs'n!O!P(W!Q![(W!c!e(W!e!f;]!f!}(W#R#S(W#T#o(W[;bWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#c(W#c#d;z#d#o(W[<PWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#i(W#i#j<i#j#o(W[<nWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#c=W#c#o(W[=]WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#h(W#h#i=u#i#o(W[=|U!fSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[>eWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#](W#]#^>}#^#o(W[?SWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y?l#Y#o(W[?qWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#c@Z#c#o(W[@`WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#h(W#h#i@x#i#o(W[APU!cSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W^AhZlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#UBZ#U#b(W#b#cE{#c#i(W#i#jIm#j#o(WYB`WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#`(W#`#aBx#a#o(WYB}WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#YCg#Y#o(WYClWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#g(W#g#hDU#h#o(WYDZWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#V(W#V#WDs#W#o(WYDxWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#YEb#Y#o(WYEiU!xQlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[FQWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#g(W#g#hFj#h#o(W[FoWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#i(W#i#jGX#j#o(W[G^WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#a(W#a#bGv#b#o(W[G{WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#YHe#Y#o(W[HjWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#gIS#g#o(W[IZU!eSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(WYIrWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#cJ[#c#o(WYJaWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#h(W#h#iJy#i#o(WYKOVlWrs'nxyKe!O!P(W!Q![(W!c!}(W#R#S(W#T#o(WQKhPyzKkQKpO!pQ[KuWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#i(W#i#jL_#j#o(W[LdWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#gL|#g#o(W[MRVlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#UMh#U#o(W[MmWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#h(W#h#iNV#i#o(W[N[WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#](W#]#^Nt#^#o(W[NyWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#c(W#c#d! c#d#o(W[! hWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#c!!Q#c#o(W[!!XU!gSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[!!pWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#g!#Y#g#o(W[!#_WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#g!#w#g#o(W[!#|WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#c(W#c#d!$f#d#o(W[!$kWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#g!%T#g#o(W[!%[U!^SlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[!%sVlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U!&Y#U#o(W[!&_WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#`(W#`#a!&w#a#o(W[!&|WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#g(W#g#h!'f#h#o(W[!'kWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y!(T#Y#o(W[!([U!ZSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[!(sWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#c!)]#c#o(W[!)bWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#h(W#h#i!)z#i#o(W[!*PWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y!*i#Y#o(W[!*nWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#g!+W#g#o(W[!+]WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#c!+u#c#o(W[!+zVlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U!,a#U#o(W[!,fWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#`(W#`#a!-O#a#o(W[!-VU!aSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[!-nWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#](W#]#^!.W#^#o(W[!.]WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#c!.u#c#o(W[!.zWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#W(W#W#X!/d#X#o(W[!/kU!hSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(WY!0SXlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U!0o#U#](W#]#^!1w#^#o(WY!0tWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#l(W#l#m!1^#m#o(WY!1eU!qQlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(WY!1|WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#c!2f#c#o(WY!2mU!rQlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[!3UXlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U!3q#U#](W#]#^!5h#^#o(W[!3vWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#a(W#a#b!4`#b#o(W[!4eWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y!4}#Y#o(W[!5UU!iSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[!5mWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#`(W#`#a!6V#a#o(W[!6^U![SlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[!6uWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#_(W#_#`!7_#`#o(W[!7fU!]SlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W~!7}XlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U!8j#U#f(W#f#g!;m#g#o(W~!8oWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#g!9X#g#o(W~!9^WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y!9v#Y#o(W~!9{WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#c!:e#c#o(W~!:jWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#h(W#h#i!;S#i#o(W~!;ZUj~lWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[!;rWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#c(W#c#d!<[#d#o(W[!<aWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#W(W#W#X!<y#X#o(W[!=OWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#i(W#i#j!=h#j#o(W[!=mWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#V(W#V#W!>V#W#o(W[!>[WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y!>t#Y#o(W[!>yWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#g!?c#g#o(W[!?jU!dSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W~!@RYlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y!@q#Y#c(W#c#d!EQ#d#o(W~!@vWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#g(W#g#h!A`#h#o(W~!AeWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#c(W#c#d!A}#d#o(W~!BSWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#i(W#i#j!Bl#j#o(W~!BqWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#g!CZ#g#o(W~!C`WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#V(W#V#W!Cx#W#o(W~!C}WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y!Dg#Y#o(W~!DnUm~lWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[!EVWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#c(W#c#d!Eo#d#o(W[!EtWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#h(W#h#i!F^#i#o(W[!FcYlWrs'n!O!P(W!Q![(W!c!p(W!p!q!GR!q!u(W!u!v!Id!v!}(W#R#S(W#T#o(W[!GWVlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U!Gm#U#o(W[!GrWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#a(W#a#b!H[#b#o(W[!HaWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y!Hy#Y#o(W[!IQU!jSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[!IiWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y!JR#Y#o(W[!JWWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#g!Jp#g#o(W[!JuWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#j(W#j#k!K_#k#o(W[!KdWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#](W#]#^!K|#^#o(W[!LRWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#V(W#V#W!Lk#W#o(W[!LpWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y!MY#Y#o(W[!M_WlWrs'n!O!P(W!Q![(W!c!p(W!p!q!Mw!q!}(W#R#S(W#T#o(W[!M|VlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U!Nc#U#o(W[!NhWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#a(W#a#b# Q#b#o(W[# VWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y# o#Y#o(W[# vU!kSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W~#!_]lWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y##W#Y#d(W#d#e#(u#e#h(W#h#i#*i#i#j#1{#j#o(W^##]YlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#`(W#`#a##{#a#f(W#f#g#&a#g#o(WY#$QWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y#$j#Y#o(WY#$oWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#V(W#V#W#%X#W#o(WY#%^WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#h(W#h#i#%v#i#o(WY#%}U!vQlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[#&fWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#j(W#j#k#'O#k#o(W[#'TWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y#'m#Y#o(W[#'rWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#g#([#g#o(W[#(cU!bSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W~#(zVlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U#)a#U#o(W~#)fWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#c#*O#c#o(W~#*VUn~lWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[#*nVlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U#+T#U#o(W[#+YWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#h(W#h#i#+r#i#o(W[#+wWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#i(W#i#j#,a#j#o(W[#,fWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#g(W#g#h#-O#h#o(W[#-VW!lSlWrs'n!O!P(W!Q![(W!c!o(W!o!p#-o!p!}(W#R#S(W#T#o(W[#-tWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y#.^#Y#o(W[#.cWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#g(W#g#h#.{#h#o(W[#/QWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#g(W#g#h#/j#h#o(W[#/oVlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U#0U#U#o(W[#0ZWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#Z(W#Z#[#0s#[#o(W[#0xWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y#1b#Y#o(W[#1iU!mSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(WY#2QWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#a(W#a#b#2j#b#o(WY#2qU!tQlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[#3YWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#g#3r#g#o(W[#3wXlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U#4d#U#i(W#i#j#;Y#j#o(W[#4iWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#V(W#V#W#5R#W#o(W[#5WWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y#5p#Y#o(W[#5uWlWrs'n!O!P(W!Q![(W!c!f(W!f!g#6_!g!}(W#R#S(W#T#o(W[#6dWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#i(W#i#j#6|#j#o(W[#7RWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#f(W#f#g#7k#g#o(W[#7pVlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#U#8V#U#o(W[#8[WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#h(W#h#i#8t#i#o(W[#8yWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#](W#]#^#9c#^#o(W[#9hWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#c(W#c#d#:Q#d#o(W[#:VWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#c#:o#c#o(W[#:vU!nSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[#;_WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y#;w#Y#o(W[#<OU!YSlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[#<gWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#b(W#b#c#=P#c#o(W[#=UWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#g(W#g#h#=n#h#o(W[#=sYlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y#>c#Y#d(W#d#e#?k#e#o(W[#>hWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#h(W#h#i#?Q#i#o(W[#?XU!_SlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W[#?pWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y#@Y#Y#o(W[#@_WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#V(W#V#W#@w#W#o(W[#@|WlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#](W#]#^#Af#^#o(W[#AkWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#Y(W#Y#Z#BT#Z#o(W[#BYWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#](W#]#^#Br#^#o(W[#BwWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#X(W#X#Y#Ca#Y#o(W[#CfWlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#W(W#W#X#DO#X#o(W[#DVU!`SlWrs'n!O!P(W!Q![(W!c!}(W#R#S(W#T#o(W~#DnO!U~~#DsPZ~#p#q#Dv~#D{OY~~#EQO!V~!S#EXO!Trb`",tokenizers:[1,2,3,4,5,new Xt.RA("j~RQYZXz{^~^O!P~~aP!P!Qd~iO!Q~~",25,46)],topRules:{TraceQL:[0,3]},tokenPrec:1001}),kn=1,Xn=2,zt=3,Xe=4,Kt=5,Gn=6,zn=7,Kn=8,Zn=9,Zt=10,qt=11,qn=12,Hn=13,xr=14,Jn=15,Ge=16,ne=17,Ht=18,Mr=19,es=20,ts=21,as=22,rs=23,ns=24,ft=25,ss=26,Me=27,is=28,os=29,ls=30,Jt=31,Lr=32,cs=33,ze=34,us=35,ea=36,Ar=37,ds=38,Ur=39,ms=40;function ta(e,t){const a=e.cursorAt(t);do if(a.from===t||a.to===t){const{node:r}=a;if(r.type.isError)return r}while(a.next());return null}function wr(e,t){return e[t]}function ye(e,t){let a=e;for(const[r,s]of t)if(a=wr(a,r),a===null||s.find(o=>o===a?.type.id)===void 0)return null;return a}function ht(e,t){return t.slice(e.from===e.to?e.from-1:e.from,e.to)}function Vr(e,t){return e.every((a,r)=>a===t[r])}function _r(e,t){if(e==="")return{query:e,type:"EMPTY"};const a=Gt.parse(e);let r=t;for(;r-1>=0&&e[r-1]===" ";)r-=1;let s=ta(a,r);s||(s=ta(a,r-1));const o=s!=null?s.cursor():a.cursorAt(r),i=o.node,c=[o.type.id];for(;o.parent();)c.push(o.type.id);let u=null;for(let d of $r)Vr(d.path,c)&&(u=d.fun(i,e,r,t));return{query:e,...u??{type:"UNKNOWN"}}}const de=0,$r=[{path:[de,Me],fun:Fr},{path:[de,ne],fun:jr},{path:[de,Ge],fun:kr},{path:[de,ze],fun:na},{path:[de,ft],fun:na},{path:[de,Xe],fun:Br},{path:[de,Jt,xr],fun:Yr},{path:[de,zt],fun:()=>({type:"UNKNOWN"})},{path:[ne],fun:aa},{path:[Ge],fun:aa},{path:[Xe],fun:ra},{path:[zt],fun:ra}],Ot=(e,t,a)=>{const r=i=>{const c=ye(i,[["firstChild",[Me]]]),u=c?ht(c,t):"",d=u.indexOf(".");return u.slice(0,d)};if(t[a-1]===" ")return;const s=ye(e,[["firstChild",[ne]]]);if(s)return{type:"SPANSET_IN_NAME_SCOPE",scope:r(s)};const o=ye(e,[["parent",[Ge]],["firstChild",[ne]]]);if(o&&t[a]!==" ")return{type:"SPANSET_IN_NAME_SCOPE",scope:r(o)}};function aa(e,t,a,r){const s=Ot(e,t,r);if(s)return s;let o=ye(e,[["firstChild",[ne]],["firstChild",[Me]]]);return o?{type:"SPANSET_EXPRESSION_OPERATORS"}:(o=ye(e,[["lastChild",[ne]],["lastChild",[ne]],["lastChild",[Mr]]]),o?{type:"SPANFIELD_COMBINING_OPERATORS"}:(o=ye(e,[["lastChild",[ne]]]),o?{type:"SPANSET_EXPRESSION_OPERATORS"}:{type:"SPANSET_EMPTY"}))}function Fr(e,t){const a=ye(e,[["parent",[Me]]]),r=a?ht(a,t):"";if(r===".")return{type:"SPANSET_ONLY_DOT"};const s=r.indexOf("."),o=r.slice(0,s);return["span","resource","parent"].find(i=>i===o)?{type:"SPANSET_IN_NAME_SCOPE",scope:o}:{type:"SPANSET_IN_NAME"}}function jr(e,t,a,r){const s=Ot(e,t,r);if(s)return s;if(e.prevSibling?.type.id===Ht){let o=e.prevSibling.prevSibling;if(o)return{type:"SPANSET_IN_VALUE",tagName:ht(o,t),betweenQuotes:!1}}return e.prevSibling?.type.name==="And"||e.prevSibling?.type.name==="Or"?{type:"SPANSET_EMPTY"}:{type:"SPANSET_IN_THE_MIDDLE"}}function Yr(e,t,a){return e.prevSibling?.type.id===ea?{type:"UNKNOWN"}:{type:"SPANSET_COMPARISON_OPERATORS"}}function ra(e,t,a){let r=e.firstChild;try{for(r=e.firstChild;r.to<a;)r=r.nextSibling}catch(s){console.error("Unexpected error while searching for previous node",s)}return r?.type.id===Kt||r?.type.id===Zt?{type:"NEW_SPANSET"}:{type:"SPANSET_COMBINING_OPERATORS"}}function na(e,t,a){const r=e?.parent;return r&&[ft,ze,Ar,Ur].includes(r.type.id)?{type:"ATTRIBUTE_FOR_FUNCTION"}:{type:"UNKNOWN"}}function Br(e,t,a){return e.prevSibling?.type.id===qt?{type:"SPANSET_PIPELINE_AFTER_OPERATOR"}:{type:"NEW_SPANSET"}}function kr(e,t,a){const r=Ot(e,t,a);return r||{type:"SPANSET_EXPRESSION_OPERATORS_WITH_MISSING_CLOSED_BRACE"}}const j=class{constructor(e){this.triggerCharacters=["{",".","[","(","=","~"," ",'"'],this.cachedValues={},this.languageProvider=e.languageProvider,this.registerInteractionCommandId=null}provideCompletionItems(e,t){if(!(this.monaco&&this.editor))throw new Error("provideCompletionItems called before CompletionProvider was initialized");if(this.editor.getModel()?.id!==e.id)return{suggestions:[]};const{range:a,offset:r}=Gr(this.monaco,e,t),s=_r(e.getValue(),r);return(s!=null?this.getCompletions(s):Promise.resolve([])).then(i=>{const c=i.length.toString().length;return{suggestions:i.map((d,p)=>{const m={kind:Xr(d.type,this.monaco),label:d.label,insertText:d.insertText,insertTextRules:d.insertTextRules,detail:d.detail,documentation:d.documentation,sortText:p.toString().padStart(c,"0"),range:a,command:{id:this.registerInteractionCommandId||"noOp",title:"Report Interaction",arguments:[d.label,d.type]}};return zr(m,d.type,e,r),m})}})}setRegisterInteractionCommandId(e){this.registerInteractionCommandId=e}async getTagValues(e,t){let a;return this.cachedValues.hasOwnProperty(e)?a=this.cachedValues[e]:(a=await this.languageProvider.getOptionsV2(e,t),this.cachedValues[e]=a),a}async getCompletions(e){switch(e.type){case"UNKNOWN":return[];case"EMPTY":return this.getScopesCompletions("{ ").concat(this.getIntrinsicsCompletions("{ ")).concat(this.getTagsCompletions("{ ."));case"SPANSET_EMPTY":return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions("."));case"SPANSET_ONLY_DOT":return this.getTagsCompletions();case"SPANSET_IN_THE_MIDDLE":return[...j.comparisonOps,...j.logicalOps].map(i=>({...i,type:"OPERATOR"}));case"SPANSET_EXPRESSION_OPERATORS_WITH_MISSING_CLOSED_BRACE":return[...j.comparisonOps,...j.logicalOps].map(i=>({...i,type:"OPERATOR"}));case"SPANSET_IN_NAME":return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions());case"SPANSET_IN_NAME_SCOPE":return this.getTagsCompletions(void 0,e.scope);case"SPANSET_EXPRESSION_OPERATORS":return[...j.comparisonOps,...j.logicalOps,...j.arithmeticOps].map(i=>({...i,type:"OPERATOR"}));case"SPANFIELD_COMBINING_OPERATORS":return[...j.logicalOps,...j.arithmeticOps,...j.comparisonOps].map(i=>({...i,type:"OPERATOR"}));case"SPANSET_COMBINING_OPERATORS":return j.spansetOps.map(i=>({...i,type:"OPERATOR"}));case"SPANSET_PIPELINE_AFTER_OPERATOR":const t=j.functions.map(i=>({...i,insertTextRules:this.monaco?.languages.CompletionItemInsertTextRule?.InsertAsSnippet,type:"FUNCTION"})),a=this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions("."));return[...t,...a];case"SPANSET_COMPARISON_OPERATORS":return j.comparisonOps.map(i=>({...i,type:"OPERATOR"}));case"SPANSET_IN_VALUE":let r;try{r=await this.getTagValues(e.tagName,e.query)}catch(i){(0,le.kW)(i)?(0,ue.WI)((0,be.$l)((0,ce.t_)(i.data.error,new Error(i.data.message)))):i instanceof Error&&(0,ue.WI)((0,be.$l)((0,ce.t_)("Error",i)))}const s=[],o=i=>e.betweenQuotes?i.label:i.type==="string"?`"${i.label}"`:i.label;return r?.forEach(i=>{i?.label&&s.push({label:i.label,insertText:o(i),type:"TAG_VALUE"})}),s;case"SPANSET_AFTER_VALUE":return j.logicalOps.map(i=>({label:i.label,insertText:i.insertText+"}",type:"OPERATOR"}));case"NEW_SPANSET":return this.getScopesCompletions("{ ","$0 }").concat(this.getIntrinsicsCompletions("{ ","$0 }")).concat(this.getTagsCompletions("."));case"ATTRIBUTE_FOR_FUNCTION":return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions("."));default:throw new Error(`Unexpected situation ${e}`)}}getTagsCompletions(e,t){return this.languageProvider.getTraceqlAutocompleteTags(t).sort((r,s)=>r.localeCompare(s,void 0,{sensitivity:"accent"})).map(r=>({label:r,insertText:(e||"")+r,type:"TAG_NAME"}))}getIntrinsicsCompletions(e,t){return $e.map(a=>({label:a,insertText:(e||"")+a+(t||""),type:"KEYWORD",insertTextRules:this.monaco?.languages.CompletionItemInsertTextRule?.InsertAsSnippet}))}getScopesCompletions(e,t){return It.map(a=>({label:a,insertText:(e||"")+a+(t||""),type:"SCOPE",insertTextRules:this.monaco?.languages.CompletionItemInsertTextRule?.InsertAsSnippet}))}};let me=j;me.arithmeticOps=[{label:"+",insertText:"+",detail:"Plus"},{label:"-",insertText:"-",detail:"Minus"},{label:"*",insertText:"*",detail:"Times"},{label:"/",insertText:"/",detail:"Over"}],me.logicalOps=[{label:"&&",insertText:"&&",detail:"And",documentation:"And (intersection) operator. Checks that both conditions found matches."},{label:"||",insertText:"||",detail:"Or",documentation:"Or (union) operator. Checks that either condition found matches."}],me.comparisonOps=[{label:"=",insertText:"=",detail:"Equality"},{label:"!=",insertText:"!=",detail:"Inequality"},{label:">",insertText:">",detail:"Greater than"},{label:">=",insertText:">=",detail:"Greater than or equal to"},{label:"<",insertText:"<",detail:"Less than"},{label:"<=",insertText:"<=",detail:"Less than or equal to"},{label:"=~",insertText:"=~",detail:"Regular expression"},{label:"!~",insertText:"!~",detail:"Negated regular expression"}],me.structuralOps=[{label:">>",insertText:">>",detail:"Descendant",documentation:"Descendant operator. Looks for spans matching {condB} that are descendants of a span matching {condA}"},{label:">",insertText:">",detail:"Child",documentation:"Child operator. Looks for spans matching {condB} that are direct child spans of a parent matching {condA}"},{label:"<<",insertText:"<<",detail:"Ancestor",documentation:"Ancestor operator. Looks for spans matching {condB} that are ancestors of a span matching {condA}"},{label:"<",insertText:"<",detail:"Parent",documentation:"Parent operator. Looks for spans matching {condB} that are direct parent spans of a child matching {condA}"},{label:"~",insertText:"~",detail:"Sibling",documentation:"Sibling operator. Checks that spans matching {condA} and {condB} are siblings of the same parent span."}],me.spansetOps=[{label:"|",insertText:"|",detail:"Pipe"},...j.logicalOps,...j.structuralOps],me.spansetAggregatorOps=[{label:"count",insertText:"count()$0",detail:"Number of spans",documentation:"Counts the number of spans in a spanset"},{label:"avg",insertText:"avg($0)",detail:"Average of attribute",documentation:"Computes the average of a given numeric attribute or intrinsic for a spanset."},{label:"max",insertText:"max($0)",detail:"Max value of attribute",documentation:"Computes the maximum value of a given numeric attribute or intrinsic for a spanset."},{label:"min",insertText:"min($0)",detail:"Min value of attribute",documentation:"Computes the minimum value of a given numeric attribute or intrinsic for a spanset."},{label:"sum",insertText:"sum($0)",detail:"Sum value of attribute",documentation:"Computes the sum value of a given numeric attribute or intrinsic for a spanset."}],me.functions=[...j.spansetAggregatorOps,{label:"by",insertText:"by($0)",detail:"Grouping of attributes",documentation:"Groups by arbitrary attributes."},{label:"select",insertText:"select($0)",detail:"Selection of fields",documentation:"Selects arbitrary fields from spans."}];function Xr(e,t){switch(e){case"TAG_NAME":return t.languages.CompletionItemKind.Enum;case"KEYWORD":return t.languages.CompletionItemKind.Keyword;case"OPERATOR":return t.languages.CompletionItemKind.Operator;case"TAG_VALUE":return t.languages.CompletionItemKind.EnumMember;case"SCOPE":return t.languages.CompletionItemKind.Class;case"FUNCTION":return t.languages.CompletionItemKind.Function;default:throw new Error(`Unexpected CompletionType: ${e}`)}}function Gr(e,t,a){const r=t.getWordAtPosition(a),s=r!=null?e.Range.lift({startLineNumber:a.lineNumber,endLineNumber:a.lineNumber,startColumn:r.startColumn,endColumn:r.endColumn}):e.Range.fromPositions(a),o={column:a.column,lineNumber:a.lineNumber};return{offset:t.getOffsetAt(o),range:s}}function zr(e,t,a,r){if(t==="TAG_NAME"){const s=a.getValue().substring(0,r).match(/(span\.|resource\.|\.)?([\w./-]*)$/);if(s){const o=s[1],i=s[2];i&&(!o&&e.insertText[0]!=="."&&(e.insertText="."+e.insertText),e.range={...e.range,startColumn:r-i.length+1})}}}const Kr=e=>{switch(e.parent?.type.id){case ne:switch(e.prevSibling?.type.id){case Kt:case Zt:return"Invalid value after logical operator.";case Ht:return"Invalid value after comparison or aritmetic operator.";default:return"Invalid operator after field expression."}case Ge:return e.prevSibling?.type.id===ne?"Invalid comparison operator after field expression.":"Invalid expression for spanset.";case Xe:switch(e.prevSibling?.type.id){case Xe:return"Invalid spanset combining operator after spanset expression.";case qt:return"Invalid aggregation operator after pipepile operator.";default:return"Invalid spanset expression after spanset combining operator."}case ft:case ze:return"Invalid expression for aggregator operator.";case Me:return"Invalid expression for spanset.";case Jt:switch(e.prevSibling?.type.id){case ea:return"Invalid value after comparison operator.";case Lr:if(e.prevSibling?.firstChild?.type.id===ze)return"Invalid comparison operator after aggregator operator.";default:return"Invalid value after comparison operator."}default:return"Invalid query."}},sa=e=>{if(e.trim()==="")return[];const t=/^[0-9A-Fa-f]*$/;if(e.trim().match(t))return[];const a=Gt.parse(e),r=[];return a.iterate({enter:s=>{s.type.id===0&&r.push(s.node)}}),r},St=(e,t,a)=>{e.editor.setModelMarkers(t,"owner",a.map(r=>{let s=0,o=0,i=r.from,c=r.to;for(;i>0;)s++,i-=t.getLineLength(s)+1;for(;c>0;)o++,c-=t.getLineLength(o)+1;return{message:Kr(r),severity:e.MarkerSeverity.Error,startLineNumber:s,endLineNumber:o,startColumn:i+t.getLineLength(s)+2,endColumn:c+t.getLineLength(o)+2}}))};function Zr(e){const{onChange:t,onRunQuery:a,placeholder:r}=e,s=tn(e.datasource),o=(0,C.l4)(),i=rn(o,r),c=(0,n.useRef)(a);c.current=a;const u=(0,n.useRef)();return n.createElement(_t.p,{value:e.value,language:Le,onBlur:t,onChange:t,containerStyles:i.queryField,readOnly:e.readOnly,monacoOptions:{folding:!1,fontSize:14,lineNumbers:"off",overviewRulerLanes:0,renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0},scrollBeyondLastLine:!1,wordWrap:"on"},onBeforeEditorMount:an,onEditorDidMount:(d,p)=>{e.readOnly||(s(d,p,Jr(d)),Hr(d,p,()=>c.current()),qr(d,p,i)),en(d);const m=d.getModel();if(m){const h=sa(m.getValue());St(p,m,h)}d.onDidChangeModelContent(h=>{const g=d.getModel();if(!g)return;window.clearTimeout(u.current);const b=sa(g.getValue()),q=h.changes[0].rangeOffset;St(p,g,b.filter(R=>!(R.from<=q&&q<=R.to))),u.current=window.setTimeout(()=>{St(p,g,b)},500)})}})}function qr(e,t,a){const r=[{range:new t.Range(1,1,1,1),options:{className:a.placeholder,isWholeLine:!0}}];let s=[];const o=()=>{const i=e.getModel();if(!i)return;const c=i.getValueLength()===0?r:[];s=i.deltaDecorations(s,c)};o(),e.onDidChangeModelContent(o)}function Hr(e,t,a){e.addAction({id:"run-query",label:"Run Query",keybindings:[t.KeyMod.Shift|t.KeyCode.Enter],contextMenuGroupId:"navigation",contextMenuOrder:1.5,run:function(){a()}})}function Jr(e){return e.addCommand(0,function(t,a,r){const s={datasourceType:"tempo",type:r};r!=="TAG_VALUE"&&(s.label=a),(0,L.ff)("grafana_traces_traceql_completion",s)})}function en(e){const t=e.getDomNode(),a=()=>{if(t){const r=Math.min(1e3,e.getContentHeight()),s=parseInt(t.style.width,10);t.style.width=`${s}px`,t.style.height=`${r}px`,e.layout({width:s,height:r})}};e.onDidContentSizeChange(a),a()}function tn(e){const t=(0,n.useRef)(new me({languageProvider:e.languageProvider}));(0,n.useEffect)(()=>{(async()=>{try{await e.languageProvider.start()}catch(s){s instanceof Error&&(0,ue.WI)((0,be.$l)((0,ce.t_)("Error",s)))}})()},[e]);const a=(0,n.useRef)(null);return(0,n.useEffect)(()=>()=>{a.current?.()},[]),(r,s,o)=>{t.current.editor=r,t.current.monaco=s,t.current.setRegisterInteractionCommandId(o);const{dispose:i}=s.languages.registerCompletionItemProvider(Le,t.current);a.current=i}}let ia=!1;const Le="traceql";function an(e){if(!ia){ia=!0;const{aliases:t,extensions:a,mimetypes:r,def:s}=Ea;e.languages.register({id:Le,aliases:t,extensions:a,mimetypes:r}),e.languages.setMonarchTokensProvider(Le,s.language),e.languages.setLanguageConfiguration(Le,s.languageConfiguration)}}const rn=(e,t)=>({queryField:(0,W.css)`
      border-radius: ${e.shape.radius.default};
      border: 1px solid ${e.components.input.borderColor};
      flex: 1;
    `,placeholder:(0,W.css)`
      ::after {
        content: '${t}';
        font-family: ${e.typography.fontFamilyMonospace};
        opacity: 0.3;
      }
    `});function nn(e){const t=(0,C.wW)(sn),a=(0,H.defaults)(e.query,Ir),r=s=>{e.onChange({...a,query:s})};return n.createElement(n.Fragment,null,n.createElement(f.W,null,"Build complex queries using TraceQL to select a list of traces."," ",n.createElement("a",{rel:"noreferrer",target:"_blank",href:"https://grafana.com/docs/tempo/latest/traceql/"},"Documentation")),n.createElement(Zr,{placeholder:"Enter a TraceQL query or trace ID (run with Shift+Enter)",value:a.query||"",onChange:r,datasource:e.datasource,onRunQuery:e.onRunQuery}),n.createElement("div",{className:t.optionsContainer},n.createElement(mt,{query:a,onChange:e.onChange})))}const sn=()=>({optionsContainer:(0,W.css)`
    margin-top: 10px;
  `}),on="traceql";class ln extends n.PureComponent{constructor(t){super(t),this.onChangeLinkedQuery=a=>{const{query:r,onChange:s}=this.props;s({...r,linkedQuery:{...a,refId:"linked"}})},this.onRunLinkedQuery=()=>{this.props.onRunQuery()},this.onClearResults=()=>{const{onChange:a,query:r,onRunQuery:s}=this.props;a({...r,queryType:"clear"}),s()},this.state={uploadModalOpen:!1}}async componentDidMount(){(!this.props.query.queryType||this.props.query.queryType==="clear")&&this.props.onChange({...this.props.query,queryType:on})}render(){const{query:t,onChange:a,datasource:r,app:s}=this.props,o=r.getLokiSearchDS(),i=r.serviceMap?.datasourceUid;let c=[{value:"traceqlSearch",label:"Search"},{value:"traceql",label:"TraceQL"},{value:"serviceMap",label:"Service Graph"}];return o&&(r?.search?.hide?c.unshift({value:"search",label:"Search"}):c.push({value:"search",label:"Loki Search"})),(t.spanName||t.serviceName||t.search||t.maxDuration||t.minDuration||t.queryType==="nativeSearch")&&c.unshift({value:"nativeSearch",label:"[Deprecated] Search"}),n.createElement(n.Fragment,null,n.createElement(_.u,{title:"Upload trace",isOpen:this.state.uploadModalOpen,onDismiss:()=>this.setState({uploadModalOpen:!1})},n.createElement("div",{className:(0,W.css)({padding:this.props.theme.spacing(2)})},n.createElement($.Yo,{options:{multiple:!1},onLoad:u=>{this.props.datasource.uploadedJson=u,a({...t,queryType:"upload"}),this.setState({uploadModalOpen:!1}),this.props.onRunQuery()}}))),n.createElement(P.Z,null,n.createElement(E._,{label:"Query type",grow:!0},n.createElement(N.Lh,{spacing:"sm",align:"center",justify:"space-between"},n.createElement(S.S,{options:c,value:t.queryType,onChange:u=>{(0,L.ff)("grafana_traces_query_type_changed",{datasourceType:"tempo",app:s??"",grafana_version:y.config.buildInfo.version,newQueryType:u,previousQueryType:t.queryType??""}),this.onClearResults(),a({...t,queryType:u})},size:"md"}),n.createElement(T.zx,{variant:"secondary",size:"sm",onClick:()=>{this.setState({uploadModalOpen:!0})}},"Import trace")))),t.queryType==="search"&&n.createElement(G,{logsDatasourceUid:o,query:t,onRunQuery:this.onRunLinkedQuery,onChange:this.onChangeLinkedQuery}),t.queryType==="nativeSearch"&&n.createElement(Wr,{datasource:this.props.datasource,query:t,onChange:a,onBlur:this.props.onBlur,onRunQuery:this.props.onRunQuery}),t.queryType==="traceqlSearch"&&n.createElement(Pr,{datasource:this.props.datasource,query:t,onChange:a,onBlur:this.props.onBlur}),t.queryType==="serviceMap"&&n.createElement(Rr,{graphDatasourceUid:i,query:t,onChange:a}),t.queryType==="traceql"&&n.createElement(nn,{datasource:this.props.datasource,query:t,onRunQuery:this.props.onRunQuery,onChange:a}))}}const cn=(0,C.HE)(ln);var un=l(83743),dn=l(55857),mn=l(99323),Wn=l(30743),oa=l(57773),pn=l(33223),Ke=l(15889),gn=l(9011),Ae=l(7033),Z=l(76581),fn=l(42056),Tt=l(29724),hn=l(261),On=l(81445),Y=l(52219),vt=l(5999),yt=l(40715),Sn=l(77172),Tn=l(87877),vn=l(7734);function yn({options:e,onOptionsChange:t}){const a=(0,n.useMemo)(()=>["grafana-pyroscope-datasource"],[]),[r,s]=(0,n.useState)([]),o=(0,n.useMemo)(()=>{let c=r.length===0?"No profile types found":"Select profile type";return e.jsonData.tracesToProfiles?.datasourceUid||(c="Please select profiling data source"),c},[e.jsonData.tracesToProfiles?.datasourceUid,r]),{value:i}=(0,On.Z)(async()=>await(0,K.F)().get(e.jsonData.tracesToProfiles?.datasourceUid),[e.jsonData.tracesToProfiles?.datasourceUid]);return(0,n.useEffect)(()=>{i&&i instanceof Tn.tF&&a.includes(i.type)&&i.uid===e.jsonData.tracesToProfiles?.datasourceUid?i.getProfileTypes().then(c=>{s(c)}):s([])},[i,t,e,a]),n.createElement("div",{className:(0,W.css)({width:"100%"})},n.createElement(P.Z,null,n.createElement(E._,{tooltip:"The profiles data source the trace is going to navigate to",label:"Data source",labelWidth:26},n.createElement(yt.q,{inputId:"trace-to-profiles-data-source-picker",filter:c=>a.includes(c.type),current:e.jsonData.tracesToProfiles?.datasourceUid,noDefault:!0,width:40,onChange:c=>{(0,Y.tp)({onOptionsChange:t,options:e},"tracesToProfiles",{...e.jsonData.tracesToProfiles,datasourceUid:c.uid})}}))),n.createElement(P.Z,null,n.createElement(E._,{tooltip:"Tags that will be used in the query. Default tags: 'service.name', 'service.namespace'",label:"Tags",labelWidth:26},n.createElement(vn.a,{values:e.jsonData.tracesToProfiles?.tags??[],onChange:c=>{(0,Y.tp)({onOptionsChange:t,options:e},"tracesToProfiles",{...e.jsonData.tracesToProfiles,tags:c})}}))),n.createElement(P.Z,null,n.createElement(E._,{tooltip:"Profile type that will be used in the query",label:"Profile type",labelWidth:26},n.createElement(Sn.o,{profileTypes:r,placeholder:o,initialProfileTypeId:e.jsonData.tracesToProfiles?.profileTypeId,onChange:c=>{(0,Y.tp)({onOptionsChange:t,options:e},"tracesToProfiles",{...e.jsonData.tracesToProfiles,profileTypeId:c})},width:40}))),n.createElement(P.Z,null,n.createElement(E._,{tooltip:"Use a custom query with the possibility to interpolate variables from the trace or span",label:"Use custom query",labelWidth:26},n.createElement(vt.x,{id:"profilesCustomQuerySwitch",value:e.jsonData.tracesToProfiles?.customQuery,onChange:c=>(0,Y.tp)({onOptionsChange:t,options:e},"tracesToProfiles",{...e.jsonData.tracesToProfiles,customQuery:c.currentTarget.checked})}))),e.jsonData.tracesToProfiles?.customQuery&&n.createElement(E._,{label:"Query",labelWidth:26,tooltip:"The query that will run when navigating from a trace to profiles data source. Interpolate tags using the `$__tags` keyword",grow:!0},n.createElement(Re.I,{label:"Query",type:"text",allowFullScreen:!0,value:e.jsonData.tracesToProfiles?.query||"",onChange:c=>(0,Y.tp)({onOptionsChange:t,options:e},"tracesToProfiles",{...e.jsonData.tracesToProfiles,query:c.currentTarget.value})})))}const En=({options:e,onOptionsChange:t})=>n.createElement(oa.K,{title:"Trace to profiles",description:n.createElement(Ae.W,{description:"Navigate from a trace span to the selected data source's profiles.",suffix:`${e.type}/#trace-to-profiles`,feature:"trace to profiles"}),isCollapsible:!0,isInitiallyOpen:!0},n.createElement(yn,{options:e,onOptionsChange:t}));var Pn=l(79152),la=l(42177);function Qn({options:e,onOptionsChange:t}){const a=(0,C.wW)(Ze),r=o=>`Time shift for ${o} of search`,s=o=>`Shifts the ${o} of the time range when searching by TraceID. Searching can return traces that do not fully fall into the search time range, so we recommend using higher time shifts for longer traces. Default: 30m (Time units can be used here, for example: 5s, 1m, 3h`;return n.createElement("div",{className:a.container},n.createElement(E._,{label:"Use time range in query",tooltip:"The time range can be used when there are performance issues or timeouts since it will narrow down the search to the defined range. Default: disabled",labelWidth:26},n.createElement(vt.x,{id:"enable-time-shift",value:e.jsonData.traceQuery?.timeShiftEnabled||!1,onChange:o=>{(0,Y.tp)({onOptionsChange:t,options:e},"traceQuery",{...e.jsonData.traceQuery,timeShiftEnabled:o.currentTarget.checked})}})),n.createElement(la.w,{label:r("start"),tooltip:s("start"),value:e.jsonData.traceQuery?.spanStartTimeShift||"",disabled:!e.jsonData.traceQuery?.timeShiftEnabled,onChange:o=>{(0,Y.tp)({onOptionsChange:t,options:e},"traceQuery",{...e.jsonData.traceQuery,spanStartTimeShift:o})},isInvalidError:Tt.Ny}),n.createElement(la.w,{label:r("end"),tooltip:s("end"),value:e.jsonData.traceQuery?.spanEndTimeShift||"",disabled:!e.jsonData.traceQuery?.timeShiftEnabled,onChange:o=>{(0,Y.tp)({onOptionsChange:t,options:e},"traceQuery",{...e.jsonData.traceQuery,spanEndTimeShift:o})},isInvalidError:Tt.Ny}))}const Ze=e=>({infoText:(0,W.css)`
    padding-bottom: ${e.spacing(2)};
    color: ${e.colors.text.secondary};
  `,container:(0,W.css)`
    width: 100%;
  `,row:(0,W.css)`
    align-items: baseline;
  `});function bn({options:e,onOptionsChange:t}){const a=(0,C.wW)(Ze),r=e.jsonData.tracesToLogs?.lokiSearch!==!1?e.jsonData.tracesToLogs?.datasourceUid:void 0;return r&&e.jsonData.lokiSearch===void 0&&(0,Y.tp)({onOptionsChange:t,options:e},"lokiSearch",{datasourceUid:r}),n.createElement("div",{className:a.container},n.createElement(P.Z,{className:a.row},n.createElement(E._,{tooltip:"The Loki data source with the service graph data",label:"Data source",labelWidth:26},n.createElement(yt.q,{inputId:"loki-search-data-source-picker",pluginId:"loki",current:e.jsonData.lokiSearch?.datasourceUid,noDefault:!0,width:40,onChange:s=>(0,Y.tp)({onOptionsChange:t,options:e},"lokiSearch",{datasourceUid:s.uid})})),e.jsonData.lokiSearch?.datasourceUid?n.createElement(T.zx,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,Y.tp)({onOptionsChange:t,options:e},"lokiSearch",{datasourceUid:void 0})}},"Clear"):null))}function Rn({options:e,onOptionsChange:t}){const a=(0,C.wW)(Ze);return n.createElement("div",{className:a.container},n.createElement(P.Z,{className:a.row},n.createElement(E._,{tooltip:"The Prometheus data source with the service graph data",label:"Data source",labelWidth:26},n.createElement(yt.q,{inputId:"service-graph-data-source-picker",pluginId:"prometheus",current:e.jsonData.serviceMap?.datasourceUid,noDefault:!0,width:40,onChange:r=>(0,Y.tp)({onOptionsChange:t,options:e},"serviceMap",{datasourceUid:r.uid})})),e.jsonData.serviceMap?.datasourceUid?n.createElement(T.zx,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,Y.tp)({onOptionsChange:t,options:e},"serviceMap",{datasourceUid:void 0})}},"Clear"):null))}function Dn({options:e,onOptionsChange:t,datasource:a}){const r=async()=>{if(!a)throw new Error("Unable to retrieve datasource");try{await a.languageProvider.start()}catch(p){throw new Error(x(p.data.message,"Unable to query Tempo"))}},{error:s,loading:o}=(0,Q.Z)(r,[a,e]),i=(0,n.useCallback)(p=>{let m=e.jsonData.search?.filters;m||=[];const h=m.findIndex(g=>g.id===p.id);h>=0?m=nt(m,h,p):m.push(p),(0,Y.tp)({onOptionsChange:t,options:e},"search",{...e.jsonData.search,filters:m})},[t,e]),c=p=>{(0,Y.tp)({onOptionsChange:t,options:e},"search",{...e.jsonData.search,filters:e.jsonData.search?.filters?.filter(m=>m.id!==p.id)})};(0,n.useEffect)(()=>{e.jsonData.search?.filters||(0,Y.tp)({onOptionsChange:t,options:e},"search",{...e.jsonData.search,filters:[{id:"service-name",tag:"service.name",operator:"=",scope:M.NM.Resource},{id:"span-name",tag:"name",operator:"=",scope:M.NM.Span}]})},[t,e]);const u=["duration"],d=e.jsonData.search?.filters?.find(p=>!p.tag);return n.createElement(n.Fragment,null,a?n.createElement(kt,{updateFilter:i,deleteFilter:c,filters:e.jsonData.search?.filters||[],datasource:a,setError:()=>{},staticTags:u,isTagsLoading:o,hideValues:!0,query:"{}"}):n.createElement("div",null,"Invalid data source, please create a valid data source and try again"),s&&n.createElement(Ee.b,{title:"Unable to fetch TraceQL tags",severity:"error",topSpacing:1},s.message),d&&n.createElement(Ee.b,{title:"Please ensure each filter has a selected tag",severity:"warning",topSpacing:1}))}function Cn({options:e,onOptionsChange:t}){const a=(0,C.wW)(Ze),r=(0,K.F)(),s=async()=>await r.get({type:e.type,uid:e.uid}),{value:o}=(0,Q.Z)(s,[r,e]);return n.createElement("div",{className:a.container},n.createElement(P.Z,{className:a.row},n.createElement(E._,{tooltip:"Removes the search tab from the query editor",label:"Hide search",labelWidth:26},n.createElement(vt.x,{id:"hideSearch",value:e.jsonData.search?.hide,onChange:i=>(0,Y.tp)({onOptionsChange:t,options:e},"search",{...e.jsonData.search,hide:i.currentTarget.checked})}))),n.createElement(P.Z,{className:a.row},n.createElement(E._,{tooltip:"Configures which fields are available in the UI",label:"Static filters",labelWidth:26},n.createElement(Dn,{datasource:o,options:e,onOptionsChange:t}))))}const In=({options:e,onOptionsChange:t})=>{const a=(0,C.wW)(Nn);return n.createElement("div",{className:a.container},n.createElement(un.j,{dataSourceName:"Tempo",docsLink:"https://grafana.com/docs/grafana/latest/datasources/tempo",hasRequiredFields:!1}),n.createElement(Z.i,null),n.createElement(dn.f,{config:e,onChange:t,urlPlaceholder:"http://localhost:3200"}),n.createElement(Z.i,null),n.createElement(mn.g,{...(0,Wn.T2)({config:e,onChange:t})}),n.createElement(Z.i,null),n.createElement(Tt.dw,{options:e,onOptionsChange:t}),n.createElement(Z.i,null),y.config.featureToggles.traceToMetrics?n.createElement(n.Fragment,null,n.createElement(hn.Y,{options:e,onOptionsChange:t}),n.createElement(Z.i,null)):null,y.config.featureToggles.traceToProfiles&&n.createElement(n.Fragment,null,n.createElement(En,{options:e,onOptionsChange:t}),n.createElement(Z.i,null)),n.createElement(oa.K,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!1},n.createElement(pn.a,{config:e,onChange:t}),y.config.secureSocksDSProxyEnabled&&n.createElement(n.Fragment,null,n.createElement(Z.i,{hideLine:!0}),n.createElement(gn.i,{options:e,onOptionsChange:t})),n.createElement(Z.i,{hideLine:!0}),n.createElement(Ke._,{title:"Service graph",description:n.createElement(Ae.W,{description:"Select a Prometheus data source that contains the service graph data.",suffix:"tempo/configure-tempo-data-source/#service-graph",feature:"the service graph"})},n.createElement(Rn,{options:e,onOptionsChange:t})),n.createElement(Z.i,{hideLine:!0}),n.createElement(fn.I,{options:e,onOptionsChange:t}),n.createElement(Z.i,{hideLine:!0}),n.createElement(Ke._,{title:"Tempo search",description:n.createElement(Ae.W,{description:"Modify how traces are searched.",suffix:"tempo/configure-tempo-data-source/#tempo-search",feature:"Tempo search"})},n.createElement(Cn,{options:e,onOptionsChange:t})),n.createElement(Z.i,{hideLine:!0}),n.createElement(Ke._,{title:"Loki search",description:n.createElement(Ae.W,{description:"Select a Loki data source to search for traces. Derived fields must be configured in the Loki data source.",suffix:"tempo/configure-tempo-data-source/#loki-search",feature:"Loki search"})},n.createElement(bn,{options:e,onOptionsChange:t})),n.createElement(Z.i,{hideLine:!0}),n.createElement(Ke._,{title:"TraceID query",description:n.createElement(Ae.W,{description:"Modify how TraceID queries are run.",suffix:"tempo/configure-tempo-data-source/#traceid-query",feature:"the TraceID query"})},n.createElement(Qn,{options:e,onOptionsChange:t})),n.createElement(Z.i,{hideLine:!0}),n.createElement(Pn.vc,{options:e,onOptionsChange:t})))},Nn=e=>({container:(0,W.css)`
    label: container;
    margin-bottom: ${e.spacing(2)};
    max-width: 900px;
  `});var xn=l(35630);const Mn=({payload:{dashboardId:e,orgId:t,grafanaVersion:a,queries:r}})=>{try{const s=r[xn.id];if(!s?.length)return;let o={grafana_version:a,dashboard_id:e,org_id:t,native_search_query_count:0,search_query_count:0,service_map_query_count:0,traceql_query_count:0,upload_query_count:0,native_search_queries_with_template_variables_count:0,search_queries_with_template_variables_count:0,service_map_queries_with_template_variables_count:0,traceql_queries_with_template_variables_count:0};for(const i of s)i.hide||(i.queryType==="nativeSearch"?(o.native_search_query_count++,(i.serviceName&&We(i.serviceName)||i.spanName&&We(i.spanName)||i.search&&We(i.search)||i.minDuration&&We(i.minDuration)||i.maxDuration&&We(i.maxDuration))&&o.native_search_queries_with_template_variables_count++):i.queryType==="search"?(o.search_query_count++,i.linkedQuery&&i.linkedQuery.expr&&We(i.linkedQuery.expr)&&o.search_queries_with_template_variables_count++):i.queryType==="serviceMap"?(o.service_map_query_count++,i.serviceMapQuery&&We(i.serviceMapQuery)&&o.service_map_queries_with_template_variables_count++):i.queryType==="traceql"?(o.traceql_query_count++,We(i.query)&&o.traceql_queries_with_template_variables_count++):i.queryType==="upload"&&o.upload_query_count++);(0,L.ff)("grafana_tempo_dashboard_loaded",o)}catch(s){console.error("error in tempo tracking handler",s)}},We=e=>(0,he.J)().containsTemplate(e),Ln=new v.hf(qa).setQueryEditor(cn).setConfigEditor(In).setQueryEditorHelp(w);(0,U.N$)().subscribe(O.Pl,Mn)}}]);

//# sourceMappingURL=9479.93330bd65ac7ed5aece2.js.map