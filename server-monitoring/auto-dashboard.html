<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Management - Auto Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid #333;
        }
        .metric-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 10px;
            text-align: center;
        }
        .metric-description {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
        }
        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 15px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-healthy { background-color: #4caf50; }
        .status-warning { background-color: #ff9800; }
        .status-error { background-color: #f44336; }
        .quick-links {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .link-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .link-item {
            text-align: center;
        }
        .link-item a {
            display: block;
            background: #667eea;
            color: white;
            padding: 15px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: background 0.3s;
        }
        .link-item a:hover {
            background: #5a6fd8;
        }
        .refresh-info {
            text-align: center;
            color: #aaa;
            font-size: 12px;
            margin-top: 20px;
        }
        .loading {
            text-align: center;
            color: #667eea;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Portfolio Management - Auto Dashboard</h1>
        <p>Real-time monitoring with live graphs - Auto-refreshing every 30 seconds</p>
    </div>

    <div class="quick-links">
        <h3>üîó Quick Access</h3>
        <div class="link-grid">
            <div class="link-item">
                <a href="http://localhost:9090" target="_blank">Prometheus UI</a>
            </div>
            <div class="link-item">
                <a href="http://localhost:9091" target="_blank">Grafana Dashboards</a>
            </div>
            <div class="link-item">
                <a href="http://localhost:6050" target="_blank">Portfolio App</a>
            </div>
            <div class="link-item">
                <a href="http://localhost:6050/metrics" target="_blank">Raw Metrics</a>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="metric-card">
            <div class="metric-title">
                <span class="status-indicator status-healthy"></span>
                üöÄ Request Rate
            </div>
            <div class="metric-value" id="request-rate">Loading...</div>
            <div class="metric-description">Requests per second over the last 5 minutes</div>
            <div class="chart-container">
                <canvas id="requestRateChart"></canvas>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">
                <span class="status-indicator status-healthy"></span>
                ‚ö° Response Time
            </div>
            <div class="metric-value" id="response-time">Loading...</div>
            <div class="metric-description">Average response time in milliseconds</div>
            <div class="chart-container">
                <canvas id="responseTimeChart"></canvas>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">
                <span class="status-indicator status-healthy"></span>
                üíæ Memory Usage
            </div>
            <div class="metric-value" id="memory-usage">Loading...</div>
            <div class="metric-description">Current memory usage in MB</div>
            <div class="chart-container">
                <canvas id="memoryUsageChart"></canvas>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">
                <span class="status-indicator status-healthy"></span>
                üîÑ Event Loop Lag
            </div>
            <div class="metric-value" id="event-loop-lag">Loading...</div>
            <div class="metric-description">Node.js event loop lag in milliseconds</div>
            <div class="chart-container">
                <canvas id="eventLoopLagChart"></canvas>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">
                <span class="status-indicator status-healthy"></span>
                ‚úÖ Success Rate
            </div>
            <div class="metric-value" id="success-rate">Loading...</div>
            <div class="metric-description">Percentage of successful requests (2xx)</div>
            <div class="chart-container">
                <canvas id="successRateChart"></canvas>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">
                <span class="status-indicator status-healthy"></span>
                ‚ùå Error Rate
            </div>
            <div class="metric-value" id="error-rate">Loading...</div>
            <div class="metric-description">Percentage of error requests (4xx/5xx)</div>
            <div class="chart-container">
                <canvas id="errorRateChart"></canvas>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">
                <span class="status-indicator status-healthy"></span>
                üìà CPU Usage
            </div>
            <div class="metric-value" id="cpu-usage">Loading...</div>
            <div class="metric-description">CPU usage rate per second</div>
            <div class="chart-container">
                <canvas id="cpuUsageChart"></canvas>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">
                <span class="status-indicator status-healthy"></span>
                ‚è±Ô∏è Process Uptime
            </div>
            <div class="metric-value" id="uptime">Loading...</div>
            <div class="metric-description">Process uptime in seconds</div>
            <div class="chart-container">
                <canvas id="uptimeChart"></canvas>
            </div>
        </div>
    </div>

    <div class="refresh-info">
        Last updated: <span id="last-update">Loading...</span> | Auto-refresh every 30 seconds
    </div>

    <script>
        // Chart.js configuration
        Chart.defaults.color = '#aaa';
        Chart.defaults.borderColor = '#333';
        Chart.defaults.plugins.legend.display = false;

        // Chart instances
        const charts = {};

        // Initialize charts
        function initializeCharts() {
            const chartConfig = {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: true,
                            grid: {
                                color: '#333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    elements: {
                        point: {
                            radius: 0
                        }
                    }
                }
            };

            const chartIds = [
                'requestRateChart', 'responseTimeChart', 'memoryUsageChart', 
                'eventLoopLagChart', 'successRateChart', 'errorRateChart',
                'cpuUsageChart', 'uptimeChart'
            ];

            chartIds.forEach(id => {
                const ctx = document.getElementById(id).getContext('2d');
                charts[id] = new Chart(ctx, JSON.parse(JSON.stringify(chartConfig)));
            });
        }

        // Fetch metric data
        async function fetchMetric(query, elementId, chartId, unit = '') {
            try {
                const response = await fetch(`http://localhost:9090/api/v1/query?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.data.result.length > 0) {
                    const value = parseFloat(data.data.result[0].value[1]);
                    const element = document.getElementById(elementId);
                    const chart = charts[chartId];
                    
                    // Update metric value
                    let displayValue = value;
                    if (elementId.includes('rate') && !elementId.includes('success') && !elementId.includes('error')) {
                        displayValue = value.toFixed(2) + ' req/s';
                    } else if (elementId.includes('memory')) {
                        displayValue = value.toFixed(2) + ' MB';
                    } else if (elementId.includes('time') || elementId.includes('lag')) {
                        displayValue = value.toFixed(2) + ' ms';
                    } else if (elementId.includes('success') || elementId.includes('error')) {
                        displayValue = value.toFixed(1) + '%';
                    } else if (elementId.includes('cpu')) {
                        displayValue = value.toFixed(3) + ' /s';
                    } else if (elementId.includes('uptime')) {
                        const hours = Math.floor(value / 3600);
                        const minutes = Math.floor((value % 3600) / 60);
                        displayValue = `${hours}h ${minutes}m`;
                    } else {
                        displayValue = value.toFixed(2);
                    }
                    
                    element.textContent = displayValue;
                    
                    // Update chart
                    const now = new Date().toLocaleTimeString();
                    chart.data.labels.push(now);
                    chart.data.datasets[0].data.push(value);
                    
                    // Keep only last 20 data points
                    if (chart.data.labels.length > 20) {
                        chart.data.labels.shift();
                        chart.data.datasets[0].data.shift();
                    }
                    
                    chart.update('none');
                }
            } catch (error) {
                console.error('Error fetching metric:', error);
                document.getElementById(elementId).textContent = 'Error';
            }
        }

        // Fetch all metrics
        async function fetchAllMetrics() {
            const metrics = [
                { query: 'portfolio:http_requests_total:rate5m', element: 'request-rate', chart: 'requestRateChart' },
                { query: 'portfolio:http_request_duration_avg_ms', element: 'response-time', chart: 'responseTimeChart' },
                { query: 'portfolio:memory_usage_mb', element: 'memory-usage', chart: 'memoryUsageChart' },
                { query: 'portfolio:eventloop_lag_ms', element: 'event-loop-lag', chart: 'eventLoopLagChart' },
                { query: 'portfolio:http_success_rate_percent', element: 'success-rate', chart: 'successRateChart' },
                { query: 'portfolio:http_errors_5xx_percent', element: 'error-rate', chart: 'errorRateChart' },
                { query: 'portfolio:cpu_usage_rate', element: 'cpu-usage', chart: 'cpuUsageChart' },
                { query: 'portfolio:process_uptime_seconds', element: 'uptime', chart: 'uptimeChart' }
            ];

            await Promise.all(metrics.map(metric => 
                fetchMetric(metric.query, metric.element, metric.chart)
            ));

            // Update last update time
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        // Initialize dashboard
        window.addEventListener('load', function() {
            initializeCharts();
            fetchAllMetrics();
            
            // Refresh every 30 seconds
            setInterval(fetchAllMetrics, 30000);
        });
    </script>
</body>
</html> 